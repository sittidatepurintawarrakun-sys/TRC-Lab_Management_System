<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCF Report - Lab Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .btn { font-weight: 600; border-radius: 0.5rem; padding: 0.6rem 1.2rem; transition: background-color 0.3s ease; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:disabled { cursor: not-allowed; background-color: #94a3b8; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #475569; }
        .form-input { width: 100%; background-color: #f9fafb; border: 1px solid #d1d5db; color: #111827; border-radius: 0.5rem; padding: 0.75rem; }

        /* Existing Sidebar Styles */
        #detailsSidebar { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        #detailsSidebar.open { transform: translateX(0); }

        /* AI Copilot Sidebar Styles */
        #copilot-sidebar { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        #copilot-sidebar.open { transform: translateX(0); }
        #close-copilot-btn { font-size: 2rem; line-height: 1; }
        .prose h3 { font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose p { margin: 0.5em 0; }

        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-issued { background-color: #eff6ff; color: #1d4ed8; }
        .status-responded { background-color: #fefce8; color: #a16207; }
        .status-completed { background-color: #f0fdf4; color: #15803d; }
        .sidebar-section { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .sidebar-label { font-weight: 600; color: #4b5563; margin-bottom: 0.25rem; display: block; }
        .sidebar-value { color: #111827; }
        .sidebar-input { width: 100%; border-gray-300 rounded-md shadow-sm; }
    </style>
</head>
<body>
    <div class="flex h-screen bg-gray-100">
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-8">
                <div class="container mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4">
                             <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-file-circle-exclamation text-blue-700"></i> Nonconformance Report</h1>
                             <button id="analyze-btn" class="btn btn-primary">
                                <i class="fas fa-sparkles"></i> Analyze with AI
                             </button>
                             
                             <div id="admin-tools-container" class="hidden items-center gap-2 ml-4 border-l pl-4 border-gray-300">
                                <span class="text-xs font-bold text-gray-500 uppercase">Admin Tools:</span>
                                <button id="manual-update-btn" class="btn bg-teal-600 text-white hover:bg-teal-700 text-sm py-1 px-3" title="Recalculate Dashboard Statistics">
                                    <i class="fas fa-sync-alt"></i> Update Stats
                                </button>
                                <button id="manual-cleanup-btn" class="btn bg-rose-600 text-white hover:bg-rose-700 text-sm py-1 px-3" title="Delete records older than 2 years">
                                    <i class="fas fa-trash-restore"></i> Clean Old NCF
                                </button>
                            </div>
                    </div>
                    <div id="auth-container">
                        <div id="user-info" class="hidden items-center gap-4">
                            <span id="user-email" class="text-gray-600 text-sm"></span>
                            <button id="logout-btn" class="btn btn-secondary text-sm">Logout</button>
                        </div>
                        <button id="login-prompt-btn" class="btn btn-primary">Admin Login</button>
                    </div>
                    <a href="index.html" class="bg-white text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition">
                    &#8592; Back to Dashboard
                    </a>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 class="font-bold text-lg text-gray-700 mb-4">Monthly Issued NCF Trend</h3>
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 class="font-bold text-lg text-gray-700 mb-4">Department Status Overview</h3>
                        <div id="departmentStatusChartsContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 text-center">
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div>
                            <label for="searchInput" class="text-sm font-medium text-gray-700">Search NCF Number:</label>
                            <input type="text" id="searchInput" placeholder="e.g., 25-AUX-1235" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="filterDepartment" class="text-sm font-medium text-gray-700">Filter by Department:</label>
                            <select id="filterDepartment" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Departments</option>
                                <option value="AUX">Auxiliary</option>
                                <option value="VIS">Viscose</option>
                                <option value="SPG">Spinning</option>
                                <option value="ETP">ETP&WTP</option>
                                <option value="ABEC">ABEC</option>
                                <option value="FIBER">FIBER</option>
                                <option value="RM">Raw Material</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterStatus" class="text-sm font-medium text-gray-700">Filter by Status:</label>
                            <select id="filterStatus" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Statuses</option>
                                <option value="Issued">Issued (Open)</option>
                                <option value="Responded">Responded</option>
                                <option value="Completed">Completed (Closed)</option>
                            </select>
                        </div>
                        <div class="col-span-1 md:col-span-3 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="exportStartDate" class="text-sm font-medium text-gray-700">Start Date:</label>
                                <input type="date" id="exportStartDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="exportEndDate" class="text-sm font-medium text-gray-700">End Date:</label>
                                <input type="date" id="exportEndDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="md:col-span-2 flex justify-end gap-2">
                                <button id="clearFiltersBtn" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Clear All Filters
                                </button>
                                <button id="exportExcelBtn" class="btn btn-primary">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">NCF Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">To Dept.</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Area Process</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Description of Nonconformance</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Issue Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Follow Up Status</th>
                                    <th class="admin-actions-header px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider" style="display: none;">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="ncfTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="text-center p-8 text-gray-500">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination-controls" class="flex justify-between items-center mt-4 px-4 py-2 bg-white rounded-lg shadow-md">
                        <button id="prevPageBtn" class="btn btn-secondary" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span id="pageInfo" class="text-sm font-semibold text-gray-700">Page 1 of 1</span>
                        <button id="nextPageBtn" class="btn btn-secondary" disabled>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="detailsSidebar" class="fixed top-0 right-0 w-full md:w-2/5 h-full bg-white shadow-2xl z-50 overflow-y-auto">
        <div class="p-8">
            <button id="closeSidebarBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <div id="sidebarContent"></div>
        </div>
    </div>

    <button id="copilot-btn" class="fixed bottom-8 right-8 bg-purple-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl z-40 hover:bg-purple-700 transition-transform transform hover:scale-110">
        <i class="fa-solid fa-wand-magic-sparkles"></i>
    </button>
    <div id="copilot-sidebar" class="fixed top-0 right-0 h-full w-full md:w-[450px] bg-white shadow-2xl z-[60] transform transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <header class="p-4 border-b flex justify-between items-center bg-slate-50 flex-shrink-0">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-wand-magic-sparkles text-purple-500 mr-2"></i> AI Analysis</h2>
                <button id="close-copilot-btn" class="text-slate-500 hover:text-slate-800">&times;</button>
            </header>
            <div id="copilot-content" class="flex-grow p-4 overflow-y-auto prose prose-sm max-w-none">
                <div class="text-center text-slate-500">
                    <p>Click "Analyze with AI" on the main page to get insights, or ask me a question below.</p>
                </div>
            </div>
            <footer class="p-4 border-t bg-slate-50 flex-shrink-0">
                <div class="flex gap-2">
                    <input type="text" id="copilot-chat-input" placeholder="Ask a follow-up question..." class="form-input flex-grow">
                    <button id="copilot-chat-submit-btn" class="btn btn-secondary">Send</button>
                </div>
            </footer>
        </div>
    </div>

            <script>
            document.addEventListener('DOMContentLoaded', () => {
                const firebaseConfig = {
                    apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
                    authDomain: "lab-trc-management-system.firebaseapp.com",
                    projectId: "lab-trc-management-system",
                    storageBucket: "lab-trc-management-system.appspot.com",
                    messagingSenderId: "43919979160",
                    appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
                };
                
                firebase.initializeApp(firebaseConfig);
            
                const db = firebase.firestore();
                db.settings({ experimentalForceLongPolling: true });
                const auth = firebase.auth();

                const functions = firebase.functions();
                
                // Callable Functions (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô index.js)
                const getNcfAiAnalysis = functions.httpsCallable('getNcfAiAnalysis');
                const askNcfChat = functions.httpsCallable('askNcfChat');
                
                // [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin
                const adminManualUpdateStats = functions.httpsCallable('manualUpdateStats');
                const adminManualCleanup = functions.httpsCallable('manualCleanupOldRecords');

            const adminEmails = ["sittidate.p@adityabirla.com", "trc-qcl.laboratory@adityabirla.com", "laboratory.trc@adityabirla.com", "waraporn.jindanath@adityabirla.com"];
            let currentUser = null;

            const loginPromptBtn = $('#login-prompt-btn');
            const logoutBtn = $('#logout-btn');
            const userInfoDiv = $('#user-info');
            const userEmailSpan = $('#user-email');

            // Custom Modal Elements
            const passwordModal = $('#passwordModal');
            const passwordInput = $('#passwordInput');
            const modalOkBtn = $('#modalOkBtn');
            const modalCancelBtn = $('#modalCancelBtn');
            let loginEmailAttempt = null;

            // [‡πÉ‡∏´‡∏°‡πà] Admin Tools Elements
            const adminToolsContainer = $('#admin-tools-container');
            const manualUpdateBtn = $('#manual-update-btn');
            const manualCleanupBtn = $('#manual-cleanup-btn');

            loginPromptBtn.on('click', () => {
                const email = prompt("Please enter your admin email:");
                if (email) {
                    loginEmailAttempt = email;
                    passwordInput.val('');
                    passwordModal.show();
                    passwordInput.focus();
                }
            });

            modalOkBtn.on('click', () => {
                const password = passwordInput.val();
                if (password && loginEmailAttempt) {
                    auth.signInWithEmailAndPassword(loginEmailAttempt, password)
                        .catch(err => alert("Login Failed: " + err.message));
                }
                passwordModal.hide();
                loginEmailAttempt = null;
            });

            modalCancelBtn.on('click', () => {
                passwordModal.hide();
                loginEmailAttempt = null;
            });

            passwordInput.on('keypress', function(e) {
                if (e.which === 13) {
                    modalOkBtn.click();
                }
            });
            logoutBtn.on('click', () => auth.signOut());

            auth.onAuthStateChanged(user => {
                currentUser = user;
                const isAdmin = user && adminEmails.includes(user.email.toLowerCase());

                if (user) {
                    loginPromptBtn.hide();
                    userInfoDiv.show().css('display', 'flex');
                    userEmailSpan.text(user.email);
                } else {
                    loginPromptBtn.show();
                    userInfoDiv.hide();
                }

                // Show/Hide Admin Actions in Table
                const headers = document.querySelectorAll('.admin-actions-header');
                const cells = document.querySelectorAll('.admin-actions-cell');
                const displayStyle = isAdmin ? '' : 'none';
                
                headers.forEach(el => el.style.display = displayStyle);
                cells.forEach(el => el.style.display = displayStyle);

                // [‡πÉ‡∏´‡∏°‡πà] Show/Hide Admin Tools Buttons
                if (isAdmin) {
                    adminToolsContainer.removeClass('hidden').addClass('flex');
                } else {
                    adminToolsContainer.removeClass('flex').addClass('hidden');
                }
            });

            // [‡πÉ‡∏´‡∏°‡πà] Logic: ‡∏õ‡∏∏‡πà‡∏° Update Stats (Recalculate)
            manualUpdateBtn.on('click', async function() {
                if(!confirm("Confirm Manual Update?\n\nThis will recalculate dashboard statistics from all records. It may take a few seconds.")) return;

                const btn = $(this);
                const originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');

                try {
                    const result = await adminManualUpdateStats();
                    alert(`‚úÖ Update Successful!\nMessage: ${result.data.message || 'Stats updated.'}`);
                    fetchDashboardData(); // Refresh Graph
                } catch (error) {
                    console.error("Update Error:", error);
                    alert(`‚ùå Update Failed: ${error.message}`);
                } finally {
                    btn.prop('disabled', false).html(originalHtml);
                }
            });

            // [‡πÉ‡∏´‡∏°‡πà] Logic: ‡∏õ‡∏∏‡πà‡∏° Clean Old Records
            manualCleanupBtn.on('click', async function() {
                const yearThreshold = 2; 
                if(!confirm(`‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è\n\nAre you sure you want to delete records older than ${yearThreshold} years?\nThis action CANNOT be undone.`)) return;
                
                const confirmPass = prompt("Type 'DELETE' to confirm cleanup:");
                if (confirmPass !== 'DELETE') return;

                const btn = $(this);
                const originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Cleaning...');

                try {
                    const result = await adminManualCleanup();
                    alert(`‚úÖ Cleanup Complete!\nDeleted: ${result.data.deletedCount} records.`);
                    resetAndRender(); // Refresh Table
                } catch (error) {
                    console.error("Cleanup Error:", error);
                    alert(`‚ùå Cleanup Failed: ${error.message}`);
                } finally {
                    btn.prop('disabled', false).html(originalHtml);
                }
            });

            // --- DOM Elements ---
            const tableBody = document.getElementById('ncfTableBody');
            const searchInput = document.getElementById('searchInput');
            const filterDepartment = document.getElementById('filterDepartment');
            const filterStatus = document.getElementById('filterStatus');
            const detailsSidebar = document.getElementById('detailsSidebar');
            const sidebarContent = document.getElementById('sidebarContent');
            const closeSidebarBtn = document.getElementById('closeSidebarBtn');
            const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
            const departmentStatusContainer = document.getElementById('departmentStatusChartsContainer');
            const exportStartDate = document.getElementById('exportStartDate');
            const exportEndDate = document.getElementById('exportEndDate');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');

            // AI Copilot DOM Elements
            const copilotBtn = $('#copilot-btn');
            const copilotSidebar = $('#copilot-sidebar');
            const closeCopilotBtn = $('#close-copilot-btn');
            const copilotContent = $('#copilot-content');
            const copilotChatInput = $('#copilot-chat-input');
            const copilotChatSubmitBtn = $('#copilot-chat-submit-btn');
            const analyzeBtn = $('#analyze-btn');

            // --- State Variables ---
            let monthlyTrendChart;
            let departmentCharts = {};
            let currentFilteredRecords = [];
            let currentRecord = null;
            let isInitialLoad = true;
            let currentPage = 1;
            const rowsPerPage = 15;
            let lastVisibleDoc = null;
            let pageDocHistory = [null];

            exportExcelBtn.disabled = true;
            exportExcelBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading Data...`;
            
            // --- AI Copilot Logic ---
            copilotBtn.on('click', () => copilotSidebar.addClass('open'));
            closeCopilotBtn.on('click', () => copilotSidebar.removeClass('open'));
            analyzeBtn.on('click', function() {
                copilotSidebar.addClass('open');
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Analyzing...');
                if (currentFilteredRecords.length === 0) {
                    copilotContent.html('<p class="text-orange-500">No data in the table to analyze.</p>');
                    $(this).prop('disabled', false).html('<i class="fas fa-sparkles"></i> Analyze with AI');
                    return;
                }
                getGeminiInsights($(this));
            });

                const getGeminiInsights = async (btn) => {
                    copilotContent.html('<p class="text-center">    ‚ú®    Analyzing data from server... Please wait a moment.</p>');

                    try {
                        const result = await getNcfAiAnalysis();
                        const text = result.data.text;
                        copilotContent.html(marked.parse(text));

                    } catch (error) {
                        console.error("Error calling AI Analysis Function:", error);
                        copilotContent.html(`<p class="text-red-500">Sorry, the AI analysis failed. Error: ${error.message}</p>`);
                    } finally {
                        btn.prop('disabled', false).html('<i class="fas fa-sparkles"></i> Analyze with AI');
                    }
                };

                copilotChatSubmitBtn.on('click', async function() {
                    const question = copilotChatInput.val().trim();
                    if (!question) return;

                    const chatBtn = $(this);
                    chatBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                    const userQuestionHtml = `<div class="user-question mb-2 border-t pt-4 mt-4"><p class="font-semibold text-slate-800">You:</p><p>${question}</p></div>`;
                    copilotContent.append(userQuestionHtml);
                    const thinkingHtmlId = `thinking-${Date.now()}`;
                    const thinkingHtml = `<div id="${thinkingHtmlId}" class="ai-answer"><p class="font-semibold text-purple-600">AI:</p><p>    ü§î    Thinking...</p></div>`;
                    copilotContent.append(thinkingHtml);
                    copilotContent.scrollTop(copilotContent[0].scrollHeight);
                    copilotChatInput.val('');

                    try {
                        const result = await askNcfChat({ question: question });
                        const text = result.data.text;
                        $(`#${thinkingHtmlId}`).html(`<p class="font-semibold text-purple-600">AI:</p><div>${marked.parse(text)}</div>`);

                    } catch (error) {
                        console.error("Error calling AI Chat Function:", error);
                        $(`#${thinkingHtmlId}`).html(`<p class="text-red-500">Error: ${error.message}</p>`);
                    } finally {
                        chatBtn.prop('disabled', false).html('Send');
                        copilotContent.scrollTop(copilotContent[0].scrollHeight);
                    }
                });

            // --- Pagination Functions ---
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');

            const updatePaginationUI = (recordsFetchedCount) => {
                pageInfo.textContent = `Page ${currentPage}`;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = recordsFetchedCount < rowsPerPage;
            };

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    applyFiltersAndRender('prev');
                }
            });

            nextPageBtn.addEventListener('click', () => {
                currentPage++;
                applyFiltersAndRender('next');
            });

            // --- Main Application Logic ---
            
            const fetchDashboardData = () => {
                const summaryRef = db.collection("ncf_dashboard_summary").doc("main_stats");

                summaryRef.onSnapshot(doc => {
                    if (doc.exists) {
                        const summaryData = doc.data();
                        updateDashboard(summaryData);
                    } else {
                        console.warn("NCF Summary document (main_stats) does not exist yet.");
                        updateDashboard({});
                    }
                }, error => {
                    console.error("Error fetching NCF dashboard data: ", error);
                });
            };

            const renderTable = (records) => {
                const isAdmin = currentUser && adminEmails.includes(currentUser.email?.toLowerCase());
                tableBody.innerHTML = '';
                if (records.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">No records found.</td></tr>`;
                    return;
                }
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 cursor-pointer';
                    tr.setAttribute('data-id', record.id);
                    const status = record.followUpStatus || 'Pending Response';
                    let statusBadge = '';
                    if (status === 'Pending Response') statusBadge = `<span class="status-badge status-issued">Issued</span>`;
                    else if (status === 'Responded') statusBadge = `<span class="status-badge status-responded">Responded</span>`;
                    else if (status === 'Completed') statusBadge = `<span class="status-badge status-completed">Completed</span>`;
                    
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-indigo-600">${record.ncfNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${record.to.department}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.part1.areaProcess || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 300px;">${record.part1.details}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.documentDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                    <td class="admin-actions-cell px-6 py-4 whitespace-nowrap text-center" style="display: ${isAdmin ? '' : 'none'};">
                        <div class="flex justify-center items-center gap-4">
                            <button onclick="editRecord(event, '${record.id}')" class="text-blue-500 hover:text-blue-700" title="Edit Record">
                                <i class="fas fa-edit fa-lg"></i>
                            </button>

                            <button onclick="deleteRecord(event, '${record.id}')" class="text-red-500 hover:text-red-700" title="Delete Record">
                                <i class="fas fa-trash-alt fa-lg"></i>
                            </button>
                        </div>
                    </td>
                    `;
                    tableBody.appendChild(tr);
                    tr.addEventListener('click', () => {
                        currentRecord = currentFilteredRecords.find(r => r.id === record.id);
                        populateAndShowSidebar(currentRecord, 'progress');
                    });
                });
            };

            const applyFiltersAndRender = async (pageDirection = 'first') => {
                const searchValue = searchInput.value.toLowerCase();
                const deptValue = filterDepartment.value;
                const statusValue = filterStatus.value;
                const startDateValue = exportStartDate.value;
                const endDateValue = exportEndDate.value;

                let query = db.collection("non_conformance_records");

                if (deptValue !== 'all') {
                    query = query.where("departmentCode", "==", deptValue);
                }

                if (statusValue === 'all') {
                    query = query.where("followUpStatus", "in", ["Pending Response", "Responded"]);
                } else if (statusValue === 'Issued') {
                    query = query.where("followUpStatus", "==", "Pending Response");
                } else if (statusValue !== 'all') {
                    query = query.where("followUpStatus", "==", statusValue);
                }

                if (startDateValue) {
                    query = query.where("createdAt", ">=", new Date(startDateValue + "T00:00:00"));
                }
                if (endDateValue) {
                    query = query.where("createdAt", "<=", new Date(endDateValue + "T23:59:59"));
                }

                if (searchValue) {
                    query = query.orderBy("ncfNumber")
                                     .startAt(searchValue.toUpperCase())
                                     .endAt(searchValue.toUpperCase() + '\uf8ff');
                } else {
                    query = query.orderBy("createdAt", "desc");
                }

                try {
                    if (pageDirection === 'prev') {
                        lastVisibleDoc = pageDocHistory[currentPage - 1]; 
                        pageDocHistory.pop();
                    }

                    let pageQuery = query;

                    if (lastVisibleDoc && (pageDirection === 'next' || pageDirection === 'prev')) {
                         pageQuery = pageQuery.startAfter(lastVisibleDoc);
                    }

                    pageQuery = pageQuery.limit(rowsPerPage);

                    const snapshot = await pageQuery.get();
                    const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    if (!snapshot.empty) {
                        lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                        if (pageDirection === 'next') {
                            pageDocHistory.push(lastVisibleDoc);
                        }
                    }

                    currentFilteredRecords = records; 
                    renderTable(records);
                    updatePaginationUI(records.length);

                } catch (error) {
                    console.error("Error fetching paginated records: ", error);
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">Failed to load data. Error: ${error.message}</td></tr>`;
                    isInitialLoad = false;
                } finally {
                    if (isInitialLoad) {
                        exportExcelBtn.disabled = false;
                        exportExcelBtn.innerHTML = `<i class="fas fa-file-excel"></i> Export Excel`;
                        isInitialLoad = false;
                    }
                }
            };

            const updateDashboard = (summaryData) => {
                const monthlyTrendData = {};
                const deptStatusData = {};

                for (const key in summaryData) {
                    const value = summaryData[key];

                    if (key.startsWith('monthlyTrend.')) {
                        const parts = key.split('.');
                        if (parts.length === 3) {
                            const monthId = parts[1];
                            const dept = parts[2];

                            if (!monthlyTrendData[monthId]) {
                                monthlyTrendData[monthId] = {};
                            }
                            monthlyTrendData[monthId][dept] = value;
                        }
                    } else if (key.startsWith('departmentStatus.')) {
                        const parts = key.split('.');
                        if (parts.length === 3) {
                            const dept = parts[1];
                            const status = parts[2];

                            if (!deptStatusData[dept]) {
                                deptStatusData[dept] = {};
                            }
                            deptStatusData[dept][status] = value;
                        }
                    }
                }

                // --- Graph 1: Monthly Trend ---
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
                sixMonthsAgo.setDate(1);
                const monthLabels = [];
                const monthIds = [];
                for (let i = 0; i < 6; i++) {
                    const date = new Date(sixMonthsAgo.getFullYear(), sixMonthsAgo.getMonth() + i, 1);
                    monthLabels.push(date.toLocaleString('en-US', { month: 'short', year: '2-digit' }));
                    monthIds.push(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
                }

                const allDeptsInSummary = new Set([
                    ...Object.values(monthlyTrendData).flatMap(month => Object.keys(month)),
                    ...Object.keys(deptStatusData)
                ]);
                const departments = Array.from(allDeptsInSummary).sort();

                const departmentColors = { 
                    'AUX': 'rgba(239, 68, 68, 1)', 'VIS': 'rgba(59, 130, 246, 1)',
                    'SPG': 'rgba(245, 158, 11, 1)', 'ETP': 'rgba(34, 197, 94, 1)',
                    'ABEC': 'rgba(139, 92, 246, 1)', 'FIBER': 'rgba(236, 72, 153, 1)',
                    'RM': 'rgba(107, 114, 128, 1)'
                };

                const datasets = departments.map(dept => {
                    const data = monthIds.map(monthId => {
                        return monthlyTrendData[monthId]?.[dept] || 0;
                    });

                    return {
                        label: dept,
                        data: data,
                        borderColor: departmentColors[dept] || 'rgba(0,0,0,1)',
                        backgroundColor: (departmentColors[dept] || 'rgba(0,0,0,1)').replace('1)', '0.1)'),
                        fill: true,
                        tension: 0.3
                    };
                });

                if (monthlyTrendChart) monthlyTrendChart.destroy();
                monthlyTrendChart = new Chart(monthlyTrendCtx, {
                    type: 'line',
                    data: { labels: monthLabels, datasets: datasets },
                    options: { plugins: { legend: { position: 'top' } } }
                });

                // --- Graph 2: Department Status ---
                departmentStatusContainer.innerHTML = '';
                Object.keys(departmentCharts).forEach(key => departmentCharts[key].destroy());

                Object.keys(deptStatusData).sort().forEach(dept => {
                    const statusCounts = deptStatusData[dept];
                    const data = {
                        Issued: statusCounts["Pending Response"] || 0,
                        Responded: statusCounts["Responded"] || 0,
                        Completed: statusCounts["Completed"] || 0
                    };

                    const total = data.Issued + data.Responded + data.Completed;
                    if (total === 0) return;

                    const chartWrapper = document.createElement('div');
                    chartWrapper.innerHTML = `<h4 class="font-bold text-gray-800">${dept}</h4><canvas id="chart-${dept}"></canvas><div class="font-semibold text-sm text-gray-600 mt-1">Total: ${total}</div>`;
                    departmentStatusContainer.appendChild(chartWrapper);
                    const ctx = document.getElementById(`chart-${dept}`).getContext('2d');
                    departmentCharts[dept] = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Issued', 'Responded', 'Completed'],
                            datasets: [{
                                data: [data.Issued, data.Responded, data.Completed],
                                backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(34, 197, 94, 0.7)'],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            plugins: {
                                legend: { display: false },
                                tooltip: { callbacks: { label: function(context) { return `${context.label}: ${context.raw} units`; } } },
                                datalabels: {
                                    formatter: (value, ctx) => {
                                        if (value === 0) return '';
                                        let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        let percentage = (value * 100 / sum).toFixed(0) + "%";
                                        return percentage;
                                    },
                                    color: '#fff',
                                    font: { weight: 'bold' }
                                }
                            }
                        }
                    });
                });
            };

            const populateAndShowSidebar = (record, mode = 'progress') => {
                const status = record.followUpStatus || 'Pending Response';
                const isEditMode = (mode === 'edit');

                let contentHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-1">NCF: ${record.ncfNumber}</h2>`;

                if (isEditMode) {
                    contentHTML += `<p class="text-sm text-blue-600 font-semibold mb-6">Mode: Editing Record Data</p>`;
                } else {
                    const issuedAt = (record.createdAt && record.createdAt.toDate) ? record.createdAt.toDate().toLocaleString('th-TH') : 'N/A';
                    contentHTML += `<p class="text-sm text-gray-500 mb-6">Issued on: ${issuedAt}</p>`;
                }

                // --- Part 1 ---
                contentHTML += `<div class="sidebar-section"><h3 class="font-bold text-lg mb-4 text-gray-700">Part 1: Description</h3>`;
                if (isEditMode) {
                    contentHTML += `<form id="editForm" class="space-y-4">
                        <div><label class="sidebar-label">To Department</label><input type="text" id="edit_toDepartment" class="sidebar-input border p-2" value="${record.to.department}"></div>
                        <div><label class="sidebar-label">Area / Process</label><input type="text" id="edit_areaProcess" class="sidebar-input border p-2" value="${record.part1.areaProcess}"></div>
                        <div><label class="sidebar-label">Details</label><textarea id="edit_details" rows="3" class="sidebar-input border p-2">${record.part1.details}</textarea></div>
                        <div><label class="sidebar-label">Issuer</label><input type="text" id="edit_issuer" class="sidebar-input border p-2" value="${record.part1.issuer}"></div>
                        <div><label class="sidebar-label">Issue Date</label><input type="text" id="edit_documentDate" class="sidebar-input border p-2" value="${record.documentDate}"></div>
                    `;
                } else {
                    contentHTML += `<div class="grid grid-cols-2 gap-4">
                        <div><span class="sidebar-label">To Department</span><span class="sidebar-value">${record.to.department}</span></div>
                        <div><span class="sidebar-label">Area / Process</span><span class="sidebar-value">${record.part1.areaProcess}</span></div>
                        <div class="col-span-2"><span class="sidebar-label">Details</span><p class="sidebar-value" style="white-space: pre-wrap;">${record.part1.details}</p></div>
                        <div><span class="sidebar-label">Issuer</span><span class="sidebar-value">${record.part1.issuer}</span></div>
                                <div>
                            <span class="sidebar-label">Finding Date</span>
                            <span class="sidebar-value">${record.documentDate || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="sidebar-label">Finding Time</span>
                            <span class="sidebar-value">${record.findingDateTime ? new Date(record.findingDateTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</span>
                        </div>
                    </div>`;
                }
                contentHTML += `</div>`;

                // --- Part 2 ---
                if (status === 'Pending Response') {
                    if (!isEditMode) {
                        contentHTML += `<div class="sidebar-section"><h3 class="font-bold text-lg mb-4 text-gray-700">Part 2: Response</h3><form id="responseForm" class="space-y-4">
                            <div><label for="containmentAction" class="sidebar-label">Containment Action:</label><textarea id="containmentAction" rows="3" class="sidebar-input border p-2"></textarea></div>
                            <div><label for="rootCause" class="sidebar-label">Root Cause:</label><textarea id="rootCause" rows="3" class="sidebar-input border p-2"></textarea></div>
                            <div><label for="correctiveAction" class="sidebar-label">Corrective Action:</label><textarea id="correctiveAction" rows="3" class="sidebar-input border p-2"></textarea></div>
                            <div><label for="inChargePerson" class="sidebar-label">In-Charge Person:</label><input type="text" id="inChargePerson" class="sidebar-input border p-2"></div>
                            <div><label for="targetDate" class="sidebar-label">Target Date:</label><input type="date" id="targetDate" class="sidebar-input border p-2"></div>
                            <div><label for="responderName" class="sidebar-label">Responder Name:</label><input type="text" id="responderName" class="sidebar-input border p-2"></div>
                            <div><label for="approvalName" class="sidebar-label">Approval Name:</label><input type="text" id="approvalName" class="sidebar-input border p-2"></div>
                        </form></div>`;
                    }
                } else {
                    const part2 = record.part2 || {};
                    contentHTML += `<div class="sidebar-section"><h3 class="font-bold text-lg mb-4 text-gray-700">Part 2: Response</h3>`;
                    if (isEditMode) {
                        contentHTML += `
                            <div><label class="sidebar-label">Containment Action</label><textarea id="edit_containmentAction" rows="3" class="sidebar-input border p-2">${part2.containmentAction || ''}</textarea></div>
                            <div><label class="sidebar-label">Root Cause</label><textarea id="edit_rootCause" rows="3" class="sidebar-input border p-2">${part2.rootCause || ''}</textarea></div>
                            <div><label class="sidebar-label">Corrective Action</label><textarea id="edit_correctiveAction" rows="3" class="sidebar-input border p-2">${part2.correctiveAction || ''}</textarea></div>
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <div><label class="sidebar-label">In-Charge Person</label><input type="text" id="edit_inChargePerson" class="sidebar-input border p-2" value="${part2.inChargePerson || ''}"></div>
                                <div><label class="sidebar-label">Target Date</label><input type="date" id="edit_targetDate" class="sidebar-input border p-2" value="${part2.targetDate || ''}"></div>
                                <div><label class="sidebar-label">Responder Name</label><input type="text" id="edit_responderName" class="sidebar-input border p-2" value="${part2.responder || ''}"></div>
                                <div><label class="sidebar-label">Approval Name</label><input type="text" id="edit_approvalName" class="sidebar-input border p-2" value="${part2.approvalName || ''}"></div>
                            </div>
                        `;
                    } else {
                        const respondedAt = part2.respondedAt ? new Date(part2.respondedAt.toDate()).toLocaleString('th-TH') : 'N/A';
                        contentHTML += `<div class="space-y-4">
                            <div><span class="sidebar-label">Containment Action</span><p class="sidebar-value">${part2.containmentAction || 'N/A'}</p></div>
                            <div><span class="sidebar-label">Root Cause</span><p class="sidebar-value">${part2.rootCause || 'N/A'}</p></div>
                            <div><span class="sidebar-label">Corrective Action</span><p class="sidebar-value">${part2.correctiveAction || 'N/A'}</p></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="sidebar-label">In-Charge Person</span><span class="sidebar-value">${part2.inChargePerson || 'N/A'}</span></div>
                                <div><span class="sidebar-label">Target Date</span><span class="sidebar-value">${part2.targetDate || 'N/A'}</span></div>
                                <div><span class="sidebar-label">Responder Name</span><span class="sidebar-value">${part2.responder || 'N/A'}</span></div>
                                <div><span class="sidebar-label">Approval Name</span><span class="sidebar-value">${part2.approvalName || 'N/A'}</span></div>
                                <div><span class="sidebar-label">Responded At</span><span class="sidebar-value">${respondedAt}</span></div>
                            </div>
                        </div>`;
                    }
                    contentHTML += `</div>`;
                }

                // --- Part 3 ---
                if (status === 'Responded') {
                    if (!isEditMode) {
                        contentHTML += `<div class="sidebar-section"><h3 class="font-bold text-lg mb-4 text-gray-700">Part 3: Follow Up</h3><form id="closeForm" class="space-y-4"><div><span class="sidebar-label">Verification Result:</span><div class="flex gap-4 mt-2"><label><input type="radio" name="followUpResult" value="Satisfaction" required> Satisfaction</label><label><input type="radio" name="followUpResult" value="Unsatisfaction"> Unsatisfaction</label></div></div><div><label for="closingIssuer" class="sidebar-label">Verified By:</label><input type="text" id="closingIssuer" class="sidebar-input border p-2"></div></form></div>`;
                    }
                } else if (status === 'Completed') {
                    const part3 = record.part3 || {};
                    contentHTML += `<div class="sidebar-section"><h3 class="font-bold text-lg mb-4 text-gray-700">Part 3: Follow Up</h3>`;
                    if (isEditMode) {
                        const satChecked = (part3.followUpResult === 'Satisfaction') ? 'checked' : '';
                        const unsatChecked = (part3.followUpResult === 'Unsatisfaction') ? 'checked' : '';
                        contentHTML += `<div class="space-y-4">
                            <div><span class="sidebar-label">Verification Result:</span>
                                <div class="flex gap-4 mt-2">
                                    <label><input type="radio" id="edit_followUpResult_sat" name="edit_followUpResult" value="Satisfaction" ${satChecked}> Satisfaction</label>
                                    <label><input type="radio" id="edit_followUpResult_unsat" name="edit_followUpResult" value="Unsatisfaction" ${unsatChecked}> Unsatisfaction</label>
                                </div>
                            </div>
                            <div><label class="sidebar-label">Verified By:</label><input type="text" id="edit_closingIssuer" class="sidebar-input border p-2" value="${part3.closingIssuerSign || ''}"></div>
                        </div>`;
                    } else {
                        const completedAt = part3.completedAt ? new Date(part3.completedAt.toDate()).toLocaleString('th-TH') : 'N/A';
                        contentHTML += `<div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><span class="sidebar-label">Verification Result</span><p class="sidebar-value">${part3.followUpResult || 'N/A'}</p></div><div><span class="sidebar-label">Verified By</span><p class="sidebar-value">${part3.closingIssuerSign || 'N/A'}</p></div></div><div><span class="sidebar-label">Completed At</span><p class="sidebar-value">${completedAt}</p></div></div>`;
                    }
                    contentHTML += `</div>`;
                }

                if (isEditMode) {
                    contentHTML += `</form>`;
                }

                // --- Action Buttons ---
                contentHTML += `<div id="sidebarActions" class="mt-8 flex items-center gap-2 flex-wrap">`;
                if (isEditMode) {
                    contentHTML += `<button id="saveChangesBtn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Save Changes</button>`;
                } else {
                    if (status === 'Pending Response') {
                        contentHTML += `<button id="submitResponseBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Submit Response</button>`;
                    } else if (status === 'Responded') {
                        contentHTML += `<button id="submitCloseBtn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Mark as Completed & Close</button>`;
                    } else {
                        contentHTML += `<span class="text-green-700 font-bold">This NCF has been closed.</span>`;
                    }
                }
                
                // PDF Export
                const isCompleted = (currentRecord.followUpStatus === 'Completed');
                const disabledAttribute = isCompleted ? '' : 'disabled';
                const disabledClasses = isCompleted ? 'hover:bg-green-700' : 'disabled:opacity-50 disabled:cursor-not-allowed';
                contentHTML += `<button id="exportF4Btn" class="mt-4 w-full bg-green-600 text-white py-2 px-4 rounded ${disabledClasses} flex items-center justify-center" ${disabledAttribute}>`;
                contentHTML += `  <i class="fas fa-file-excel mr-2"></i> Export F4`;
                contentHTML += `</button>`;

                const noteDisplayStyle = isCompleted ? 'style="display: none;"' : '';
                contentHTML += `<p id="f4-export-note" class="text-xs text-center text-gray-500 mt-1" ${noteDisplayStyle}>`;
                contentHTML += `  (Only Status: Completed)`;
                contentHTML += `</p>`;

                contentHTML += `</div>`;

                sidebarContent.innerHTML = contentHTML;
                detailsSidebar.classList.add('open');
            };

            detailsSidebar.addEventListener('click', async (e) => {
                if (e.target.id === 'saveChangesBtn') {
                    const btn = e.target;
                    btn.disabled = true;
                    btn.textContent = 'Saving...';

                    try {
                        const updateData = {};
                        const status = currentRecord.followUpStatus || 'Pending Response';

                        updateData['to.department'] = document.getElementById('edit_toDepartment').value;
                        updateData['part1.areaProcess'] = document.getElementById('edit_areaProcess').value;
                        updateData['part1.details'] = document.getElementById('edit_details').value;
                        updateData['part1.issuer'] = document.getElementById('edit_issuer').value;
                        updateData['documentDate'] = document.getElementById('edit_documentDate').value;

                        if (status === 'Responded' || status === 'Completed') {
                            updateData['part2.containmentAction'] = document.getElementById('edit_containmentAction').value;
                            updateData['part2.rootCause'] = document.getElementById('edit_rootCause').value;
                            updateData['part2.correctiveAction'] = document.getElementById('edit_correctiveAction').value;
                            updateData['part2.inChargePerson'] = document.getElementById('edit_inChargePerson').value;
                            updateData['part2.targetDate'] = document.getElementById('edit_targetDate').value;
                            updateData['part2.responder'] = document.getElementById('edit_responderName').value;
                            updateData['part2.approvalName'] = document.getElementById('edit_approvalName').value;
                        }

                        if (status === 'Completed') {
                            const resultRadio = document.querySelector('input[name="edit_followUpResult"]:checked');
                            updateData['part3.followUpResult'] = resultRadio ? resultRadio.value : '';
                            updateData['part3.closingIssuerSign'] = document.getElementById('edit_closingIssuer').value;
                        }

                        await db.collection("non_conformance_records").doc(currentRecord.id).update(updateData);
                        detailsSidebar.classList.remove('open');
                        resetAndRender(); 

                    } catch (error) {
                        console.error("Error saving changes: ", error);
                        alert("Failed to save changes.");
                        btn.disabled = false;
                        btn.textContent = 'Save Changes';
                    }
                }
                else if (e.target.id === 'exportF4Btn' || e.target.closest('#exportF4Btn')) {
                    const btn = e.target.closest('#exportF4Btn');
                    if (btn.disabled) return;
                    if (!currentRecord || !currentRecord.id) {
                        alert("Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (currentRecord.id)");
                        return;
                    }

                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Generating...`;

                    try {
                        const exportNcfToF4Format = firebase.functions().httpsCallable('exportNcfToF4Format');
                        const result = await exportNcfToF4Format({ docId: currentRecord.id });

                        if (result.data && result.data.fileContents) {
                            const { fileContents, fileName } = result.data;
                            downloadBase64File(
                                fileContents,
                                fileName || "F4_Export.xlsx",
                                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                            );
                        } else {
                            throw new Error("Invalid response from function.");
                        }
                    } catch (error) {
                        console.error("Error exporting F4 Excel:", error);
                        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå F4:\n${error.message}`);
                    } finally {
                        if (currentRecord.followUpStatus === 'Completed') {
                            btn.disabled = false;
                        }
                        btn.innerHTML = `<i class="fas fa-file-excel mr-2"></i> Export F4`;
                    }
                }
                else if (e.target.id === 'submitResponseBtn') {
                    const btn = e.target;
                    btn.disabled = true;
                    btn.textContent = 'Submitting...';
                    try {
                        await db.collection("non_conformance_records").doc(currentRecord.id).update({
                            'part2.containmentAction': document.getElementById('containmentAction').value,
                            'part2.rootCause': document.getElementById('rootCause').value,
                            'part2.correctiveAction': document.getElementById('correctiveAction').value,
                            'part2.inChargePerson': document.getElementById('inChargePerson').value,
                            'part2.targetDate': document.getElementById('targetDate').value,
                            'part2.responder': document.getElementById('responderName').value,
                            'part2.approvalName': document.getElementById('approvalName').value,
                            'part2.respondedAt': firebase.firestore.FieldValue.serverTimestamp(),
                            followUpStatus: 'Responded'
                        });
                        detailsSidebar.classList.remove('open');
                        resetAndRender();
                    } catch (error) {
                        console.error("Error submitting response: ", error);
                        alert("Failed to submit response.");
                        btn.disabled = false;
                        btn.textContent = 'Submit Response';
                    }
                }
                else if (e.target.id === 'submitCloseBtn') {
                    const btn = e.target;
                    btn.disabled = true;
                    btn.textContent = 'Closing...';
                    try {
                        await db.collection("non_conformance_records").doc(currentRecord.id).update({
                            'part3.followUpResult': document.querySelector('input[name="followUpResult"]:checked').value,
                            'part3.closingIssuerSign': document.getElementById('closingIssuer').value,
                            'part3.completedAt': firebase.firestore.FieldValue.serverTimestamp(),
                            followUpStatus: 'Completed'
                        });
                        detailsSidebar.classList.remove('open');
                        resetAndRender();
                    } catch (error) {
                        console.error("Error closing NCF: ", error);
                        alert("Failed to close NCF.");
                        btn.disabled = false;
                        btn.textContent = 'Mark as Completed & Close';
                    }
                }
            });

            window.editRecord = (event, recordId) => {
                event.stopPropagation(); 
                const recordToEdit = currentFilteredRecords.find(r => r.id === recordId);
                if (recordToEdit) {
                    currentRecord = recordToEdit;
                    populateAndShowSidebar(currentRecord, 'edit');
                } else {
                    alert("Error: Could not find record data to edit.");
                }
            };

            window.deleteRecord = (event, recordId) => {
                event.stopPropagation(); 
                if (!confirm(`Are you sure you want to delete this NCF record?\nID: ${recordId}\n\nThis action cannot be undone.`)) return;

                db.collection("non_conformance_records").doc(recordId).delete()
                    .then(() => {
                        alert("Record deleted successfully!");
                        resetAndRender(); 
                    })
                    .catch(error => {
                        console.error("Error deleting record: ", error);
                        alert("Failed to delete record: " + error.message);
                    });
            };

            const resetAndRender = () => {
                currentPage = 1;
                lastVisibleDoc = null;
                pageDocHistory = [null]; 
                applyFiltersAndRender('first'); 
            };

            fetchDashboardData();
            resetAndRender();

            searchInput.addEventListener('input', resetAndRender);
            filterDepartment.addEventListener('change', resetAndRender);
            filterStatus.addEventListener('change', resetAndRender);
            closeSidebarBtn.addEventListener('click', () => detailsSidebar.classList.remove('open'));
            exportStartDate.addEventListener('change', resetAndRender);
            exportEndDate.addEventListener('change', resetAndRender);

            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                filterDepartment.value = 'all';
                filterStatus.value = 'all';
                exportStartDate.value = '';
                exportEndDate.value = '';
                resetAndRender();
            });
            const formatTimestamp = (timestamp) => {
                if (timestamp && typeof timestamp.toDate === 'function') {
                    return timestamp.toDate().toLocaleString('th-TH', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                }
                return '';
            };

            exportExcelBtn.addEventListener('click', async () => {
                const fetchAllFilteredRecordsForExport = async () => {
                    const searchValue = searchInput.value.toLowerCase();
                    const deptValue = filterDepartment.value;
                    const statusValue = filterStatus.value;
                    const startDateValue = exportStartDate.value;
                    const endDateValue = exportEndDate.value;

                    let query = db.collection("non_conformance_records");

                    if (deptValue !== 'all') {
                        query = query.where("departmentCode", "==", deptValue);
                    }
                    if (statusValue !== 'all') {
                        if (statusValue === 'Issued') {
                        query = query.where("followUpStatus", "==", "Pending Response");
                        } else {
                        query = query.where("followUpStatus", "==", statusValue);
                        }
                    }
                    if (startDateValue) {
                        query = query.where("createdAt", ">=", new Date(startDateValue + "T00:00:00"));
                    }
                    if (endDateValue) {
                        query = query.where("createdAt", "<=", new Date(endDateValue + "T23:59:59"));
                    }
                    if (searchValue) {
                        query = query.orderBy("ncfNumber")
                                         .startAt(searchValue.toUpperCase())
                                         .endAt(searchValue.toUpperCase() + '\uf8ff');
                    } else {
                        query = query.orderBy("createdAt", "desc");
                    }

                    const snapshot = await query.get();
                    if (snapshot.empty) {
                        return [];
                    }
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                };

                exportExcelBtn.disabled = true;
                exportExcelBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Preparing...`;

                try {
                    const recordsToExport = await fetchAllFilteredRecordsForExport();

                    if (recordsToExport.length === 0) {
                        alert("No data to export based on the current filters.");
                        return;
                    }

                    const formattedData = recordsToExport.map(record => ({
                        "NCF Number": record.ncfNumber,
                        "Issue Date": record.documentDate,
                        "Finding Time": record.findingDateTime ? new Date(record.findingDateTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '',
                        "Department": record.to?.department || '',
                        "Area Process": record.part1?.areaProcess || '',
                        "Description of Nonconformance": record.part1?.details || '',
                        "Issuer": record.part1?.issuer || '',
                        "Containment Action": record.part2?.containmentAction || '',
                        "Root Cause": record.part2?.rootCause || '',
                        "Corrective Action": record.part2?.correctiveAction || '',
                        "In-Charge Person": record.part2?.inChargePerson || '',
                        "Target Date": record.part2?.targetDate || '',
                        "Responder": record.part2?.responder || '',
                        "Approval": record.part2?.approvalName || '',
                        "Responded Date": formatTimestamp(record.part2?.respondedAt),
                        "Verification Result": record.part3?.followUpResult || '',
                        "Verified By": record.part3?.closingIssuerSign || '',
                        "Completed Date": formatTimestamp(record.part3?.completedAt),
                        "Status": record.followUpStatus || 'Issued'
                    }));

                    const worksheet = XLSX.utils.json_to_sheet(formattedData);
                    worksheet['!cols'] = [
                        { wch: 18 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 25 }, { wch: 50 },
                        { wch: 20 }, { wch: 50 }, { wch: 50 }, { wch: 50 }, { wch: 20 },
                        { wch: 12 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 },
                        { wch: 20 }, { wch: 20 }, { wch: 15 }
                    ];
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "NCF Records");
                    XLSX.writeFile(workbook, "Nonconformance_Report_Detailed.xlsx");

                } catch (error) {
                    console.error("Error exporting Excel: ", error);
                    alert("An error occurred while preparing the export file.");
                } finally {
                    exportExcelBtn.disabled = false;
                    exportExcelBtn.innerHTML = `<i class="fas fa-file-excel"></i> Export Excel`;
                }
            });

            function downloadBase64File(base64Data, fileName, mimeType) {
                const linkSource = `data:${mimeType};base64,${base64Data}`;
                const downloadLink = document.createElement("a");
                downloadLink.href = linkSource;
                downloadLink.download = fileName;
                downloadLink.click();
            }
        });
        </script>

<div id="passwordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-[100]" style="display: none;">
  <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3 text-center">
      <h3 class="text-lg leading-6 font-medium text-gray-900">Enter Password</h3>
      <div class="mt-2 px-7 py-3">
         <label for="passwordInput" class="sr-only">Password</label> <input type="password" id="passwordInput" class="form-input w-full text-center" placeholder="Password">
      </div>
      <div class="items-center px-4 py-3">
        <button id="modalOkBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
          OK
        </button>
        <button id="modalCancelBtn" class="ml-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>
</body>
</html>