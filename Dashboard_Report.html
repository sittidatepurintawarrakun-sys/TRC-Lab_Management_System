<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC Command Center v3.1 - Optimized & Corrected</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .card-header { @apply flex justify-between items-center mb-3 pb-2 border-b border-slate-100; }
        .kpi-value { @apply text-2xl font-bold text-slate-800; }
        .kpi-label { @apply text-xs text-slate-500 uppercase tracking-wider font-semibold; }
        
        /* Skeleton Loading Animation */
        @keyframes pulse-bg {
            0% { background-color: #e2e8f0; }
            50% { background-color: #f1f5f9; }
            100% { background-color: #e2e8f0; }
        }
        .skeleton {
            animation: pulse-bg 1.5s infinite;
            border-radius: 0.5rem;
            width: 100%;
            height: 100%;
        }
        .chart-container { position: relative; width: 100%; height: 256px; }

        /* Chat UI */
        .chat-bubble-ai { background-color: #ffffff; border: 1px solid #e2e8f0; color: #1e293b; border-radius: 12px 12px 12px 0; }
        .chat-bubble-user { background-color: #4f46e5; color: white; border-radius: 12px 12px 0 12px; }
        
        /* Layout Utilities */
        .section-title { font-size: 0.9rem; font-weight: 700; color: #475569; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 text-white p-3 shadow-md z-30 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded flex items-center justify-center font-bold text-xl shadow-lg">
                TRC
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-wide">Summary Dashboard </h1>
                <p class="text-[10px] text-slate-400">Holistic View: Pulp ‚Ä¢ Process ‚Ä¢ Fibre</p>
            </div>
        </div>

        <div class="flex gap-4 bg-slate-800 p-2 rounded-lg items-center border border-slate-700">
            <div class="flex flex-col">
                <label class="text-[10px] text-slate-400 font-bold uppercase">Select Line (MC)</label>
                <select id="mcFilter" class="bg-slate-700 text-white text-sm font-bold border-none outline-none rounded px-2 py-1 w-40 hover:bg-slate-600 transition" onchange="handleMCChange()">
                    <option value="MC2">MC2 (Modal Fibre)</option>
                    <option value="MC3">MC3 (Non-Woven Fibre)</option>
                    <option value="MC5">MC5 (Grey Fibre)</option>
                    <option value="MC6">MC6 (Non-Woven Fibre)</option>
                </select>
            </div>
            
            <div class="h-8 w-px bg-slate-600 mx-2"></div>

            <div class="flex items-center gap-2">
                <input type="date" id="startDate" class="bg-slate-700 text-white text-xs px-2 py-1 rounded outline-none" onchange="clearCache()">
                <span class="text-slate-500">-</span>
                <input type="date" id="endDate" class="bg-slate-700 text-white text-xs px-2 py-1 rounded outline-none" onchange="clearCache()">
            </div>

            <button onclick="updateDashboard(true)" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded text-sm font-bold transition shadow-lg border border-indigo-400 flex items-center gap-2">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-100">
        
        <section>
            <div class="section-title text-orange-700 flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <i class="fas fa-tree"></i>
                    <span>1. Raw Material Input (COA Analysis)</span>
                </div>
            </div>
            <div id="pulpSupplierContainer" class="flex flex-col gap-4">
                <div class="w-full h-24 bg-white rounded-xl border border-slate-200 flex items-center justify-center">
                    <span class="text-slate-400 text-sm">Initializing...</span>
                </div>
            </div>
        </section>

        <section class="flex flex-col">
            <div class="section-title text-blue-700 flex justify-between mb-2">
                <span><i class="fas fa-cogs"></i> 2. Process Control (<span id="lblMcProcess">MC2</span>)</span>
                <span class="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded border">Impacts Quality Directly</span>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-blue-500 w-full">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-sm font-bold text-blue-800 bg-blue-50 rounded px-2 py-1 outline-none border border-blue-100" id="selProc1" onchange="updateSingleChart('Proc', 1)"></select>
                        </div>
                        <div class="chart-container" id="containerProc1"><canvas id="chartProc1"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-sm font-bold text-blue-800 bg-blue-50 rounded px-2 py-1 outline-none border border-blue-100" id="selProc2" onchange="updateSingleChart('Proc', 2)"></select>
                        </div>
                        <div class="chart-container" id="containerProc2"><canvas id="chartProc2"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-sm font-bold text-blue-800 bg-blue-50 rounded px-2 py-1 outline-none border border-blue-100" id="selProc3" onchange="updateSingleChart('Proc', 3)"></select>
                        </div>
                        <div class="chart-container" id="containerProc3"><canvas id="chartProc3"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-sm font-bold text-blue-800 bg-blue-50 rounded px-2 py-1 outline-none border border-blue-100" id="selProc4" onchange="updateSingleChart('Proc', 4)"></select>
                        </div>
                        <div class="chart-container" id="containerProc4"><canvas id="chartProc4"></canvas></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="flex flex-col" id="part3-quality-section">
            <div class="section-title text-emerald-700 flex flex-wrap md:flex-nowrap justify-between items-center mb-4 gap-2">

                <div class="flex items-center gap-2 shrink-0">
                    <i class="fas fa-tags"></i>
                    <span class="whitespace-nowrap">3. Product Quality & Grade (<span id="lblMcProduct">MC2</span>)</span>
                </div>

                <div class="flex-1 flex justify-center w-full md:w-auto order-last md:order-none px-0 md:px-4">
                    <div class="flex items-center gap-2 bg-emerald-50 px-3 py-1 rounded-lg border border-emerald-100 w-full md:max-w-md shadow-sm">
                        <span class="text-[10px] font-bold text-emerald-800 uppercase whitespace-nowrap"><i class="fas fa-filter mr-1"></i>Material:</span>
                        <select id="materialFilter" onchange="handleMaterialChange()" class="w-full bg-white text-xs font-bold text-slate-700 border border-emerald-200 rounded px-2 py-1 outline-none focus:border-emerald-500 transition cursor-pointer truncate">
                            <option value="ALL">All Materials (Mixed)</option>
                        </select>
                        <span id="matLoading" class="text-[10px] text-emerald-500 hidden"><i class="fas fa-circle-notch fa-spin"></i></span>
                    </div>
                </div>

                <span class="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded border whitespace-nowrap shrink-0">Result of Process</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                 <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-emerald-500 relative overflow-hidden group hover:shadow-md transition">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Excellent (E)</p>
                            <h3 class="text-2xl font-bold text-slate-700 mt-1" id="grade-e-pct">--%</h3>
                        </div>
                        <div class="p-1.5 bg-emerald-100 rounded text-emerald-600"><i class="fas fa-medal"></i></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 z-10 relative">Total: <span id="grade-e-ton" class="font-bold text-slate-600">0</span> Bales</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500 relative overflow-hidden group hover:shadow-md transition">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Standard (ST)</p>
                            <h3 class="text-2xl font-bold text-slate-700 mt-1" id="grade-st-pct">--%</h3>
                        </div>
                        <div class="p-1.5 bg-blue-100 rounded text-blue-600"><i class="fas fa-box"></i></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 z-10 relative">Total: <span id="grade-st-ton" class="font-bold text-slate-600">0</span> Bales</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-yellow-500 relative overflow-hidden group hover:shadow-md transition">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Intermediate (I)</p>
                            <h3 class="text-2xl font-bold text-slate-700 mt-1" id="grade-i-pct">--%</h3>
                        </div>
                        <div class="p-1.5 bg-yellow-100 rounded text-yellow-600"><i class="fas fa-exclamation-triangle"></i></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 z-10 relative">Total: <span id="grade-i-ton" class="font-bold text-slate-600">0</span> Bales</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500 relative overflow-hidden group hover:shadow-md transition">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Off Grade (O)</p>
                            <h3 class="text-2xl font-bold text-slate-700 mt-1" id="grade-o-pct">--%</h3>
                        </div>
                        <div class="p-1.5 bg-red-100 rounded text-red-600"><i class="fas fa-times-circle"></i></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 z-10 relative">Total: <span id="grade-o-ton" class="font-bold text-slate-600">0</span> Bales</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-emerald-500 w-full">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition bg-slate-50/50">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-2 py-1 outline-none border border-emerald-100 max-w-[70%]" id="selProd1" onchange="updateSingleChart('Prod', 1)"></select>
                        </div>
                        <div class="chart-container" id="containerProd1"><canvas id="chartProd1"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition bg-slate-50/50">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-2 py-1 outline-none border border-emerald-100 max-w-[70%]" id="selProd2" onchange="updateSingleChart('Prod', 2)"></select>
                        </div>
                        <div class="chart-container" id="containerProd2"><canvas id="chartProd2"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition bg-slate-50/50">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-2 py-1 outline-none border border-emerald-100 max-w-[70%]" id="selProd3" onchange="updateSingleChart('Prod', 3)"></select>
                        </div>
                        <div class="chart-container" id="containerProd3"><canvas id="chartProd3"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition bg-slate-50/50">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-2 py-1 outline-none border border-emerald-100 max-w-[70%]" id="selProd4" onchange="updateSingleChart('Prod', 4)"></select>
                        </div>
                        <div class="chart-container" id="containerProd4"><canvas id="chartProd4"></canvas></div>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="section-title text-indigo-700 mb-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-project-diagram"></i>
                    <span>4. Correlation Analysis & Root Cause Finder (AI)</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetSection4()" class="px-3 py-1.5 bg-slate-200 text-slate-600 text-xs font-bold rounded hover:bg-slate-300 transition">
                        <i class="fas fa-undo"></i> Reset All
                    </button>
                    <button onclick="analyzeRootCauseAI()" class="px-4 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded hover:bg-indigo-700 transition shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> AI Analyze (Combined)
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md border border-indigo-100 p-6 space-y-8">

                <div class="border-b border-slate-100 pb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <div>
                            <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                                <i class="fas fa-chart-line text-blue-500"></i> A. Trend Analysis (Multi-Parameter)
                            </h2>
                            <p class="text-[10px] text-slate-500">Select multiple inputs to see patterns over time.</p>
                        </div>
                        <button onclick="renderTrendChart()" class="px-3 py-1.5 bg-slate-800 text-white text-xs rounded hover:bg-slate-700 transition font-bold">
                            <i class="fa-solid fa-play"></i> Plot Trend
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div class="lg:col-span-3 space-y-4">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <label class="block text-[10px] font-bold text-slate-700 uppercase mb-2">
                                    Process Inputs (Left Axis)
                                </label>
                                <div class="space-y-1 h-32 overflow-y-auto text-xs" id="correlationInputList">
                                    </div>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <label class="block text-[10px] font-bold text-slate-700 uppercase mb-2">
                                    Target (Right Axis)
                                </label>
                                <select id="corrTrendTarget" class="w-full p-1.5 border rounded bg-white text-xs font-bold text-slate-700 outline-none"></select>
                            </div>
                        </div>
                        <div class="lg:col-span-9">
                            <div class="relative h-64 w-full">
                                <canvas id="chartTrend"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <div>
                            <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                                <i class="fas fa-braille text-indigo-500"></i> B. XY Correlation (Scatter Plot)
                            </h2>
                            <p class="text-[10px] text-slate-500">Check relationship strength between two variables.</p>
                        </div>
                        <div class="flex items-center gap-2 bg-slate-50 p-1.5 rounded border border-slate-200">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">X:</span>
                            <select id="corrScatterX" class="text-xs border rounded p-1 outline-none w-32"></select>
                            <span class="text-[10px] font-bold text-slate-500 uppercase">vs Y:</span>
                            <select id="corrScatterY" class="text-xs border rounded p-1 outline-none w-32"></select>
                            <button onclick="renderScatterChart()" class="ml-2 px-3 py-1 bg-indigo-100 text-indigo-700 text-xs rounded hover:bg-indigo-200 font-bold transition">
                                <i class="fas fa-play"></i> Plot Scatter
                            </button>
                        </div>
                    </div>
                    <div class="relative h-64 w-full flex justify-center bg-slate-50/50 rounded-lg border border-dashed border-slate-200">
                        <canvas id="chartScatter"></canvas>
                    </div>
                </div>

                <div id="aiAnalysisResult" class="hidden bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-slate-800 shadow-inner animate-fade-in">
                    <h4 class="font-bold text-indigo-700 mb-2 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-brain"></i> AI Process Advisor Insight:
                    </h4>
                    <div id="aiTextContent" class="text-sm leading-relaxed whitespace-pre-line bg-white p-4 rounded border border-indigo-100 font-sarabun"></div>
                </div>

            </div>
        </section>
    </div>

    <div class="fixed bottom-6 right-6 z-50">
        <div id="chatWindow" class="hidden bg-white w-96 h-[450px] rounded-xl shadow-2xl border border-slate-200 flex flex-col mb-4 overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-700 to-purple-700 p-3 text-white flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-brain"></i> <span class="font-bold text-sm">TRC Pulp&Fibre Expert AI</span>
                </div>
                <button onclick="toggleChat()" class="hover:text-red-200"><i class="fas fa-times"></i></button>
            </div>
            <div id="chatMessages" class="flex-1 bg-slate-50 p-3 overflow-y-auto space-y-3 text-sm">
                <div class="chat-bubble-ai p-3 shadow-sm max-w-[90%]">
                    ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pulp & Fibre ‡∏Ñ‡∏£‡∏±‡∏ö üè≠ <br>
                    ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á <b><span id="aiMcContext">MC2</span></b>
                    <br><br>
                    <i>‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡πà‡∏ô:</i> "‡∏ó‡∏≥‡πÑ‡∏° Tenacity ‡∏Ç‡∏≠‡∏á MC2 ‡∏ñ‡∏∂‡∏á‡∏ï‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤?"
                </div>
            </div>
            <div class="p-2 border-t flex gap-2 bg-white">
                <input type="text" id="chatInput" class="flex-1 bg-slate-100 rounded-full px-3 py-1.5 text-sm outline-none border focus:border-indigo-500" placeholder="Ask AI..." onkeypress="handleEnter(event)">
                <button onclick="sendChatMessage()" class="bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-indigo-700"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        <button onclick="toggleChat()" class="bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl transition transform hover:scale-110">
            <i class="fas fa-comment-dots"></i>
        </button>
    </div>

    <script>
        // =========================================================
        // 1. FIREBASE & CONFIG
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
            authDomain: "lab-trc-management-system.firebaseapp.com",
            projectId: "lab-trc-management-system",
            storageBucket: "lab-trc-management-system.appspot.com",
            messagingSenderId: "43919979160",
            appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.settings({ experimentalForceLongPolling: true });
        const functions = firebase.app().functions('asia-southeast1');

        // CACHE SYSTEM (Optimization)
        let REQUEST_CACHE = {};
        function clearCache() { 
            REQUEST_CACHE = {}; 
            console.log("Cache cleared");
        }
        
        // --- METADATA CONFIG ---
        const PULP_PARAM_MAP = {
            alpha: { dbKey: "alphaCellulose", label: "Alpha Cellulose", unit: "%", type: 'quality' },
            viscosity: { dbKey: "viscosity", label: "Viscosity (ISO)", unit: "ml/g", type: 'quality' },
            whiteness: { dbKey: "whiteness", label: "Berger Whiteness", unit: "%", type: 'quality' },
            silica: { dbKey: "silica", label: "Acid Insoluble (SiO2)", unit: "ppm", type: 'impurity' },
            calcium: { dbKey: "calcium", label: "Calcium (Ca)", unit: "ppm", type: 'impurity' }
        };
        const MC_SUPPLIER_RULES = {
            "MC2": ["AV NACKAWIC"],
            "MC3": ["ARAUCO", "AV CELL", "PHOENIX"],
            "MC5": ["ARAUCO", "AV CELL", "PHOENIX"],
            "MC6": ["ARAUCO", "AV CELL", "PHOENIX"]
        };
        // Collection Mappings for DAILY data (aggregated)
        const DEPT_COLLECTION_MAP = {
            "Viscose": "stats_Viscose",
            "Auxiliary": "stats_Auxiliary",
            "Spinning": "stats_Spinning"
        };
        const MC_COLLECTION_MAP = {
            "MC2": "Modal",
            "MC5": "Grey",
            "MC3": "NonWoven",
            "MC6": "NonWoven"
        };
        
        const MACHINE_PROCESS_CONFIG = {
            "MC2": {
                viscose: [
                    "Steep Lye Alkali %", "Steep Lye Temp.", "MD E Exit End Total Alk.", "MD E Exit End Cell.",
                    "MCL Conc. gpl%", "MCL Temp.", "Diss. Modal Vis BF", "Buffer Tank 5 Vis Temp",
                    "Buffer Tank 6 Vis Temp", "Buffer Tank 7 Vis Temp", "Modal Rec14 BF",
                    "Spinning Viscose Ball Fall", "Spinning Viscose Gamma no", "Spinning Viscose Alkali %",
                    "Spinning Viscose Cellulose %", "MD 2 Vis Kw", "Flash Delta 6", "Flash Delta 7", "Vis Temp"
                ],
                auxiliary: [
                    "MD 2 Spin bath Na2SO4", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."
                ],
                spinning: [
                    "Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.",
                    "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC2",
                    "HSB Temp", "HSB Acid", "HSB Zn", "HSB Salt"
                ]
            },
            "MC3": {
                viscose: [
                    "Steep Lye Alkali %", "Steep Lye Temp.", "MD C Exit End Total Alk.", "MD C Exit End Cell.",
                    "MD D Exit End Total Alk.", "MD D Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.",
                    "Buffer Tank 1 Vis Temp", "Buffer Tank 2 Vis Temp", "Buffer Tank 3 Vis Temp",
                    "Buffer Tank 4 Vis Temp", "Rec Ball Fall", "Rec 1 KW", "Spinning Viscose Ball Fall",
                    "Machine Viscose RI", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %",
                    "Spinning Viscose KW", "Vis Temp", "Flash Delta 2", "Flash Delta 4", "Flash Delta 5"
                ],
                auxiliary: [
                    "MC 3 Spin bath Sp. Gr.", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."
                ],
                spinning: [
                    "Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.",
                    "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC3"
                ]
            },
            "MC5": {
                viscose: [
                    "Steep Lye Alkali %", "Steep Lye Temp.", "MD F Alkali %", "MD F Cellulose %",
                    "MD G Exit End Total Alk.", "MD G Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.",
                    "Churn Blender 1 Vis Temp", "Churn Blender 2 Vis Temp", "Spinning Viscose Ball Fall",
                    "Machine Viscose RI", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %",
                    "Spinning Viscose KW", "Rec Ball Fall", "REC. TK. N3 CKW", "Flash Delta 8", "Flash Delta 9", "Vis Temp"
                ],
                auxiliary: [
                    "MC 5 Spin bath Sp. Gr.", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."
                ],
                spinning: [
                    "Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.",
                    "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC5"
                ]
            },
            "MC6": {
                viscose: [
                    "Steep Lye Alkali %", "Steep Lye Temp.", "MD C Exit End Total Alk.", "MD C Exit End Cell.",
                    "MD D Exit End Total Alk.", "MD D Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.",
                    "Buffer Tank 1 Vis Temp", "Buffer Tank 2 Vis Temp", "Buffer Tank 3 Vis Temp",
                    "Buffer Tank 4 Vis Temp", "Rec 1 KW", "Rec Ball Fall", "Spinning Viscose Ball Fall",
                    "Machine Viscose RI", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %",
                    "Vis Temp", "Flash Delta 2", "Flash Delta 4", "Flash Delta 5", "Spinning Viscose KW"
                ],
                auxiliary: [
                    "MC 6 Spin bath Sp. Gr.", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."
                ],
                spinning: [
                    "Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.",
                    "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC6"
                ]
            }
        };
        
        // [UPDATED] Corrected Default Values
        const PROCESS_DEFAULTS = {
            "MC2": ["Spinning Viscose Ball Fall", "Spinning Viscose Gamma no", "Spin Bath ZnSO4 gpl", "Spin Bath Acid gpl"],
            "MC5": ["Spinning Viscose Ball Fall", "Machine Viscose RI", "Spin Bath Acid gpl", "MC 5 Spin bath Sp. Gr."],
            "MC3": ["Spinning Viscose Ball Fall", "Spinning Viscose Alkali %", "Spin Bath Acid gpl", "Bleach Bath Conc. gpl"],
            "MC6": ["Spinning Viscose Ball Fall", "Spinning Viscose Alkali %", "Spin Bath Acid gpl", "Bleach Bath Conc. gpl"]
        };

        // [UPDATED] Expanded Common Options to include Black Particle
        const PRODUCT_RAW_LISTS = {
            "Modal": [
                "Brightness", "Whiteness", "Yellow Index", "Wet Lump", "Den Quick", "OPU",
                "Final Squeeze Roler Moisture", "L %", "B %", "BL %", "Dyeability dL", "Dyeability dE",
                "Denier Cond", "Denier Cond CV", "Denier SD", "Tenacity Cond.", "Tenacity Cond. CV",
                "Tenacity Cond SD", "Young Modulus @ 1%", "Tenacity Cond. At 5%", "Tenacity Cond. At 10%",
                "Elongation Cond", "Elongation Cond CV", "Elongation Cond SD", "Wet Denier", "Wet Denier CV",
                "Tenacity Wet", "Tenacity Wet CV", "Elongation Wet", "Elongation Wet CV", "Tenacity Wet Modulus",
                "Shirley Fault Big", "Shirley Fault Small", "Shirley Fault Spack", "Shirley Fault Weight",
                "Neps", "PH(Chemical)", "Brightbleached", "Alkalinity", "Sulphur", "Quick Diag Eff Length",
                "Forte Moisture", "Good Cross Section %", "FW:Big Fault", "FW:Fused Fiber", "FW:Specks",
                "FW:Total Nos", "FW:Total Wt(mg)"
            ],
            "NW": [
                "Brightness", "Whiteness", "Yellow Index", "Wet Lump", "Den Quick", "OPU",
                "Final Squeeze Roler Moisture", "Big", "Small", "Speck", "Stuck up", "L %", "B %", "BL %",
                "Dyeability dL", "Dyeability dE", "Denier Cond", "Denier Cond CV", "Denier SD",
                "Tenacity Cond.", "Tenacity Cond. CV", "Tenacity Cond SD", "Young Modulus @ 1%",
                "Tenacity Cond. At 5%", "Tenacity Cond. At 10%", "Elongation Cond", "Elongation Cond CV",
                "Elongation Cond SD", "Wet Denier", "Wet Denier CV", "Tenacity Wet", "Tenacity Wet CV",
                "Elongation Wet", "Elongation Wet CV", "Shirley Fault Big", "Shirley Fault Small",
                "Shirley Fault Spack", "Shirley Fault Weight", "Neps", "PH(Chemical)", "Alkalinity", "Sulphur",
                "Quick Diag Eff Length", "Forte Moisture", "% Ash (Semi Dull)", "% Ash (Full Dull)",
                "NW Black Particle(</=1 mm)", "NW Black Particle(>1mm)", "FW:Big Fault", "FW:Fused Fiber",
                "FW:Specks", "FW:Total Nos", "FW:Total Wt(mg)", "NW Fibre Crimp", "NW Fibre Sulphate Ash",
                "NW Fibre Water Soluble Sub", "NW Fibre Ether Soluble Sub", "NW Fibre Water Holding Cap",
                "Sinking Time(NW Fibre)", "Fiber Foam Test(NW Fibre)"
            ],
            "Grey": [
                "Brightness", "Whiteness", "Yellow Index", "Wet Lump", "Den Quick", "OPU",
                "Final Squeeze Roler Moisture", "Big", "Small", "Speck", "Stuck up", "L %", "B %", "BL %",
                "Dyeability dL", "Dyeability dE", "Denier Cond", "Denier Cond CV", "Denier SD",
                "Tenacity Cond.", "Tenacity Cond. CV", "Tenacity Cond SD", "Young Modulus @ 1%",
                "Tenacity Cond. At 5%", "Tenacity Cond. At 10%", "Elongation Cond", "Elongation Cond CV",
                "Elongation Cond SD", "Wet Denier", "Wet Denier CV", "Tenacity Wet", "Tenacity Wet CV",
                "Elongation Wet", "Elongation Wet CV", "Shirley Fault Big", "Shirley Fault Small",
                "Shirley Fault Spack", "Shirley Fault Weight", "Neps", "PH(Chemical)", "Brightbleached",
                "Alkalinity", "Sulphur", "Quick Diag Eff Length", "Forte Moisture", "FW:Big Fault",
                "FW:Fused Fiber", "FW:Specks", "FW:Total Nos", "FW:Total Wt(mg)"
            ]
        };

        // ‡∏£‡∏ß‡∏° NW ‡πÅ‡∏•‡∏∞ Grey ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô (‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≥) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Hybrid (MC3, 5, 6)
        // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ COMMON_NW_OPTS ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤
        const HYBRID_NW_GREY_OPTS = [...new Set([...PRODUCT_RAW_LISTS.NW, ...PRODUCT_RAW_LISTS.Grey])];

        const PRODUCT_PARAM_CONFIG = {
            "MC2": PRODUCT_RAW_LISTS.Modal,
            "MC3": HYBRID_NW_GREY_OPTS, // Hybrid (NW + Grey)
            "MC5": HYBRID_NW_GREY_OPTS, // Hybrid (NW + Grey)
            "MC6": HYBRID_NW_GREY_OPTS  // Hybrid (NW + Grey)
        };

        // [UPDATED] Corrected Default Values (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)
        const PRODUCT_DEFAULTS = {
            "MC2": ["Tenacity Cond.", "Elongation Cond", "FW:Total Nos", "Good Cross Section %"],
            "MC3": ["Whiteness", "FW:Total Nos", "NW Black Particle(</=1 mm)", "NW Black Particle(>1mm)"],
            "MC5": ["Whiteness", "Tenacity Cond.", "Elongation Cond", "FW:Total Nos"],
            "MC6": ["Whiteness", "FW:Total Nos", "NW Black Particle(</=1 mm)", "NW Black Particle(>1mm)"]
        };

        let chartInstances = {};

        // =========================================================
        // 2. UI INITIALIZATION
        // =========================================================
        window.onload = function() {
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Helper to get local date string YYYY-MM-DD
            const toLocalISOString = (date) => {
                const offset = date.getTimezoneOffset();
                const localDate = new Date(date.getTime() - (offset*60*1000));
                return localDate.toISOString().split('T')[0];
            };

            document.getElementById('startDate').value = toLocalISOString(startOfMonth);
            document.getElementById('endDate').value = toLocalISOString(today);

            injectGranularityControls();
            handleMCChange();
        };

        function handleMCChange() {
            clearCache(); // New MC means new data
            updateDropdownOptions();
            updateDashboard(true);
        }

        function injectGranularityControls() {
            const headerFilterDiv = document.querySelector('.bg-slate-800');
            if (!headerFilterDiv) return;

            // ‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏î‡∏£‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
            const oldContainer = document.getElementById('viewModeContainer');
            if(oldContainer) oldContainer.remove();

            const container = document.createElement('div');
            container.id = "viewModeContainer"; // ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡πà‡∏≤‡∏¢
            container.className = "flex flex-col ml-4 mr-4";

            container.innerHTML = `
                <label class="text-[10px] text-slate-400 font-bold uppercase mb-1">View Mode</label>
                <div class="flex bg-slate-700 rounded p-0.5">
                    <label class="cursor-pointer">
                        <input type="radio" name="granularity" value="hourly" class="hidden peer">
                        <span class="text-xs font-bold px-3 py-1 rounded text-slate-400 peer-checked:bg-indigo-500 peer-checked:text-white transition block">Hourly</span>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="granularity" value="daily" class="hidden peer" checked>
                        <span class="text-xs font-bold px-3 py-1 rounded text-slate-400 peer-checked:bg-indigo-500 peer-checked:text-white transition block">Daily</span>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="granularity" value="monthly" class="hidden peer">
                        <span class="text-xs font-bold px-3 py-1 rounded text-slate-400 peer-checked:bg-indigo-500 peer-checked:text-white transition block">Monthly</span>
                    </label>
                </div>
            `;

            // Add Event Listeners
            const radios = container.querySelectorAll('input[name="granularity"]');
            radios.forEach(r => r.addEventListener('change', () => {
                clearCache(); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î = ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Cache

                // --- LOGIC ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ---
                if(r.value === 'hourly') {
                    const startDateInput = document.getElementById('startDate');
                    const endDateInput = document.getElementById('endDate');

                    if(startDateInput.value && endDateInput.value) {
                        const s = new Date(startDateInput.value);
                        const e = new Date(endDateInput.value);
                        const diffTime = Math.abs(e - s);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏°? ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏î ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
                        if(diffDays > 7) {
                            const newStart = new Date(e);
                            newStart.setDate(e.getDate() - 7); // ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 7 ‡∏ß‡∏±‡∏ô (‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° 3)

                            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô Timezone
                            const offset = newStart.getTimezoneOffset();
                            const localDate = new Date(newStart.getTime() - (offset*60*1000));
                            startDateInput.value = localDate.toISOString().split('T')[0];

                            alert("Hourly View: ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
                        }
                    }
                }
                updateDashboard(true);
            }));

            const dateInput = document.getElementById('startDate');
            if (dateInput && dateInput.parentElement) {
                headerFilterDiv.insertBefore(container, dateInput.parentElement.previousElementSibling);
            }
        }

        function getGranularity() {
            const radios = document.getElementsByName('granularity');
            for (let r of radios) if (r.checked) return r.value;
            return 'daily';
        }

        function updateDropdownOptions() {
            const mc = document.getElementById('mcFilter').value;
            const procConfig = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            const procDefaults = PROCESS_DEFAULTS[mc];
            const allProcessParams = [...(procConfig.viscose||[]), ...(procConfig.auxiliary||[]), ...(procConfig.spinning||[])];

            // Update Process Dropdowns
            for(let i=1; i<=4; i++) {
                const el = document.getElementById(`selProc${i}`);
                if(el) {
                    el.innerHTML = '';
                    allProcessParams.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item; opt.text = item;
                        el.appendChild(opt);
                    });
                    if(procDefaults && procDefaults[i-1] && allProcessParams.includes(procDefaults[i-1])) {
                        el.value = procDefaults[i-1];
                    }
                }
            }

            // Update Product Dropdowns
            const prodParams = PRODUCT_PARAM_CONFIG[mc] || PRODUCT_PARAM_CONFIG["MC2"];
            const prodDefaults = PRODUCT_DEFAULTS[mc] || prodParams.slice(0, 4);
            for(let i=1; i<=4; i++) {
                const el = document.getElementById(`selProd${i}`);
                if(el) {
                    el.innerHTML = '';
                    prodParams.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item; opt.text = item;
                        el.appendChild(opt);
                    });
                    // Force select default if exists in list
                    if(prodDefaults[i-1] && prodParams.includes(prodDefaults[i-1])) {
                        el.value = prodDefaults[i-1];
                    }
                }
            }
            
            // Update Correlation
            fillSelect('corrY1', allProcessParams);
            fillSelect('corrY2', prodParams);
        }

        function fillSelect(id, items) {
            const el = document.getElementById(id);
            if(el) {
                el.innerHTML = '';
                items.forEach(i => { const o = document.createElement('option'); o.value=i; o.text=i; el.appendChild(o); });
            }
        }
        // [START ADD]: Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Material Filter
        function handleMaterialChange() {
            clearCache(); // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Cache ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
            // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô Product (Part 3) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
            const mc = document.getElementById('mcFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const mode = getGranularity();

            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Loading ‡πÄ‡∏•‡πá‡∏Å‡πÜ
            const loader = document.getElementById('matLoading');
            if(loader) loader.classList.remove('hidden');

            renderProductCharts(mc, start, end, mode).then(() => {
                if(loader) loader.classList.add('hidden');
            });
        }

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Material ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô dropdown ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        let FOUND_MATERIALS = new Set();
        // [END ADD]

        // =========================================================
        // 3. MAIN UPDATE LOGIC (PARALLEL & OPTIMIZED)
        // =========================================================
        async function updateDashboard(manual = false) {
            if(manual) clearCache();

            const mc = document.getElementById('mcFilter').value;
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            const btn = document.querySelector('button[onclick="updateDashboard(true)"]');
            const mode = getGranularity();

            // --- GUARD: DATE RANGE LIMITS ---
            const d1 = new Date(startStr);
            const d2 = new Date(endStr);
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Hourly: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà 7 ‡∏ß‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î)
            if (mode === 'hourly' && diffDays > 7) {
                alert("‚ö†Ô∏è Performance: ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (Hourly) ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 7 ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö \n(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å)");
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü
            }

            // Daily: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà 180 ‡∏ß‡∏±‡∏ô (6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
            if (mode === 'daily' && diffDays > 180) {
                alert("‚ö†Ô∏è Performance: ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily) ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 180 ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            // ... (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
            if(btn) { btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...'; btn.disabled = true; }
            document.getElementById('lblMcProcess').innerText = `${mc} (${mode.toUpperCase()})`;
            document.getElementById('lblMcProduct').innerText = `${mc} (${mode.toUpperCase()})`;
            document.getElementById('aiMcContext').innerText = mc;

            try {
                await Promise.all([
                    renderPulpSection(mc),
                    renderProcessCharts(mc, startStr, endStr, mode),
                    renderProductCharts(mc, startStr, endStr, mode),
                    renderCorrelation(mc, startStr, endStr, mode)
                ]);
            } catch (e) {
                console.error("Dashboard update error:", e);
            } finally {
                if(btn) { btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh'; btn.disabled = false; }
            }
        }

        // =========================================================
        // 4. DATA FETCHERS (OPTIMIZED WITH CACHE & AGGREGATION)
        // =========================================================
        
        async function getCachedData(key, fetcher) {
            if (REQUEST_CACHE[key]) return REQUEST_CACHE[key];
            const data = await fetcher();
            REQUEST_CACHE[key] = data;
            return data;
        }

        // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á Array ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Master Timeline)
        function generateDateLabels(startStr, endStr, mode) {
            const labels = [];
            const current = new Date(startStr);
            const end = new Date(endStr);

            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 00:00:00 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
            current.setHours(0,0,0,0);
            end.setHours(0,0,0,0);

            while (current <= end) {
                if (mode === 'daily') {
                    // Format YYYY-MM-DD
                    const y = current.getFullYear();
                    const m = String(current.getMonth() + 1).padStart(2, '0');
                    const d = String(current.getDate()).padStart(2, '0');
                    labels.push(`${y}-${m}-${d}`);
                    current.setDate(current.getDate() + 1);
                } else if (mode === 'hourly') {
                     // Format YYYY-MM-DD HH:00
                    const y = current.getFullYear();
                    const m = String(current.getMonth() + 1).padStart(2, '0');
                    const d = String(current.getDate()).padStart(2, '0');
                    for(let h=0; h<24; h++) {
                         labels.push(`${y}-${m}-${d} ${String(h).padStart(2,'0')}:00`);
                    }
                    current.setDate(current.getDate() + 1);
                } else {
                     // Monthly handled separately
                     break;
                }
            }
            return labels;
        }

        // CENTRAL FETCH ROUTER
        async function fetchProcessDataByType(mc, paramName, start, end, mode) {
            const cacheKey = `proc_${mc}_${paramName}_${start}_${end}_${mode}`;
            return await getCachedData(cacheKey, async () => {
                if (mode === 'monthly') return await fetchMonthlyProcessStats(mc, paramName, start, end);
                if (mode === 'daily') return await fetchDailyProcessLogs(mc, paramName, start, end);
                return await fetchHourlyProcessLogs(mc, paramName, start, end);
            });
        }
        async function fetchProductDataByType(mc, paramName, start, end, mode) {
            const cacheKey = `prod_${mc}_${paramName}_${start}_${end}_${mode}`;
            return await getCachedData(cacheKey, async () => {
                if (mode === 'monthly') return await fetchMonthlyProductStats(mc, paramName, start, end);
                if (mode === 'daily') return await fetchDailyProductLogs(mc, paramName, start, end);
                return await fetchHourlyProductLogs(mc, paramName, start, end);
            });
        }

        // --- 1. DAILY FETCHERS (FIXED) ---
        async function fetchDailyProcessLogs(mc, paramName, start, end) {
            const config = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            let category = "Viscose";
            if ((config.auxiliary||[]).includes(paramName)) category = "Auxiliary";
            else if ((config.spinning||[]).includes(paramName)) category = "Spinning";

            const collectionName = DEPT_COLLECTION_MAP[category] || "stats_Viscose";

            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Timeline ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
            const masterLabels = generateDateLabels(start, end, 'daily');
            const dataMap = new Map(); // ‡πÉ‡∏ä‡πâ Map ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß

            try {
                const snapshot = await db.collection(collectionName)
                    .where('machineId', '==', mc)
                    .where('date', '>=', start)
                    .where('date', '<=', end)
                    .get(); // ‡∏ï‡∏±‡∏î orderBy ‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠ performance ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤ match ‡πÉ‡∏ô map ‡πÅ‡∏ó‡∏ô

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(d.stats && d.stats[paramName]) {
                        const s = d.stats[paramName];
                        let avg = s.avg !== undefined ? s.avg : (s.count > 0 ? s.sum/s.count : 0);
                        if(avg !== 0) {
                            dataMap.set(d.date, avg);
                        }
                    }
                });
            } catch(e) { console.warn(`Fetch Daily Process Error`, e); }

            // 2. Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Timeline (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏™‡πà null)
            const finalData = masterLabels.map(dateLabel => {
                return dataMap.has(dateLabel) ? dataMap.get(dateLabel) : null;
            });

            const stats = calculateStats(finalData.filter(v => v !== null)); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Stats ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
            return { labels: masterLabels, data: finalData, avg: stats.avg, cv: stats.cv };
        }

        async function fetchDailyProductLogs(mc, paramName, start, end) {
            const productType = MC_COLLECTION_MAP[mc] || "Modal";
            const selectedMat = document.getElementById('materialFilter') ? document.getElementById('materialFilter').value : "ALL";
            const masterLabels = generateDateLabels(start, end, 'daily');
            const dataMap = new Map();

            // Reset Material List ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏•‡∏±‡∏Å
            if(paramName === document.getElementById('selProd1').value) FOUND_MATERIALS.clear();

            try {
                // Fetch Stats (Daily)
                const snapshot = await db.collection(`stats_Product_${productType}`)
                    .where('machineId', '==', mc)
                    .where('date', '>=', start)
                    .where('date', '<=', end)
                    .get();

                const datesNeedRaw = []; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏î‡∏∂‡∏á Raw (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ 2025 ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Filter Material)

                snapshot.forEach(doc => {
                    const d = doc.data();

                    // 1. ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Material ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà Dropdown
                    if (d.materials_breakdown) {
                        Object.keys(d.materials_breakdown).forEach(m => FOUND_MATERIALS.add(m));
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ breakdown ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ 2025 -> ‡πÄ‡∏£‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ Material ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        // ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÑ‡∏õ‡∏î‡∏∂‡∏á Raw (‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏£‡∏µ‡∏ö)
                        if (selectedMat !== "ALL") datesNeedRaw.push(d.date);
                    }

                    // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Value
                    let val = null;

                    // Case A: ALL Materials
                    if (selectedMat === "ALL") {
                        if (d.stats && d.stats[paramName]) {
                            val = d.stats[paramName].avg;
                        }
                    }
                    // Case B: Filtered Material (Hybrid)
                    else {
                        if (d.materials_breakdown && d.materials_breakdown[selectedMat]) {
                            // ‡∏õ‡∏µ 2026+: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Breakdown ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å!
                            if (d.materials_breakdown[selectedMat][paramName]) {
                                val = d.materials_breakdown[selectedMat][paramName].avg;
                            }
                        } else {
                            // ‡∏õ‡∏µ 2025: ‡πÑ‡∏°‡πà‡∏°‡∏µ Breakdown -> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏î‡∏∂‡∏á Raw
                            datesNeedRaw.push(d.date);
                        }
                    }

                    if (val !== null) dataMap.set(d.date, val);
                });

                // 3. Fallback: Fetch Raw Logs ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                // (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÅ‡∏•‡∏∞ user ‡∏î‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å filter material)
                if (datesNeedRaw.length > 0) {
                    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û: ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô user ‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏î
                    // ‡πÉ‡∏ä‡πâ query ‡πÅ‡∏ö‡∏ö range ‡∏ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ where 'in' ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏≠‡∏∞
                    // ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢: ‡∏î‡∏∂‡∏á‡∏ä‡πà‡∏ß‡∏á start-end ‡∏Ç‡∏≠‡∏á Raw logs ‡πÄ‡∏•‡∏¢ (‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡∏ä‡∏±‡∏ß‡∏£‡πå)
                    const rawSnap = await db.collection('product_raw_logs')
                        .where('machineId', '==', mc)
                        .where('date', '>=', start) // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞ optimize ‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á‡∏ï‡∏≤‡∏° datesNeedRaw ‡πÑ‡∏î‡πâ
                        .where('date', '<=', end)
                        .get();

                    rawSnap.forEach(doc => {
                        const d = doc.data();
                        if (!datesNeedRaw.includes(d.date)) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Stats ‡πÅ‡∏•‡πâ‡∏ß

                        const pData = d.data[productType] || d.data["Modal"];
                        if (!pData) return;

                        // Harvest Materials for Dropdown (Old Data)
                        const matKey = Object.keys(pData).find(k => k.toLowerCase().includes("material"));
                        if (matKey && pData[matKey]) {
                            pData[matKey].forEach(m => { if(m) FOUND_MATERIALS.add(String(m)); });
                        }

                        // Calculate Value from Raw
                        if (selectedMat !== "ALL") {
                            // Filter Logic
                            let targetKey = paramName;
                            if (!pData[targetKey]) {
                                 // Find approximate key match
                                 const cleanParam = paramName.toLowerCase().replace(/[^a-z0-9]/g, "");
                                 const foundKey = Object.keys(pData).find(k => k.toLowerCase().replace(/[^a-z0-9]/g, "") === cleanParam);
                                 if (foundKey) targetKey = foundKey;
                            }

                            if (pData[targetKey] && matKey && pData[matKey]) {
                                const vals = pData[targetKey];
                                const mats = pData[matKey];
                                let sum = 0, count = 0;
                                for(let i=0; i<vals.length; i++) {
                                    if(String(mats[i]) === selectedMat && vals[i] !== null && vals[i] !== "") {
                                        sum += Number(vals[i]);
                                        count++;
                                    }
                                }
                                if (count > 0) dataMap.set(d.date, sum/count);
                            }
                        }
                    });
                }

            } catch (e) { console.warn("Hybrid Product Chart Error", e); }

            if(paramName === document.getElementById('selProd1').value) updateMaterialDropdownUI();

            const finalData = masterLabels.map(dateLabel => dataMap.has(dateLabel) ? dataMap.get(dateLabel) : null);
            const stats = calculateStats(finalData.filter(v => v !== null));
            return { labels: masterLabels, data: finalData, avg: stats.avg };
        }

        // --- 2. MONTHLY FETCHERS (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Å‡πá‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ) ---
        // (‡∏Ç‡∏≠‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Code ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠ Daily)
        async function fetchMonthlyProcessStats(mc, paramName, start, end) {
             // ... (‡πÉ‡∏ä‡πâ Code ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö) ...
            const config = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            let category = "Viscose";
            if ((config.auxiliary||[]).includes(paramName)) category = "Auxiliary";
            else if ((config.spinning||[]).includes(paramName)) category = "Spinning";
            const collectionName = `${DEPT_COLLECTION_MAP[category]}_Monthly`;
            const labels = [], dataPoints = [];
            let weightedCV = 0;
            try {
                const startM = start.substring(0,7); const endM = end.substring(0,7);
                const snapshot = await db.collection(collectionName)
                    .where('machineId', '==', mc)
                    .where('month', '>=', startM)
                    .where('month', '<=', endM)
                    .orderBy('month', 'asc').get();
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(d.stats && d.stats[paramName]) {
                        const s = d.stats[paramName];
                        let avg = s.avg !== undefined ? s.avg : (s.count > 0 ? s.sum/s.count : 0);
                        labels.push(d.month);
                        dataPoints.push(avg);
                        if(s.sumSq && s.count > 0) {
                            const variance = (s.sumSq/s.count) - (avg*avg);
                            const sd = Math.sqrt(Math.max(0, variance));
                            const cv = avg !== 0 ? (sd/avg)*100 : 0;
                            weightedCV = cv;
                        }
                    }
                });
            } catch(e) { console.warn("Monthly Process Error", e); }
            return { labels, data: dataPoints, cv: weightedCV };
        }

        async function fetchMonthlyProductStats(mc, paramName, start, end) {
            // ... (‡πÉ‡∏ä‡πâ Code ‡πÄ‡∏î‡∏¥‡∏°) ...
            const productType = MC_COLLECTION_MAP[mc] || "Modal";
            const collectionName = `stats_Product_${productType}_Monthly`;
            const labels = [], dataPoints = [];
            try {
                const startM = start.substring(0,7); const endM = end.substring(0,7);
                const snapshot = await db.collection(collectionName)
                    .where('machineId', '==', mc)
                    .where('month', '>=', startM)
                    .where('month', '<=', endM)
                    .orderBy('month', 'asc').get();
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(d.stats && d.stats[paramName]) {
                        const s = d.stats[paramName];
                        let avg = s.avg !== undefined ? s.avg : (s.count > 0 ? s.sum/s.count : 0);
                        labels.push(d.month);
                        dataPoints.push(avg);
                    }
                });
            } catch(e) { console.warn("Monthly Product Error", e); }
            const stats = calculateStats(dataPoints);
            return { labels, data: dataPoints, avg: stats.avg };
        }


        // --- 3. HOURLY FETCHERS (FIXED) ---
        async function fetchHourlyProcessLogs(mc, paramName, start, end) {
            const config = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            let category = "Viscose";
            if ((config.auxiliary||[]).includes(paramName)) category = "Auxiliary";
            else if ((config.spinning||[]).includes(paramName)) category = "Spinning";

            const masterLabels = generateDateLabels(start, end, 'hourly');
            const dataMap = new Map();

            try {
                const snapshot = await db.collection('process_raw_logs')
                    .where('machineId', '==', mc)
                    .where('date', '>=', start).where('date', '<=', end)
                    .get();

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(!d.data) return;
                    let target = d.data[category] || d.data[category.toLowerCase()];
                    if(target && target[paramName]) {
                        const valArr = target[paramName];
                        for(let h=0; h<24; h++) {
                            const val = valArr[h];
                            if(val !== undefined && val !== null && val !== "") {
                                // Key format: YYYY-MM-DD HH:00
                                const key = `${d.date} ${String(h).padStart(2,'0')}:00`;
                                dataMap.set(key, Number(val));
                            }
                        }
                    }
                });
            } catch(e) { console.warn("Hourly Process Error", e); }

            const finalData = masterLabels.map(label => dataMap.has(label) ? dataMap.get(label) : null);
            const stats = calculateStats(finalData.filter(v => v !== null));
            return { labels: masterLabels, data: finalData, avg: stats.avg, cv: stats.cv };
        }

        async function fetchHourlyProductLogs(mc, paramName, start, end) {
            const targetCategory = MC_COLLECTION_MAP[mc] || "Modal";
            const masterLabels = generateDateLabels(start, end, 'hourly');
            const dataMap = new Map();

            try {
                const snapshot = await db.collection('product_raw_logs')
                    .where('machineId', '==', mc)
                    .where('date', '>=', start).where('date', '<=', end)
                    .get();

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(!d.data) return;
                    let target = d.data[targetCategory] || d.data["Modal"];
                    if(target && target[paramName]) {
                        for(let h=0; h<24; h++) {
                            const val = target[paramName][h];
                            if(val !== undefined && val !== null && val !== "") {
                                const key = `${d.date} ${String(h).padStart(2,'0')}:00`;
                                dataMap.set(key, Number(val));
                            }
                        }
                    }
                });
            } catch(e) { console.warn("Hourly Product Error", e); }

            const finalData = masterLabels.map(label => dataMap.has(label) ? dataMap.get(label) : null);
            const stats = calculateStats(finalData.filter(v => v !== null));
            return { labels: masterLabels, data: finalData, avg: stats.avg };
        }

        // Utils
        function calculateStats(arr) {
            const n = arr.length;
            if(n===0) return { avg:0, cv:0 };
            const mean = arr.reduce((a,b)=>a+b,0)/n;
            const variance = arr.reduce((a,b)=>a+Math.pow(b-mean,2),0)/n;
            const cv = mean!==0 ? (Math.sqrt(variance)/mean)*100 : 0;
            return { avg: mean, cv: cv };
        }
        function getPreviousPeriodDates(startStr, endStr) {
            const dStart = new Date(startStr);
            const dEnd = new Date(endStr);
            dStart.setMonth(dStart.getMonth()-1);
            dEnd.setMonth(dEnd.getMonth()-1);
            return { start: dStart.toISOString().split('T')[0], end: dEnd.toISOString().split('T')[0] };
        }

        // =========================================================
        // 5. CHART RENDERING (PARALLEL)
        // =========================================================
        
        async function renderProcessCharts(mc, start, end, mode) {
            const prevPeriod = getPreviousPeriodDates(start, end);
            const promises = [];
            
            // Push all 4 charts to promise array
            for(let i=1; i<=4; i++) {
                promises.push(updateSingleChart('Proc', i, mc, start, end, mode, prevPeriod));
            }
            await Promise.all(promises);
        }

        async function renderProductCharts(mc, start, end, mode) {
            const prevPeriod = getPreviousPeriodDates(start, end);
            
            // 1. Grade Summary (Parallel with Charts)
            const gradePromise = fetchAndRenderGrades(mc, start, end, mode);
            
            // 2. Charts
            const chartPromises = [];
            for(let i=1; i<=4; i++) {
                chartPromises.push(updateSingleChart('Prod', i, mc, start, end, mode, prevPeriod));
            }
            
            await Promise.all([gradePromise, ...chartPromises]);
        }

        // Unified Update Function
        async function updateSingleChart(type, index, mc, start, end, mode, prevPeriod) {
            // If args missing (called from dropdown change), refill them
            if(!mc) {
                mc = document.getElementById('mcFilter').value;
                start = document.getElementById('startDate').value;
                end = document.getElementById('endDate').value;
                mode = getGranularity();
                prevPeriod = getPreviousPeriodDates(start, end);
            }

            const selId = `sel${type}${index}`;
            const chartId = `chart${type}${index}`;
            const containerId = `container${type}${index}`;
            const el = document.getElementById(selId);
            const container = document.getElementById(containerId);
            
            if (!el || !el.value) return;
            const param = el.value;

            // Show Skeleton
            if(container) {
                const existingCanvas = container.querySelector('canvas');
                existingCanvas.style.opacity = '0.3';
                let skel = container.querySelector('.skeleton');
                if(!skel) {
                    skel = document.createElement('div');
                    skel.className = 'skeleton absolute top-0 left-0 z-10';
                    container.appendChild(skel);
                }
            }
            
            el.disabled = true;

            try {
                let result, prevResult;
                
                // Parallel Fetch Current vs Previous
                if (type === 'Proc') {
                    [result, prevResult] = await Promise.all([
                        fetchProcessDataByType(mc, param, start, end, mode),
                        fetchProcessDataByType(mc, param, prevPeriod.start, prevPeriod.end, mode)
                    ]);
                    updateProcessStabilityBadge(selId, result.cv, prevResult.cv, false);
                    createDynamicLineChart(chartId, param, '#2563eb', result.labels, result.data, mode);
                } else {
                    [result, prevResult] = await Promise.all([
                        fetchProductDataByType(mc, param, start, end, mode),
                        fetchProductDataByType(mc, param, prevPeriod.start, prevPeriod.end, mode)
                    ]);
                    updateProcessStabilityBadge(selId, result.avg, prevResult.avg, true);
                    createDynamicLineChart(chartId, param, '#10b981', result.labels, result.data, mode);
                }
            } catch (e) {
                console.error(`Chart ${type}${index} Error`, e);
            } finally {
                // Remove Skeleton
                if(container) {
                    const skel = container.querySelector('.skeleton');
                    if(skel) skel.remove();
                    const existingCanvas = container.querySelector('canvas');
                    existingCanvas.style.opacity = '1';
                }
                el.disabled = false;
            }
        }

        // =========================================================
        // 6. GRADE & AUXILIARY LOGIC
        // =========================================================
        async function fetchAndRenderGrades(mc, start, end, mode) {
            const productType = MC_COLLECTION_MAP[mc] || "Modal";
            const selectedMat = document.getElementById('materialFilter') ? document.getElementById('materialFilter').value : "ALL";
            let gradeCounts = { E: 0, ST: 0, I: 0, O: 0 };

            // Config: ‡∏ä‡∏∑‡πà‡∏≠ Parameter ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏£‡∏î
            const gradeParamNames = ["Over All Grade", "overallgrade", "Length Grade", "Grade"];

            try {
                // --- Strategy: Fetch STATS First (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ 2025 ‡πÅ‡∏•‡∏∞ 2026+) ---
                // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏∂‡∏á Stats ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞:
                // 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ 2025: Stats ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏° (ALL) -> ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà Filter Material
                // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ 2026+: Stats ‡∏°‡∏µ materials_breakdown -> ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÅ‡∏°‡πâ‡∏à‡∏∞ Filter Material
                // 3. ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å 2025 ‡πÅ‡∏ö‡∏ö Filter Material -> ‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡∏î‡∏∂‡∏á Raw Logs ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î

                let collectionName = (mode === 'daily') ? `stats_Product_${productType}` : `stats_Product_${productType}_Monthly`;
                let query = db.collection(collectionName).where("machineId", "==", mc);

                if (mode === 'monthly') {
                    query = query.where("month", ">=", start.substring(0,7)).where("month", "<=", end.substring(0,7));
                } else {
                    query = query.where("date", ">=", start).where("date", "<=", end);
                }

                const snapshot = await query.get();
                const docsMissingBreakdown = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡πÑ‡∏°‡πà‡∏°‡∏µ Breakdown)

                snapshot.forEach(doc => {
                    const d = doc.data();

                    // CASE A: User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "ALL" -> ‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î ‡πÉ‡∏ä‡πâ Stats ‡∏£‡∏ß‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏î)
                    if (selectedMat === "ALL") {
                        // ‡∏´‡∏≤ Parameter ‡πÄ‡∏Å‡∏£‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                        let gStats = null;
                        for(let name of gradeParamNames) { if(d.stats && d.stats[name]) { gStats = d.stats[name]; break; } }

                        if (gStats && gStats.counts) {
                            gradeCounts.E += (gStats.counts.E || gStats.counts.EXCELLENT || 0);
                            gradeCounts.ST += (gStats.counts.ST || gStats.counts.STANDARD || 0);
                            gradeCounts.I += (gStats.counts.I || gStats.counts.INTERMEDIATE || 0);
                            // ‡∏£‡∏ß‡∏° Off Grade ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                            Object.keys(gStats.counts).forEach(k => {
                                if(!['E','EXCELLENT','ST','STANDARD','I','INTERMEDIATE'].includes(k)) gradeCounts.O += gStats.counts[k];
                            });
                        }
                    }
                    // CASE B: User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á Material
                    else {
                        // 1. ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÉ‡∏ô materials_breakdown ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2026+)
                        if (d.materials_breakdown && d.materials_breakdown[selectedMat]) {
                            // ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å Material ‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î Raw)
                            let gStats = null;
                            for(let name of gradeParamNames) { 
                                if(d.materials_breakdown[selectedMat][name]) { 
                                    gStats = d.materials_breakdown[selectedMat][name]; break; 
                                } 
                            }
                            if (gStats && gStats.counts) {
                                gradeCounts.E += (gStats.counts.E || gStats.counts.EXCELLENT || 0);
                                gradeCounts.ST += (gStats.counts.ST || gStats.counts.STANDARD || 0);
                                gradeCounts.I += (gStats.counts.I || gStats.counts.INTERMEDIATE || 0);
                                Object.keys(gStats.counts).forEach(k => {
                                    if(!['E','EXCELLENT','ST','STANDARD','I','INTERMEDIATE'].includes(k)) gradeCounts.O += gStats.counts[k];
                                });
                            }
                        } 
                        // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ breakdown (‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏õ‡∏µ 2025) -> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÇ‡∏´‡∏•‡∏î Raw Logs
                        else {
                            docsMissingBreakdown.push(mode === 'daily' ? d.date : d.month);
                        }
                    }
                });

                // --- FALLBACK: Load Raw Logs for Missing Dates (Hybrid Logic) ---
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Material Filter ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ Breakdown (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2025)
                if (selectedMat !== "ALL" && docsMissingBreakdown.length > 0) {
                    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏∂‡∏á Raw Logs ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ã‡πâ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
                    // (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô ‡∏î‡∏∂‡∏á‡∏ó‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á Read)
                    // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ö‡∏ö Simple: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ú‡∏™‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å Raw ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏±‡πâ‡∏ô

                    // ‡∏´‡∏≤ Min/Max date ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
                    docsMissingBreakdown.sort();
                    const missingStart = docsMissingBreakdown[0];
                    const missingEnd = docsMissingBreakdown[docsMissingBreakdown.length-1];

                    // ‡∏î‡∏∂‡∏á Raw Logs
                    let rawQuery = db.collection("product_raw_logs").where("machineId", "==", mc);
                    if(mode === 'monthly') {
                         // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ
                         rawQuery = rawQuery.where("date", ">=", missingStart + "-01").where("date", "<=", missingEnd + "-31");
                    } else {
                         rawQuery = rawQuery.where("date", ">=", missingStart).where("date", "<=", missingEnd);
                    }

                    const rawSnap = await rawQuery.get();
                    rawSnap.forEach(doc => {
                         const d = doc.data();
                         if(!d.data) return;
                         const pData = d.data[productType] || d.data["Modal"];
                         if(!pData) return;

                         // Logic ‡∏ô‡∏±‡∏ö‡πÄ‡∏Å‡∏£‡∏î‡πÅ‡∏ö‡∏ö Raw
                         const gradeKey = Object.keys(pData).find(k => gradeParamNames.some(n => k.toLowerCase().includes(n.toLowerCase())));
                         const matKey = Object.keys(pData).find(k => k.toLowerCase().includes("material"));

                         if(gradeKey && pData[gradeKey] && matKey && pData[matKey]) {
                             const gradeArr = pData[gradeKey];
                             const matArr = pData[matKey];
                             for(let i=0; i<gradeArr.length; i++) {
                                 if(String(matArr[i]) === selectedMat) {
                                     const g = String(gradeArr[i]).toUpperCase();
                                     if (g.startsWith("E")) gradeCounts.E++;
                                     else if (g.startsWith("ST")) gradeCounts.ST++;
                                     else if (g.startsWith("I")) gradeCounts.I++;
                                     else gradeCounts.O++;
                                 }
                             }
                         }
                    });
                }

                // Render Result
                const total = gradeCounts.E + gradeCounts.ST + gradeCounts.I + gradeCounts.O;
                ['E', 'ST', 'I', 'O'].forEach(g => {
                    const elPct = document.getElementById(`grade-${g.toLowerCase()}-pct`);
                    const elTon = document.getElementById(`grade-${g.toLowerCase()}-ton`);
                    if (elPct) {
                        elPct.style.opacity = '0.5';
                        setTimeout(() => {
                            elPct.innerText = total > 0 ? ((gradeCounts[g] / total) * 100).toFixed(1) + "%" : "0.0%";
                            elPct.style.opacity = '1';
                        }, 100);
                    }
                    if (elTon) elTon.innerText = gradeCounts[g].toLocaleString();
                });

            } catch (e) {
                console.warn("Hybrid Grade Fetch Error", e);
            }
        }

        const LOWER_IS_BETTER_KEYWORDS = [
            "FW:", "NW Black", "Neps", "Wet Lump", "Stuck up", "Speck", 
            "Sulphur", "Ash", "Silica", "Calcium", "Iron", "CV", "SD" 
            // CV ‡πÅ‡∏•‡∏∞ SD ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô ‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏¢‡∏¥‡πà‡∏á‡∏ô‡∏¥‡πà‡∏á (‡∏î‡∏µ)
        ];

        function updateProcessStabilityBadge(selectId, currentVal, prevVal, isProduct = false) {
            const selectEl = document.getElementById(selectId);
            if(!selectEl) return;

            // 1. ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ Parameter ‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ß‡∏Å "‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏î‡∏µ" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const paramName = selectEl.value || "";
            const isLowerBetter = LOWER_IS_BETTER_KEYWORDS.some(k => paramName.includes(k));

            const parent = selectEl.parentElement;
            const oldBadge = parent.querySelector('.stability-badge');
            if(oldBadge) oldBadge.remove();

            if (currentVal === undefined || currentVal === null) return;

            let baseColor = isProduct ? "emerald" : "indigo";
            let bgColorClass = `bg-${baseColor}-50 border-${baseColor}-200 text-${baseColor}-700`;
            let comparisonHtml = '';

            if (prevVal !== undefined && prevVal !== null && prevVal > 0) {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á (Absolute Difference)
                const diff = currentVal - prevVal;

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏®‡∏£ (‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏á ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á)
                const arrowIcon = diff > 0 ? 'fa-arrow-up' : 'fa-arrow-down';

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ (Meaningful Color)
                let isGood = false;
                if (isLowerBetter) {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ß‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢: ‡∏•‡∏î‡∏•‡∏á (diff < 0) ‡∏Ñ‡∏∑‡∏≠‡∏î‡∏µ
                    isGood = diff < 0; 
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ß‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (diff > 0) ‡∏Ñ‡∏∑‡∏≠‡∏î‡∏µ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≤‡∏ß, ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
                    isGood = diff > 0;
                }

                // ‡∏î‡∏µ = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡πÅ‡∏¢‡πà = ‡πÅ‡∏î‡∏á
                const trendColor = isGood ? 'text-emerald-600' : 'text-rose-600';

                comparisonHtml = `
                    <div class="flex items-center gap-1 ml-2 ${trendColor} border-l border-slate-200 pl-2">
                        <i class="fas ${arrowIcon} text-[8px]"></i>
                        <span class="text-[9px] font-bold">${Math.abs(diff).toFixed(2)}</span>
                    </div>
                    <span class="text-[8px] text-slate-400 ml-1">vs ${prevVal.toFixed(2)}</span>
                `;
            } else {
                comparisonHtml = `<span class="text-[8px] text-slate-400 ml-2">Prev: -</span>`;
            }

            const badgeHtml = `
                <div class="stability-badge flex items-center px-2 py-0.5 rounded border ${bgColorClass} ml-auto shadow-sm transition-all duration-300">
                    <span class="text-[10px] font-bold text-slate-700">${isProduct?'Avg':'Avg'} ${currentVal.toFixed(2)}</span>
                    ${comparisonHtml}
                </div>
            `;
            selectEl.insertAdjacentHTML('afterend', badgeHtml);
        }

        // =========================================================
        // 7. PULP SECTION (Kept mostly original but optimized)
        // =========================================================
        function getPulpDocID(year, monthIndex) {
            if (year > 2025) return 'summary_2025';
            if (year === 2025 && monthIndex >= 10) return 'summary_2025';
            return 'main_summary';
        }

        // Function 1: Render ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å stats_pulp)
        async function renderPulpSection(mc) {
            const container = document.getElementById('pulpSupplierContainer');
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            const suppliers = MC_SUPPLIER_RULES[mc] || ["ARAUCO", "AVC", "PHOENIX", "AV NACKAWIC"];

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Compare)
            const sDate = new Date(startStr);
            const prevMonthDate = new Date(sDate.getFullYear(), sDate.getMonth() - 1, 1);

            container.innerHTML = '<div class="w-full text-center py-8"><i class="fas fa-circle-notch fa-spin text-orange-500"></i> Loading Pulp Data...</div>';

            try {
                // Parallel Fetch: 
                // 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Raw (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                // 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Stats Summary (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)
                const [currentData, prevData] = await Promise.all([
                    fetchRawPulpData(startStr, endStr, suppliers),
                    fetchSingleMonthSummaryPulp(prevMonthDate, suppliers)
                ]);

                container.innerHTML = '';
                if(Object.keys(currentData).length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-4">No Pulp Data Found</div>';
                    return;
                }

                suppliers.forEach(sup => {
                    const data = currentData[sup];
                    const prev = prevData[sup] || {}; 

                    if(!data || data.lotCount === 0) return;

                    // True = ‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏î‡∏µ (Alpha, Visc, White), False = ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏î‡∏µ (Silica, Ca)
                    const row = `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                            <div class="flex items-center gap-3 mb-4 pb-2 border-b border-slate-100">
                                <div class="w-1.5 h-6 bg-orange-500 rounded-full"></div>
                                <h3 class="text-xl font-bold text-slate-700 tracking-wide">${sup}</h3>
                                <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-100 ml-auto">${data.lotCount} lots</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                ${renderPulpCard("Alpha", data.alpha, prev.alpha, "%", true)}
                                ${renderPulpCard("Viscosity", data.viscosity, prev.viscosity, "ml/g", true)}
                                ${renderPulpCard("Whiteness", data.whiteness, prev.whiteness, "%", true)}
                                ${renderPulpCard("Silica", data.silica, prev.silica, "ppm", false)}
                                ${renderPulpCard("Calcium", data.calcium, prev.calcium, "ppm", false)}
                            </div>
                        </div>`;
                    container.innerHTML += row;
                });
            } catch(e) {
                console.error("Render Pulp Error:", e);
                container.innerHTML = '<div class="text-red-500 text-center">Error loading pulp data</div>';
            }
        }

        // Function 2: ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        function renderPulpCard(label, val, prevVal, unit, isHigherBetter) {
            let trendHtml = '<span class="text-[9px] text-slate-300 mt-1">Prev: -</span>';
            let valColor = "text-slate-800";

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ prevVal ‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô null/undefined)
            if (val !== null && prevVal !== null && prevVal !== undefined) {
                const diff = val - prevVal;
                const isUp = diff > 0;
                // ‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏µ: Quality (‡∏Ç‡∏∂‡πâ‡∏ô=‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß), Impurity (‡∏Ç‡∏∂‡πâ‡∏ô=‡πÅ‡∏î‡∏á)
                const isGood = isHigherBetter ? isUp : !isUp;

                const color = isGood ? "text-emerald-500" : "text-rose-500";
                const icon = isUp ? "fa-arrow-up" : "fa-arrow-down";

                trendHtml = `
                    <div class="flex items-center gap-1 ${color} text-[10px] font-bold mt-1">
                        <i class="fas ${icon}"></i>
                        <span>${Math.abs(diff).toFixed(2)}</span>
                        <span class="text-[9px] text-slate-400 font-normal ml-1">vs ${prevVal.toFixed(2)}</span>
                    </div>
                `;
            }

            return `
                <div class="flex flex-col p-3 bg-slate-50 rounded-lg border border-slate-100 items-start h-24 relative group hover:border-indigo-100 transition">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">${label}</span>
                    <div class="flex items-baseline gap-1 mt-auto w-full">
                        <span class="text-2xl font-bold ${valColor}">${val ? val.toFixed(2) : '-'}</span>
                        <span class="text-[10px] text-slate-400">${unit}</span>
                    </div>
                    ${trendHtml}
                </div>`;
        }

        // Function 3: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å Raw (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        async function fetchRawPulpData(start, end, suppliers) {
            const results = {};
            suppliers.forEach(s => { results[s] = { lotCount:0, alphaSum:0, alphaCnt:0, viscositySum:0, viscosityCnt:0, whitenessSum:0, whitenessCnt:0, silicaSum:0, silicaCnt:0, calciumSum:0, calciumCnt:0 }; });

            const snapshot = await db.collection('rm_pulp_inspections')
                .where('receivedDate', '>=', start).where('receivedDate', '<=', end).get();

            snapshot.forEach(doc => {
                const d = doc.data();
                // Match Supplier ‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà)
                const s = suppliers.find(sup => sup.trim().toUpperCase() === (d.supplier||"").trim().toUpperCase());
                if(s && d.parameters) {
                    results[s].lotCount++;
                    const p = d.parameters;
                    if(p.alphaCellulose?.coa) { results[s].alphaSum += Number(p.alphaCellulose.coa); results[s].alphaCnt++; }
                    if(p.viscosity?.coa) { results[s].viscositySum += Number(p.viscosity.coa); results[s].viscosityCnt++; }
                    if(p.whiteness?.coa) { results[s].whitenessSum += Number(p.whiteness.coa); results[s].whitenessCnt++; }
                    if(p.silica?.coa) { results[s].silicaSum += Number(p.silica.coa); results[s].silicaCnt++; }
                    if(p.calcium?.coa) { results[s].calciumSum += Number(p.calcium.coa); results[s].calciumCnt++; }
                }
            });

            const final = {};
            suppliers.forEach(s => {
                const r = results[s];
                final[s] = {
                    lotCount: r.lotCount,
                    alpha: r.alphaCnt ? r.alphaSum/r.alphaCnt : null,
                    viscosity: r.viscosityCnt ? r.viscositySum/r.viscosityCnt : null,
                    whiteness: r.whitenessCnt ? r.whitenessSum/r.whitenessCnt : null,
                    silica: r.silicaCnt ? r.silicaSum/r.silicaCnt : null,
                    calcium: r.calciumCnt ? r.calciumSum/r.calciumCnt : null
                };
            });
            return final;
        }

        // Function 4: [RESTORED] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Prev) ‡∏à‡∏≤‡∏Å stats_pulp
        async function fetchSingleMonthSummaryPulp(dateObj, targetSuppliers) {
            const year = dateObj.getFullYear();
            const month = dateObj.getMonth(); // 0-11
            const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const docID = getPulpDocID(year, month);

            const results = {};
            targetSuppliers.forEach(s => results[s] = {});

            try {
                const docRef = db.collection("stats_pulp").doc(docID);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    const incoming = data.pulp_incoming || {};
                    // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Key: pulp_incoming -> YYYY-MM
                    const monthData = incoming[monthStr];

                    if (monthData) {
                        targetSuppliers.forEach(sup => {
                            // ‡∏´‡∏≤ Supplier Key ‡πÉ‡∏ô DB (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Case sensitive)
                            const dbSupKey = Object.keys(monthData).find(k => k.trim().toUpperCase() === sup.trim().toUpperCase());

                            if (dbSupKey) {
                                const rec = monthData[dbSupKey];
                                // Map ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Summary ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á Format
                                Object.keys(PULP_PARAM_MAP).forEach(pKey => {
                                    const dbKey = PULP_PARAM_MAP[pKey].dbKey; // ‡πÄ‡∏ä‡πà‡∏ô alpha -> alphaCellulose
                                    if (rec.params && rec.params[dbKey]) {
                                        results[sup][pKey] = rec.params[dbKey].coa_avg;
                                    } else {
                                        results[sup][pKey] = null;
                                    }
                                });
                            }
                        });
                    }
                }
            } catch (e) {
                console.warn("Fetch Summary Pulp Error:", e);
            }
            return results;
        }

        // =========================================================
        // 8. NEW CORRELATION & AI ROOT CAUSE FINDER (HYBRID: Trend + Scatter)
        // =========================================================

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI (‡πÅ‡∏¢‡∏Å 2 ‡∏Å‡∏£‡∏≤‡∏ü)
        let currentTrendData = null;   
        let currentScatterData = null; 
        let chatHistoryLog = []; 
        let currentAIContext = "";

        // Override ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateDropdownOptions ‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å initCorrelationControls ‡∏î‡πâ‡∏ß‡∏¢
        const _originalUpdateDropdowns = updateDropdownOptions;
        updateDropdownOptions = function() {
            _originalUpdateDropdowns(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Part 2 & 3
            initCorrelationControls();  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Part 4
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4 (‡∏™‡∏£‡πâ‡∏≤‡∏á Checkbox ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏° Dropdown)
        function initCorrelationControls() {
            const mc = document.getElementById('mcFilter').value;
            const procConfig = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            // ‡∏£‡∏ß‡∏° Parameter ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á Process
            const allProcessParams = [...(procConfig.viscose||[]), ...(procConfig.auxiliary||[]), ...(procConfig.spinning||[])];
            // Parameter ‡∏Ç‡∏≠‡∏á Product
            const prodParams = PRODUCT_PARAM_CONFIG[mc] || PRODUCT_PARAM_CONFIG["MC2"];

            // 1. Setup Trend Analysis Inputs (Checkboxes) - ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
            const container = document.getElementById('correlationInputList');
            if(container) {
                container.innerHTML = '';
                allProcessParams.forEach(param => {
                    // [MODIFIED]: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡πä‡∏Å checked ‡πÇ‡∏î‡∏¢ Default (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≠)
                    const div = document.createElement('div');
                    div.className = "flex items-center space-x-2 cursor-pointer hover:bg-slate-200 p-1 rounded transition";
                    div.innerHTML = `
                        <input type="checkbox" class="corr-input-check accent-blue-600 w-3 h-3" value="${param}">
                        <span class="truncate" title="${param}">${param}</span>
                    `;
                    container.appendChild(div);
                });
            }

            // 2. Setup Dropdowns - ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ (Target ‡πÅ‡∏•‡∏∞ Scatter)
            fillSelect('corrTrendTarget', prodParams);  // Target ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô
            fillSelect('corrScatterX', allProcessParams); // ‡πÅ‡∏Å‡∏ô X ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∏‡∏î
            fillSelect('corrScatterY', prodParams);       // ‡πÅ‡∏Å‡∏ô Y ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∏‡∏î
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Reset (‡∏õ‡∏∏‡πà‡∏° Reset All)
        function resetSection4() {
            // 1. Clear Checkboxes
            document.querySelectorAll('.corr-input-check').forEach(cb => cb.checked = false);

            // 2. Reset Dropdowns (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î)
            const selects = ['corrTrendTarget', 'corrScatterX', 'corrScatterY'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el && el.options.length > 0) el.selectedIndex = 0;
            });

            // 3. Clear Charts (‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü)
            if (chartInstances['trend']) {
                chartInstances['trend'].destroy();
                delete chartInstances['trend'];
            }
            if (chartInstances['scatter']) {
                chartInstances['scatter'].destroy();
                delete chartInstances['scatter'];
            }

            // 4. Clear Data & AI Result
            currentTrendData = null;
            currentScatterData = null;
            document.getElementById('aiAnalysisResult').classList.add('hidden');
            document.getElementById('aiTextContent').innerHTML = '';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Trend (Chart A)
        async function renderTrendChart() {
            const mc = document.getElementById('mcFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const mode = getGranularity();

            // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Input Parameters ‡∏ó‡∏µ‡πà User ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const checkboxes = document.querySelectorAll('.corr-input-check:checked');
            const selectedInputs = Array.from(checkboxes).map(cb => cb.value);
            // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Target
            const targetParam = document.getElementById('corrTrendTarget').value;

            if (selectedInputs.length === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Process Input (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            // 3. Fetch Data
            const inputPromises = selectedInputs.map(param => fetchProcessDataByType(mc, param, start, end, mode));
            const targetPromise = fetchProductDataByType(mc, targetParam, start, end, mode);

            try {
                const [targetData, ...inputsData] = await Promise.all([targetPromise, ...inputPromises]);

                // 4. Prepare Datasets
                const datasets = [];

                // Target (Output) - ‡πÅ‡∏Å‡∏ô‡∏Ç‡∏ß‡∏≤ - ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                datasets.push({
                    label: `TARGET: ${targetParam}`,
                    data: targetData.data,
                    borderColor: '#dc2626', backgroundColor: '#dc2626',
                    yAxisID: 'yRight', type: 'line', borderWidth: 3, pointRadius: 0, tension: 0.4, fill: false
                });

                // Inputs (Process) - ‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ - ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏´‡∏•‡∏≤‡∏Å‡∏™‡∏µ
                const colors = ['#2563eb', '#059669', '#d97706', '#7c3aed', '#db2777'];
                inputsData.forEach((result, index) => {
                    datasets.push({
                        label: selectedInputs[index],
                        data: result.data,
                        borderColor: colors[index % colors.length], backgroundColor: colors[index % colors.length],
                        yAxisID: 'yLeft', type: 'line', borderWidth: 1.5, borderDash: [5, 5], pointRadius: 0, tension: 0.3, fill: false
                    });
                });

                // 5. Render Chart
                const ctx = document.getElementById('chartTrend').getContext('2d');
                if (chartInstances['trend']) chartInstances['trend'].destroy();

                chartInstances['trend'] = new Chart(ctx, {
                    type: 'line',
                    data: { labels: targetData.labels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { display: true, ticks: { maxTicksLimit: 8 } },
                            yLeft: { type: 'linear', display: true, position: 'left', title: {display:true, text: 'Inputs'}, grid: {display:false} },
                            yRight: { type: 'linear', display: true, position: 'right', title: {display:true, text: targetParam}, grid: {color: '#f3f4f6'} }
                        }
                    }
                });

                // Save for AI
                currentTrendData = {
                    targetName: targetParam,
                    targetData: targetData.data,
                    labels: targetData.labels,
                    inputs: inputsData.map((d, i) => ({ name: selectedInputs[i], data: d.data }))
                };

            } catch (error) { console.error("Trend Chart Error:", error); }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Scatter (Chart B)
        async function renderScatterChart() {
            const mc = document.getElementById('mcFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const mode = getGranularity();

            const xParam = document.getElementById('corrScatterX').value;
            const yParam = document.getElementById('corrScatterY').value;

            try {
                const [d1, d2] = await Promise.all([
                    fetchProcessDataByType(mc, xParam, start, end, mode),
                    fetchProductDataByType(mc, yParam, start, end, mode)
                ]);

                // Match Data by Date/Time Label (‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
                const scatterData = [];
                const map2 = new Map();
                d2.labels.forEach((l, i) => map2.set(l, d2.data[i]));

                d1.labels.forEach((l, i) => {
                    if (map2.has(l)) {
                        scatterData.push({ x: d1.data[i], y: map2.get(l) });
                    }
                });

                const ctx = document.getElementById('chartScatter').getContext('2d');
                if (chartInstances['scatter']) chartInstances['scatter'].destroy();

                chartInstances['scatter'] = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `Correlation`,
                            data: scatterData,
                            backgroundColor: '#4f46e5'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { title: { display: true, text: xParam } },
                            y: { title: { display: true, text: yParam } }
                        }
                    }
                });

                // Save for AI
                currentScatterData = {
                    xName: xParam, yName: yParam,
                    points: scatterData // [{x,y}, ...]
                };

            } catch (error) { console.error("Scatter Chart Error:", error); }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI Analyze (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á 2 ‡∏Å‡∏£‡∏≤‡∏ü‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        async function analyzeRootCauseAI() {
            if (!currentTrendData && !currentScatterData) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏•‡πá‡∏≠‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á (Trend ‡∏´‡∏£‡∏∑‡∏≠ Scatter) ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ñ‡∏≤‡∏° AI ‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            const resultBox = document.getElementById('aiAnalysisResult');
            const content = document.getElementById('aiTextContent');
            resultBox.classList.remove('hidden');
            content.innerHTML = `<div class="flex items-center gap-2 text-indigo-600 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin"></i><span>Synthesizing Multi-Chart Analysis...</span></div>`;

            // 1. Prepare Trend Payload (‡∏¢‡πà‡∏≠ Key ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend CSV Logic)
            let trendPayload = null;
            if (currentTrendData) {
                const len = currentTrendData.labels.length;
                const startIdx = Math.max(0, len - 20); // ‡πÄ‡∏≠‡∏≤ 20 ‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

                const simplifiedData = [];
                for (let i = startIdx; i < len; i++) {
                    let row = { t: currentTrendData.labels[i] }; // t = time

                    // Target
                    let val = currentTrendData.targetData[i];
                    row.tg = (typeof val === 'number') ? Number(val.toFixed(2)) : val; // tg = target

                    // Inputs (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ i0, i1... ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend Loop)
                    currentTrendData.inputs.forEach((inp, idx) => {
                        let v = inp.data[i];
                        row[`i${idx}`] = (typeof v === 'number') ? Number(v.toFixed(2)) : v; 
                    });
                    simplifiedData.push(row);
                }

                trendPayload = { 
                    target: currentTrendData.targetName, 
                    inputs: currentTrendData.inputs.map(i => i.name), 
                    data: simplifiedData 
                };
            }

            // 2. Prepare Scatter Payload
            let scatterPayload = null;
            if (currentScatterData) {
                const points = currentScatterData.points.slice(0, 50).map(p => ({
                    x: Number(p.x.toFixed(2)),
                    y: Number(p.y.toFixed(2))
                }));

                scatterPayload = {
                    xName: currentScatterData.xName,
                    yName: currentScatterData.yName,
                    data: points
                };
            }

            // (Optional) ‡πÄ‡∏û‡∏¥‡πà‡∏° processMeta ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Å‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
            const processMeta = `Product Grade: ${document.getElementById('corrTrendTarget').value}`; 

            try {
                const analyzeFn = functions.httpsCallable('analyzeRootCause');
                const result = await analyzeFn({ 
                    trendData: trendPayload, 
                    scatterData: scatterPayload,
                    processMeta: processMeta // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏â‡∏•‡∏≤‡∏î‡πÑ‡∏î‡πâ
                });

                const aiText = result.data.analysis;
                // 1. ‡πÄ‡∏Å‡πá‡∏ö Context ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° History ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö KM
                currentAIContext = document.getElementById('mcFilter').value; 
                chatHistoryLog = []; 
                // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                chatHistoryLog.push({ role: "user", content: `Analyze Root Cause for Target: ${document.getElementById('corrTrendTarget').value}` });
                chatHistoryLog.push({ role: "ai", content: aiText });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ User ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ Save ‡πÑ‡∏î‡πâ
                const hintMessage = `<br><br><span class="text-xs text-slate-400 italic bg-slate-50 px-2 py-1 rounded border border-slate-200"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i>‡∏û‡∏¥‡∏°‡∏û‡πå <b>"save"</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"</b> ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà (KM)</span>`;
                
                content.innerHTML = aiText
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<b class="text-indigo-800">$1</b>')
                .replace(/- /g, '‚Ä¢ ') + hintMessage;

            } catch (error) {
                content.innerHTML = `<div class="text-red-500">Analysis Failed: ${error.message}</div>`;
            }
        }
        // =========================================================
        // [RESTORED] MISSING FUNCTION: GRAPH RENDERING
        // =========================================================
        function createDynamicLineChart(canvasId, label, color, labels, dataPoints, mode) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const pointRadius = (mode === 'hourly' && dataPoints.length > 50) ? 0 : 2;
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: dataPoints,
                        borderColor: color,
                        backgroundColor: color + '10',
                        borderWidth: 1.5,
                        pointRadius: pointRadius,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, ticks: { maxTicksLimit: 6 } },
                        y: { display: true }
                    }
                }
            });
        }
        // =========================================================
        // 10. AI CHAT
        // =========================================================
        function toggleChat() { document.getElementById('chatWindow').classList.toggle('hidden'); }
        function handleEnter(e) { if(e.key === 'Enter') sendChatMessage(); }
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value;
            if(!msg) return;
            const container = document.getElementById('chatMessages');
            container.innerHTML += `<div class="flex justify-end"><div class="chat-bubble-user p-3 shadow-sm max-w-[90%] text-white bg-indigo-600 rounded-l-xl rounded-br-xl">${msg}</div></div>`;
            input.value = '';
            // 1. ‡πÄ‡∏Å‡πá‡∏ö History ‡∏ù‡∏±‡πà‡∏á User
            chatHistoryLog.push({ role: "user", content: msg });

            // 2. ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á SAVE (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á "save" ‡πÅ‡∏•‡∏∞ "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")
            if (msg.toLowerCase() === "save" || msg.toLowerCase() === "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å") {
                container.innerHTML += `<div id="km-saving" class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-orange-50 text-orange-600 border border-orange-200"><i class="fas fa-save fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Case ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà...</div></div>`;
                container.scrollTop = container.scrollHeight;

                try {
                    const saveKM = functions.httpsCallable('saveIncidentFromChat');
                    const res = await saveKM({ history: chatHistoryLog, context: currentAIContext });

                    document.getElementById("km-saving").remove();
                    container.innerHTML += `<div class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-green-50 text-green-700 border border-green-200"><i class="fas fa-check-circle mr-2"></i> ${res.data.message}</div></div>`;
                } catch (err) {
                    if(document.getElementById("km-saving")) document.getElementById("km-saving").remove();
                    container.innerHTML += `<div class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-red-50 text-red-600">Save Failed: ${err.message}</div></div>`;
                }
                container.scrollTop = container.scrollHeight;
                return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤ Chatbot ‡∏õ‡∏Å‡∏ï‡∏¥
            }
            container.innerHTML += `<div id="ai-loading" class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-white text-slate-500 rounded-r-xl rounded-bl-xl"><i class="fas fa-circle-notch fa-spin"></i> Thinking...</div></div>`;
            container.scrollTop = container.scrollHeight;

            try {
                const askAI = functions.httpsCallable('askProductChat');
                const result = await askAI({ question: msg });
                document.getElementById("ai-loading").remove();
                let reply = result.data.text.replace(/\n/g, '<br>');
                chatHistoryLog.push({ role: "ai", content: result.data.text });
                container.innerHTML += `<div class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-white text-slate-800 rounded-r-xl rounded-bl-xl border border-slate-200">${reply}</div></div>`;
            } catch (error) {
                if(document.getElementById("ai-loading")) document.getElementById("ai-loading").remove();
                container.innerHTML += `<div class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-red-50 text-red-600">Error: ${error.message}</div></div>`;
            }
            container.scrollTop = container.scrollHeight;
        }
        function updateMaterialDropdownUI() {
            const select = document.getElementById('materialFilter');
            if(!select) return;

            const currentVal = select.value;
            // ‡πÄ‡∏Å‡πá‡∏ö Option 'ALL' ‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            select.innerHTML = '<option value="ALL">All Materials (Mixed)</option>';

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Option
            const sortedMats = Array.from(FOUND_MATERIALS).sort();
            sortedMats.forEach(mat => {
                const opt = document.createElement('option');
                opt.value = mat;
                opt.innerText = mat;
                select.appendChild(opt);
            });

            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
            if(sortedMats.includes(currentVal)) {
                select.value = currentVal;
            } else {
                select.value = "ALL";
            }
        }
    </script>
</body>
</html>
