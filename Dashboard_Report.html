<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC Command Center v2 - Integrated Line View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .card-header { @apply flex justify-between items-center mb-3 pb-2 border-b border-slate-100; }
        .kpi-value { @apply text-2xl font-bold text-slate-800; }
        .kpi-label { @apply text-xs text-slate-500 uppercase tracking-wider font-semibold; }
        .trend-up { @apply text-emerald-500 text-xs; }
        .trend-down { @apply text-rose-500 text-xs; }
        
        /* Chat UI */
        .chat-bubble-ai { background-color: #ffffff; border: 1px solid #e2e8f0; color: #1e293b; border-radius: 12px 12px 12px 0; }
        .chat-bubble-user { background-color: #4f46e5; color: white; border-radius: 12px 12px 0 12px; }

        /* Layout Utilities */
        .grid-dashboard { display: grid; grid-template-columns: 300px 1fr; gap: 1.5rem; }
        .section-title { font-size: 0.9rem; font-weight: 700; color: #475569; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 text-white p-3 shadow-md z-30 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded flex items-center justify-center font-bold text-xl shadow-lg">
                TRC
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-wide">Summary Dashboard</h1>
                <p class="text-[10px] text-slate-400">Holistic View: Pulp ‚Ä¢ Process ‚Ä¢ Fibre</p>
            </div>
        </div>

        <div class="flex gap-4 bg-slate-800 p-2 rounded-lg items-center border border-slate-700">
            <div class="flex flex-col">
                <label class="text-[10px] text-slate-400 font-bold uppercase">Select Line (MC)</label>
                <select id="mcFilter" class="bg-slate-700 text-white text-sm font-bold border-none outline-none rounded px-2 py-1 w-40 hover:bg-slate-600 transition" onchange="updateDashboard()">
                    <option value="MC2">MC2 (Modal Fibre)</option>
                    <option value="MC3">MC3 (Non-Woven Fibre)</option>
                    <option value="MC5">MC5 (Grey Fibre)</option>
                    <option value="MC6">MC6 (Non-Woven Fibre)</option>
                </select>
            </div>
            <div class="h-8 w-px bg-slate-600 mx-2"></div>
            <div class="flex items-center gap-2">
                <input type="date" id="startDate" class="bg-slate-700 text-white text-xs px-2 py-1 rounded outline-none">
                <span class="text-slate-500">-</span>
                <input type="date" id="endDate" class="bg-slate-700 text-white text-xs px-2 py-1 rounded outline-none">
            </div>
            <button onclick="updateDashboard()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded text-sm font-bold transition shadow-lg border border-indigo-400">
                <i class="fas fa-sync-alt animate-pulse-slow"></i> Refresh
            </button>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-100">
        
        <section>
            <div class="section-title text-orange-700 flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <i class="fas fa-tree"></i> 
                    <span>1. Raw Material Input (COA Analysis)</span>
                </div>
            </div>
            
            <div id="pulpSupplierContainer" class="flex flex-col gap-4">
                <div class="w-full flex flex-col items-center justify-center text-slate-400 bg-white rounded-xl border border-dashed border-slate-300 py-8">
                    <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-orange-300"></i>
                    <span class="text-sm">Retrieving Pulp Data...</span>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-2 gap-6">
            <section class="flex flex-col h-full">
                <div class="section-title text-blue-700 flex justify-between">
                    <span><i class="fas fa-cogs"></i> 2. Process Control (<span id="lblMcProcess">MC2</span>)</span>
                    <span class="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded border">Impacts Quality Directly</span>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-blue-500 flex-1 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border rounded p-2">
                            <div class="flex justify-between mb-1">
                                <select class="text-xs font-bold text-blue-800 bg-blue-50 rounded px-1" id="selProc1" onchange="updateSubChart('proc1')">
                                    <option value="Ball Fall">Viscose Ball Fall (sec)</option>
                                    <option value="Ripening Index">Ripening Index (Hot)</option>
                                    <option value="Viscose Temp">Viscose Temp (¬∞C)</option>
                                </select>
                                <span class="text-[10px] text-slate-400">Target: 45-50</span>
                            </div>
                            <div class="relative w-full" style="height: 180px;">
                                <canvas id="chartProc1"></canvas>
                            </div>
                        </div>
                        <div class="border rounded p-2">
                            <div class="flex justify-between mb-1">
                                <select class="text-xs font-bold text-blue-800 bg-blue-50 rounded px-1" id="selProc2">
                                    <option value="Acid">Spin Bath Acid (g/l)</option>
                                    <option value="Temp">Spin Bath Temp (¬∞C)</option>
                                </select>
                                <span class="text-[10px] text-slate-400">Target: 125 ¬±2</span>
                            </div>
                            <div class="relative w-full" style="height: 180px;"><canvas id="chartProc2"></canvas></div>
                        </div>
                        <div class="border rounded p-2">
                            <div class="flex justify-between mb-1">
                                <select class="text-xs font-bold text-blue-800 bg-blue-50 rounded px-1" id="selProc3">
                                    <option value="Zinc">Spin Bath Zinc (g/l)</option>
                                    <option value="Sulphate">Sodium Sulphate</option>
                                </select>
                                <span class="text-[10px] text-slate-400">Target: High Precision</span>
                            </div>
                            <div class="relative w-full" style="height: 180px;"><canvas id="chartProc3"></canvas></div>
                        </div>
                        <div class="border rounded p-2">
                            <div class="flex justify-between mb-1">
                                <select class="text-xs font-bold text-blue-800 bg-blue-50 rounded px-1" id="selProc4">
                                    <option value="Alk">Steep Lye Alkali %</option>
                                    <option value="Hemi">Hemi-Cellulose %</option>
                                </select>
                            </div>
                            <div class="relative w-full" style="height: 180px;"><canvas id="chartProc4"></canvas></div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="flex flex-col h-full">
                <div class="section-title text-emerald-700 flex justify-between">
                    <span><i class="fas fa-tags"></i> 3. Product Quality (<span id="lblMcProduct">MC2</span>)</span>
                    <span class="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded border">Result of Process</span>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-emerald-500 flex-1 space-y-4">
                    <div class="flex gap-4 items-center bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                        <div class="w-1/3 h-24 relative">
                            <canvas id="gradeChart"></canvas>
                        </div>
                        <div class="w-2/3 grid grid-cols-2 gap-2 text-xs">
                            <div><span class="font-bold text-emerald-700">% Grade E (Export):</span> <span id="valGradeE">92%</span></div>
                            <div><span class="font-bold text-blue-600">% Grade ST (Standard):</span> <span id="valGradeST">5%</span></div>
                            <div><span class="font-bold text-orange-500">% Grade I (Inferior):</span> <span id="valGradeI">2%</span></div>
                            <div><span class="font-bold text-red-500">% Grade O (Off):</span> <span id="valGradeO">1%</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border rounded p-2">
                            <div class="flex justify-between mb-1">
                                <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-1" id="selProd1">
                                    <option value="Tenacity">Tenacity (Cond.)</option>
                                    <option value="Elongation">Elongation (%)</option>
                                </select>
                            </div>
                            <div class="relative w-full" style="height: 180px;"><canvas id="chartProd1"></canvas></div>
                        </div>
                        <div class="border rounded p-2">
                            <div class="flex justify-between mb-1">
                                <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-1" id="selProd2">
                                    <option value="Whiteness">Whiteness (%MgO)</option>
                                    <option value="Brightness">Brightness</option>
                                </select>
                            </div>
                            <div class="relative w-full" style="height: 180px;"><canvas id="chartProd2"></canvas></div>
                        </div>
                        <div class="border rounded p-2">
                            <div class="flex justify-between mb-1">
                                <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-1" id="selProd3">
                                    <option value="Splinter">Splinter (Total)</option>
                                    <option value="Milky">Milky Fibres</option>
                                </select>
                            </div>
                            <div class="relative w-full" style="height: 180px;"><canvas id="chartProd3"></canvas></div>
                        </div>
                        <div class="border rounded p-2">
                            <div class="flex justify-between mb-1">
                                <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-1" id="selProd4">
                                    <option value="Denier">Titer (Denier)</option>
                                    <option value="Length">Cut Length (mm)</option>
                                </select>
                            </div>
                            <div class="relative w-full" style="height: 180px;"><canvas id="chartProd4"></canvas></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <section>
            <div class="section-title text-indigo-700">
                <i class="fas fa-project-diagram"></i> 4. Correlation Analysis (Root Cause Finder)
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md border border-indigo-100">
                <div class="flex gap-2 mb-4 bg-slate-50 p-2 rounded items-center">
                    <span class="text-xs font-bold text-slate-500 uppercase">Y1-Axis (Process):</span>
                    <select id="corrY1" class="text-xs border rounded p-1"><option>Spin Bath Acid</option><option>Viscose Ball Fall</option><option>Zn Concentration</option></select>
                    
                    <span class="text-xs font-bold text-slate-500 uppercase ml-4">vs</span>
                    
                    <span class="text-xs font-bold text-slate-500 uppercase ml-2">Y2-Axis (Product/Pulp):</span>
                    <select id="corrY2" class="text-xs border rounded p-1"><option>Tenacity</option><option>Whiteness</option><option>Pulp Iron (Fe)</option></select>
                    
                    <button class="ml-auto bg-indigo-600 text-white text-xs px-3 py-1 rounded hover:bg-indigo-500" onclick="updateCorrelation()">Plot Correlation</button>
                </div>
                <div class="h-64">
                    <canvas id="correlationChart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <div class="fixed bottom-6 right-6 z-50">
        <div id="chatWindow" class="hidden bg-white w-96 h-[450px] rounded-xl shadow-2xl border border-slate-200 flex flex-col mb-4 overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-700 to-purple-700 p-3 text-white flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-brain"></i> <span class="font-bold text-sm">TRC Pulp&Fibre Expert AI</span>
                </div>
                <button onclick="toggleChat()" class="hover:text-red-200"><i class="fas fa-times"></i></button>
            </div>
            <div id="chatMessages" class="flex-1 bg-slate-50 p-3 overflow-y-auto space-y-3 text-sm">
                <div class="chat-bubble-ai p-3 shadow-sm max-w-[90%]">
                    ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pulp & Fibre ‡∏Ñ‡∏£‡∏±‡∏ö üè≠ <br>
                    ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á <b><span id="aiMcContext">MC2</span></b>
                    <br><br>
                    <i>‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡πà‡∏ô:</i> "‡∏ó‡∏≥‡πÑ‡∏° Tenacity ‡∏Ç‡∏≠‡∏á MC2 ‡∏ñ‡∏∂‡∏á‡∏ï‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤?" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Ñ‡πà‡∏≤ Fe ‡πÉ‡∏ô Pulp ‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠ Whiteness ‡πÑ‡∏´‡∏°?"
                </div>
            </div>
            <div class="p-2 border-t flex gap-2 bg-white">
                <input type="text" id="chatInput" class="flex-1 bg-slate-100 rounded-full px-3 py-1.5 text-sm outline-none border focus:border-indigo-500" placeholder="Ask AI..." onkeypress="handleEnter(event)">
                <button onclick="sendChatMessage()" class="bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-indigo-700"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        <button onclick="toggleChat()" class="bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl transition transform hover:scale-110">
            <i class="fas fa-comment-dots"></i>
        </button>
    </div>

    <script>
    // =========================================================
    // 1. FIREBASE CONFIGURATION & INIT
    // =========================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
        authDomain: "lab-trc-management-system.firebaseapp.com",
        projectId: "lab-trc-management-system",
        storageBucket: "lab-trc-management-system.appspot.com",
        messagingSenderId: "43919979160",
        appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.settings({ experimentalForceLongPolling: true });
    const functions = firebase.functions();

    // =========================================================
    // 2. CONFIGURATION & METADATA
    // =========================================================

    // --- PULP CONFIGURATION (Updated with Trend Logic) ---
    // type: 'quality' (Higher is Better), 'impurity' (Lower is Better)
    const PULP_PARAM_MAP = {
        alpha: { dbKey: "alphaCellulose", label: "Alpha Cellulose", unit: "%", type: 'quality' },
        viscosity: { dbKey: "viscosity", label: "Viscosity (ISO)", unit: "ml/g", type: 'quality' }, // Sometimes defined target, but generally stability/high is monitored
        whiteness: { dbKey: "whiteness", label: "Berger Whiteness", unit: "%", type: 'quality' },
        silica: { dbKey: "silica", label: "Acid Insoluble (SiO2)", unit: "ppm", type: 'impurity' },
        calcium: { dbKey: "calcium", label: "Calcium (Ca)", unit: "ppm", type: 'impurity' }
    };

    const MC_SUPPLIER_RULES = {
        "MC2": ["AV NACKAWIC"],
        "MC3": ["ARAUCO", "AV CELL", "PHOENIX"],
        "MC5": ["ARAUCO", "AV CELL", "PHOENIX"],
        "MC6": ["ARAUCO", "AV CELL", "PHOENIX"]
    };

    // --- PROCESS & PRODUCT CONFIG ---
    const MACHINE_PROCESS_CONFIG = {
        "MC2": {
            viscose: ["Steep Lye Alkali %", "Steep Lye Temp.", "MD E Exit End Total Alk.", "MD E Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.", "Diss. Modal Vis BF", "Buffer Tank 5 Vis Temp", "Buffer Tank 6 Vis Temp", "Buffer Tank 7 Vis Temp", "Modal Rec14 BF", "Spinning Viscose Ball Fall", "Spinning Viscose Gamma no", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %", "MD 2 Vis Kw", "Flash Delta 6", "Flash Delta 7", "Vis Temp"],
            auxiliary: ["MD 2 Spin bath Na2SO4", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."],
            spinning: ["Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.", "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC2", "HSB Temp", "HSB Acid", "HSB Zn", "HSB Salt"]
        },
        "MC3": {
            viscose: ["Steep Lye Alkali %", "Steep Lye Temp.", "MD C Exit End Total Alk.", "MD C Exit End Cell.", "MD D Exit End Total Alk.", "MD D Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.", "Buffer Tank 1 Vis Temp", "Buffer Tank 2 Vis Temp", "Buffer Tank 3 Vis Temp", "Buffer Tank 4 Vis Temp", "Rec Ball Fall", "Rec 1 KW", "Spinning Viscose Ball Fall", "Machine Viscose RI", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %", "Spinning Viscose KW", "Vis Temp", "Flash Delta 2", "Flash Delta 4", "Flash Delta 5"],
            auxiliary: ["MC 3 Spin bath Sp. Gr.", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."],
            spinning: ["Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.", "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC3"]
        },
        "MC5": {
            viscose: ["Steep Lye Alkali %", "Steep Lye Temp.", "MD F Alkali %", "MD F Cellulose %", "MD G Exit End Total Alk.", "MD G Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.", "Churn Blender 1 Vis Temp", "Churn Blender 2 Vis Temp", "Spinning Viscose Ball Fall", "Machine Viscose RI", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %", "Spinning Viscose KW", "Rec Ball Fall", "REC. TK. N3 CKW", "Flash Delta 8", "Flash Delta 9", "Vis Temp"],
            auxiliary: ["MC 5 Spin bath Sp. Gr.", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."],
            spinning: ["Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.", "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC5"]
        },
        "MC6": {
            viscose: ["Steep Lye Alkali %", "Steep Lye Temp.", "MD C Exit End Total Alk.", "MD C Exit End Cell.", "MD D Exit End Total Alk.", "MD D Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.", "Buffer Tank 1 Vis Temp", "Buffer Tank 2 Vis Temp", "Buffer Tank 3 Vis Temp", "Buffer Tank 4 Vis Temp", "Rec 1 KW", "Rec Ball Fall", "Spinning Viscose Ball Fall", "Machine Viscose RI", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %", "Vis Temp", "Flash Delta 2", "Flash Delta 4", "Flash Delta 5", "Spinning Viscose KW"],
            auxiliary: ["MC 6 Spin bath Sp. Gr.", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."],
            spinning: ["Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.", "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC6"]
        }
    };

    const PRODUCT_PARAM_CONFIG = {
        "Modal": ["Brightness", "Whiteness", "Whitness Grade", "Yellow Index", "Wet Lump", "Den Quick", "OPU", "L %", "B %", "Denier Cond", "Denier Cond CV", "Tenacity Cond.", "Tenacity Cond. CV", "Elongation Cond", "Elongation Cond CV", "Wet Denier", "Tenacity Wet", "Elongation Wet", "Shirley Fault Big", "Shirley Fault Small", "Neps", "Sulphur"],
        "Grey_NW": ["Brightness", "Whiteness", "Whitness Grade", "Yellow Index", "Wet Lump", "Den Quick", "OPU", "L %", "B %", "Denier Cond", "Denier Cond CV", "Tenacity Cond.", "Tenacity Cond. CV", "Elongation Cond", "Elongation Cond CV", "Wet Denier", "Tenacity Wet", "Elongation Wet", "Shirley Fault Big", "Shirley Fault Small", "Neps", "Sulphur", "NW Black Particle(</=1 mm)", "NW Black Particle(>1mm)", "NW Fibre Water Holding Cap", "Sinking Time(NW Fibre)"]
    };

    const MC_PRODUCT_MAPPING = {
        "MC2": "stats_Product_Modal",
        "MC3": "stats_Product_Grey",
        "MC5": "stats_Product_NonWoven",
        "MC6": "stats_Product_NonWoven"
    };

    let chartInstances = {};

    // =========================================================
    // 3. UI INITIALIZATION
    // =========================================================
    window.onload = function() {
        const today = new Date();
        // Default to Start of Current Month
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

        // Set format YYYY-MM-DD
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        // Adjust logic: if today is 1st or 2nd day, maybe show last month? 
        // For now, adhere to "Start of Month" rule.
        document.getElementById('startDate').value = startOfMonth.toISOString().split('T')[0];

        updateDropdownOptions();
        updateDashboard();
    };

    function updateDropdownOptions() {
        const mc = document.getElementById('mcFilter').value;
        const procConfig = MACHINE_PROCESS_CONFIG[mc];

        const prodTypeKey = (mc === "MC2") ? "Modal" : "Grey_NW";
        const prodParams = PRODUCT_PARAM_CONFIG[prodTypeKey];

        const fillSelect = (id, items) => {
            const el = document.getElementById(id);
            if (!el) return;
            const currentVal = el.value;
            el.innerHTML = '';
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.text = item;
                el.appendChild(opt);
            });
            if(items.includes(currentVal)) el.value = currentVal;
        };

        // Process Dropdowns
        fillSelect('selProc1', procConfig.viscose);
        fillSelect('selProc2', procConfig.auxiliary);
        fillSelect('selProc3', procConfig.auxiliary);
        fillSelect('selProc4', procConfig.spinning);

        // Product Dropdowns
        if(document.getElementById('selProd1')) fillSelect('selProd1', prodParams);
        if(document.getElementById('selProd2')) fillSelect('selProd2', prodParams);
        if(document.getElementById('selProd3')) fillSelect('selProd3', prodParams);
        if(document.getElementById('selProd4')) fillSelect('selProd4', prodParams);

        // Correlation Dropdowns
        fillSelect('corrY1', [...procConfig.viscose, ...procConfig.auxiliary, ...procConfig.spinning]);
        fillSelect('corrY2', prodParams);
    }

    // =========================================================
    // 4. MAIN UPDATE LOGIC
    // =========================================================
    async function updateDashboard() {
        const mc = document.getElementById('mcFilter').value;
        const btn = document.querySelector('button[onclick="updateDashboard()"]');

        if(btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;
        }

        // Update Labels
        document.getElementById('lblMcProcess').innerText = mc;
        document.getElementById('lblMcProduct').innerText = mc;
        document.getElementById('aiMcContext').innerText = mc;

        updateDropdownOptions();

        try {
            await Promise.all([
                renderPulpSection(mc),  // Updated Pulp Logic
                renderProcessCharts(mc),
                renderProductCharts(mc),
                renderCorrelation(mc)
            ]);
        } catch (e) {
            console.error("Dashboard update error:", e);
        } finally {
            if(btn) {
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                btn.disabled = false;
            }
        }
    }

    // =========================================================
    // 5. PULP LOGIC (UPDATED: Trend & DB Routing)
    // =========================================================

    // Helper to determine Document ID based on Date
    // Logic: Nov 2025 onwards -> 'summary_2025', Before -> 'main_summary'
    function getPulpDocID(year, monthIndex) { // monthIndex 0-11
        if (year > 2025) return 'summary_2025';
        if (year === 2025 && monthIndex >= 10) return 'summary_2025'; // Nov is 10
        return 'main_summary';
    }

    async function renderPulpSection(mc) {
        const container = document.getElementById('pulpSupplierContainer');
        container.innerHTML = '<div class="w-full text-center py-8"><i class="fas fa-circle-notch fa-spin text-orange-500"></i> Loading Pulp Data...</div>';

        // 1. Prepare Dates
        const startDateStr = document.getElementById('startDate').value;
        const endDateStr = document.getElementById('endDate').value;
        const targetSuppliers = MC_SUPPLIER_RULES[mc] || ["ARAUCO", "AVC", "PHOENIX", "AV NACKAWIC"];

        try {
            // 2. Fetch Current Period Data
            const currentData = await fetchPulpStats(startDateStr, endDateStr, targetSuppliers);

            // 3. Fetch Previous Period Data (For Trend Analysis)
            // Logic: Get the month immediately preceding the Start Date
            const sDate = new Date(startDateStr);
            const prevMonthDate = new Date(sDate.getFullYear(), sDate.getMonth() - 1, 1);
            const prevData = await fetchSingleMonthSummary(prevMonthDate, targetSuppliers);

            // 4. Render
            container.innerHTML = ''; 

            targetSuppliers.forEach(supplierName => {
                const curSupData = currentData[supplierName] || {};
                const prevSupData = prevData[supplierName] || {};
                const lotCount = curSupData.lotCount || 0;

                const rowHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="flex items-center gap-3 mb-4 pb-2 border-b border-slate-100">
                            <div class="w-1.5 h-6 bg-orange-500 rounded-full"></div>
                            <h3 class="text-xl font-bold text-slate-700 tracking-wide">${supplierName}</h3>
                            <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-100 ml-auto">
                               ${lotCount > 0 ? `Based on ${lotCount} lots` : 'No COA Data'}
                            </span>
                        </div>
                        <div class="grid grid-cols-5 gap-4">
                            ${renderKPICard(curSupData, prevSupData, 'alpha')}
                            ${renderKPICard(curSupData, prevSupData, 'viscosity')}
                            ${renderKPICard(curSupData, prevSupData, 'whiteness')}
                            ${renderKPICard(curSupData, prevSupData, 'silica')}
                            ${renderKPICard(curSupData, prevSupData, 'calcium')}
                        </div>
                    </div>
                `;
                container.innerHTML += rowHTML;
            });

        } catch (error) {
            console.error("Render Pulp Error:", error);
            container.innerHTML = `<div class="text-red-500 text-center p-4">Error loading pulp data: ${error.message}</div>`;
        }
    }

    function renderKPICard(currData, prevData, paramKey) {
        const config = PULP_PARAM_MAP[paramKey];

        // Current Value
        const val = currData[paramKey];
        const hasData = (val !== null && val !== undefined);
        const displayVal = hasData ? Number(val).toFixed(2) : '-';

        // Previous Value & Trend
        const prevVal = prevData[paramKey];
        const hasPrev = (prevVal !== null && prevVal !== undefined);

        let trendHTML = '<span class="text-slate-300">-</span>';
        let trendColorClass = "text-slate-800"; // Default value color

        if (hasData && hasPrev) {
            const diff = val - prevVal;
            const isHigher = diff > 0;
            const isBetter = (config.type === 'quality' && isHigher) || (config.type === 'impurity' && !isHigher);

            const arrowIcon = isHigher ? 'fa-arrow-up' : 'fa-arrow-down';
            const trendColor = isBetter ? 'text-emerald-500' : 'text-rose-500';

            // Update main value color if significant (optional, keep simple for now)
            // trendColorClass = isBetter ? "text-emerald-700" : "text-rose-700";

            trendHTML = `
                <div class="flex items-center gap-1 ${trendColor} text-[10px] font-bold">
                    <i class="fas ${arrowIcon}"></i>
                    <span>${Math.abs(diff).toFixed(2)}</span>
                </div>
                <span class="text-[9px] text-slate-400 ml-1">vs ${prevVal.toFixed(2)}</span>
            `;
        } else if (hasData && !hasPrev) {
            trendHTML = `<span class="text-[9px] text-slate-400">Prev: N/A</span>`;
        }

        return `
            <div class="flex flex-col p-3 bg-slate-50 rounded-lg border border-slate-100 items-start hover:border-indigo-100 transition h-24 relative group">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">${config.label}</span>
                <div class="flex items-baseline gap-1 mt-auto w-full">
                    <span class="text-2xl font-bold ${trendColorClass} tracking-tight">${displayVal}</span>
                    <span class="text-[10px] text-slate-400 mb-1">${config.unit}</span>
                </div>
                <div class="flex items-center w-full mt-1 h-4">
                    ${trendHTML}
                </div>
            </div>
        `;
    }

    // ---------------------------------------------------------
    //  DATA FETCHING LOGIC (With DB Routing)
    // ---------------------------------------------------------

    // Helper to fetch summary for ONE specific month (used for Previous Month)
    async function fetchSingleMonthSummary(dateObj, targetSuppliers) {
        const year = dateObj.getFullYear();
        const month = dateObj.getMonth(); // 0-11
        const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;

        // Determine Doc
        const docID = getPulpDocID(year, month);

        const results = {};
        targetSuppliers.forEach(s => results[s] = {});

        try {
            const docRef = db.collection("stats_pulp").doc(docID);
            const docSnap = await docRef.get();

            if (docSnap.exists) {
                const data = docSnap.data();
                const incoming = data.pulp_incoming || {};
                const monthData = incoming[monthStr]; // Direct access to month key

                if (monthData) {
                    targetSuppliers.forEach(sup => {
                        // Match supplier key case-insensitive
                        const dbSupKey = Object.keys(monthData).find(k => k.trim().toUpperCase() === sup.trim().toUpperCase());
                        if (dbSupKey) {
                            const rec = monthData[dbSupKey];
                            Object.keys(PULP_PARAM_MAP).forEach(pKey => {
                                const dbKey = PULP_PARAM_MAP[pKey].dbKey;
                                if (rec.params && rec.params[dbKey]) {
                                    results[sup][pKey] = rec.params[dbKey].coa_avg;
                                } else {
                                    results[sup][pKey] = null;
                                }
                            });
                        }
                    });
                }
            }
        } catch (e) {
            console.warn(`Error fetching prev month ${monthStr}:`, e);
        }
        return results;
    }

    // Main Fetcher (Decides Raw vs Summary)
    async function fetchPulpStats(start, end, targetSuppliers) {
        const startD = new Date(start);
        const endD = new Date(end);
        const diffTime = Math.abs(endD - startD);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays <= 60) {
            // Raw Data (rm_pulp_inspections)
            return await fetchRawPulpData(start, end, targetSuppliers);
        } else {
            // Summary Data (stats_pulp)
            return await fetchSummaryPulpData(start, end, targetSuppliers);
        }
    }

    // Fetch Raw (Unchanged logic, just ensure params match)
    async function fetchRawPulpData(startDate, endDate, targetSuppliers) {
        const results = {};
        targetSuppliers.forEach(sup => {
            results[sup] = { lotCount: 0 };
            Object.keys(PULP_PARAM_MAP).forEach(key => {
                results[sup][key + 'Sum'] = 0;
                results[sup][key + 'Count'] = 0;
            });
        });

        try {
            const snapshot = await db.collection('rm_pulp_inspections')
                .where('receivedDate', '>=', startDate)
                .where('receivedDate', '<=', endDate)
                .get();

            snapshot.forEach(doc => {
                const data = doc.data();
                const supplier = data.supplier;
                const matchedSupplier = targetSuppliers.find(s => s.trim().toUpperCase() === supplier.trim().toUpperCase());

                if (matchedSupplier) {
                    results[matchedSupplier].lotCount += 1;
                    Object.keys(PULP_PARAM_MAP).forEach(pKey => {
                        const dbParamKey = PULP_PARAM_MAP[pKey].dbKey;
                        if (data.parameters && data.parameters[dbParamKey]) {
                            const val = parseFloat(data.parameters[dbParamKey].coa);
                            if (!isNaN(val)) {
                                results[matchedSupplier][pKey + 'Sum'] += val;
                                results[matchedSupplier][pKey + 'Count'] += 1;
                            }
                        }
                    });
                }
            });
        } catch (error) {
            console.error("Error fetching raw pulp:", error);
        }

        const finalResult = {};
        targetSuppliers.forEach(sup => {
            finalResult[sup] = { lotCount: results[sup].lotCount };
            Object.keys(PULP_PARAM_MAP).forEach(pKey => {
                const sum = results[sup][pKey + 'Sum'];
                const count = results[sup][pKey + 'Count'];
                finalResult[sup][pKey] = count > 0 ? (sum / count) : null;
            });
        });
        return finalResult;
    }

    // Fetch Summary (Updated to handle doc split inside the loop)
    async function fetchSummaryPulpData(start, end, targetSuppliers) {
        const startD = new Date(start);
        const endD = new Date(end);

        // Generate list of "YYYY-MM" to fetch
        const monthsToFetch = [];
        let cur = new Date(startD);
        // Align to start of month
        cur.setDate(1); 
        while (cur <= endD) {
            const y = cur.getFullYear();
            const m = cur.getMonth();
            monthsToFetch.push({ year: y, month: m, str: `${y}-${String(m+1).padStart(2,'0')}` });
            cur.setMonth(cur.getMonth() + 1);
        }

        const aggregated = {};
        targetSuppliers.forEach(sup => {
            aggregated[sup] = { lotCount: 0 };
            Object.keys(PULP_PARAM_MAP).forEach(k => { 
                aggregated[sup][k + 'Sum'] = 0; 
                aggregated[sup][k + 'Count'] = 0; 
            });
        });

        // Use a cache to avoid re-fetching the same doc for multiple months
        const docCache = {}; 

        for (let mObj of monthsToFetch) {
            const docID = getPulpDocID(mObj.year, mObj.month);

            try {
                if (!docCache[docID]) {
                    docCache[docID] = await db.collection("stats_pulp").doc(docID).get();
                }

                const docSnap = docCache[docID];
                if (docSnap.exists) {
                    const data = docSnap.data();
                    const incoming = data.pulp_incoming || {};
                    const monthData = incoming[mObj.str];

                    if (monthData) {
                        targetSuppliers.forEach(sup => {
                            const dbSupKey = Object.keys(monthData).find(k => k.trim().toUpperCase() === sup.trim().toUpperCase());
                            if (dbSupKey) {
                                const rec = monthData[dbSupKey];
                                aggregated[sup].lotCount += (rec.lot_count || 0);

                                Object.keys(PULP_PARAM_MAP).forEach(pKey => {
                                    const dbKey = PULP_PARAM_MAP[pKey].dbKey;
                                    if (rec.params && rec.params[dbKey]) {
                                        const val = rec.params[dbKey].coa_avg;
                                        const count = rec.params[dbKey].coa_count || rec.lot_count;
                                        if (val !== undefined && val !== null) {
                                            aggregated[sup][pKey + 'Sum'] += (val * count);
                                            aggregated[sup][pKey + 'Count'] += count;
                                        }
                                    }
                                });
                            }
                        });
                    }
                }
            } catch (e) {
                console.error(`Error processing month ${mObj.str}:`, e);
            }
        }

        const finalResult = {};
        targetSuppliers.forEach(sup => {
            if (aggregated[sup].lotCount > 0) {
                finalResult[sup] = { lotCount: aggregated[sup].lotCount };
                Object.keys(PULP_PARAM_MAP).forEach(pKey => {
                    const totalSum = aggregated[sup][pKey + 'Sum'];
                    const totalCount = aggregated[sup][pKey + 'Count'];
                    finalResult[sup][pKey] = (totalCount > 0) ? (totalSum / totalCount) : null;
                });
            }
        });
        return finalResult;
    }

    // =========================================================
    // 6. GENERIC CHART & UTILS (Existing Logic)
    // =========================================================
    async function fetchData(collectionName, machineId, paramName, startDate, endDate) {
        try {
            const snapshot = await db.collection(collectionName)
                .where("machineId", "==", machineId)
                .where("date", ">=", startDate)
                .where("date", "<=", endDate)
                .orderBy("date", "asc")
                .get();
            const labels = [];
            const data = [];
            snapshot.forEach(doc => {
                const docData = doc.data();
                if (docData.stats && docData.stats[paramName]) {
                    labels.push(docData.date);
                    const valObj = docData.stats[paramName];
                    if (typeof valObj.avg === 'number') {
                        data.push(valObj.avg);
                    } else if (valObj.percentages && valObj.percentages['E']) {
                        data.push(valObj.percentages['E']);
                    } else {
                        data.push(null);
                    }
                }
            });
            return { labels, data };
        } catch (error) {
            console.warn(`Fetch error (${paramName}):`, error);
            return { labels: [], data: [] };
        }
    }

    async function renderProcessCharts(mc) {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const procConfig = MACHINE_PROCESS_CONFIG[mc];
        const getCollection = (param) => {
            if(procConfig.viscose.includes(param)) return 'stats_Viscose';
            if(procConfig.auxiliary.includes(param)) return 'stats_Auxiliary';
            return 'stats_Spinning';
        };
        const draw = async (selId, chartId) => {
            const param = document.getElementById(selId).value;
            const d = await fetchData(getCollection(param), mc, param, start, end);
            createLineChart(chartId, param, '#2563eb', d.labels, d.data);
        };
        await draw('selProc1', 'chartProc1');
        await draw('selProc2', 'chartProc2');
        await draw('selProc3', 'chartProc3');
        await draw('selProc4', 'chartProc4');
    }

    async function renderProductCharts(mc) {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const collection = MC_PRODUCT_MAPPING[mc];
        for (let i = 1; i <= 4; i++) {
            const selId = `selProd${i}`;
            const chartId = `chartProd${i}`;
            const el = document.getElementById(selId);
            if(el && el.value) {
                const d = await fetchData(collection, mc, el.value, start, end);
                createLineChart(chartId, el.value, '#10b981', d.labels, d.data);
            }
        }
    }

    async function renderCorrelation(mc) {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const y1Param = document.getElementById('corrY1').value;
        const y2Param = document.getElementById('corrY2').value;

        let d1 = await fetchData('stats_Viscose', mc, y1Param, start, end);
        if(!d1.data.length) d1 = await fetchData('stats_Auxiliary', mc, y1Param, start, end);
        if(!d1.data.length) d1 = await fetchData('stats_Spinning', mc, y1Param, start, end);

        const d2 = await fetchData(MC_PRODUCT_MAPPING[mc], mc, y2Param, start, end);
        const scatterData = [];
        d1.labels.forEach((date, idx) => {
            const idx2 = d2.labels.indexOf(date);
            if (idx2 !== -1 && d1.data[idx] !== null && d2.data[idx2] !== null) {
                scatterData.push({ x: d1.data[idx], y: d2.data[idx2] });
            }
        });

        const ctx = document.getElementById('correlationChart').getContext('2d');
        if (chartInstances['corr']) chartInstances['corr'].destroy();

        chartInstances['corr'] = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Correlation',
                    data: scatterData,
                    backgroundColor: '#4f46e5'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: y1Param } },
                    y: { title: { display: true, text: y2Param } }
                }
            }
        });
    }

    function createLineChart(canvasId, label, color, labels, dataPoints) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

        chartInstances[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: color + '10',
                    borderWidth: 2,
                    pointRadius: 3,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: true } }
            }
        });
    }

    // =========================================================
    // 7. AI CHAT LOGIC
    // =========================================================
    function toggleChat() {
        document.getElementById('chatWindow').classList.toggle('hidden');
    }
    function handleEnter(e) {
        if(e.key === 'Enter') sendChatMessage();
    }
    async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const msg = input.value;
        if(!msg) return;
        const container = document.getElementById('chatMessages');
        container.innerHTML += `<div class="flex justify-end"><div class="chat-bubble-user p-3 shadow-sm max-w-[90%] text-white bg-indigo-600 rounded-l-xl rounded-br-xl">${msg}</div></div>`;
        input.value = '';
        container.scrollTop = container.scrollHeight;

        const loadingId = 'ai-loading-' + Date.now();
        container.innerHTML += `<div id="${loadingId}" class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-white text-slate-500 rounded-r-xl rounded-bl-xl"><i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div>`;
        container.scrollTop = container.scrollHeight;

        try {
            const askAI = functions.httpsCallable('askProductChat');
            const result = await askAI({ question: msg });
            document.getElementById(loadingId).remove();
            let reply = result.data.text.replace(/\n/g, '<br>');
            reply = reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            container.innerHTML += `<div class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-white text-slate-800 rounded-r-xl rounded-bl-xl border border-slate-200">${reply}</div></div>`;
        } catch (error) {
            document.getElementById(loadingId).remove();
            console.error("AI Error:", error);
            container.innerHTML += `<div class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-red-50 text-red-600 border border-red-200">AI Connection Error: ${error.message}</div></div>`;
        }
        container.scrollTop = container.scrollHeight;
    }
    </script>
</body>
</html>