<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC Command Center v3.1 - Optimized & Corrected</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .card-header { @apply flex justify-between items-center mb-3 pb-2 border-b border-slate-100; }
        .kpi-value { @apply text-2xl font-bold text-slate-800; }
        .kpi-label { @apply text-xs text-slate-500 uppercase tracking-wider font-semibold; }
        
        /* Skeleton Loading Animation */
        @keyframes pulse-bg {
            0% { background-color: #e2e8f0; }
            50% { background-color: #f1f5f9; }
            100% { background-color: #e2e8f0; }
        }
        .skeleton {
            animation: pulse-bg 1.5s infinite;
            border-radius: 0.5rem;
            width: 100%;
            height: 100%;
        }
        .chart-container { position: relative; width: 100%; height: 256px; }

        /* Chat UI */
        .chat-bubble-ai { background-color: #ffffff; border: 1px solid #e2e8f0; color: #1e293b; border-radius: 12px 12px 12px 0; }
        .chat-bubble-user { background-color: #4f46e5; color: white; border-radius: 12px 12px 0 12px; }
        
        /* Layout Utilities */
        .section-title { font-size: 0.9rem; font-weight: 700; color: #475569; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 text-white p-3 shadow-md z-30 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded flex items-center justify-center font-bold text-xl shadow-lg">
                TRC
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-wide">Summary Dashboard </h1>
                <p class="text-[10px] text-slate-400">Holistic View: Pulp ‚Ä¢ Process ‚Ä¢ Fibre</p>
            </div>
        </div>

        <div class="flex gap-4 bg-slate-800 p-2 rounded-lg items-center border border-slate-700">
            <div class="flex flex-col">
                <label class="text-[10px] text-slate-400 font-bold uppercase">Select Line (MC)</label>
                <select id="mcFilter" class="bg-slate-700 text-white text-sm font-bold border-none outline-none rounded px-2 py-1 w-40 hover:bg-slate-600 transition" onchange="handleMCChange()">
                    <option value="MC2">MC2 (Modal Fibre)</option>
                    <option value="MC3">MC3 (Non-Woven Fibre)</option>
                    <option value="MC5">MC5 (Grey Fibre)</option>
                    <option value="MC6">MC6 (Non-Woven Fibre)</option>
                </select>
            </div>
            
            <div class="h-8 w-px bg-slate-600 mx-2"></div>

            <div class="flex items-center gap-2">
                <input type="date" id="startDate" class="bg-slate-700 text-white text-xs px-2 py-1 rounded outline-none" onchange="clearCache()">
                <span class="text-slate-500">-</span>
                <input type="date" id="endDate" class="bg-slate-700 text-white text-xs px-2 py-1 rounded outline-none" onchange="clearCache()">
            </div>

            <button onclick="updateDashboard(true)" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded text-sm font-bold transition shadow-lg border border-indigo-400 flex items-center gap-2">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-100">
        
        <section>
            <div class="section-title text-orange-700 flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <i class="fas fa-tree"></i>
                    <span>1. Raw Material Input (COA Analysis)</span>
                </div>
            </div>
            <div id="pulpSupplierContainer" class="flex flex-col gap-4">
                <div class="w-full h-24 bg-white rounded-xl border border-slate-200 flex items-center justify-center">
                    <span class="text-slate-400 text-sm">Initializing...</span>
                </div>
            </div>
        </section>

        <section class="flex flex-col">
            <div class="section-title text-blue-700 flex justify-between mb-2">
                <span><i class="fas fa-cogs"></i> 2. Process Control (<span id="lblMcProcess">MC2</span>)</span>
                <span class="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded border">Impacts Quality Directly</span>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-blue-500 w-full">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-sm font-bold text-blue-800 bg-blue-50 rounded px-2 py-1 outline-none border border-blue-100" id="selProc1" onchange="updateSingleChart('Proc', 1)"></select>
                        </div>
                        <div class="chart-container" id="containerProc1"><canvas id="chartProc1"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-sm font-bold text-blue-800 bg-blue-50 rounded px-2 py-1 outline-none border border-blue-100" id="selProc2" onchange="updateSingleChart('Proc', 2)"></select>
                        </div>
                        <div class="chart-container" id="containerProc2"><canvas id="chartProc2"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-sm font-bold text-blue-800 bg-blue-50 rounded px-2 py-1 outline-none border border-blue-100" id="selProc3" onchange="updateSingleChart('Proc', 3)"></select>
                        </div>
                        <div class="chart-container" id="containerProc3"><canvas id="chartProc3"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-sm font-bold text-blue-800 bg-blue-50 rounded px-2 py-1 outline-none border border-blue-100" id="selProc4" onchange="updateSingleChart('Proc', 4)"></select>
                        </div>
                        <div class="chart-container" id="containerProc4"><canvas id="chartProc4"></canvas></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="flex flex-col" id="part3-quality-section">
            <div class="section-title text-emerald-700 flex flex-wrap md:flex-nowrap justify-between items-center mb-4 gap-2">

                <div class="flex items-center gap-2 shrink-0">
                    <i class="fas fa-tags"></i>
                    <span class="whitespace-nowrap">3. Product Quality & Grade (<span id="lblMcProduct">MC2</span>)</span>
                </div>

                <div class="flex-1 flex justify-center w-full md:w-auto order-last md:order-none px-0 md:px-4">
                    <div class="flex items-center gap-2 bg-emerald-50 px-3 py-1 rounded-lg border border-emerald-100 w-full md:max-w-md shadow-sm">
                        <span class="text-[10px] font-bold text-emerald-800 uppercase whitespace-nowrap"><i class="fas fa-filter mr-1"></i>Material:</span>
                        <select id="materialFilter" onchange="handleMaterialChange()" class="w-full bg-white text-xs font-bold text-slate-700 border border-emerald-200 rounded px-2 py-1 outline-none focus:border-emerald-500 transition cursor-pointer truncate">
                            <option value="ALL">All Materials (Mixed)</option>
                        </select>
                        <span id="matLoading" class="text-[10px] text-emerald-500 hidden"><i class="fas fa-circle-notch fa-spin"></i></span>
                    </div>
                </div>

                <span class="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded border whitespace-nowrap shrink-0">Result of Process</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                 <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-emerald-500 relative overflow-hidden group hover:shadow-md transition">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Excellent (E)</p>
                            <h3 class="text-2xl font-bold text-slate-700 mt-1" id="grade-e-pct">--%</h3>
                        </div>
                        <div class="p-1.5 bg-emerald-100 rounded text-emerald-600"><i class="fas fa-medal"></i></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 z-10 relative">Total: <span id="grade-e-ton" class="font-bold text-slate-600">0</span> Bales</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500 relative overflow-hidden group hover:shadow-md transition">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Standard (ST)</p>
                            <h3 class="text-2xl font-bold text-slate-700 mt-1" id="grade-st-pct">--%</h3>
                        </div>
                        <div class="p-1.5 bg-blue-100 rounded text-blue-600"><i class="fas fa-box"></i></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 z-10 relative">Total: <span id="grade-st-ton" class="font-bold text-slate-600">0</span> Bales</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-yellow-500 relative overflow-hidden group hover:shadow-md transition">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Intermediate (I)</p>
                            <h3 class="text-2xl font-bold text-slate-700 mt-1" id="grade-i-pct">--%</h3>
                        </div>
                        <div class="p-1.5 bg-yellow-100 rounded text-yellow-600"><i class="fas fa-exclamation-triangle"></i></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 z-10 relative">Total: <span id="grade-i-ton" class="font-bold text-slate-600">0</span> Bales</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500 relative overflow-hidden group hover:shadow-md transition">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Off Grade (O)</p>
                            <h3 class="text-2xl font-bold text-slate-700 mt-1" id="grade-o-pct">--%</h3>
                        </div>
                        <div class="p-1.5 bg-red-100 rounded text-red-600"><i class="fas fa-times-circle"></i></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 z-10 relative">Total: <span id="grade-o-ton" class="font-bold text-slate-600">0</span> Bales</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-emerald-500 w-full">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition bg-slate-50/50">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-2 py-1 outline-none border border-emerald-100 max-w-[70%]" id="selProd1" onchange="updateSingleChart('Prod', 1)"></select>
                        </div>
                        <div class="chart-container" id="containerProd1"><canvas id="chartProd1"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition bg-slate-50/50">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-2 py-1 outline-none border border-emerald-100 max-w-[70%]" id="selProd2" onchange="updateSingleChart('Prod', 2)"></select>
                        </div>
                        <div class="chart-container" id="containerProd2"><canvas id="chartProd2"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition bg-slate-50/50">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-2 py-1 outline-none border border-emerald-100 max-w-[70%]" id="selProd3" onchange="updateSingleChart('Prod', 3)"></select>
                        </div>
                        <div class="chart-container" id="containerProd3"><canvas id="chartProd3"></canvas></div>
                    </div>
                    <div class="border rounded p-3 shadow-sm hover:shadow-md transition bg-slate-50/50">
                        <div class="flex justify-between mb-2 items-center">
                            <select class="text-xs font-bold text-emerald-800 bg-emerald-50 rounded px-2 py-1 outline-none border border-emerald-100 max-w-[70%]" id="selProd4" onchange="updateSingleChart('Prod', 4)"></select>
                        </div>
                        <div class="chart-container" id="containerProd4"><canvas id="chartProd4"></canvas></div>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="section-title text-indigo-700 mb-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-project-diagram"></i>
                    <span>4. Correlation Analysis & Root Cause Finder (AI)</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetSection4()" class="px-3 py-1.5 bg-slate-200 text-slate-600 text-xs font-bold rounded hover:bg-slate-300 transition">
                        <i class="fas fa-undo"></i> Reset All
                    </button>
                    <button onclick="analyzeRootCauseAI()" class="px-4 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded hover:bg-indigo-700 transition shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> AI Analyze (Combined)
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md border border-indigo-100 p-6 space-y-8">

                <div class="border-b border-slate-100 pb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <div>
                            <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                                <i class="fas fa-chart-line text-blue-500"></i> A. Trend Analysis (Multi-Parameter)
                            </h2>
                            <p class="text-[10px] text-slate-500">Select multiple inputs to see patterns over time.</p>
                        </div>
                        <button onclick="renderTrendChart()" class="px-3 py-1.5 bg-slate-800 text-white text-xs rounded hover:bg-slate-700 transition font-bold">
                            <i class="fa-solid fa-play"></i> Plot Trend
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div class="lg:col-span-3 space-y-4">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <label class="block text-[10px] font-bold text-slate-700 uppercase mb-2">
                                    Process Inputs (Left Axis)
                                </label>
                                <div class="space-y-1 h-32 overflow-y-auto text-xs" id="correlationInputList">
                                    </div>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <label class="block text-[10px] font-bold text-slate-700 uppercase mb-2">
                                    Target (Right Axis)
                                </label>
                                <select id="corrTrendTarget" class="w-full p-1.5 border rounded bg-white text-xs font-bold text-slate-700 outline-none"></select>
                            </div>
                        </div>
                        <div class="lg:col-span-9">
                            <div class="relative h-64 w-full">
                                <canvas id="chartTrend"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <div>
                            <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                                <i class="fas fa-braille text-indigo-500"></i> B. XY Correlation (Scatter Plot)
                            </h2>
                            <p class="text-[10px] text-slate-500">Check relationship strength between two variables.</p>
                        </div>
                        <div class="flex items-center gap-2 bg-slate-50 p-1.5 rounded border border-slate-200">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">X:</span>
                            <select id="corrScatterX" class="text-xs border rounded p-1 outline-none w-32"></select>
                            <span class="text-[10px] font-bold text-slate-500 uppercase">vs Y:</span>
                            <select id="corrScatterY" class="text-xs border rounded p-1 outline-none w-32"></select>
                            <button onclick="renderScatterChart()" class="ml-2 px-3 py-1 bg-indigo-100 text-indigo-700 text-xs rounded hover:bg-indigo-200 font-bold transition">
                                <i class="fas fa-play"></i> Plot Scatter
                            </button>
                        </div>
                    </div>
                    <div class="relative h-64 w-full flex justify-center bg-slate-50/50 rounded-lg border border-dashed border-slate-200">
                        <canvas id="chartScatter"></canvas>
                    </div>
                </div>

                <div id="aiAnalysisResult" class="hidden bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-slate-800 shadow-inner animate-fade-in">
                    <h4 class="font-bold text-indigo-700 mb-2 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-brain"></i> AI Process Advisor Insight:
                    </h4>
                    <div id="aiTextContent" class="text-sm leading-relaxed whitespace-pre-line bg-white p-4 rounded border border-indigo-100 font-sarabun"></div>
                </div>

            </div>
        </section>
    </div>

    <div class="fixed bottom-6 right-6 z-50">
        <div id="chatWindow" class="hidden bg-white w-96 h-[450px] rounded-xl shadow-2xl border border-slate-200 flex flex-col mb-4 overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-700 to-purple-700 p-3 text-white flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-brain"></i> <span class="font-bold text-sm">TRC Pulp&Fibre Expert AI</span>
                </div>
                <button onclick="toggleChat()" class="hover:text-red-200"><i class="fas fa-times"></i></button>
            </div>
            <div id="chatMessages" class="flex-1 bg-slate-50 p-3 overflow-y-auto space-y-3 text-sm">
                <div class="chat-bubble-ai p-3 shadow-sm max-w-[90%]">
                    ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pulp & Fibre ‡∏Ñ‡∏£‡∏±‡∏ö üè≠ <br>
                    ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á <b><span id="aiMcContext">MC2</span></b>
                    <br><br>
                    <i>‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡πà‡∏ô:</i> "‡∏ó‡∏≥‡πÑ‡∏° Tenacity ‡∏ñ‡∏∂‡∏á‡∏ï‡∏Å ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤?" <br>
                    (‡∏û‡∏¥‡∏°‡∏û‡πå <b>"save"</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI Machine Learning)
                </div>
            </div>
            <div class="p-2 border-t flex gap-2 bg-white">
                <input type="text" id="chatInput" class="flex-1 bg-slate-100 rounded-full px-3 py-1.5 text-sm outline-none border focus:border-indigo-500" placeholder="Ask AI..." onkeypress="handleEnter(event)">
                <button onclick="sendChatMessage()" class="bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-indigo-700"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
        <button onclick="toggleChat()" class="bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl transition transform hover:scale-110">
            <i class="fas fa-comment-dots"></i>
        </button>
    </div>

    <script>
        // =========================================================
        // 1. FIREBASE & CONFIG
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
            authDomain: "lab-trc-management-system.firebaseapp.com",
            projectId: "lab-trc-management-system",
            storageBucket: "lab-trc-management-system.appspot.com",
            messagingSenderId: "43919979160",
            appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.settings({ experimentalForceLongPolling: true });
        const functions = firebase.app().functions('asia-southeast1');

        // CACHE SYSTEM (Optimization)
        let REQUEST_CACHE = {};
        let SHARED_FILTER_TIMELINE = null;
        function clearCache() { 
            REQUEST_CACHE = {}; 
            console.log("Cache cleared");
        }
        
        // --- METADATA CONFIG ---
        const PULP_PARAM_MAP = {
            alpha: { dbKey: "alphaCellulose", label: "Alpha Cellulose", unit: "%", type: 'quality' },
            viscosity: { dbKey: "viscosity", label: "Viscosity (ISO)", unit: "ml/g", type: 'quality' },
            whiteness: { dbKey: "whiteness", label: "Berger Whiteness", unit: "%", type: 'quality' },
            silica: { dbKey: "silica", label: "Acid Insoluble (SiO2)", unit: "ppm", type: 'impurity' },
            calcium: { dbKey: "calcium", label: "Calcium (Ca)", unit: "ppm", type: 'impurity' }
        };
        const MC_SUPPLIER_RULES = {
            "MC2": ["AV NACKAWIC"],
            "MC3": ["ARAUCO", "AV CELL", "PHOENIX"],
            "MC5": ["ARAUCO", "AV CELL", "PHOENIX"],
            "MC6": ["ARAUCO", "AV CELL", "PHOENIX"]
        };
        // Collection Mappings for DAILY data (aggregated)
        const DEPT_COLLECTION_MAP = {
            "Viscose": "stats_Viscose",
            "Auxiliary": "stats_Auxiliary",
            "Spinning": "stats_Spinning"
        };
        const MC_COLLECTION_MAP = {
            "MC2": "Modal",
            "MC5": "Grey",
            "MC3": "NonWoven",
            "MC6": "NonWoven"
        };
        
        const MACHINE_PROCESS_CONFIG = {
            "MC2": {
                viscose: [
                    "Steep Lye Alkali %", "Steep Lye Temp.", "MD E Exit End Total Alk.", "MD E Exit End Cell.",
                    "MCL Conc. gpl%", "MCL Temp.", "Diss. Modal Vis BF", "Buffer Tank 5 Vis Temp",
                    "Buffer Tank 6 Vis Temp", "Buffer Tank 7 Vis Temp", "Modal Rec14 BF",
                    "Spinning Viscose Ball Fall", "Spinning Viscose Gamma no", "Spinning Viscose Alkali %",
                    "Spinning Viscose Cellulose %", "MD 2 Vis Kw", "Flash Delta 6", "Flash Delta 7", "Vis Temp"
                ],
                auxiliary: [
                    "MD 2 Spin bath Na2SO4", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."
                ],
                spinning: [
                    "Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.",
                    "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC2",
                    "HSB Temp", "HSB Acid", "HSB Zn", "HSB Salt"
                ]
            },
            "MC3": {
                viscose: [
                    "Steep Lye Alkali %", "Steep Lye Temp.", "MD C Exit End Total Alk.", "MD C Exit End Cell.",
                    "MD D Exit End Total Alk.", "MD D Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.",
                    "Buffer Tank 1 Vis Temp", "Buffer Tank 2 Vis Temp", "Buffer Tank 3 Vis Temp",
                    "Buffer Tank 4 Vis Temp", "Rec Ball Fall", "Rec 1 KW", "Spinning Viscose Ball Fall",
                    "Machine Viscose RI", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %",
                    "Spinning Viscose KW", "Vis Temp", "Flash Delta 2", "Flash Delta 4", "Flash Delta 5"
                ],
                auxiliary: [
                    "MC 3 Spin bath Sp. Gr.", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."
                ],
                spinning: [
                    "Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.",
                    "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC3"
                ]
            },
            "MC5": {
                viscose: [
                    "Steep Lye Alkali %", "Steep Lye Temp.", "MD F Alkali %", "MD F Cellulose %",
                    "MD G Exit End Total Alk.", "MD G Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.",
                    "Churn Blender 1 Vis Temp", "Churn Blender 2 Vis Temp", "Spinning Viscose Ball Fall",
                    "Machine Viscose RI", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %",
                    "Spinning Viscose KW", "Rec Ball Fall", "REC. TK. N3 CKW", "Flash Delta 8", "Flash Delta 9", "Vis Temp"
                ],
                auxiliary: [
                    "MC 5 Spin bath Sp. Gr.", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."
                ],
                spinning: [
                    "Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.",
                    "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC5"
                ]
            },
            "MC6": {
                viscose: [
                    "Steep Lye Alkali %", "Steep Lye Temp.", "MD C Exit End Total Alk.", "MD C Exit End Cell.",
                    "MD D Exit End Total Alk.", "MD D Exit End Cell.", "MCL Conc. gpl%", "MCL Temp.",
                    "Buffer Tank 1 Vis Temp", "Buffer Tank 2 Vis Temp", "Buffer Tank 3 Vis Temp",
                    "Buffer Tank 4 Vis Temp", "Rec 1 KW", "Rec Ball Fall", "Spinning Viscose Ball Fall",
                    "Machine Viscose RI", "Spinning Viscose Alkali %", "Spinning Viscose Cellulose %",
                    "Vis Temp", "Flash Delta 2", "Flash Delta 4", "Flash Delta 5", "Spinning Viscose KW"
                ],
                auxiliary: [
                    "MC 6 Spin bath Sp. Gr.", "Spin Bath Acid gpl", "Spin Bath ZnSO4 gpl", "Spin Bath Temp."
                ],
                spinning: [
                    "Desulph Bath Conc. gpl", "Desulph Bath Temp.", "Bleach Bath Conc. gpl", "Bleach Bath Temp.",
                    "Soft Finish ER %", "Soft Finish Temp.", "Soft Finish pH", "HEAD TANK TEMP MC6"
                ]
            }
        };
        
        // [UPDATED] Corrected Default Values
        const PROCESS_DEFAULTS = {
            "MC2": ["Spinning Viscose Ball Fall", "Spinning Viscose Gamma no", "Spin Bath ZnSO4 gpl", "Spin Bath Acid gpl"],
            "MC5": ["Spinning Viscose Ball Fall", "Machine Viscose RI", "Spin Bath Acid gpl", "MC 5 Spin bath Sp. Gr."],
            "MC3": ["Spinning Viscose Ball Fall", "Spinning Viscose Alkali %", "Spin Bath Acid gpl", "Bleach Bath Conc. gpl"],
            "MC6": ["Spinning Viscose Ball Fall", "Spinning Viscose Alkali %", "Spin Bath Acid gpl", "Bleach Bath Conc. gpl"]
        };

        // [UPDATED] Expanded Common Options to include Black Particle
        const PRODUCT_RAW_LISTS = {
            "Modal": [
                "Brightness", "Whiteness", "Yellow Index", "Wet Lump", "Den Quick", "OPU",
                "Final Squeeze Roler Moisture", "L %", "B %", "BL %", "Dyeability dL", "Dyeability dE",
                "Denier Cond", "Denier Cond CV", "Denier SD", "Tenacity Cond.", "Tenacity Cond. CV",
                "Tenacity Cond SD", "Young Modulus @ 1%", "Tenacity Cond. At 5%", "Tenacity Cond. At 10%",
                "Elongation Cond", "Elongation Cond CV", "Elongation Cond SD", "Wet Denier", "Wet Denier CV",
                "Tenacity Wet", "Tenacity Wet CV", "Elongation Wet", "Elongation Wet CV", "Tenacity Wet Modulus",
                "Shirley Fault Big", "Shirley Fault Small", "Shirley Fault Spack", "Shirley Fault Weight",
                "Neps", "PH(Chemical)", "Brightbleached", "Alkalinity", "Sulphur", "Quick Diag Eff Length",
                "Forte Moisture", "Good Cross Section %", "FW:Big Fault", "FW:Fused Fiber", "FW:Specks",
                "FW:Total Nos", "FW:Total Wt(mg)"
            ],
            "NW": [
                "Brightness", "Whiteness", "Yellow Index", "Wet Lump", "Den Quick", "OPU",
                "Final Squeeze Roler Moisture", "Big", "Small", "Speck", "Stuck up", "L %", "B %", "BL %",
                "Dyeability dL", "Dyeability dE", "Denier Cond", "Denier Cond CV", "Denier SD",
                "Tenacity Cond.", "Tenacity Cond. CV", "Tenacity Cond SD", "Young Modulus @ 1%",
                "Tenacity Cond. At 5%", "Tenacity Cond. At 10%", "Elongation Cond", "Elongation Cond CV",
                "Elongation Cond SD", "Wet Denier", "Wet Denier CV", "Tenacity Wet", "Tenacity Wet CV",
                "Elongation Wet", "Elongation Wet CV", "Shirley Fault Big", "Shirley Fault Small",
                "Shirley Fault Spack", "Shirley Fault Weight", "Neps", "PH(Chemical)", "Alkalinity", "Sulphur",
                "Quick Diag Eff Length", "Forte Moisture", "% Ash (Semi Dull)", "% Ash (Full Dull)",
                "NW Black Particle(</=1 mm)", "NW Black Particle(>1mm)", "FW:Big Fault", "FW:Fused Fiber",
                "FW:Specks", "FW:Total Nos", "FW:Total Wt(mg)", "NW Fibre Crimp", "NW Fibre Sulphate Ash",
                "NW Fibre Water Soluble Sub", "NW Fibre Ether Soluble Sub", "NW Fibre Water Holding Cap",
                "Sinking Time(NW Fibre)", "Fiber Foam Test(NW Fibre)"
            ],
            "Grey": [
                "Brightness", "Whiteness", "Yellow Index", "Wet Lump", "Den Quick", "OPU",
                "Final Squeeze Roler Moisture", "Big", "Small", "Speck", "Stuck up", "L %", "B %", "BL %",
                "Dyeability dL", "Dyeability dE", "Denier Cond", "Denier Cond CV", "Denier SD",
                "Tenacity Cond.", "Tenacity Cond. CV", "Tenacity Cond SD", "Young Modulus @ 1%",
                "Tenacity Cond. At 5%", "Tenacity Cond. At 10%", "Elongation Cond", "Elongation Cond CV",
                "Elongation Cond SD", "Wet Denier", "Wet Denier CV", "Tenacity Wet", "Tenacity Wet CV",
                "Elongation Wet", "Elongation Wet CV", "Shirley Fault Big", "Shirley Fault Small",
                "Shirley Fault Spack", "Shirley Fault Weight", "Neps", "PH(Chemical)", "Brightbleached",
                "Alkalinity", "Sulphur", "Quick Diag Eff Length", "Forte Moisture", "FW:Big Fault",
                "FW:Fused Fiber", "FW:Specks", "FW:Total Nos", "FW:Total Wt(mg)"
            ]
        };

        // ‡∏£‡∏ß‡∏° NW ‡πÅ‡∏•‡∏∞ Grey ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô (‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≥) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Hybrid (MC3, 5, 6)
        // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ COMMON_NW_OPTS ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤
        const HYBRID_NW_GREY_OPTS = [...new Set([...PRODUCT_RAW_LISTS.NW, ...PRODUCT_RAW_LISTS.Grey])];

        const PRODUCT_PARAM_CONFIG = {
            "MC2": PRODUCT_RAW_LISTS.Modal,
            "MC3": HYBRID_NW_GREY_OPTS, // Hybrid (NW + Grey)
            "MC5": HYBRID_NW_GREY_OPTS, // Hybrid (NW + Grey)
            "MC6": HYBRID_NW_GREY_OPTS  // Hybrid (NW + Grey)
        };

        // [UPDATED] Corrected Default Values (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)
        const PRODUCT_DEFAULTS = {
            "MC2": ["Tenacity Cond.", "Elongation Cond", "FW:Total Nos", "Good Cross Section %"],
            "MC3": ["Whiteness", "FW:Total Nos", "NW Black Particle(</=1 mm)", "NW Black Particle(>1mm)"],
            "MC5": ["Whiteness", "Tenacity Cond.", "Elongation Cond", "FW:Total Nos"],
            "MC6": ["Whiteness", "FW:Total Nos", "NW Black Particle(</=1 mm)", "NW Black Particle(>1mm)"]
        };

        let chartInstances = {};
        
        // =========================================================
        // 2. UI INITIALIZATION
        // =========================================================
        window.onload = function() {
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Helper to get local date string YYYY-MM-DD
            const toLocalISOString = (date) => {
                const offset = date.getTimezoneOffset();
                const localDate = new Date(date.getTime() - (offset*60*1000));
                return localDate.toISOString().split('T')[0];
            };

            document.getElementById('startDate').value = toLocalISOString(startOfMonth);
            document.getElementById('endDate').value = toLocalISOString(today);

            injectGranularityControls();
            handleMCChange();
        };

        function handleMCChange() {
            clearCache(); // New MC means new data

            // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] Reset View Mode to Daily ---
            const dailyRadio = document.querySelector('input[name="granularity"][value="daily"]');
            if (dailyRadio) {
                dailyRadio.checked = true;
            }
            // ------------------------------------------

            //  ‚úÖ  [FIXED] ‡∏™‡∏±‡πà‡∏á Reset Material Filter ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
            const matSelect = document.getElementById('materialFilter');
            if (matSelect) {
                matSelect.value = "ALL"; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô ALL
                // ‡∏•‡πâ‡∏≤‡∏á Option ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô (‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á)
                matSelect.innerHTML = '<option value="ALL">All Materials (Mixed)</option>';
            }

            // ‡∏•‡πâ‡∏≤‡∏á List Material ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢
            if (typeof FOUND_MATERIALS !== 'undefined') FOUND_MATERIALS.clear();

            updateDropdownOptions();
            updateDashboard(true);
        }

        function injectGranularityControls() {
            const headerFilterDiv = document.querySelector('.bg-slate-800');
            if (!headerFilterDiv) return;

            // ‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏î‡∏£‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
            const oldContainer = document.getElementById('viewModeContainer');
            if(oldContainer) oldContainer.remove();

            const container = document.createElement('div');
            container.id = "viewModeContainer"; // ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡πà‡∏≤‡∏¢
            container.className = "flex flex-col ml-4 mr-4";

            container.innerHTML = `
                <label class="text-[10px] text-slate-400 font-bold uppercase mb-1">View Mode</label>
                <div class="flex bg-slate-700 rounded p-0.5">
                    <label class="cursor-pointer">
                        <input type="radio" name="granularity" value="hourly" class="hidden peer">
                        <span class="text-xs font-bold px-3 py-1 rounded text-slate-400 peer-checked:bg-indigo-500 peer-checked:text-white transition block">Hourly</span>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="granularity" value="daily" class="hidden peer" checked>
                        <span class="text-xs font-bold px-3 py-1 rounded text-slate-400 peer-checked:bg-indigo-500 peer-checked:text-white transition block">Daily</span>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="granularity" value="monthly" class="hidden peer">
                        <span class="text-xs font-bold px-3 py-1 rounded text-slate-400 peer-checked:bg-indigo-500 peer-checked:text-white transition block">Monthly</span>
                    </label>
                </div>
            `;

            // Add Event Listeners
            const radios = container.querySelectorAll('input[name="granularity"]');
            radios.forEach(r => r.addEventListener('change', () => {
                clearCache(); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î = ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Cache

                // --- LOGIC ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ---
                if(r.value === 'hourly') {
                    const startDateInput = document.getElementById('startDate');
                    const endDateInput = document.getElementById('endDate');

                    if(startDateInput.value && endDateInput.value) {
                        const s = new Date(startDateInput.value);
                        const e = new Date(endDateInput.value);
                        const diffTime = Math.abs(e - s);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏°? ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏î ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
                        if(diffDays > 7) {
                            const newStart = new Date(e);
                            newStart.setDate(e.getDate() - 7); // ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 7 ‡∏ß‡∏±‡∏ô (‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° 3)

                            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô Timezone
                            const offset = newStart.getTimezoneOffset();
                            const localDate = new Date(newStart.getTime() - (offset*60*1000));
                            startDateInput.value = localDate.toISOString().split('T')[0];

                            alert("Hourly View: ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
                        }
                    }
                }
                updateDashboard(true);
            }));

            const dateInput = document.getElementById('startDate');
            if (dateInput && dateInput.parentElement) {
                headerFilterDiv.insertBefore(container, dateInput.parentElement.previousElementSibling);
            }
        }

        function getGranularity() {
            const radios = document.getElementsByName('granularity');
            for (let r of radios) if (r.checked) return r.value;
            return 'daily';
        }

        function updateDropdownOptions() {
            const mc = document.getElementById('mcFilter').value;
            const procConfig = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            const procDefaults = PROCESS_DEFAULTS[mc];
            const allProcessParams = [...(procConfig.viscose||[]), ...(procConfig.auxiliary||[]), ...(procConfig.spinning||[])];

            // Update Process Dropdowns
            for(let i=1; i<=4; i++) {
                const el = document.getElementById(`selProc${i}`);
                if(el) {
                    el.innerHTML = '';
                    allProcessParams.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item; opt.text = item;
                        el.appendChild(opt);
                    });
                    if(procDefaults && procDefaults[i-1] && allProcessParams.includes(procDefaults[i-1])) {
                        el.value = procDefaults[i-1];
                    }
                }
            }

            // Update Product Dropdowns
            const prodParams = PRODUCT_PARAM_CONFIG[mc] || PRODUCT_PARAM_CONFIG["MC2"];
            const prodDefaults = PRODUCT_DEFAULTS[mc] || prodParams.slice(0, 4);
            for(let i=1; i<=4; i++) {
                const el = document.getElementById(`selProd${i}`);
                if(el) {
                    el.innerHTML = '';
                    prodParams.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item; opt.text = item;
                        el.appendChild(opt);
                    });
                    // Force select default if exists in list
                    if(prodDefaults[i-1] && prodParams.includes(prodDefaults[i-1])) {
                        el.value = prodDefaults[i-1];
                    }
                }
            }
            
            // Update Correlation
            fillSelect('corrY1', allProcessParams);
            fillSelect('corrY2', prodParams);
        }

        function fillSelect(id, items) {
            const el = document.getElementById(id);
            if(el) {
                el.innerHTML = '';
                items.forEach(i => { const o = document.createElement('option'); o.value=i; o.text=i; el.appendChild(o); });
            }
        }
        // [START ADD]: Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Material Filter
        function handleMaterialChange() {
            
            updateDashboard(true);
        }

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Material ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô dropdown ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        let FOUND_MATERIALS = new Set();
        // [END ADD]

        // =========================================================
        // 3. MAIN UPDATE LOGIC (PARALLEL & OPTIMIZED)
        // =========================================================
        async function updateDashboard(manual = false) {
            if(manual) clearCache();

            const mc = document.getElementById('mcFilter').value;
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            const btn = document.querySelector('button[onclick="updateDashboard(true)"]');
            const mode = getGranularity();

            // --- GUARD: DATE RANGE LIMITS ---
            const d1 = new Date(startStr);
            const d2 = new Date(endStr);
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Hourly: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà 7 ‡∏ß‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î)
            if (mode === 'hourly' && diffDays > 7) {
                alert("‚ö†Ô∏è Performance: ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (Hourly) ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 7 ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö \n(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å)");
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü
            }

            // Daily: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà 180 ‡∏ß‡∏±‡∏ô (6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
            if (mode === 'daily' && diffDays > 180) {
                alert("‚ö†Ô∏è Performance: ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily) ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 180 ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            // ... (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
            if(btn) { btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...'; btn.disabled = true; }
            document.getElementById('lblMcProcess').innerText = `${mc} (${mode.toUpperCase()})`;
            document.getElementById('lblMcProduct').innerText = `${mc} (${mode.toUpperCase()})`;
            document.getElementById('aiMcContext').innerText = mc;

                    try {
                        // [STEP 1] ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ Timeline ‡∏Å‡πà‡∏≠‡∏ô
                        SHARED_FILTER_TIMELINE = null;

                        // [STEP 2] ‡πÇ‡∏´‡∏•‡∏î Product (Part 3) ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô! (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï)
                        await renderProductCharts(mc, startStr, endStr, mode);

                        // [STEP 3] ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Product ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î Process (Part 2) 
                        // Process ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ SHARED_FILTER_TIMELINE ‡∏ó‡∏µ‡πà Product ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
                        await Promise.all([
                            renderPulpSection(mc),
                            renderProcessCharts(mc, startStr, endStr, mode),
                            renderCorrelation(mc, startStr, endStr, mode)
                        ]);

                    } catch (e) {
                console.error("Dashboard update error:", e);
            } finally {
                if(btn) { btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh'; btn.disabled = false; }
            }
        }

        // =========================================================
        // 4. DATA FETCHERS (OPTIMIZED WITH CACHE & AGGREGATION)
        // =========================================================
        
        async function getCachedData(key, fetcher) {
            if (REQUEST_CACHE[key]) return REQUEST_CACHE[key];
            const data = await fetcher();
            REQUEST_CACHE[key] = data;
            return data;
        }

        // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á Array ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Master Timeline)
        function generateDateLabels(startStr, endStr, mode) {
            const labels = [];
            const current = new Date(startStr);
            const end = new Date(endStr);

            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 00:00:00 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
            current.setHours(0,0,0,0);
            end.setHours(0,0,0,0);

            while (current <= end) {
                if (mode === 'daily') {
                    // Format YYYY-MM-DD
                    const y = current.getFullYear();
                    const m = String(current.getMonth() + 1).padStart(2, '0');
                    const d = String(current.getDate()).padStart(2, '0');
                    labels.push(`${y}-${m}-${d}`);
                    current.setDate(current.getDate() + 1);
                } else if (mode === 'hourly') {
                     // Format YYYY-MM-DD HH:00
                    const y = current.getFullYear();
                    const m = String(current.getMonth() + 1).padStart(2, '0');
                    const d = String(current.getDate()).padStart(2, '0');
                    for(let h=0; h<24; h++) {
                         labels.push(`${y}-${m}-${d} ${String(h).padStart(2,'0')}:00`);
                    }
                    current.setDate(current.getDate() + 1);
                } else {
                     // Monthly handled separately
                     break;
                }
            }
            return labels;
        }

        // CENTRAL FETCH ROUTER
        async function fetchProcessDataByType(mc, paramName, start, end, mode) {
            const cacheKey = `proc_${mc}_${paramName}_${start}_${end}_${mode}`;
            return await getCachedData(cacheKey, async () => {
                if (mode === 'monthly') return await fetchMonthlyProcessStats(mc, paramName, start, end);
                if (mode === 'daily') return await fetchDailyProcessLogs(mc, paramName, start, end);
                return await fetchHourlyProcessLogs(mc, paramName, start, end);
            });
        }
        async function fetchProductDataByType(mc, paramName, start, end, mode) {
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Material Filter ‡∏•‡∏á‡πÉ‡∏ô Cache Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Cache ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏° Material
            const mat = document.getElementById('materialFilter') ? document.getElementById('materialFilter').value : "ALL";
            const cacheKey = `prod_${mc}_${paramName}_${start}_${end}_${mode}_${mat}`;

            return await getCachedData(cacheKey, async () => {
                if (mode === 'monthly') return await fetchMonthlyProductStats(mc, paramName, start, end);
                if (mode === 'daily') return await fetchDailyProductStats(mc, paramName, start, end); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≤‡∏Å Logs ‡πÄ‡∏õ‡πá‡∏ô Stats
                return await fetchHourlyProductLogs(mc, paramName, start, end); // Hourly ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ Raw Logs
            });
        }

        // --- 1. DAILY FETCHERS (FIXED) ---
        async function fetchDailyProcessLogs(mc, paramName, start, end) {
            const config = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            let category = "Viscose";
            if ((config.auxiliary||[]).includes(paramName)) category = "Auxiliary";
            else if ((config.spinning||[]).includes(paramName)) category = "Spinning";

            const collectionName = DEPT_COLLECTION_MAP[category] || "stats_Viscose";

            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Timeline ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
            const masterLabels = generateDateLabels(start, end, 'daily');
            const dataMap = new Map(); // ‡πÉ‡∏ä‡πâ Map ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß

            try {
                const snapshot = await db.collection(collectionName)
                    .where('machineId', '==', mc)
                    .where('date', '>=', start)
                    .where('date', '<=', end)
                    .get(); // ‡∏ï‡∏±‡∏î orderBy ‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠ performance ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤ match ‡πÉ‡∏ô map ‡πÅ‡∏ó‡∏ô

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(d.stats && d.stats[paramName]) {
                        const s = d.stats[paramName];
                        let avg = s.avg !== undefined ? s.avg : (s.count > 0 ? s.sum/s.count : 0);
                        if(avg !== 0) {
                            dataMap.set(d.date, avg);
                        }
                    }
                });
            } catch(e) { console.warn(`Fetch Daily Process Error`, e); }

            // 2. Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Timeline (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏™‡πà null)
            const finalData = masterLabels.map(dateLabel => {
                return dataMap.has(dateLabel) ? dataMap.get(dateLabel) : null;
            });

            const stats = calculateStats(finalData.filter(v => v !== null)); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Stats ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
            return { labels: masterLabels, data: finalData, avg: stats.avg, cv: stats.cv };
        }

        async function fetchDailyProductStats(mc, paramName, start, end) {
            const productType = MC_COLLECTION_MAP[mc] || "Modal";
            const collectionName = `stats_Product_${productType}`; 
            const selectedMat = document.getElementById('materialFilter') ? document.getElementById('materialFilter').value : "ALL";

            // ‚úÖ [ADDED 1]: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏ã‡πâ‡∏≥‡∏™‡∏∞‡∏™‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
            const firstChartParam = document.getElementById('selProd1') ? document.getElementById('selProd1').value : "";
            if (paramName === firstChartParam) {
                FOUND_MATERIALS.clear();
            }

            const masterLabels = generateDateLabels(start, end, 'daily');
            const dataMap = new Map();

            try {
                const snapshot = await db.collection(collectionName)
                    .where('machineId', '==', mc)
                    .where('date', '>=', start)
                    .where('date', '<=', end)
                    .get();

                snapshot.forEach(doc => {
                    const d = doc.data();
                    let val = null;

                    // -------------------------------------------------------------
                    // ‚úÖ [ADDED 2]: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Material ‡∏à‡∏≤‡∏Å breakdown ‡πÉ‡∏™‡πà Dropdown
                    // -------------------------------------------------------------
                    // ‡πÄ‡∏£‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ materialBreakdown ‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á Key ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
                    if (d.materialBreakdown) {
                        Object.keys(d.materialBreakdown).forEach(matCode => {
                            // ‡∏Å‡∏£‡∏≠‡∏á key ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≠‡∏Å (‡πÄ‡∏ä‡πà‡∏ô _meta)
                            if (matCode !== '_meta') {
                                FOUND_MATERIALS.add(matCode);
                            }
                        });
                    }
                    // -------------------------------------------------------------

                    // CASE 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ALL -> ‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡πÉ‡∏ô d.stats
                    if (selectedMat === "ALL") {
                        if (d.stats && d.stats[paramName]) {
                            val = d.stats[paramName].avg;
                        }
                    } 
                    // CASE 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Material Specific -> ‡πÄ‡∏à‡∏≤‡∏∞‡∏î‡∏π‡πÉ‡∏ô d.materialBreakdown
                    else {
                        if (d.materialBreakdown && d.materialBreakdown[selectedMat]) {
                            const matStats = d.materialBreakdown[selectedMat];
                            if (matStats[paramName]) {
                                val = matStats[paramName].avg;
                            }
                        }
                    }

                    if (val !== null && val !== undefined) {
                        dataMap.set(d.date, Number(val));
                    }
                });
            } catch (e) {
                console.warn("Fetch Daily Product Stats Error", e);
            }

            // ‚úÖ [ADDED 3]: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI Dropdown ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (paramName === firstChartParam) {
                updateMaterialDropdownUI();
            }

            const finalData = masterLabels.map(label => dataMap.has(label) ? dataMap.get(label) : null);
            const validData = finalData.filter(v => v !== null);
            const stats = calculateStats(validData);

            return { labels: masterLabels, data: finalData, avg: stats.avg, cv: stats.cv };
        }

        // --- 2. MONTHLY FETCHERS (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Å‡πá‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ) ---
        // (‡∏Ç‡∏≠‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Code ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠ Daily)
        async function fetchMonthlyProcessStats(mc, paramName, start, end) {
             // ... (‡πÉ‡∏ä‡πâ Code ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö) ...
            const config = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            let category = "Viscose";
            if ((config.auxiliary||[]).includes(paramName)) category = "Auxiliary";
            else if ((config.spinning||[]).includes(paramName)) category = "Spinning";
            const collectionName = `${DEPT_COLLECTION_MAP[category]}_Monthly`;
            const labels = [], dataPoints = [];
            let weightedCV = 0;
            try {
                const startM = start.substring(0,7); const endM = end.substring(0,7);
                const snapshot = await db.collection(collectionName)
                    .where('machineId', '==', mc)
                    .where('month', '>=', startM)
                    .where('month', '<=', endM)
                    .orderBy('month', 'asc').get();
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(d.stats && d.stats[paramName]) {
                        const s = d.stats[paramName];
                        let avg = s.avg !== undefined ? s.avg : (s.count > 0 ? s.sum/s.count : 0);
                        labels.push(d.month);
                        dataPoints.push(avg);
                        if(s.sumSq && s.count > 0) {
                            const variance = (s.sumSq/s.count) - (avg*avg);
                            const sd = Math.sqrt(Math.max(0, variance));
                            const cv = avg !== 0 ? (sd/avg)*100 : 0;
                            weightedCV = cv;
                        }
                    }
                });
            } catch(e) { console.warn("Monthly Process Error", e); }
            return { labels, data: dataPoints, cv: weightedCV };
        }

        async function fetchMonthlyProductStats(mc, paramName, start, end) {
            const productType = MC_COLLECTION_MAP[mc] || "Modal";
            const selectedMat = document.getElementById('materialFilter') ? document.getElementById('materialFilter').value : "ALL";
            const collectionName = `stats_Product_${productType}_Monthly`;

            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á List ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (YYYY-MM)
            let [startYear, startMonth] = start.split('-').map(Number);
            let [endYear, endMonth] = end.split('-').map(Number);
            const monthsToFetch = [];

            let currY = startYear;
            let currM = startMonth;
            while (currY < endYear || (currY === endYear && currM <= endMonth)) {
                const mStr = `${currY}-${String(currM).padStart(2, '0')}`;
                monthsToFetch.push(mStr);
                currM++;
                if (currM > 12) { currM = 1; currY++; }
            }

            const labels = [];
            const dataPoints = [];

            // Helper: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Avg (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ô DB ‡πÑ‡∏°‡πà‡∏°‡∏µ field avg)
            const findAndCalculateAvg = (statsObj, searchKey) => {
                if (!statsObj) return null;

                // 1. Normal Search
                let targetData = statsObj[searchKey];

                // 2. Smart Search (‡∏ï‡∏±‡∏î‡∏à‡∏∏‡∏î ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á) ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞
                if (!targetData) {
                    const cleanSearch = searchKey.toLowerCase().replace(/[^a-z0-9]/g, "");
                    const foundKey = Object.keys(statsObj).find(k => 
                        k.toLowerCase().replace(/[^a-z0-9]/g, "") === cleanSearch
                    );
                    if (foundKey) targetData = statsObj[foundKey];
                }

                // 3. Calculate Average (Sum / Count)
                if (targetData) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ field avg ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
                    if (targetData.avg !== undefined) return Number(targetData.avg);

                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ avg ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏≠‡∏á‡∏à‡∏≤‡∏Å sum / count (‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ Database ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
                    if (targetData.sum !== undefined && targetData.count > 0) {
                        return Number(targetData.sum) / Number(targetData.count);
                    }
                }

                return null;
            };

            try {
                // CASE 1: ALL (Main Collection)
                if (selectedMat === "ALL") {
                    const startM = monthsToFetch[0];
                    const endM = monthsToFetch[monthsToFetch.length - 1];

                    const snapshot = await db.collection(collectionName)
                        .where('machineId', '==', mc)
                        .where('month', '>=', startM)
                        .where('month', '<=', endM)
                        .orderBy('month', 'asc').get();

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const val = findAndCalculateAvg(d.stats, paramName); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Avg
                        if (val !== null) {
                            labels.push(d.month);
                            dataPoints.push(Number(val)); // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏Å‡∏£‡∏≤‡∏ü
                        }
                    });
                } 
                // CASE 2: Specific Material (Subcollection) - ‡∏ß‡∏¥‡πà‡∏á‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏´‡∏¢‡∏¥‡∏ö
                else {
                    const promises = monthsToFetch.map(async (monthId) => {
                        const docId = `${mc}_${monthId}`;
                        const matDocRef = db.collection(collectionName)
                                            .doc(docId)
                                            .collection('materials')
                                            .doc(selectedMat);

                        const snap = await matDocRef.get();
                        return { month: monthId, snap: snap };
                    });

                    const results = await Promise.all(promises);

                    results.forEach(({ month, snap }) => {
                        if (snap.exists) {
                            const d = snap.data();
                            // ‡πÉ‡∏ô Subcollection ‡∏Å‡πá‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô field 'stats' ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
                            const val = findAndCalculateAvg(d.stats, paramName); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Avg

                            if (val !== null) {
                                labels.push(month);
                                dataPoints.push(Number(val));
                            }
                        }
                    });
                }

            } catch (e) {
                console.warn("Fetch Monthly Product Error", e);
            }

            const stats = calculateStats(dataPoints);
            return { labels, data: dataPoints, avg: stats.avg };
        }


        // --- 3. HOURLY FETCHERS (FIXED) ---
        async function fetchHourlyProcessLogs(mc, paramName, start, end) {
            const config = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            let category = "Viscose";
            if ((config.auxiliary||[]).includes(paramName)) category = "Auxiliary";
            else if ((config.spinning||[]).includes(paramName)) category = "Spinning";

            const masterLabels = generateDateLabels(start, end, 'hourly');
            const dataMap = new Map();

            try {
                const snapshot = await db.collection('process_raw_logs')
                    .where('machineId', '==', mc)
                    .where('date', '>=', start).where('date', '<=', end)
                    .get();

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(!d.data) return;
                    let target = d.data[category] || d.data[category.toLowerCase()];
                    if(target && target[paramName]) {
                        const valArr = target[paramName];
                        for(let h=0; h<24; h++) {
                            const val = valArr[h];
                            if(val !== undefined && val !== null && val !== "") {
                                // Key format: YYYY-MM-DD HH:00
                                const key = `${d.date} ${String(h).padStart(2,'0')}:00`;
                                dataMap.set(key, Number(val));
                            }
                        }
                    }
                });
            } catch(e) { console.warn("Hourly Process Error", e); }

            const finalData = masterLabels.map(label => dataMap.has(label) ? dataMap.get(label) : null);
            const stats = calculateStats(finalData.filter(v => v !== null));
            return { labels: masterLabels, data: finalData, avg: stats.avg, cv: stats.cv };
        }

        async function fetchHourlyProductLogs(mc, paramName, start, end) {
            const targetCategory = MC_COLLECTION_MAP[mc] || "Modal";
            const masterLabels = generateDateLabels(start, end, 'hourly');
            const dataMap = new Map();

            try {
                const snapshot = await db.collection('product_raw_logs')
                    .where('machineId', '==', mc)
                    .where('date', '>=', start).where('date', '<=', end)
                    .get();

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(!d.data) return;
                    let target = d.data[targetCategory] || d.data["Modal"];
                    if(target && target[paramName]) {
                        for(let h=0; h<24; h++) {
                            const val = target[paramName][h];
                            if(val !== undefined && val !== null && val !== "") {
                                const key = `${d.date} ${String(h).padStart(2,'0')}:00`;
                                dataMap.set(key, Number(val));
                            }
                        }
                    }
                });
            } catch(e) { console.warn("Hourly Product Error", e); }

            const finalData = masterLabels.map(label => dataMap.has(label) ? dataMap.get(label) : null);
            const stats = calculateStats(finalData.filter(v => v !== null));
            return { labels: masterLabels, data: finalData, avg: stats.avg };
        }

        // Utils
        function calculateStats(arr) {
            const n = arr.length;
            if(n===0) return { avg:0, cv:0 };
            const mean = arr.reduce((a,b)=>a+b,0)/n;
            const variance = arr.reduce((a,b)=>a+Math.pow(b-mean,2),0)/n;
            const cv = mean!==0 ? (Math.sqrt(variance)/mean)*100 : 0;
            return { avg: mean, cv: cv };
        }
        function compressDataOnly(labels, data) {
            const cleanLabels = [];
            const cleanData = [];
            for (let i = 0; i < labels.length; i++) {
                // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Null, Undefined ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
                if (data[i] !== null && data[i] !== undefined && data[i] !== "") {
                    cleanLabels.push(labels[i]);
                    cleanData.push(data[i]);
                }
            }
            return { labels: cleanLabels, data: cleanData };
        }
        function getPreviousPeriodDates(startStr, endStr) {
            const dStart = new Date(startStr);
            const dEnd = new Date(endStr);
            dStart.setMonth(dStart.getMonth()-1);
            dEnd.setMonth(dEnd.getMonth()-1);
            return { start: dStart.toISOString().split('T')[0], end: dEnd.toISOString().split('T')[0] };
        }

        // =========================================================
        // 5. CHART RENDERING (PARALLEL)
        // =========================================================
        
        async function renderProcessCharts(mc, start, end, mode) {
            const prevPeriod = getPreviousPeriodDates(start, end);
            const promises = [];
            
            // Push all 4 charts to promise array
            for(let i=1; i<=4; i++) {
                promises.push(updateSingleChart('Proc', i, mc, start, end, mode, prevPeriod));
            }
            await Promise.all(promises);
        }

        async function renderProductCharts(mc, start, end, mode) {
            const prevPeriod = getPreviousPeriodDates(start, end);
            
            // 1. Grade Summary (Parallel with Charts)
            const gradePromise = fetchAndRenderGrades(mc, start, end, mode);
            
            // 2. Charts
            const chartPromises = [];
            for(let i=1; i<=4; i++) {
                chartPromises.push(updateSingleChart('Prod', i, mc, start, end, mode, prevPeriod));
            }
            
            await Promise.all([gradePromise, ...chartPromises]);
        }

        // Unified Update Function
        async function updateSingleChart(type, index, mc, start, end, mode, prevPeriod) {
            // If args missing (called from dropdown change), refill them
            if(!mc) {
                mc = document.getElementById('mcFilter').value;
                start = document.getElementById('startDate').value;
                end = document.getElementById('endDate').value;
                mode = getGranularity();
                prevPeriod = getPreviousPeriodDates(start, end);
            }

            const selId = `sel${type}${index}`;
            const chartId = `chart${type}${index}`;
            const containerId = `container${type}${index}`;
            const el = document.getElementById(selId);
            const container = document.getElementById(containerId);
            
            if (!el || !el.value) return;
            const param = el.value;

            // Show Skeleton
            if(container) {
                const existingCanvas = container.querySelector('canvas');
                existingCanvas.style.opacity = '0.3';
                let skel = container.querySelector('.skeleton');
                if(!skel) {
                    skel = document.createElement('div');
                    skel.className = 'skeleton absolute top-0 left-0 z-10';
                    container.appendChild(skel);
                }
            }
            
            el.disabled = true;

            try {
                let result, prevResult;
                
                // Parallel Fetch Current vs Previous
                    if (type === 'Proc') {
                        [result, prevResult] = await Promise.all([
                            fetchProcessDataByType(mc, param, start, end, mode),
                            fetchProcessDataByType(mc, param, prevPeriod.start, prevPeriod.end, mode)
                        ]);

                        // [NEW] Logic Sync Process -> Product
                        let finalLabels = result.labels;
                        let finalData = result.data;

                        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Timeline ‡∏à‡∏≤‡∏Å Product ‡∏™‡πà‡∏á‡∏°‡∏≤ (‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á Material ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)
                        if (SHARED_FILTER_TIMELINE && SHARED_FILTER_TIMELINE.length > 0) {
                            const targetLabels = SHARED_FILTER_TIMELINE;
                            const procMap = new Map();
                            // Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Process ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
                            result.labels.forEach((l, i) => procMap.set(l, result.data[i]));

                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡πÄ‡∏ß‡∏•‡∏≤" ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Product ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                            finalData = targetLabels.map(t => procMap.has(t) ? procMap.get(t) : null);
                            finalLabels = targetLabels;
                        }

                        updateProcessStabilityBadge(selId, result.cv, prevResult.cv, false);
                        // ‡πÉ‡∏ä‡πâ finalLabels ‡πÅ‡∏•‡∏∞ finalData ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏•‡πá‡∏≠‡∏ï
                        createDynamicLineChart(chartId, param, '#2563eb', finalLabels, finalData, mode);

                    } else {
                    [result, prevResult] = await Promise.all([
                        fetchProductDataByType(mc, param, start, end, mode),
                        fetchProductDataByType(mc, param, prevPeriod.start, prevPeriod.end, mode)
                    ]);

                    // [EDITED] ‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏≤‡∏ü Product (Part 3)
                    const compressed = compressDataOnly(result.labels, result.data);

                    // [NEW] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Timeline ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ Process (Part 2) ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à) ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢
                    if (compressed.labels.length > 0 && !SHARED_FILTER_TIMELINE) {
                        SHARED_FILTER_TIMELINE = compressed.labels;
                    }

                    updateProcessStabilityBadge(selId, result.avg, prevResult.avg, true);
                    createDynamicLineChart(chartId, param, '#10b981', compressed.labels, compressed.data, mode);
                }
            } catch (e) {
                console.error(`Chart ${type}${index} Error`, e);
            } finally {
                // Remove Skeleton
                if(container) {
                    const skel = container.querySelector('.skeleton');
                    if(skel) skel.remove();
                    const existingCanvas = container.querySelector('canvas');
                    existingCanvas.style.opacity = '1';
                }
                el.disabled = false;
            }
        }

        // =========================================================
        // 6. GRADE & AUXILIARY LOGIC
        // =========================================================
        async function fetchAndRenderGrades(mc, start, end, mode) {
            const productType = MC_COLLECTION_MAP[mc] || "Modal";
            const selectedMat = document.getElementById('materialFilter') ? document.getElementById('materialFilter').value : "ALL";
            const collectionName = `stats_Product_${productType}`; // Base name

            let gradeCounts = { E: 0, ST: 0, I: 0, O: 0 };
            const gradeFields = ["Over All Grade", "Length Grade", "Grade"];

            try {
                // --- MODE: MONTHLY ---
                if (mode === 'monthly') {
                    const startM = start.substring(0, 7);
                    const endM = end.substring(0, 7);
                    const monthlyColName = `${collectionName}_Monthly`;

                    if (selectedMat === "ALL") {
                        // ... (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á ALL) ...
                        const snapshot = await db.collection(monthlyColName)
                            .where('machineId', '==', mc)
                            .where('month', '>=', startM).where('month', '<=', endM).get();
                        snapshot.forEach(doc => processGradeDoc(doc.data(), "stats")); // Helper
                    } else {
                        // ‚úÖ [UPDATED] ‡πÉ‡∏ä‡πâ Direct Fetch ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
                        let current = new Date(start);
                        const endDate = new Date(end);
                        const monthsToFetch = [];
                        while (current <= endDate) {
                            const mStr = current.toISOString().slice(0, 7);
                            if(!monthsToFetch.includes(mStr)) monthsToFetch.push(mStr);
                            current.setMonth(current.getMonth() + 1);
                        }
                        if(!monthsToFetch.includes(endM)) monthsToFetch.push(endM);

                        const promises = monthsToFetch.map(monthId => 
                            db.collection(monthlyColName)
                              .doc(`${mc}_${monthId}`)
                              .collection('materials')
                              .doc(selectedMat)
                              .get()
                        );

                        const snapshots = await Promise.all(promises);
                        snapshots.forEach(snap => {
                            if(snap.exists) processGradeDoc(snap.data(), "stats");
                        });
                    }
                } 
                // --- MODE: DAILY ---
                else {
                     // ... (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á Daily) ...
                     const snapshot = await db.collection(collectionName)
                        .where('machineId', '==', mc)
                        .where('date', '>=', start).where('date', '<=', end).get();

                     snapshot.forEach(doc => {
                         const targetKey = (selectedMat === "ALL") ? "stats" : "materialBreakdown";
                         const d = doc.data();
                         if (selectedMat !== "ALL") {
                             // ‡πÄ‡∏à‡∏≤‡∏∞ Breakdown
                             if (d.materialBreakdown && d.materialBreakdown[selectedMat]) {
                                 processGradeStats(d.materialBreakdown[selectedMat]);
                             }
                         } else {
                             processGradeDoc(d, "stats");
                         }
                     });
                }

                // --- Helper Functions ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Code ‡∏ã‡πâ‡∏≥) ---
                function processGradeDoc(data, keyName) {
                    if(data[keyName]) processGradeStats(data[keyName]);
                }
                function processGradeStats(statsObj) {
                    for (const f of gradeFields) {
                        if (statsObj[f] && statsObj[f].counts) {
                            const c = statsObj[f].counts;
                            gradeCounts.E += (c.E || 0);
                            gradeCounts.ST += (c.ST || 0);
                            gradeCounts.I += (c.I || 0);
                            gradeCounts.O += (c.O || 0);
                            break;
                        }
                    }
                }

                // Render UI (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                const total = gradeCounts.E + gradeCounts.ST + gradeCounts.I + gradeCounts.O;
                ['E', 'ST', 'I', 'O'].forEach(g => {
                    const elPct = document.getElementById(`grade-${g.toLowerCase()}-pct`);
                    const elTon = document.getElementById(`grade-${g.toLowerCase()}-ton`);
                    if (elPct) {
                        const pct = total > 0 ? ((gradeCounts[g] / total) * 100).toFixed(1) : "0.0";
                        elPct.innerText = `${pct}%`;
                        // Color Logic
                        if(g==='E') elPct.className = `text-2xl font-bold ${pct >= 90 ? 'text-emerald-600' : 'text-yellow-600'}`;
                    }
                    if (elTon) elTon.innerText = gradeCounts[g].toLocaleString();
                });

            } catch (e) { console.error("Grade Error:", e); }
        }

        const LOWER_IS_BETTER_KEYWORDS = [
            "FW:", "NW Black", "Neps", "Wet Lump", "Stuck up", "Speck", 
            "Sulphur", "Ash", "Silica", "Calcium", "Iron", "CV", "SD" 
            // CV ‡πÅ‡∏•‡∏∞ SD ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô ‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏¢‡∏¥‡πà‡∏á‡∏ô‡∏¥‡πà‡∏á (‡∏î‡∏µ)
        ];

        function updateProcessStabilityBadge(selectId, currentVal, prevVal, isProduct = false) {
            const selectEl = document.getElementById(selectId);
            if(!selectEl) return;

            // 1. ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ Parameter ‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ß‡∏Å "‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏î‡∏µ" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const paramName = selectEl.value || "";
            const isLowerBetter = LOWER_IS_BETTER_KEYWORDS.some(k => paramName.includes(k));

            const parent = selectEl.parentElement;
            const oldBadge = parent.querySelector('.stability-badge');
            if(oldBadge) oldBadge.remove();

            if (currentVal === undefined || currentVal === null) return;

            let baseColor = isProduct ? "emerald" : "indigo";
            let bgColorClass = `bg-${baseColor}-50 border-${baseColor}-200 text-${baseColor}-700`;
            let comparisonHtml = '';

            if (prevVal !== undefined && prevVal !== null && prevVal > 0) {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á (Absolute Difference)
                const diff = currentVal - prevVal;

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏®‡∏£ (‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏á ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á)
                const arrowIcon = diff > 0 ? 'fa-arrow-up' : 'fa-arrow-down';

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ (Meaningful Color)
                let isGood = false;
                if (isLowerBetter) {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ß‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢: ‡∏•‡∏î‡∏•‡∏á (diff < 0) ‡∏Ñ‡∏∑‡∏≠‡∏î‡∏µ
                    isGood = diff < 0; 
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ß‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (diff > 0) ‡∏Ñ‡∏∑‡∏≠‡∏î‡∏µ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≤‡∏ß, ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
                    isGood = diff > 0;
                }

                // ‡∏î‡∏µ = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡πÅ‡∏¢‡πà = ‡πÅ‡∏î‡∏á
                const trendColor = isGood ? 'text-emerald-600' : 'text-rose-600';

                comparisonHtml = `
                    <div class="flex items-center gap-1 ml-2 ${trendColor} border-l border-slate-200 pl-2">
                        <i class="fas ${arrowIcon} text-[8px]"></i>
                        <span class="text-[9px] font-bold">${Math.abs(diff).toFixed(2)}</span>
                    </div>
                    <span class="text-[8px] text-slate-400 ml-1">vs ${prevVal.toFixed(2)}</span>
                `;
            } else {
                comparisonHtml = `<span class="text-[8px] text-slate-400 ml-2">Prev: -</span>`;
            }

            const badgeHtml = `
                <div class="stability-badge flex items-center px-2 py-0.5 rounded border ${bgColorClass} ml-auto shadow-sm transition-all duration-300">
                    <span class="text-[10px] font-bold text-slate-700">${isProduct?'Avg':'%CV'} ${currentVal.toFixed(2)}</span>
                    ${comparisonHtml}
                </div>
            `;
            selectEl.insertAdjacentHTML('afterend', badgeHtml);
        }

        // =========================================================
        // 7. PULP SECTION (Kept mostly original but optimized)
        // =========================================================
        function getPulpDocID(year, monthIndex) {
            if (year > 2025) return 'summary_2025';
            if (year === 2025 && monthIndex >= 10) return 'summary_2025';
            return 'main_summary';
        }

        // Function 1: Render ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å stats_pulp)
        async function renderPulpSection(mc) {
            const container = document.getElementById('pulpSupplierContainer');
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            const suppliers = MC_SUPPLIER_RULES[mc] || ["ARAUCO", "AVC", "PHOENIX", "AV NACKAWIC"];

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Compare)
            const sDate = new Date(startStr);
            const prevMonthDate = new Date(sDate.getFullYear(), sDate.getMonth() - 1, 1);

            container.innerHTML = '<div class="w-full text-center py-8"><i class="fas fa-circle-notch fa-spin text-orange-500"></i> Loading Pulp Data...</div>';

            try {
                // Parallel Fetch: 
                // 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Raw (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                // 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Stats Summary (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)
                const [currentData, prevData] = await Promise.all([
                    fetchRawPulpData(startStr, endStr, suppliers),
                    fetchSingleMonthSummaryPulp(prevMonthDate, suppliers)
                ]);

                container.innerHTML = '';
                if(Object.keys(currentData).length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-400 py-4">No Pulp Data Found</div>';
                    return;
                }

                suppliers.forEach(sup => {
                    const data = currentData[sup];
                    const prev = prevData[sup] || {}; 

                    if(!data || data.lotCount === 0) return;

                    // True = ‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏î‡∏µ (Alpha, Visc, White), False = ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏î‡∏µ (Silica, Ca)
                    const row = `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                            <div class="flex items-center gap-3 mb-4 pb-2 border-b border-slate-100">
                                <div class="w-1.5 h-6 bg-orange-500 rounded-full"></div>
                                <h3 class="text-xl font-bold text-slate-700 tracking-wide">${sup}</h3>
                                <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-100 ml-auto">${data.lotCount} lots</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                ${renderPulpCard("Alpha", data.alpha, prev.alpha, "%", true)}
                                ${renderPulpCard("Viscosity", data.viscosity, prev.viscosity, "ml/g", true)}
                                ${renderPulpCard("Whiteness", data.whiteness, prev.whiteness, "%", true)}
                                ${renderPulpCard("Silica", data.silica, prev.silica, "ppm", false)}
                                ${renderPulpCard("Calcium", data.calcium, prev.calcium, "ppm", false)}
                            </div>
                        </div>`;
                    container.innerHTML += row;
                });
            } catch(e) {
                console.error("Render Pulp Error:", e);
                container.innerHTML = '<div class="text-red-500 text-center">Error loading pulp data</div>';
            }
        }

        // Function 2: ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        function renderPulpCard(label, val, prevVal, unit, isHigherBetter) {
            let trendHtml = '<span class="text-[9px] text-slate-300 mt-1">Prev: -</span>';
            let valColor = "text-slate-800";

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ prevVal ‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô null/undefined)
            if (val !== null && prevVal !== null && prevVal !== undefined) {
                const diff = val - prevVal;
                const isUp = diff > 0;
                // ‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏µ: Quality (‡∏Ç‡∏∂‡πâ‡∏ô=‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß), Impurity (‡∏Ç‡∏∂‡πâ‡∏ô=‡πÅ‡∏î‡∏á)
                const isGood = isHigherBetter ? isUp : !isUp;

                const color = isGood ? "text-emerald-500" : "text-rose-500";
                const icon = isUp ? "fa-arrow-up" : "fa-arrow-down";

                trendHtml = `
                    <div class="flex items-center gap-1 ${color} text-[10px] font-bold mt-1">
                        <i class="fas ${icon}"></i>
                        <span>${Math.abs(diff).toFixed(2)}</span>
                        <span class="text-[9px] text-slate-400 font-normal ml-1">vs ${prevVal.toFixed(2)}</span>
                    </div>
                `;
            }

            return `
                <div class="flex flex-col p-3 bg-slate-50 rounded-lg border border-slate-100 items-start h-24 relative group hover:border-indigo-100 transition">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">${label}</span>
                    <div class="flex items-baseline gap-1 mt-auto w-full">
                        <span class="text-2xl font-bold ${valColor}">${val ? val.toFixed(2) : '-'}</span>
                        <span class="text-[10px] text-slate-400">${unit}</span>
                    </div>
                    ${trendHtml}
                </div>`;
        }

        // Function 3: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å Raw (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        async function fetchRawPulpData(start, end, suppliers) {
            const results = {};
            suppliers.forEach(s => { results[s] = { lotCount:0, alphaSum:0, alphaCnt:0, viscositySum:0, viscosityCnt:0, whitenessSum:0, whitenessCnt:0, silicaSum:0, silicaCnt:0, calciumSum:0, calciumCnt:0 }; });

            const snapshot = await db.collection('rm_pulp_inspections')
                .where('receivedDate', '>=', start).where('receivedDate', '<=', end).get();

            snapshot.forEach(doc => {
                const d = doc.data();
                // Match Supplier ‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà)
                const s = suppliers.find(sup => sup.trim().toUpperCase() === (d.supplier||"").trim().toUpperCase());
                if(s && d.parameters) {
                    results[s].lotCount++;
                    const p = d.parameters;
                    if(p.alphaCellulose?.coa) { results[s].alphaSum += Number(p.alphaCellulose.coa); results[s].alphaCnt++; }
                    if(p.viscosity?.coa) { results[s].viscositySum += Number(p.viscosity.coa); results[s].viscosityCnt++; }
                    if(p.whiteness?.coa) { results[s].whitenessSum += Number(p.whiteness.coa); results[s].whitenessCnt++; }
                    if(p.silica?.coa) { results[s].silicaSum += Number(p.silica.coa); results[s].silicaCnt++; }
                    if(p.calcium?.coa) { results[s].calciumSum += Number(p.calcium.coa); results[s].calciumCnt++; }
                }
            });

            const final = {};
            suppliers.forEach(s => {
                const r = results[s];
                final[s] = {
                    lotCount: r.lotCount,
                    alpha: r.alphaCnt ? r.alphaSum/r.alphaCnt : null,
                    viscosity: r.viscosityCnt ? r.viscositySum/r.viscosityCnt : null,
                    whiteness: r.whitenessCnt ? r.whitenessSum/r.whitenessCnt : null,
                    silica: r.silicaCnt ? r.silicaSum/r.silicaCnt : null,
                    calcium: r.calciumCnt ? r.calciumSum/r.calciumCnt : null
                };
            });
            return final;
        }

        // Function 4: [RESTORED] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Prev) ‡∏à‡∏≤‡∏Å stats_pulp
        async function fetchSingleMonthSummaryPulp(dateObj, targetSuppliers) {
            const year = dateObj.getFullYear();
            const month = dateObj.getMonth(); // 0-11
            const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const docID = getPulpDocID(year, month);

            const results = {};
            targetSuppliers.forEach(s => results[s] = {});

            try {
                const docRef = db.collection("stats_pulp").doc(docID);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    const incoming = data.pulp_incoming || {};
                    // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Key: pulp_incoming -> YYYY-MM
                    const monthData = incoming[monthStr];

                    if (monthData) {
                        targetSuppliers.forEach(sup => {
                            // ‡∏´‡∏≤ Supplier Key ‡πÉ‡∏ô DB (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Case sensitive)
                            const dbSupKey = Object.keys(monthData).find(k => k.trim().toUpperCase() === sup.trim().toUpperCase());

                            if (dbSupKey) {
                                const rec = monthData[dbSupKey];
                                // Map ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Summary ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á Format
                                Object.keys(PULP_PARAM_MAP).forEach(pKey => {
                                    const dbKey = PULP_PARAM_MAP[pKey].dbKey; // ‡πÄ‡∏ä‡πà‡∏ô alpha -> alphaCellulose
                                    if (rec.params && rec.params[dbKey]) {
                                        results[sup][pKey] = rec.params[dbKey].coa_avg;
                                    } else {
                                        results[sup][pKey] = null;
                                    }
                                });
                            }
                        });
                    }
                }
            } catch (e) {
                console.warn("Fetch Summary Pulp Error:", e);
            }
            return results;
        }
        // =========================================================
        // [FIXED] MISSING FUNCTION: CORRELATION RENDERER
        // =========================================================
        async function renderCorrelation(mc, start, end, mode) {
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Refresh ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Filter
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Part 4 ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ñ‡πà "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°" ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£ "Plot ‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" 
            // ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ X, Y ‡πÄ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Instance ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡πâ Clear ‡∏ó‡∏¥‡πâ‡∏á (‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏ö‡∏™‡∏ô)
            if (chartInstances['trend']) {
                chartInstances['trend'].destroy();
                delete chartInstances['trend'];
            }
            if (chartInstances['scatter']) {
                chartInstances['scatter'].destroy();
                delete chartInstances['scatter'];
            }

            // 2. Clear ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AI Analysis ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á
            currentTrendData = null;
            currentScatterData = null;
            const aiResultBox = document.getElementById('aiAnalysisResult');
            if(aiResultBox) aiResultBox.classList.add('hidden');

            // 3. (Optional) ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Dropdown ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            // initCorrelationControls(); // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô updateDropdownOptions ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß

            return Promise.resolve(); // ‡∏™‡πà‡∏á Promise ‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ updateDashboard ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏∏‡∏î
        }

        // =========================================================
        // 8. NEW CORRELATION & AI ROOT CAUSE FINDER (HYBRID: Trend + Scatter)
        // =========================================================

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI (‡πÅ‡∏¢‡∏Å 2 ‡∏Å‡∏£‡∏≤‡∏ü)
        let currentTrendData = null;   
        let currentScatterData = null; 
        let latestAnalysisContext = null;
        let chatHistoryLog = []; 
        let currentAIContext = "";

        // Override ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateDropdownOptions ‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å initCorrelationControls ‡∏î‡πâ‡∏ß‡∏¢
        const _originalUpdateDropdowns = updateDropdownOptions;
        updateDropdownOptions = function() {
            _originalUpdateDropdowns(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Part 2 & 3
            initCorrelationControls();  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Part 4
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4 (‡∏™‡∏£‡πâ‡∏≤‡∏á Checkbox ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏° Dropdown)
        function initCorrelationControls() {
            const mc = document.getElementById('mcFilter').value;
            const procConfig = MACHINE_PROCESS_CONFIG[mc] || MACHINE_PROCESS_CONFIG["MC2"];
            // ‡∏£‡∏ß‡∏° Parameter ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á Process
            const allProcessParams = [...(procConfig.viscose||[]), ...(procConfig.auxiliary||[]), ...(procConfig.spinning||[])];
            // Parameter ‡∏Ç‡∏≠‡∏á Product
            const prodParams = PRODUCT_PARAM_CONFIG[mc] || PRODUCT_PARAM_CONFIG["MC2"];

            // 1. Setup Trend Analysis Inputs (Checkboxes) - ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
            const container = document.getElementById('correlationInputList');
            if(container) {
                container.innerHTML = '';
                allProcessParams.forEach(param => {
                    // [MODIFIED]: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡πä‡∏Å checked ‡πÇ‡∏î‡∏¢ Default (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≠)
                    const div = document.createElement('div');
                    div.className = "flex items-center space-x-2 cursor-pointer hover:bg-slate-200 p-1 rounded transition";
                    div.innerHTML = `
                        <input type="checkbox" class="corr-input-check accent-blue-600 w-3 h-3" value="${param}">
                        <span class="truncate" title="${param}">${param}</span>
                    `;
                    container.appendChild(div);
                });
            }

            // 2. Setup Dropdowns - ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ (Target ‡πÅ‡∏•‡∏∞ Scatter)
            fillSelect('corrTrendTarget', prodParams);  // Target ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô
            fillSelect('corrScatterX', allProcessParams); // ‡πÅ‡∏Å‡∏ô X ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∏‡∏î
            fillSelect('corrScatterY', prodParams);       // ‡πÅ‡∏Å‡∏ô Y ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∏‡∏î
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Reset (‡∏õ‡∏∏‡πà‡∏° Reset All)
        function resetSection4() {
          // Clear Charts
          if (chartInstances['trend']) {
            chartInstances['trend'].destroy();
            delete chartInstances['trend'];
          }
          if (chartInstances['scatter']) {
            chartInstances['scatter'].destroy();
            delete chartInstances['scatter'];
          }

          // Clear Data
          currentTrendData = null;
          currentScatterData = null;

          // ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£ Reset latestAnalysisContext ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          // ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ User ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ô Chatbot
          // ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå UI ‡∏Ç‡∏≠‡∏á Part 4
          const aiBox = document.getElementById('aiAnalysisResult');
          if (aiBox) aiBox.classList.add('hidden');

          // ‚úÖ Reset Checkboxes & Dropdowns
          document.querySelectorAll('.corr-input-check').forEach(cb => cb.checked = false);
          const selects = ['corrTrendTarget', 'corrScatterX', 'corrScatterY'];
          selects.forEach(id => {
            const el = document.getElementById(id);
            if (el && el.options.length > 0) el.selectedIndex = 0;
          });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Trend (Chart A)
        async function renderTrendChart() {
            const mc = document.getElementById('mcFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const mode = getGranularity();

            // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Input Parameters ‡∏ó‡∏µ‡πà User ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const checkboxes = document.querySelectorAll('.corr-input-check:checked');
            const selectedInputs = Array.from(checkboxes).map(cb => cb.value);
            // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Target
            const targetParam = document.getElementById('corrTrendTarget').value;

            if (selectedInputs.length === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Process Input (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            // 3. Fetch Data
            const inputPromises = selectedInputs.map(param => fetchProcessDataByType(mc, param, start, end, mode));
            const targetPromise = fetchProductDataByType(mc, targetParam, start, end, mode);

            try {
                const [targetDataRaw, ...inputsDataRaw] = await Promise.all([targetPromise, ...inputPromises]);

                // 1. Clean Target (Product) -> ‡∏™‡∏£‡πâ‡∏≤‡∏á "Master Timeline" ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                const cleanTarget = compressDataOnly(targetDataRaw.labels, targetDataRaw.data);
                const validTimestamps = cleanTarget.labels; // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏µ‡πà‡∏°‡∏µ Product ‡∏à‡∏£‡∏¥‡∏á‡πÜ

                // 2. Map Inputs (Process) -> ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤ ‡∏ì ‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Product
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Process ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡πÜ
                const inputsSynced = inputsDataRaw.map(rawProc => {
                    const procMap = new Map();
                    rawProc.labels.forEach((t, i) => procMap.set(t, rawProc.data[i]));

                    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Process ‡∏ï‡∏≤‡∏° Timestamps ‡∏Ç‡∏≠‡∏á Product ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    const syncedData = validTimestamps.map(t => procMap.has(t) ? procMap.get(t) : null);
                    return { data: syncedData };
                });

                // 4. Prepare Datasets (‡πÉ‡∏ä‡πâ cleanTarget ‡πÅ‡∏•‡∏∞ inputsSynced)
                const datasets = [];

                // Target (Output) - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Clean ‡πÅ‡∏•‡πâ‡∏ß
                datasets.push({
                    label: `TARGET: ${targetParam}`,
                    data: cleanTarget.data, // ‡πÉ‡∏ä‡πâ data ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß
                    borderColor: '#dc2626', backgroundColor: '#dc2626',
                    yAxisID: 'yRight', type: 'line', borderWidth: 3, pointRadius: 3, tension: 0.4, fill: false
                });

                // Inputs (Process) - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Sync ‡πÅ‡∏•‡πâ‡∏ß
                const colors = ['#2563eb', '#059669', '#d97706', '#7c3aed', '#db2777'];
                inputsSynced.forEach((result, index) => {
                    datasets.push({
                        label: selectedInputs[index],
                        data: result.data, // ‡πÉ‡∏ä‡πâ data ‡∏ó‡∏µ‡πà Sync ‡πÅ‡∏•‡πâ‡∏ß
                        borderColor: colors[index % colors.length], backgroundColor: colors[index % colors.length],
                        yAxisID: 'yLeft', type: 'line', borderWidth: 1.5, borderDash: [5, 5], pointRadius: 3, tension: 0.3, fill: false
                    });
                });

                // 5. Render Chart (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÅ‡∏Å‡πâ labels ‡πÄ‡∏õ‡πá‡∏ô cleanTarget.labels)
                const ctx = document.getElementById('chartTrend').getContext('2d');
                if (chartInstances['trend']) chartInstances['trend'].destroy();
                chartInstances['trend'] = new Chart(ctx, {
                    type: 'line',
                    data: { labels: cleanTarget.labels, datasets: datasets }, // ‡πÉ‡∏ä‡πâ Labels ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { display: true, ticks: { maxTicksLimit: 8 } },
                            yLeft: { type: 'linear', display: true, position: 'left', title: {display:true, text: 'Inputs'}, grid: {display:false} },
                            yRight: { type: 'linear', display: true, position: 'right', title: {display:true, text: targetParam}, grid: {color: '#f3f4f6'} }
                        }
                    }
                });

                // Save for AI (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Clean ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡πÉ‡∏´‡πâ AI)
                currentTrendData = {
                    targetName: targetParam,
                    targetData: cleanTarget.data,
                    labels: cleanTarget.labels,
                    inputs: inputsSynced.map((d, i) => ({ name: selectedInputs[i], data: d.data }))
                };

            } catch (error) { console.error("Trend Chart Error:", error); }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Scatter (Chart B)
        async function renderScatterChart() {
            const mc = document.getElementById('mcFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const mode = getGranularity();

            const xParam = document.getElementById('corrScatterX').value;
            const yParam = document.getElementById('corrScatterY').value;

            try {
                const [d1, d2] = await Promise.all([
                    fetchProcessDataByType(mc, xParam, start, end, mode),
                    fetchProductDataByType(mc, yParam, start, end, mode)
                ]);

                // Match Data by Date/Time Label (‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
                const scatterData = [];
                const map2 = new Map();
                d2.labels.forEach((l, i) => map2.set(l, d2.data[i]));

                d1.labels.forEach((l, i) => {
                    if (map2.has(l)) {
                        scatterData.push({ x: d1.data[i], y: map2.get(l) });
                    }
                });

                const ctx = document.getElementById('chartScatter').getContext('2d');
                if (chartInstances['scatter']) chartInstances['scatter'].destroy();

                chartInstances['scatter'] = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `Correlation`,
                            data: scatterData,
                            backgroundColor: '#4f46e5'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { title: { display: true, text: xParam } },
                            y: { title: { display: true, text: yParam } }
                        }
                    }
                });

                // Save for AI
                currentScatterData = {
                    xName: xParam, yName: yParam,
                    points: scatterData // [{x,y}, ...]
                };

            } catch (error) { console.error("Scatter Chart Error:", error); }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI Analyze (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á 2 ‡∏Å‡∏£‡∏≤‡∏ü‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        async function analyzeRootCauseAI() {
            if (!currentTrendData && !currentScatterData) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏•‡πá‡∏≠‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á (Trend ‡∏´‡∏£‡∏∑‡∏≠ Scatter) ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ñ‡∏≤‡∏° AI ‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            const resultBox = document.getElementById('aiAnalysisResult');
            const content = document.getElementById('aiTextContent');
            resultBox.classList.remove('hidden');
            content.innerHTML = `<div class="flex items-center gap-2 text-indigo-600 animate-pulse"><i class="fa-solid fa-circle-notch fa-spin"></i><span>Synthesizing Multi-Chart Analysis...</span></div>`;

            // 1. Prepare Trend Payload (‡∏¢‡πà‡∏≠ Key ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend CSV Logic)
            let trendPayload = null;
            if (currentTrendData) {
                const len = currentTrendData.labels.length;
                const startIdx = 0;

                const simplifiedData = [];
                for (let i = startIdx; i < len; i++) {
                    let row = { t: currentTrendData.labels[i] }; // t = time

                    // Target
                    let val = currentTrendData.targetData[i];
                    row.tg = (typeof val === 'number') ? Number(val.toFixed(2)) : val; // tg = target

                    // Inputs (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ i0, i1... ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend Loop)
                    currentTrendData.inputs.forEach((inp, idx) => {
                        let v = inp.data[i];
                        row[`i${idx}`] = (typeof v === 'number') ? Number(v.toFixed(2)) : v; 
                    });
                    simplifiedData.push(row);
                }

                trendPayload = { 
                    target: currentTrendData.targetName, 
                    inputs: currentTrendData.inputs.map(i => i.name), 
                    data: simplifiedData 
                };
            }

            // 2. Prepare Scatter Payload
            let scatterPayload = null;
            if (currentScatterData) {
                    const points = currentScatterData.points.map(p => ({
                    x: Number(p.x.toFixed(2)),
                    y: Number(p.y.toFixed(2))
                }));

                scatterPayload = {
                    xName: currentScatterData.xName,
                    yName: currentScatterData.yName,
                    data: points
                };
            }

            // (Optional) ‡πÄ‡∏û‡∏¥‡πà‡∏° processMeta ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Å‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
            const processMeta = `Product Grade: ${document.getElementById('corrTrendTarget').value}`; 

            try {
                const analyzeFn = functions.httpsCallable('analyzeRootCause');
                const result = await analyzeFn({ 
                    trendData: trendPayload, 
                    scatterData: scatterPayload,
                    processMeta: processMeta // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏â‡∏•‡∏≤‡∏î‡πÑ‡∏î‡πâ
                });

                const aiText = result.data.analysis;
                latestAnalysisContext = {
                    analysisResult: aiText,
                    parameters: {
                        target: document.getElementById('corrTrendTarget').value,
                        inputs: trendPayload ? trendPayload.inputs : []
                    },
                    trendSnapshot: trendPayload,
                    scatterSnapshot: scatterPayload,
                    analyzedAt: new Date().toISOString()
                };
                console.log("‚úÖ Analysis Context Saved for Chatbot:", latestAnalysisContext);
                // 1. ‡πÄ‡∏Å‡πá‡∏ö Context ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° History ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö KM
                currentAIContext = document.getElementById('mcFilter').value; 
                chatHistoryLog = []; 
                // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                chatHistoryLog.push({ role: "user", content: `Analyze Root Cause for Target: ${document.getElementById('corrTrendTarget').value}` });
                chatHistoryLog.push({ role: "ai", content: aiText });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ User ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ Save ‡πÑ‡∏î‡πâ
                const hintMessage = `
                  <div class="mt-4 p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-200">
                    <div class="flex items-center gap-2 text-indigo-700 font-bold text-sm mb-2">
                      <i class="fas fa-lightbulb"></i>
                      <span>üí° Quick Actions</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                      <button onclick="translateToEnglish()" 
                              class="bg-white border border-indigo-300 rounded px-3 py-2 hover:bg-indigo-50 transition">
                        üåç Translate to English
                      </button>
                      <button onclick="openChatWithContext()" 
                              class="bg-white border border-purple-300 rounded px-3 py-2 hover:bg-purple-50 transition">
                        üí¨ Ask Follow-up Questions
                      </button>
                    </div>
                  </div>
                `;
                
                content.innerHTML = aiText
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<b class="text-indigo-800">$1</b>')
                .replace(/- /g, '‚Ä¢ ') + hintMessage;

            } catch (error) {
                content.innerHTML = `<div class="text-red-500">Analysis Failed: ${error.message}</div>`;
            }
        }
        // =========================================================
        // [RESTORED] MISSING FUNCTION: GRAPH RENDERING
        // =========================================================
        function createDynamicLineChart(canvasId, label, color, labels, dataPoints, mode) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏´‡∏ô‡πà‡∏≠‡∏¢
            const isSinglePoint = dataPoints.length === 1;
            const pointRadius = (mode === 'hourly' && dataPoints.length > 50) ? 0 : (isSinglePoint ? 6 : 3); // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: dataPoints,
                        borderColor: color,
                        backgroundColor: color + '20', // ‡∏à‡∏≤‡∏á‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢
                        borderWidth: 2,
                        pointRadius: pointRadius,      // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { 
                            display: true, 
                            ticks: { maxTicksLimit: 6 },
                            // ‚úÖ [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö
                            offset: true 
                        },
                        y: { display: true }
                    }
                }
            });
        }
        // =========================================================
        // 10. AI CHAT
        // =========================================================
        function toggleChat() { document.getElementById('chatWindow').classList.toggle('hidden'); }
        function handleEnter(e) { if(e.key === 'Enter') sendChatMessage(); }

        async function sendChatMessage() {
            // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1] ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ input ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error
            const input = document.getElementById('chatInput');
            const container = document.getElementById('chatMessages');

            // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ input ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏Å‡∏±‡∏ô Error)
            if (!input) return;

            const msg = input.value.trim();
            if (!msg) return;

                const systemCommands = [
                    "Yes, please translate.",
                    "‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö (Translate analysis to English)"
                ];

                //  üß†  Smart Detection (Logic ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡πÅ‡∏õ‡∏•)
                //  ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç !systemCommands.includes(msg) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏¢"
                if (latestAnalysisContext &&
                    !systemCommands.includes(msg) &&  // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
                    (msg.includes('‡πÅ‡∏õ‡∏•') || msg.includes('translate') ||
                    msg.includes('‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©') || msg.includes('english'))) {

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©
            container.innerHTML += `
                <div class="chat-bubble-ai p-4 bg-blue-50 border-2 border-blue-200">
                    <div class="font-bold text-blue-800 mb-2">
                        üîó  Detected: Translation Request from Part 4
                    </div>
                    <button onclick="confirmTranslation()"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        ‚úÖ  Yes, translate the analysis above
                    </button>
                    <button onclick="askNormalQuestion('${msg}')"
                        class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400 ml-2">
                        ‚ùå  No, I'm asking something else
                    </button>
                </div>
                `;
                input.value = ''; 
                container.scrollTop = container.scrollHeight;
                return;
            }

            // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° User
            container.innerHTML += `<div class="flex justify-end"><div class="chat-bubble-user p-3 shadow-sm text-white rounded-l-xl rounded-br-xl">${msg}</div></div>`;
            input.value = '';
            container.scrollTop = container.scrollHeight;

            // 3. ‡πÅ‡∏™‡∏î‡∏á Loading
            const loadingId = "ai-loading-" + Date.now();
            container.innerHTML += `<div id="${loadingId}" class="flex justify-start"><div class="chat-bubble-ai p-3 bg-gray-100 text-gray-500 rounded-r-xl rounded-bl-xl"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div>`;
            container.scrollTop = container.scrollHeight;

            // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á SAVE
            if (msg.toLowerCase() === "save" || msg.toLowerCase() === "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å") {
                 document.getElementById(loadingId).remove();
                 container.innerHTML += `<div class="flex justify-start"><div class="chat-bubble-ai p-3 bg-yellow-50 text-yellow-700">‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö</div></div>`;
                 return;
            }

            try {
                // 4. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Context
                const currentMachineUI = document.getElementById('mcFilter')?.value || "ALL";

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Cloud Function (‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend)
                const askAI = functions.httpsCallable('askProductChat');

                // 5. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const response = await askAI({
                    question: msg,
                    history: chatHistoryLog,
                    // ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å Part 4 ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÅ‡∏ä‡∏ó‡∏≠‡πà‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢
                    analysisContext: latestAnalysisContext, 
                    uiContext: {
                        machine: currentMachineUI,
                        timestamp: new Date().toISOString()
                    }
                });

                // 6. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                const loadingEl = document.getElementById(loadingId);
                if(loadingEl) loadingEl.remove();

                const reply = response.data.text; 

                // ‡πÅ‡∏õ‡∏•‡∏á Markdown ‡πÄ‡∏õ‡πá‡∏ô HTML
                const formattedReply = reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

                container.innerHTML += `
                <div class="flex justify-start mb-3">
                    <div class="chat-bubble-ai p-3 shadow-sm bg-white text-slate-800 rounded-r-xl rounded-bl-xl border border-slate-200 text-sm leading-relaxed max-w-[85%]">
                        <div>${formattedReply}</div>
                        <div class="mt-2 pt-2 border-t border-slate-100 flex justify-end">
                            <button onclick="saveThisChatToKM('${loadingId}')" 
                                    id="btn-save-${loadingId}"
                                    class="text-[10px] bg-slate-50 border border-slate-300 text-slate-600 px-2 py-1 rounded hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-all">
                                <i class="fas fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ Knowledge Base
                            </button>
                        </div>
                    </div>
                </div>`;
                // 7. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢
                chatHistoryLog.push({ role: "user", content: msg });
                chatHistoryLog.push({ role: "model", content: reply });

            } catch (error) {
                const loadingEl = document.getElementById(loadingId);
                if(loadingEl) loadingEl.remove();

                container.innerHTML += `<div class="flex justify-start"><div class="chat-bubble-ai p-3 shadow-sm bg-red-50 text-red-600 text-xs">Error: ${error.message}<br>(Check Console for details)</div></div>`;
                console.error("Chat Error:", error);
            }

            container.scrollTop = container.scrollHeight;
        }

        function updateMaterialDropdownUI() {
            const select = document.getElementById('materialFilter');
            if(!select) return;

            const currentVal = select.value;
            // ‡πÄ‡∏Å‡πá‡∏ö Option 'ALL' ‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            select.innerHTML = '<option value="ALL">All Materials (Mixed)</option>';

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Option
            const sortedMats = Array.from(FOUND_MATERIALS).sort();
            sortedMats.forEach(mat => {
                const opt = document.createElement('option');
                opt.value = mat;
                opt.innerText = mat;
                select.appendChild(opt);
            });

            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
            if(sortedMats.includes(currentVal)) {
                select.value = currentVal;
            } else {
                select.value = "ALL";
            }
        }

        // =========================================================
        // HELPER FUNCTIONS FOR CHAT & AI ACTIONS
        // =========================================================

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "Translate to English" ‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á AI Result
        function translateToEnglish() {
            const input = document.getElementById('chatInput');
            // ‡πÄ‡∏õ‡∏¥‡∏î Chat Window ‡∏Å‡πà‡∏≠‡∏ô
            document.getElementById('chatWindow').classList.remove('hidden');
            // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            input.value = "‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö (Translate analysis to English)";
            sendChatMessage();
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "Ask Follow-up Questions"
        function openChatWithContext() {
            document.getElementById('chatWindow').classList.remove('hidden');
            const input = document.getElementById('chatInput');
            input.focus();
            input.placeholder = "‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö...";
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏• (‡πÉ‡∏ô Chat Bubble ‡∏ó‡∏µ‡πà AI ‡πÄ‡∏™‡∏ô‡∏≠)
        function confirmTranslation() {
            const input = document.getElementById('chatInput');
            input.value = "Yes, please translate.";
            sendChatMessage();
            // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ñ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á (Optional: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î)
            const chatContainer = document.getElementById('chatMessages');
            const lastMsg = chatContainer.lastElementChild;
            if(lastMsg) lastMsg.remove(); 
        }

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏• (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏ó‡∏ô)
        function askNormalQuestion(originalMsg) {
             const input = document.getElementById('chatInput');
             // ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà User ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô Input ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏≤‡πÅ‡∏Å‡πâ
             input.value = originalMsg; 
             input.focus();
             // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ñ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á
             const chatContainer = document.getElementById('chatMessages');
             const lastMsg = chatContainer.lastElementChild;
             if(lastMsg) lastMsg.remove();
        }

        async function saveThisChatToKM(id) {
            const btn = document.getElementById(`btn-save-${id}`);
            const originalText = btn.innerHTML;

            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà (KM) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

                // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ functions (asia-southeast1)
                const saveKM = functions.httpsCallable('saveIncidentFromChat'); 

                const result = await saveKM({
                    history: chatHistoryLog, 
                    context: document.getElementById('mcFilter')?.value || "ALL",
                    aiAnalysis: latestAnalysisContext // ‡∏™‡πà‡∏á Context ‡∏Ç‡∏≠‡∏á AI ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                });

                if (result.data.success) {
                    btn.className = "text-[10px] bg-emerald-500 text-white px-2 py-1 rounded pointer-events-none";
                    btn.innerHTML = '<i class="fas fa-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Saved to KM)';
                }
            } catch (error) {
                console.error("Save KM Error:", error);
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.className = "text-[10px] bg-red-50 border border-red-300 text-red-600 px-2 py-1 rounded hover:bg-red-600 hover:text-white transition-all";
            }
        }
    </script>
</body>
</html>
