<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulp Inspection Record - LabTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Theme & Basic Styles */
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f9ff; }
        
        /* Sidebar Animation */
        #recordSidebar { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        #recordSidebar.open { transform: translateX(0); }

        /* Comparison Grid Style */
        .param-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr 1fr;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #f1f5f9;
        }
        .param-row:hover { background-color: #f8fafc; }
        .param-label { font-size: 0.875rem; color: #475569; font-weight: 500; }

        .data-input {
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        .data-input:focus { outline: none; border-color: #2563eb; ring: 2px solid #bfdbfe; }

        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background-color: #fefce8; color: #a16207; }
        .status-completed { background-color: #f0fdf4; color: #15803d; }

        .diff-value { font-size: 0.8rem; font-weight: bold; text-align: center; }
        .diff-ok { color: #16a34a; }
        .diff-warning { color: #ca8a04; }
        .diff-danger { color: #dc2626; background: #fee2e2; border-radius: 4px; padding: 0 4px; }
    </style>
</head>
<body>

    <div class="flex h-screen overflow-hidden">
        <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
            
            <header class="bg-white shadow-sm z-10 p-4">
                <div class="flex justify-between items-center max-w-7xl mx-auto w-full">
                    <div class="flex items-center gap-4">
                        <a class='text-slate-400 hover:text-blue-600 transition' href=RawMaterial_Record.html>
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                        <h1 class="text-2xl font-bold text-slate-800">
                            <i class="fas fa-tree text-green-600 mr-2"></i> Pulp Inspection Record
                        </h1>
                    </div>
                    <div class="flex gap-3">
                        <button id="refreshBtn" class="text-slate-500 hover:text-blue-600"><i class="fas fa-sync-alt"></i></button>
                        <button id="newRecordBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold shadow-sm transition flex items-center gap-2">
                            <i class="fas fa-plus"></i> New Inspection
                        </button>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto">
                    
                    <div class="bg-white rounded-lg shadow-sm p-4 mb-6 flex flex-wrap gap-4 items-end">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Search Batch/Lot</label>
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
                                <input type="text" id="searchInput" placeholder="Enter Batch or Lot No..." class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded-md text-sm">
                            </div>
                        </div>
                        <div class="w-[180px]">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Supplier</label>
                            <select id="filterSupplier" class="w-full p-2 border border-slate-300 rounded-md text-sm">
                                <option value="all">All Suppliers</option>
                                <option value="ARAUCO">ARAUCO</option>
                                <option value="AV NACKAWIC">AV NACKAWIC</option>
                                <option value="AV CELL">AV CELL</option>
                                <option value="PHOENIX">PHOENIX</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="w-[150px]">
                             <label class="block text-xs font-medium text-slate-500 mb-1">Start Date</label>
                             <input type="date" id="filterStartDate" class="w-full p-2 border border-slate-300 rounded-md text-sm">
                        </div>
                        <div class="w-[150px]">
                             <label class="block text-xs font-medium text-slate-500 mb-1">End Date</label>
                             <input type="date" id="filterEndDate" class="w-full p-2 border border-slate-300 rounded-md text-sm">
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow border border-slate-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Receive Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Supplier / Material</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Batch / Lot</th>
                                    <th class="px-6 py-3 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">Key Params</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="bg-white divide-y divide-slate-200">
                                <tr><td colspan="6" class="text-center py-10 text-slate-400">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-between items-center mt-4">
                        <span class="text-xs text-slate-400" id="pageInfo"></span>
                        <div class="flex gap-2">
                            <button id="prevPage" class="px-3 py-1 border rounded bg-white text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left mr-1"></i> Previous
                            </button>
                            <button id="nextPage" class="px-3 py-1 border rounded bg-white text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next <i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside id="recordSidebar" class="fixed inset-y-0 right-0 w-full md:w-[600px] bg-white shadow-2xl z-50 flex flex-col">
            <div class="p-5 border-b bg-slate-50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-slate-800" id="sidebarTitle">New Inspection</h2>
                    <p class="text-sm text-slate-500">Compare COA vs Lab Results</p>
                </div>
                <button id="closeSidebar" class="text-slate-400 hover:text-slate-600 transition text-xl">&times;</button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <form id="recordForm">
                    <div class="grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-600 mb-1">Supplier / Brand</label>
                            <select id="inp_supplier" class="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-blue-200 outline-none">
                                <option value="" disabled selected>-- Select Supplier --</option>
                                <option value="ARAUCO">ARAUCO</option>
                                <option value="AV NACKAWIC">AV NACKAWIC</option>
                                <option value="AV CELL">AV CELL</option>
                                <option value="PHOENIX">PHOENIX</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Batch No.</label>
                            <input type="text" id="inp_batch" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-200 outline-none uppercase">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Lot / Invoice No.</label>
                            <input type="text" id="inp_lot" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-200 outline-none uppercase">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Received Date</label>
                            <input type="date" id="inp_receiveDate" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">COA Date</label>
                            <input type="date" id="inp_coaDate" class="w-full p-2 border rounded text-sm">
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="font-bold text-slate-700"><i class="fas fa-flask text-blue-500 mr-2"></i>Quality Parameters</h3>
                            <span class="text-xs text-slate-400">*Red diff means > 5% deviation</span>
                        </div>

                        <div class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm">
                            <div class="grid grid-cols-[2fr_1.5fr_1.5fr_1fr] gap-2 bg-slate-100 p-2 border-b text-xs font-bold text-slate-600">
                                <div>Parameter</div>
                                <div class="text-right pr-2">COA Value</div>
                                <div class="text-right pr-2">Lab Result</div>
                                <div class="text-center">Diff (%)</div>
                            </div>
                            <div id="parametersContainer"></div>
                        </div>
                        <div class="mt-2 text-right">
                            <button type="button" id="addParamBtn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold">
                                <i class="fas fa-plus-circle"></i> Add Custom Parameter
                            </button>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="block text-xs font-bold text-slate-600 mb-1">Remarks / Note</label>
                        <textarea id="inp_remarks" rows="2" class="w-full p-2 border rounded text-sm placeholder-slate-300" placeholder="e.g., Package damaged, COA missing..."></textarea>
                    </div>
                </form>
            </div>

            <div class="p-4 border-t bg-white flex justify-end gap-3">
                <button type="button" id="cancelBtn" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded transition">Cancel</button>
                <button type="button" id="saveBtn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow-lg transform hover:-translate-y-0.5 transition font-semibold">
                    <i class="fas fa-save mr-2"></i> Save Record
                </button>
            </div>
        </aside>
    </div>

    <script>
        // --- 1. Configuration & Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
            authDomain: "lab-trc-management-system.firebaseapp.com",
            projectId: "lab-trc-management-system",
            storageBucket: "lab-trc-management-system.appspot.com",
            messagingSenderId: "43919979160",
            appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.settings({ experimentalForceLongPolling: true });

        const PULP_PARAMETERS = [
            { key: 'alphaCellulose', label: 'Alpha Cellulose (%)' },
            { key: 'solubility10', label: 'Solubility in 10% NaOH (%)' },
            { key: 'solubility18', label: 'Solubility in 18% NaOH (%)' },
            { key: 'moisture', label: 'Moisture (%)' },
            { key: 'viscosity', label: 'Viscosity (ISO) (ml/g)' },
            { key: 'viscosity_t206', label: 'Viscosity (T-206) (cP)' },
            { key: 'brightness', label: 'ISO Brightness (%)' },
            { key: 'whiteness', label: 'Berger Whiteness' },
            { key: 'silica', label: 'Acid Insoluble (ppm)' },
            { key: 'calcium', label: 'Calcium as CaO (ppm)' },
            { key: 'iron', label: 'Iron as Fe (ppm)' },
            { key: 'ash', label: 'Ash (%)' },
            { key: 'resins', label: 'Resins & Fats (DCM) (%)' },
            { key: 'ph', label: 'pH of 1% Solution' },
            { key: 'swelling', label: 'Swelling Factor (%)' },
            { key: 'dirtCount', label: 'Dirt Count (count/m²)' },
            { key: 'r18', label: 'Alkali Res. (R18) (%)' },
            { key: 'kappa', label: 'Kappa Number' },
            { key: 'reactivity', label: 'Reactivity' },
            { key: 'pentosan', label: 'Pentosan (%)' }
        ];

        // --- Variables for Pagination ---
        let currentDocId = null;
        let lastVisible = null; 
        let pageStack = []; // Stack to keep track of start points for "Previous"
        let isPaginating = false;
        const PAGE_SIZE = 15;

        // DOM Elements
        const recordSidebar = document.getElementById('recordSidebar');
        const tableBody = document.getElementById('tableBody');
        const paramsContainer = document.getElementById('parametersContainer');
        const nextBtn = document.getElementById('nextPage');
        const prevBtn = document.getElementById('prevPage');

        // --- 2. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check Auth First (Critical for Editing)
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log("Logged in as:", user.email);
                    fetchRecords('reset'); // Load data only when auth checked
                } else {
                    console.log("No user logged in. Edit might fail.");
                    fetchRecords('reset'); // Load anyway (ReadOnly mode)
                }
            });

            // Sidebar Toggles
            document.getElementById('newRecordBtn').addEventListener('click', () => openSidebar());
            document.getElementById('closeSidebar').addEventListener('click', () => closeSidebar());
            document.getElementById('cancelBtn').addEventListener('click', () => closeSidebar());

            // Actions
            document.getElementById('saveBtn').addEventListener('click', saveRecord);
            document.getElementById('refreshBtn').addEventListener('click', () => fetchRecords('reset'));
            document.getElementById('addParamBtn').addEventListener('click', () => addCustomParameterRow());

            // Filters
            document.getElementById('searchInput').addEventListener('input', debounce(() => fetchRecords('reset'), 500));
            document.getElementById('filterSupplier').addEventListener('change', () => fetchRecords('reset'));
            document.getElementById('filterStartDate').addEventListener('change', () => fetchRecords('reset'));
            document.getElementById('filterEndDate').addEventListener('change', () => fetchRecords('reset'));

            // Pagination Controls
            nextBtn.addEventListener('click', () => fetchRecords('next'));
            prevBtn.addEventListener('click', () => fetchRecords('prev'));
        });

        // --- 3. UI Functions ---

        function renderParameterRows(existingData = {}) {
            paramsContainer.innerHTML = '';
            PULP_PARAMETERS.forEach(param => {
                const pData = existingData[param.key] || { coa: '', lab: '' };
                const row = document.createElement('div');
                row.className = 'param-row';
                row.innerHTML = `
                    <div class="param-label">${param.label}</div>
                    <div><input type="number" step="0.01" class="data-input inp-coa" data-key="${param.key}" value="${pData.coa || ''}" placeholder="-"></div>
                    <div><input type="number" step="0.01" class="data-input inp-lab" data-key="${param.key}" value="${pData.lab || ''}" placeholder="-"></div>
                    <div class="diff-value" id="diff-${param.key}">-</div>
                `;
                paramsContainer.appendChild(row);
                
                const coaInp = row.querySelector('.inp-coa');
                const labInp = row.querySelector('.inp-lab');
                const diffEl = row.querySelector(`#diff-${param.key}`);

                const calcDiff = () => {
                    const coa = parseFloat(coaInp.value);
                    const lab = parseFloat(labInp.value);
                    if (!isNaN(coa) && !isNaN(lab) && coa !== 0) {
                        const diff = lab - coa;
                        const diffPct = (diff / coa) * 100;
                        diffEl.textContent = (diff > 0 ? '+' : '') + diff.toFixed(2);
                        if (Math.abs(diffPct) > 5) { diffEl.className = 'diff-value diff-danger'; diffEl.title = `Deviation: ${diffPct.toFixed(1)}%`; }
                        else if (Math.abs(diffPct) > 2) { diffEl.className = 'diff-value diff-warning'; }
                        else { diffEl.className = 'diff-value diff-ok'; }
                    } else { diffEl.textContent = '-'; diffEl.className = 'diff-value'; }
                };
                coaInp.addEventListener('input', calcDiff);
                labInp.addEventListener('input', calcDiff);
                calcDiff();
            });
        }

        function addCustomParameterRow(data = { key: '', coa: '', lab: '' }) {
            const row = document.createElement('div');
            row.className = 'param-row custom-param-row';
            const diffId = 'diff-' + Math.random().toString(36).substr(2, 9);
            row.innerHTML = `
                <div class="flex items-center gap-1">
                    <button type="button" class="text-red-400 hover:text-red-600" onclick="this.closest('.param-row').remove()"><i class="fas fa-times-circle"></i></button>
                    <input type="text" class="data-input inp-param-name text-xs font-bold text-slate-600" value="${data.key || ''}" placeholder="Enter Param Name">
                </div>
                <div><input type="number" step="0.01" class="data-input inp-coa" value="${data.coa || ''}" placeholder="-"></div>
                <div><input type="number" step="0.01" class="data-input inp-lab" value="${data.lab || ''}" placeholder="-"></div>
                <div class="diff-value" id="${diffId}">-</div>
            `;
            paramsContainer.appendChild(row);
            // Re-use logic for custom rows (omitted for brevity, assume similar to above)
        }

        function openSidebar(record = null) {
            currentDocId = record ? record.id : null;
            document.getElementById('sidebarTitle').textContent = record ? 'Edit Inspection' : 'New Inspection';
            document.getElementById('recordForm').reset();

            if (record) {
                document.getElementById('inp_supplier').value = record.supplier || '';
                document.getElementById('inp_batch').value = record.batchNo || '';
                document.getElementById('inp_lot').value = record.lotNo || '';
                document.getElementById('inp_remarks').value = record.remarks || '';
                if (record.receivedDate) document.getElementById('inp_receiveDate').value = record.receivedDate.split('T')[0];
                if (record.coaDate) document.getElementById('inp_coaDate').value = record.coaDate.split('T')[0];
                renderParameterRows(record.parameters);
                if (record.parameters) {
                    const standardKeys = PULP_PARAMETERS.map(p => p.key);
                    Object.keys(record.parameters).forEach(key => {
                        if (!standardKeys.includes(key)) {
                            addCustomParameterRow({ key: key, coa: record.parameters[key].coa, lab: record.parameters[key].lab });
                        }
                    });
                }
            } else {
                document.getElementById('inp_receiveDate').valueAsDate = new Date();
                renderParameterRows({});
            }
            recordSidebar.classList.add('open');
        }

        function closeSidebar() { recordSidebar.classList.remove('open'); }

        // --- 4. Database Functions (Updated Pagination & Filter) ---

        async function fetchRecords(direction = 'reset') {
            if (isPaginating) return;
            isPaginating = true;
            
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-10"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i></td></tr>';
            nextBtn.disabled = true;
            prevBtn.disabled = true;

            try {
                let query = db.collection('rm_pulp_inspections');

                // --- Filtering ---
                const supplier = document.getElementById('filterSupplier').value;
                const startDate = document.getElementById('filterStartDate').value;
                const endDate = document.getElementById('filterEndDate').value;

                if (supplier !== 'all') {
                    query = query.where('supplier', '==', supplier);
                }

                // Date Range Filter
                if (startDate) query = query.where('receivedDate', '>=', startDate);
                if (endDate) query = query.where('receivedDate', '<=', endDate);

                // Sort: Must sort by receivedDate if filtering by range, else createdAt
                if (startDate || endDate) {
                    query = query.orderBy('receivedDate', 'desc');
                } else {
                    query = query.orderBy('createdAt', 'desc');
                }

                // --- Pagination Logic ---
                if (direction === 'reset') {
                    pageStack = [];
                    lastVisible = null;
                    query = query.limit(PAGE_SIZE);
                } 
                else if (direction === 'next' && lastVisible) {
                    pageStack.push(lastVisible); // Save cursor
                    query = query.startAfter(lastVisible).limit(PAGE_SIZE);
                } 
                else if (direction === 'prev' && pageStack.length > 0) {
                    const prevCursor = pageStack.pop(); // Remove current page's cursor
                    // If stack is now empty, we are back to page 1
                    if (pageStack.length === 0) {
                        // Reset to page 1 logic
                        // Need to rebuild query without startAfter
                        // Simply calling the logic for page 1 manually
                    } else {
                        // We need to start after the NEW top of stack
                        const cursorToUse = pageStack[pageStack.length - 1];
                        query = query.startAfter(cursorToUse).limit(PAGE_SIZE);
                    }
                    
                    // Note: Firestore 'prev' is tricky. Simplest robust way is:
                    // If popping makes stack empty -> Reset.
                    // If not empty -> startAfter(newStackTop).
                    if (pageStack.length === 0) {
                         // Reset query params effectively
                         // Re-apply filters is already done above
                         query = query.limit(PAGE_SIZE); 
                    }
                }

                // --- Execute ---
                const snapshot = await query.get();

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-slate-400">No records found.</td></tr>';
                    nextBtn.disabled = true;
                    prevBtn.disabled = (pageStack.length === 0);
                    isPaginating = false;
                    return;
                }

                lastVisible = snapshot.docs[snapshot.docs.length - 1]; // Update cursor for Next button

                let html = '';
                const search = document.getElementById('searchInput').value.trim().toUpperCase();

                snapshot.forEach(doc => {
                    const data = doc.data();

                    // Client-side Text Search (Batch/Lot)
                    if (search && (!data.batchNo || !data.batchNo.includes(search)) && (!data.lotNo || !data.lotNo.includes(search))) {
                        return; 
                    }

                    const status = (data.parameters && Object.keys(data.parameters).length > 0) ? 'Completed' : 'Pending';
                    const statusClass = status === 'Completed' ? 'status-completed' : 'status-pending';
                    const alpha = data.parameters?.alphaCellulose?.lab || '-';
                    const visc = data.parameters?.viscosity?.lab || '-';
                    const white = data.parameters?.whiteness?.lab || '-';

                    html += `
                    <tr class="hover:bg-slate-50 transition cursor-pointer" onclick="editRecord('${doc.id}')">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatDate(data.receivedDate)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-700"><div class="font-bold">${data.supplier}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            <div class="text-xs text-slate-400">Batch:</div> ${data.batchNo || '-'}
                            <div class="text-xs text-slate-400 mt-1">Lot:</div> ${data.lotNo || '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-slate-600">
                            <div class="flex justify-center gap-4">
                                <div class="text-xs text-left"><span class="block text-slate-400">Alpha</span><span class="font-mono font-bold text-slate-700">${alpha}</span></div>
                                <div class="text-xs text-left"><span class="block text-slate-400">Visc.</span><span class="font-mono font-bold text-blue-600">${visc}</span></div>
                                <div class="text-xs text-left"><span class="block text-slate-400">White</span><span class="font-mono font-bold text-slate-700">${white}</span></div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="status-badge ${statusClass}">${status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="event.stopPropagation(); editRecord('${doc.id}')"><i class="fas fa-edit"></i></button>
                            <button class="text-red-500 hover:text-red-700" onclick="event.stopPropagation(); deleteRecord('${doc.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });

                tableBody.innerHTML = html || '<tr><td colspan="6" class="text-center py-10 text-slate-400">No matching records on this page.</td></tr>';

                // Update Buttons
                nextBtn.disabled = snapshot.docs.length < PAGE_SIZE; // Disable Next if less than full page
                prevBtn.disabled = (pageStack.length === 0);

            } catch (error) {
                console.error("Error:", error);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-red-500">Error: ${error.message} <br> <small class="text-gray-500">(Check console if Index is required)</small></td></tr>`;
            } finally {
                isPaginating = false;
            }
        }

        async function saveRecord() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                // Ensure User is Auth (Double check)
                const currentUser = firebase.auth().currentUser;
                const userEmail = currentUser ? currentUser.email : "Guest/Anonymous";

                const headerData = {
                    supplier: document.getElementById('inp_supplier').value,
                    batchNo: document.getElementById('inp_batch').value.toUpperCase(),
                    lotNo: document.getElementById('inp_lot').value.toUpperCase(),
                    receivedDate: document.getElementById('inp_receiveDate').value,
                    coaDate: document.getElementById('inp_coaDate').value,
                    remarks: document.getElementById('inp_remarks').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: userEmail // ✅ ใช้ตัวแปรที่เราสร้างไว้แทน
                };

                if (!headerData.supplier || !headerData.batchNo) {
                    alert("Please enter Supplier and Batch No.");
                    throw new Error("Validation failed");
                }

                const parameters = {};
                const inputs = paramsContainer.querySelectorAll('.param-row');
                inputs.forEach(row => {
                    let key = row.querySelector('.inp-coa')?.dataset.key;
                    if (!key) {
                        const nameInp = row.querySelector('.inp-param-name');
                        if (nameInp && nameInp.value.trim() !== "") key = nameInp.value.trim();
                    }
                    if (key) {
                        const coaInp = row.querySelector('.inp-coa');
                        const labInp = row.querySelector('.inp-lab');
                        if(coaInp.value || labInp.value) {
                            parameters[key] = {
                                coa: coaInp.value ? parseFloat(coaInp.value) : null,
                                lab: labInp.value ? parseFloat(labInp.value) : null
                            };
                        }
                    }
                });

                const docData = { ...headerData, parameters };

                if (currentDocId) {
                    await db.collection('rm_pulp_inspections').doc(currentDocId).update(docData);
                } else {
                    docData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    docData.bookedBy = userEmail;
                    await db.collection('rm_pulp_inspections').add(docData);
                }

                closeSidebar();
                fetchRecords('reset');
            } catch (error) {
                if(error.message !== "Validation failed") alert("Failed to save: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Record';
            }
        }

        window.editRecord = async (id) => {
            try {
                const doc = await db.collection('rm_pulp_inspections').doc(id).get();
                if (doc.exists) openSidebar({ id: doc.id, ...doc.data() });
            } catch (e) { console.error(e); }
        };

        window.deleteRecord = async (id) => {
            if(confirm("Are you sure?")) {
                await db.collection('rm_pulp_inspections').doc(id).delete();
                fetchRecords('reset');
            }
        };

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const [year, month, day] = parts;
                return `${day}/${month}/${year}`;
            }
            return dateString;
        }
    </script>
</body>
</html>