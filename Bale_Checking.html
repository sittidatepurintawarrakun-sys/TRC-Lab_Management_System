<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bale Checking - Lab-TRC-App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; color: #334155; }
        .card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .form-input, .form-select { width: 100%; background-color: #f8fafc; border: 1px solid #cbd5e1; color: #1e293b; border-radius: 0.5rem; padding: 0.75rem; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .btn-primary { background-color: #2563eb; color: white; font-weight: 600; border-radius: 0.5rem; padding: 0.75rem 1.5rem; transition: background-color 0.3s ease; cursor: pointer; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-primary:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .form-file-button { background-color: #f1f5f9; border: 1px solid #cbd5e1; color: #334155; padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; }
        .form-file-button:hover { background-color: #e2e8f0; }
    </style>
</head>
<body class="antialiased">
<div class="relative min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="mb-6">
            <a href="index.html" class="text-slate-600 hover:text-blue-700 font-semibold text-sm">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-800"><i class="fas fa-barcode text-blue-700"></i> Bale Checking</h1>
        </header>
        <div class="card p-8">
            <div id="auth-message" class="hidden text-center p-8 bg-yellow-100 text-yellow-800 rounded-lg">
                <p>Please log in as an admin on the <a href="Bale_Check_Report.html" class="font-bold underline">Report Page</a> to edit this record.</p>
            </div>
            <form id="bale-entry-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                 <div>
                    <label for="inspectionDate" class="font-semibold text-slate-700">Date & Time</label>
                    <input type="datetime-local" id="inspectionDate" name="inspectionDate" class="form-input mt-2" required>
                </div>
                <div>
                    <label for="department" class="font-semibold text-slate-700">Department</label>
                    <select id="department" name="department" class="form-select mt-2" required>
                        <option value="" disabled selected>-- Select Department --</option>
                        <option value="Spinning">Spinning</option>
                        <option value="Warehouse">Warehouse</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="customerName" class="font-semibold text-slate-700">Customer Name</label>
                    <input type="text" id="customerName" name="customerName" class="form-input mt-2" required>
                </div>
                <div>
                    <label for="baleNumber" class="font-semibold text-slate-700">Bale Number</label>
                    <input type="text" id="baleNumber" name="baleNumber" class="form-input mt-2" required>
                </div>
                <div>
                    <label for="checkedBy" class="font-semibold text-slate-700">Checked By</label>
                    <input type="text" id="checkedBy" name="checkedBy" class="form-input mt-2" required>
                </div>
                <div class="md:col-span-2">
                    <label for="issueProblem" class="font-semibold text-slate-700">Issue Problem</label>
                    <select id="issueProblem" name="issueProblem" class="form-select mt-2" required>
                        <option value="" disabled selected>-- Select Issue --</option>
                        <option value="Dirty Patch/Dirty Fiber">Dirty Patch/Dirty Fiber</option>
                        <option value="Dirty Bale/Packaging">Dirty Bale/Packaging</option>
                        <option value="Black Particles in Bale/Fiber">Black Particles in Bale/Fiber</option>
                        <option value="Black Particles in Packaging">Black Particles in Packaging</option>
                        <option value="Yellow Patch">Yellow Patch</option>
                        <option value="Unopened Fiber">Unopened Fiber</option>
                        <option value="Insect Contamination">Insect Contamination</option>
                        <option value="Hair Contamination">Hair Contamination</option>
                        <option value="Metal Contamination">Metal Contamination</option>
                        <option value="Oil Contamination">Oil Contamination</option>
                        <option value="Other Contamination">Other Contamination</option>
                        <option value="Barcode Damage">Barcode Damage</option>
                        <option value="Packaging Damage">Packaging Damage</option>
                        <option value="Heat Sealing Damage">Heat Sealing Damage</option>
                        <option value="Strap Issue">Strap Issue</option>
                        <option value="Other Issue">Other Issue</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="photoReference" class="font-semibold text-slate-700">Photo Reference</label>
                    <div id="image-preview-container" class="hidden mt-2">
                        <p class="text-sm text-slate-600 mb-2">Current Image:</p>
                        <img id="image-preview" src="" alt="Current Bale Image" class="max-w-xs max-h-48 rounded-lg shadow-md">
                        <p class="text-xs text-slate-500 mt-2">To replace this image, choose a new one below.</p>
                    </div>
                    <div class="mt-2 flex items-center gap-4">
                        <input type="file" id="photoReference" name="photoReference" class="hidden" accept="image/*">
                        <label for="photoReference" class="form-file-button">
                            <i class="fas fa-upload mr-2"></i> Choose Image
                        </label>
                        <span id="fileName" class="text-sm text-slate-500">No file selected</span>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label for="notes" class="font-semibold text-slate-700">Notes / Comments</label>
                    <textarea id="notes" name="notes" rows="4" class="form-input mt-2"></textarea>
                </div>
                <div class="md:col-span-2 text-right mt-4">
                    <button type="submit" class="btn-primary">Submit Record</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Firebase Configuration ---
    const mainAppConfig = {
        apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
        authDomain: "lab-trc-management-system.firebaseapp.com",
        projectId: "lab-trc-management-system",
        storageBucket: "lab-trc-management-system.firebasestorage.app",
        messagingSenderId: "43919979160",
        appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
    };
    const photoAppConfig = {
        apiKey: "AIzaSyCtJrG-GT19tRArvSywcb7RMYVsdsicjG0",
        authDomain: "trc-photo-data.firebaseapp.com",
        projectId: "trc-photo-data",
        storageBucket: "trc-photo-data.firebasestorage.app",
        messagingSenderId: "656245706360",
        appId: "1:656245706360:web:6de7bd9d296158bc57678d"
    };
    const mainApp = firebase.initializeApp(mainAppConfig);
    const photoApp = firebase.initializeApp(photoAppConfig, 'photoStorageApp');
    const db = mainApp.firestore();
    const storage = photoApp.storage();
    const auth = mainApp.auth();
    db.settings({ experimentalForceLongPolling: true });

    // --- DOM Elements ---
    const baleForm = document.getElementById('bale-entry-form');
    const pageTitle = document.querySelector('h1');
    const submitButton = baleForm.querySelector('button[type="submit"]');
    const photoInput = document.getElementById('photoReference');
    const fileNameSpan = document.getElementById('fileName');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const authMessage = document.getElementById('auth-message');
    
    // --- State Variables ---
    const urlParams = new URLSearchParams(window.location.search);
    const recordId = urlParams.get('id');
    const isEditMode = Boolean(recordId);
    let originalRecordData = null;
    const adminEmail = "sittidate.p@adityabirla.com";

    const populateForm = (data) => {
        baleForm.inspectionDate.value = data.inspectionDate;
        baleForm.department.value = data.department;
        baleForm.customerName.value = data.customerName;
        baleForm.baleNumber.value = data.baleNumber;
        baleForm.checkedBy.value = data.checkedBy;
        baleForm.issueProblem.value = data.issueProblem;
        baleForm.notes.value = data.notes || '';
        if (data.photoURL) {
            imagePreview.src = data.photoURL;
            imagePreviewContainer.classList.remove('hidden');
        }
    };

    photoInput.addEventListener('change', () => {
        fileNameSpan.textContent = photoInput.files.length > 0 ? photoInput.files[0].name : 'No file selected';
    });

    // --- Main Logic Controller (Auth-aware) ---
    auth.onAuthStateChanged(user => {
        if (isEditMode) {
            const isAdmin = user && user.email.toLowerCase() === adminEmail.toLowerCase();
            if (isAdmin) {
                baleForm.classList.remove('hidden');
                authMessage.classList.add('hidden');
                
                pageTitle.innerHTML = '<i class="fas fa-edit text-blue-700"></i> Edit Record';
                submitButton.textContent = 'Update Record';

                db.collection("bale_checking_records").doc(recordId).get()
                    .then(doc => {
                        if (doc.exists) {
                            originalRecordData = doc.data();
                            populateForm(originalRecordData);
                        } else {
                            alert("Error: Record not found.");
                            pageTitle.textContent = "Record Not Found";
                            baleForm.classList.add('hidden');
                        }
                    }).catch(error => {
                        console.error("Error getting document:", error);
                        alert("Error loading record data.");
                    });
            } else {
                baleForm.classList.add('hidden');
                authMessage.classList.remove('hidden');
            }
        }
    });
    
    // --- Form Submission Logic (Handles both Create and Update) ---
    baleForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const updatedData = {
            inspectionDate: baleForm.inspectionDate.value,
            department: baleForm.department.value,
            customerName: baleForm.customerName.value,
            baleNumber: baleForm.baleNumber.value,
            checkedBy: baleForm.checkedBy.value,
            issueProblem: baleForm.issueProblem.value,
            notes: baleForm.notes.value,
        };

        if (!updatedData.inspectionDate || !updatedData.department || !updatedData.customerName || !updatedData.baleNumber || !updatedData.checkedBy || !updatedData.issueProblem) {
            return alert('Please fill in all required fields.');
        }

        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';
        try {
            let fileToUpload = photoInput.files[0]; // <-- (1) เปลี่ยนจาก const เป็น let

            // ✅  ===== START: แทรกโค้ดบีบอัดเข้ามาตรงนี้ =====
            if (fileToUpload) {
                submitButton.textContent = 'Compressing Image...';

                const options = {
                    maxSizeMB: 0.5,           // ขนาดไฟล์สูงสุด 0.5 MB (500 KB)
                    maxWidthOrHeight: 1920, // ความละเอียดสูงสุด
                    useWebWorker: true,
                    fileType: 'image/jpeg'
                };

                try {
                    const compressedFile = await imageCompression(fileToUpload, options);
                    fileToUpload = compressedFile; // (2) อัปเดตตัวแปร fileToUpload เป็นไฟล์ใหม่ที่บีบอัดแล้ว
                    console.log(`Image compressed: ${fileToUpload.size / 1024} KB`);
                } catch (compressionError) {
                    console.error("Image compression failed:", compressionError);
                    alert("Image compression failed. Uploading original file.");
                    fileToUpload = photoInput.files[0]; // (3) หากล้มเหลว ให้กลับไปใช้ไฟล์เดิม
                }
            }
            // ✅  ===== END: แทรกโค้ดบีบอัด =====

            if (fileToUpload) { // (4) โค้ดที่เหลือจะใช้ตัวแปร fileToUpload (ซึ่งอาจเป็นไฟล์ที่บีบอัดแล้ว)
                submitButton.textContent = 'Uploading Image...';
                const uniqueFileName = Date.now() + '-' + fileToUpload.name;
                const storageRef = storage.ref('bale_images/' + uniqueFileName);

                const uploadTask = await storageRef.put(fileToUpload); // <-- อัปโหลดไฟล์ใหม่
                const downloadURL = await uploadTask.ref.getDownloadURL();
                updatedData.photoURL = downloadURL;
                updatedData.photoFileName = uniqueFileName;

                if (isEditMode && originalRecordData && originalRecordData.photoFileName) {
                    const oldPhotoRef = storage.ref(`bale_images/${originalRecordData.photoFileName}`);
                    await oldPhotoRef.delete().catch(err => console.warn("Old photo deletion failed (might not exist):", err));
                }
            } else if (isEditMode) {
                updatedData.photoURL = originalRecordData.photoURL || "";
                updatedData.photoFileName = originalRecordData.photoFileName || "";
            }

            if (isEditMode) {
                submitButton.textContent = 'Updating Record...';
                await db.collection("bale_checking_records").doc(recordId).update(updatedData);
                alert("Record updated successfully!");
                window.location.href = 'Bale_Check_Report.html';
            } else {
                updatedData.status = "In Progress";
                updatedData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                
                submitButton.textContent = 'Saving Record...';
                await db.collection("bale_checking_records").add(updatedData);
                alert("Record saved successfully!");
                baleForm.reset();
                fileNameSpan.textContent = 'No file selected';
                imagePreviewContainer.classList.add('hidden');
            }

        } catch (error) {
            console.error("An error occurred: ", error);
            alert("Failed to save record. Please check the console for details.");
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = isEditMode ? 'Update Record' : 'Submit Record';
        }
    });
});
</script>
</body>
</html>