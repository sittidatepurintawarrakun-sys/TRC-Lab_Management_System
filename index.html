<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab-TRC-App - Laboratory Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Professional Theme (Deep Blue & White) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff;
            color: #334155;
        }
        header h1 { color: #1e40af; }
        header h1 .fa-flask-vial { color: #1d4ed8; }
        header p, #datetime-display { color: #475569; }
        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            transition: all 0.3s ease;
        }
        /* No hover effect on calendar card */
        .card:not(.calendar-card):hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }
        .stat-card { padding: 1.5rem; }
        .stat-card .stat-number { color: #1e40af; font-weight: 700; }
        .stat-card .stat-label { color: #64748b; }
        .stat-card .stat-icon { color: #94a3b8; }
        .stat-card.alert .stat-number { color: #be123c; }
        .module-card { padding: 1.5rem; }
        .module-card h2 { color: #1e40af; font-weight: 600; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem; }
        .module-link { display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem; color: #334155; font-weight: 500;
        transition: background-color 0.2s ease, color 0.2s ease; cursor: pointer; }
        .module-link:hover { background-color: #e0f2fe; color: #0c4a6e; }
        .module-link i { width: 2rem; color: #60a5fa; }

        /* CSS to shrink the calendar */
        #dashboard-calendar {
            font-size: 0.8rem; /* Reduce overall font size */
        }
        .fc .fc-toolbar-title {
            font-size: 1em; /* Adjust month title font size */
        }
        .fc .fc-daygrid-day-number, .fc .fc-col-header-cell-cushion {
            font-size: 0.9em; /* Adjust day number and header font size */
        }
    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="relative min-h-screen p-4 sm:p-6 lg:p-8">
        <div id="datetime-display" class="absolute top-4 right-4 sm:top-6 sm:right-6 lg:top-8 lg:right-8 text-right text-sm font-medium"></div>
        <section id="lobby-page">
            <header class="text-center mb-12">
                <h1 class="text-4xl sm:text-5xl font-bold tracking-tight"><i class="fas fa-flask-vial"></i> Laboratory</h1>
                <p class="mt-2 text-lg">Quality Control & Laboratory Management System</p>
            </header>

            <main class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        
                        <div class="card calendar-card p-4 mb-6">
                            <h3 class="font-bold text-slate-700 mb-3 text-lg"><i class="fas fa-calendar-alt mr-2 text-blue-600"></i>This Month's Bookings</h3>
                            <div id="dashboard-calendar"></div>
                        </div>
                        
                        <h2 class="text-2xl font-bold text-slate-700 mb-4">Dashboard Overview</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                            <div id="samples-in-progress-card" class="card stat-card"><div class="flex justify-between items-center"><div><p class="stat-label text-sm font-medium">Samples in Progress</p><p id="samples-in-progress-number" class="stat-number text-4xl mt-1">0</p></div><div class="stat-icon text-2xl opacity-50"><i class="fas fa-vials"></i></div></div></div>
                            <div id="overdue-calibrations-card" class="card stat-card alert"><div class="flex justify-between items-center"><div><p class="stat-label text-sm font-medium">Overdue Calibrations</p><p id="overdue-calibrations-number" class="stat-number text-4xl mt-1">0</p></div><div class="stat-icon text-2xl opacity-50"><i class="fas fa-tools"></i></div></div></div>
                            <div id="open-ncrs-card" class="card stat-card"><div class="flex justify-between items-center"><div><p class="stat-label text-sm font-medium">Open NCRs</p><p id="open-ncrs-number" class="stat-number text-4xl mt-1">0</p></div><div class="stat-icon text-2xl opacity-50"><i class="fas fa-triangle-exclamation"></i></div></div></div>
                        </div>
                        <div class="card mt-6 p-6"><h3 class="font-semibold text-slate-700 mb-4">Test Result Trends</h3><div class="text-center text-slate-400 py-12"><i class="fas fa-chart-line text-4xl mb-2"></i><p>(Basic data visualization charts will be displayed here)</p></div></div>
                    </div>
                    <div class="lg:col-span-1 flex flex-col gap-8">
                        <h2 class="text-2xl font-bold text-slate-700 mb-0 lg:mb-4">System Modules</h2>
                        <div class="card module-card">
                            <h2><i class="fas fa-tasks w-6 mr-2 text-sky-600"></i> Core Operations</h2>
                            <nav class="flex flex-col gap-1">
                                <a href="Sample_Requesting.html" class="module-link"><i class="fas fa-flask"></i> Special Sample Requesting</a>
                                <a href="Bale_Checking.html" class="module-link"><i class="fas fa-barcode"></i> Bale Checking</a>
                                <a href="Lab_Record.html" class="module-link"><i class="fas fa-file-invoice"></i> Lab Reports & Records</a>
                                <a href="F4.html" id="ncr-link" class="module-link"><i class="fas fa-triangle-exclamation"></i> NCR (F4) Register</a>
                                <a href="FSC.html" id="ncr-link" class="module-link"><i class="fas fa-tree"></i> FSC&PEFC System</a>
                                <a href="audit.html" id="ncr-link" class="module-link"><i class="fas fa-check"></i> Internal Audit</a>
                            </nav>
                        </div>
                        <div class="card module-card">
                            <h2><i class="fas fa-shield-halved w-6 mr-2 text-teal-600"></i> Quality & Assets</h2>
                            <nav class="flex flex-col gap-1">
                                <a href="NcfReport.html" class="module-link"><i class="fas fa-triangle-exclamation"></i> NCR (F4) Report</a>
                                <a class="module-link"><i class="fas fa-tools"></i> Equipment</a>
                                <a class="module-link"><i class="fas fa-prescription-bottle"></i> Chemical Inventory</a>
                                <a href="View_Test_Results_Reports.html" class="module-link"><i class="fas fa-file-alt"></i> View Test Results / Reports</a>
                                <a href="FSC_Report.html" class="module-link"><i class="fas fa-leaf"></i> FSC&PEFC Report</a>
                            </nav>
                        </div>
                        <div class="card module-card">
                            <h2><i class="fas fa-cog w-6 mr-2 text-slate-500"></i> System & Admin</h2>
                            <nav class="flex flex-col gap-1">
                                <a href="Room_Booking.html" class="module-link"><i class="fas fa-calendar-alt"></i> Room Booking</a>
                                <a class="module-link"><i class="fas fa-file-pdf"></i> Report Generation</a>
                                <a class="module-link"><i class="fas fa-users-cog"></i> User Management</a>
                            </nav>
                        </div>
                    </div>
                </div>
            </main>
        </section>
        
        <footer class="w-full text-center mt-12">
            <p class="text-sm text-slate-500">&copy; 2025 Sittidate Purintawarrakun</p>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Date/Time Update ---
            const updateDateTime = () => {
                const datetimeDisplay = document.getElementById('datetime-display');
                if (!datetimeDisplay) return;
                const now = new Date();
                const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateString = now.toLocaleDateString('en-US', optionsDate);
                const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit'});
                datetimeDisplay.innerHTML = `<div>${dateString}</div><div>${timeString}</div>`;
            };
            updateDateTime();
            setInterval(updateDateTime, 1000);

            
            // --- Calendar Logic ---
            const firebaseConfig = {
                apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
                authDomain: "lab-trc-management-system.firebaseapp.com",
                projectId: "lab-trc-management-system",
                storageBucket: "lab-trc-management-system.firebasestorage.app",
                messagingSenderId: "43919979160",
                appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
            };

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();

            // Add this line to fix connection issues on restricted networks
            db.settings({ experimentalForceLongPolling: true }); 

            const bookingsCollection = db.collection('bookings');

            // --- (ใหม่) Function to Fetch Dashboard Stats ---
            const fetchDashboardStats = async () => {
                console.log("Fetching all dashboard stats from summary docs...");
                try {
                    // --- 1. Fetch Samples in Progress ---
                    // (ชี้ไปที่เอกสารสรุป 'sample_dashboard_summary')
                    const sampleSummaryRef = db.collection("metadata").doc("sample_dashboard_summary");
                    const sampleSummaryDoc = await sampleSummaryRef.get();

                    let sampleCount = 0; // (ค่าเริ่มต้น)

                    if (sampleSummaryDoc.exists) {
                        const summaryData = sampleSummaryDoc.data();
                        // "Samples in Progress" คือยอดรวมของ 'Submitted' และ 'In Progress'
                        const submittedCount = summaryData['status.Submitted'] || 0;
                        const inProgressCount = summaryData['status.InProgress'] || 0;
                        sampleCount = submittedCount + inProgressCount;
                        console.log(`Sample Summary: Submitted (${submittedCount}), InProgress (${inProgressCount})`);
                    } else {
                        console.warn("Summary document (sample_dashboard_summary) not found.");
                    }

                    // อัปเดตการ์ด "Samples in Progress"
                    const sampleNumberEl = document.getElementById('samples-in-progress-number');
                    if (sampleNumberEl) {
                        sampleNumberEl.textContent = sampleCount;
                        console.log(`Updated Samples in Progress: ${sampleCount}`);
                    }

                    // --- 2. (ใหม่) Fetch Open NCRs ---
                    // (ชี้ไปที่เอกสารสรุป 'ncf_dashboard_summary/main_stats')
                    const ncfSummaryRef = db.collection("ncf_dashboard_summary").doc("main_stats");
                    const ncfSummaryDoc = await ncfSummaryRef.get();

                    let ncrCount = 0; // (ค่าเริ่มต้น)

                    if (ncfSummaryDoc.exists) {
                        const ncfData = ncfSummaryDoc.data();
                        // วนลูป field ทั้งหมดในเอกสาร
                        for (const key in ncfData) {
                            // เช็คว่า field ขึ้นต้นด้วย 'departmentStatus.' 
                            // และ *ไม่* ลงท้ายด้วย '.Completed'
                            if (key.startsWith('departmentStatus.') && !key.endsWith('.Completed')) {
                                // ถ้าใช่ ให้นับรวมค่าเข้าไป (ป้องกันค่า NaN)
                                ncrCount += (ncfData[key] || 0);
                            }
                        }
                        console.log(`NCF Summary: Total Open NCRs (${ncrCount})`);
                    } else {
                        console.warn("Summary document (ncf_dashboard_summary/main_stats) not found.");
                    }

                    // อัปเดตการ์ด "Open NCRs"
                    const ncrNumberEl = document.getElementById('open-ncrs-number');
                    if (ncrNumberEl) {
                        ncrNumberEl.textContent = ncrCount;
                        console.log(`Updated Open NCRs: ${ncrCount}`);
                    }

                } catch (error) {
                    console.error("Error fetching dashboard summaries:", error);
                    // (Optional) แสดง Error บน UI ทั้งสองการ์ด
                    const sampleNumberEl = document.getElementById('samples-in-progress-number');
                    if (sampleNumberEl) sampleNumberEl.textContent = 'E';
                    const ncrNumberEl = document.getElementById('open-ncrs-number');
                    if (ncrNumberEl) ncrNumberEl.textContent = 'E';
                }
            };
            // --- (จบส่วนที่เพิ่ม) ---

            const initializeDashboardCalendar = () => {
                const calendarEl = document.getElementById('dashboard-calendar');
                if (!calendarEl) return;

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'title',
                        center: '',
                        right: ''
                    },
                    editable: false,
                    selectable: false,
                    dayMaxEvents: true, 
                    
                    eventSources: [
                        // Source 1: Hardcoded events (loads instantly)
                        {
                            events: [
                                {
                                    title: 'Plant Daily Meeting',
                                    startTime: '10:30:00',
                                    endTime: '12:00:00',
                                    daysOfWeek: [1, 3, 5], 
                                    color: '#8b5cf6',
                                    classNames: ['pointer-events-none']
                                }
                            ]
                        },
                        // Source 2: Events from Firebase (loads asynchronously)
                        {
                            events: async (fetchInfo, successCallback, failureCallback) => {
                                console.log("Fetching bookings from Firebase...");
                                try {
                                    const snapshot = await bookingsCollection.get();
                                    console.log(`Found ${snapshot.docs.length} documents in 'bookings' collection.`);

                                    const firebaseEvents = snapshot.docs.map(doc => {
                                        const data = doc.data();
                                        // Check data integrity before processing
                                        if (data.start && typeof data.start.toDate === 'function' &&
                                            data.end && typeof data.end.toDate === 'function') {
                                            return {
                                                id: doc.id,
                                                title: data.title,
                                                start: data.start.toDate(),
                                                end: data.end.toDate(),
                                            };
                                        } else {
                                            console.warn(`Skipping document ${doc.id} due to missing or invalid date fields.`, data);
                                            return null;
                                        }
                                    }).filter(event => event !== null); // Filter out invalid items

                                    console.log(`Successfully mapped ${firebaseEvents.length} events.`);
                                    successCallback(firebaseEvents);
                                } catch (error) {
                                    console.error("Error fetching bookings from Firebase:", error);
                                    failureCallback(error);
                                }
                            }
                        }
                    ]
                });

                calendar.render();
            };

            initializeDashboardCalendar();
            fetchDashboardStats();
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ncrLink = document.getElementById('ncr-link');

            // เช็คให้แน่ใจว่าเจอปุ่มก่อนจะเพิ่ม event
            if (ncrLink) {
                ncrLink.addEventListener('click', function(event) {
                    // หยุดการทำงานปกติของลิงก์ (ไม่ให้ไปหน้า F4 ทันที)
                    event.preventDefault();

                    // ตั้งรหัสผ่านของคุณที่นี่
                    const correctPassword = "123456789"; 

                    // แสดงหน้าต่างให้กรอกรหัสผ่าน
                    const enteredPassword = prompt("Please enter the password to access NCR Register:");

                    if (enteredPassword === correctPassword) {
                        // ถ้ารหัสผ่านถูกต้อง ให้เก็บ "กุญแจ" ไว้ใน sessionStorage
                        sessionStorage.setItem('isF4Authenticated', 'true');
                        // แล้วค่อยพาไปที่หน้า F4.html
                        window.location.href = ncrLink.href;
                    } else if (enteredPassword !== null) { // เช็คว่าผู้ใช้ไม่ได้กด Cancel
                        // ถ้ารหัสผ่านผิด
                        alert("Incorrect password. Access denied.");
                    }
                });
            }
        });
    </script>
    </body>
    </html>
