<!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bale Checking Report - Lab-TRC-App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.tailwindcss.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.tailwindcss.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; color: #334155; }
        .card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .kpi-card { background: #ffffff; border-radius: 1rem; padding: 1.5rem; text-align: center; }
        .kpi-card .value { font-size: 1.75rem; font-weight: 700; color: #1e293b; line-height: 2.25rem; }
        .kpi-card .label { font-size: 0.875rem; color: #64748b; margin-top: 0.25rem; }
        .form-input { width: 100%; background-color: #f8fafc; border: 1px solid #cbd5e1; color: #1e293b; border-radius: 0.5rem; padding: 0.75rem; }
        .btn { font-weight: 600; border-radius: 0.5rem; padding: 0.6rem 1.2rem; transition: background-color 0.3s ease; cursor: pointer; display: inline-flex; align-items: center;
        gap: 0.5rem; }
        .btn:disabled { cursor: not-allowed; background-color: #94a3b8; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #475569; }
        th { position: sticky; top: 0; background-color: #f1f5f9; z-index: 10; }
        .thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem; }
        .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter { margin-bottom: 1rem; }
        .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate { padding-top: 1rem; font-size: 0.875rem; }
        .dataTables_wrapper .dataTables_filter input { width: 250px !important; margin-left: 0.5rem; }
        thead .filter-row th { padding: 8px; font-weight: normal; vertical-align: top; }
        thead .filter-row input, thead .filter-row select { width: 100%; }
        .prose h3 { font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose p { margin: 0.5em 0; }
        #close-copilot-btn { font-size: 2rem; line-height: 1; }
        #copilot-content { word-wrap: break-word; }
        .user-question p:first-child, .ai-answer p:first-child { margin-top: 0; }
        /* ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Notes ‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
        #recordsTable .notes-column {
          max-width: 250px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ä‡∏≠‡∏ö) */
          word-wrap: break-word; /* ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
          white-space: normal !important; /* ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ */
        }
    </style>
    </head>
    <body class="antialiased">
    <div class="relative min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        <div class="mb-6">
        <a href="index.html" class="text-slate-600 hover:text-blue-700 font-semibold text-sm">
            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
        </div>
        <header class="mb-8 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-slate-800"><i class="fas fa-chart-pie text-blue-700"></i> Bale Checking Report</h1>
        <div id="auth-container">
            <div id="user-info" class="hidden items-center gap-4">
            <span id="user-email" class="text-slate-600 text-sm"></span>
            <button id="logout-btn" class="btn btn-primary text-sm">Logout</button>
            </div>
            <button id="login-prompt-btn" class="btn btn-primary">Admin Login</button>
        </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="kpi-card card">
                <div id="kpi-total-issues" class="value">-</div>
                <div class="label">Total Issues</div>
            </div>
            <div class="kpi-card card">
                <div id="kpi-top-issue" class="value truncate">-</div>
                <div class="label">Most Frequent Issue</div>
            </div>
            <div class="card p-4 flex flex-col justify-center">
                <label class="text-sm font-semibold text-slate-600 mb-2 text-center">üìä Chart Date Filter</label>
                <div class="flex items-center gap-2">
                    <input type="date" id="chartStartDate" class="form-input text-sm p-2">
                    <input type="date" id="chartEndDate" class="form-input text-sm p-2">
                    <button id="chartFilterResetBtn" class="btn btn-secondary p-2" title="Reset Chart Filter">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-6 mb-8">
            <div class="card p-6 h-[450px] flex flex-col">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex-shrink-0">Top 10 Issues</h2>
                <div class="relative flex-grow"><canvas id="topIssuesChart"></canvas></div>
            </div>
             <div class="card p-6 h-[450px] flex flex-col">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex-shrink-0">Issue Comparison by Department</h2>
                <div class="relative flex-grow"><canvas id="departmentComparisonChart"></canvas></div>
            </div>
        </div>
        <div class="card p-6 h-[450px] flex flex-col mb-8">
            <h2 class="text-lg font-bold text-slate-800 mb-4 flex-shrink-0">Issue Trend (Last 3 Active Months)</h2>
            <div class="relative flex-grow"><canvas id="issueTrendChart"></canvas></div>
        </div>
        <div class="card p-6 overflow-x-auto">
        <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
            <div class="flex items-center">
            <h2 class="text-xl font-bold text-slate-800">All Records</h2>
                <button id="analyze-btn" class="btn btn-primary ml-4" style="display: none;">
                <i class="fas fa-sparkles"></i> Analyze with AI
            </button>
            </div>
            <div class="flex items-center gap-4">
            <div class="font-semibold text-slate-700 text-sm">Export by date range:</div>
            <input type="date" id="exportStartDate" class="form-input" style="width: 160px;">
            <input type="date" id="exportEndDate" class="form-input" style="width: 160px;">
            <button id="clearFiltersBtn" class="btn btn-secondary"><i class="fas fa-times"></i> Clear All Filters</button>
            <button id="exportExcel" class="btn btn-primary"><i class="fas fa-file-excel"></i> Export Excel</button>
            </div>
        </div>
        <div id="loadingIndicator" class="text-center py-8">Loading data...</div>
        <div class="table-wrapper hidden" id="table-container">
            <table class="w-full text-sm text-left text-slate-500" id="recordsTable">
            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                <tr>
                <th class="px-6 py-3">Inspection Date</th>
                <th class="px-6 py-3">Department</th>
                <th class="px-6 py-3">Photo Ref</th>
                <th class="px-6 py-3">Customer</th>
                <th class="px-6 py-3">Bale No.</th>
                <th class="px-6 py-3">Checked By</th>
                <th class="px-6 py-3">Issue Problem</th>
                <th class="px-6 py-3">Notes</th>
                <th class="px-6 py-3">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
            </table>
        </div>
        </div>
    </div>
    </div>
        <button id="copilot-btn" class="fixed bottom-8 right-8 bg-purple-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl z-40 hover:bg-purple-700 transition-transform transform hover:scale-110" style="display: none;">
    <i class="fa-solid fa-wand-magic-sparkles"></i>
    </button>

    <div id="copilot-sidebar" class="fixed top-0 right-0 h-full w-full md:w-[450px] bg-white shadow-2xl z-50 transform transition-transform duration-300 ease-in-out translate-x-full">
    <div class="flex flex-col h-full">
        <header class="p-4 border-b flex justify-between items-center bg-slate-50 flex-shrink-0">
        <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-wand-magic-sparkles text-purple-500 mr-2"></i> AI Analysis</h2>
        <button id="close-copilot-btn" class="text-slate-500 hover:text-slate-800">&times;</button>
        </header>
        <div id="copilot-content" class="flex-grow p-4 overflow-y-auto prose prose-sm max-w-none">
        <div class="text-center text-slate-500">
            <p>Click "Analyze with AI" on the main page to get insights, or ask me a question below.</p>
        </div>
        </div>
        <footer class="p-4 border-t bg-slate-50 flex-shrink-0">
        <div class="flex gap-2">
            <input type="text" id="copilot-chat-input" placeholder="Ask a follow-up question..." class="form-input flex-grow">
            <button id="copilot-chat-submit-btn" class="btn btn-secondary">Send</button>
        </div>
        </footer>
    </div>
    </div>
        <script>
        const GEMINI_API_KEY = "AIzaSyBSwjq_-voEyaMHHz0boCWlcsx5dVChc-Y"; // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        $(document).ready(function() {
            const mainFirebaseConfig = {
                apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
                authDomain: "lab-trc-management-system.firebaseapp.com",
                projectId: "lab-trc-management-system",
                storageBucket: "lab-trc-management-system.firebasestorage.app",
                messagingSenderId: "43919979160",
                appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
            };
            const photoFirebaseConfig = {
                apiKey: "AIzaSyCtJrG-GT19tRArvSywcb7RMYVsdsicjG0",
                authDomain: "trc-photo-data.firebaseapp.com",
                projectId: "trc-photo-data",
                storageBucket: "trc-photo-data.firebasestorage.app",
                messagingSenderId: "656245706360",
                appId: "1:656245706360:web:6de7bd9d296158bc57678d"
            };
            const mainApp = firebase.initializeApp(mainFirebaseConfig);
            const photoApp = firebase.initializeApp(photoFirebaseConfig, 'photoStorageApp');
            const db = mainApp.firestore();
            const storage = photoApp.storage();
            const auth = mainApp.auth();
            db.settings({ experimentalForceLongPolling: true });

            const loadingIndicator = $('#loadingIndicator');
            const tableContainer = $('#table-container');
            const loginPromptBtn = $('#login-prompt-btn');
            const logoutBtn = $('#logout-btn');
            const userInfoDiv = $('#user-info');
            const userEmailSpan = $('#user-email');
            const exportStartDateInput = document.getElementById('exportStartDate');
            const exportEndDateInput = document.getElementById('exportEndDate');
            const clearFiltersBtn = $('#clearFiltersBtn');
            const chartStartDateInput = document.getElementById('chartStartDate');
            const chartEndDateInput = document.getElementById('chartEndDate');
            const chartFilterResetBtn = document.getElementById('chartFilterResetBtn');

            const adminEmails = [
                "sittidate.p@adityabirla.com",
                "trc-qcl.laboratory@adityabirla.com",
                "laboratory.trc@adityabirla.com",
                "waraporn.jindanath@adityabirla.com"
            ];

            let currentUser = null;
            let recordsTable;
            let allRecords = []; // <--  logique ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            let currentFilteredRecords = []; // <-- logique ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI
            let lastAIResponse = '';

            const copilotBtn = $('#copilot-btn');
            const copilotSidebar = $('#copilot-sidebar');
            const closeCopilotBtn = $('#close-copilot-btn');
            const copilotContent = $('#copilot-content');
            const copilotChatInput = $('#copilot-chat-input');
            const copilotChatSubmitBtn = $('#copilot-chat-submit-btn');

            // copilotBtn.on('click', () => copilotSidebar.toggleClass('translate-x-full'));
            closeCopilotBtn.on('click', () => copilotSidebar.addClass('translate-x-full'));
/*
             $('#analyze-btn').on('click', function() {
                const analyzeBtn = $(this);
                copilotSidebar.removeClass('translate-x-full');
                analyzeBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Analyzing...');

                // ---  ‚ú®  REFACTORED: ‡πÉ‡∏ä‡πâ currentFilteredRecords ---
                if (currentFilteredRecords.length === 0) {
                    copilotContent.html('<p class="text-orange-500">No data available to analyze.</p>');
                    analyzeBtn.prop('disabled', false).html('<i class="fas fa-sparkles"></i> Analyze with AI');
                    return;
                }
                getGeminiInsights(currentFilteredRecords, analyzeBtn);
             }); 
             */

            loginPromptBtn.on('click', () => {
                const email = prompt("Please enter your admin email:");
                if (email) {
                    const password = prompt("Please enter your password:");
                    if (password) {
                        auth.signInWithEmailAndPassword(email, password).catch(err => alert("Login Failed: " + err.message));
                    }
                }
            });

            logoutBtn.on('click', () => auth.signOut());

            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    loginPromptBtn.hide();
                    userInfoDiv.show().css('display', 'flex');
                    userEmailSpan.text(user.email);
                } else {
                    loginPromptBtn.show();
                    userInfoDiv.hide();
                }
                if (recordsTable) {
                    const isAdmin = currentUser && adminEmails.includes(currentUser.email.toLowerCase());
                    recordsTable.column(8).visible(isAdmin);
                }
            });

            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year}, ${hours}:${minutes}`;
            };

            // --- AI & COPILOT FUNCTIONS ---
            const getGeminiInsights = async (records, analyzeBtn) => {
                copilotContent.html('<p class="text-center">  ‚ú®  Analyzing data... Please wait a moment.</p>');
                if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                    copilotContent.html('<p class="text-red-500">Error: Gemini API Key is missing. Please configure it in the script.</p>');
                    analyzeBtn.prop('disabled', false).html('<i class="fas fa-sparkles"></i> Analyze with AI');
                    return;
                }
                try {
                    // ‚ú® REFACTORED: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á slice ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                    const simplifiedRecords = records.map(({ id, photoURL, photoFileName, ...rest }) => rest);
                    const prompt = `
                    # Role and Expertise
                    You are "Insight-AI," a world-class Data Scientist and Quality Control Expert specializing in sharp, rapid analysis of laboratory data.
                    # Data Context
                    - **Data Type:** 'Bale Checking Inspection Report'
                    - **Analysis Goal:** 'To identify contamination trends, recurring issues from specific customers or departments, and detect any unusual patterns in the bale inspection process.'
                    - **Additional Key Info:** The 'issueProblem' field is the primary indicator of a quality failure.
                    # Task
                    Given the dataset below, perform a comprehensive, multi-dimensional analysis and generate a summary report covering all the following sections:
                    1.  **Executive Summary:** Summarize the most critical points in 2-3 sentences. What is the single most important takeaway?
                    2.  **Key Highlights & Insights:** Find the most interesting findings, patterns, or unexpected discoveries.
                    3.  **Anomalies & Outliers:** Identify any data points that are out of spec, unusual, or inconsistent.
                    4.  **Trend Analysis:** Analyze if any specific 'issueProblem', 'customerName', or 'department' shows a significant trend.
                    5.  **Correlations & Relationships:** Analyze potential relationships. For example, 'Does a specific department have a higher rate of a particular issue type?'
                    6.  **Priority & Actionable Recommendations:** Based on all analyses, provide a prioritized list of the top 1-3 things the team should do next, with clear, actionable steps.
                    # Data for Analysis
                    \`\`\`json
                    ${JSON.stringify(simplifiedRecords, null, 2)}
                    \`\`\`
                    # Output Format
                    Please generate the response in clean, well-structured Markdown.
                    `;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                    }
                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    lastAIResponse = text;
                    copilotContent.html(marked.parse(text));
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    copilotContent.html(`<p class="text-red-500">Sorry, the AI analysis failed. Error: ${error.message}</p>`);
                } finally {
                    analyzeBtn.prop('disabled', false).html('<i class="fas fa-sparkles"></i> Analyze with AI');
                }
            };

            copilotChatSubmitBtn.on('click', async function() {
                const question = copilotChatInput.val().trim();
                if (!question) return;
                const chatBtn = $(this);
                chatBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                const userQuestionHtml = `<div class="user-question mb-2 border-t pt-4 mt-4"><p class="font-semibold text-slate-800">You:</p><p>${question}</p></div>`;
                copilotContent.append(userQuestionHtml);
                const thinkingHtmlId = `thinking-${Date.now()}`;
                const thinkingHtml = `<div id="${thinkingHtmlId}" class="ai-answer"><p class="font-semibold text-purple-600">AI:</p><p>  ü§î  Thinking...</p></div>`;
                copilotContent.append(thinkingHtml);
                copilotContent.scrollTop(copilotContent[0].scrollHeight);
                copilotChatInput.val('');
                try {
                    // ---  ‚ú®  REFACTORED: ‡πÉ‡∏ä‡πâ currentFilteredRecords ---
                    const simplifiedRecords = currentFilteredRecords.map(({ id, photoURL, photoFileName, ...rest }) => rest);
                    const prompt = `
                    # Role and Goal
                    You are an intelligent data assistant. Your goal is to answer the user's question accurately based on the provided information.
                    # Provided Information
                    You have access to two distinct sources of information:
                    ## 1. Previous AI Analysis (Conversation Context)
                    This is the analysis that was just presented to the user.
                    Use this context if the user's question is a follow-up, such as asking for a translation, a summary, or an elaboration of this analysis.
                    \`\`\`
                    ${lastAIResponse || "No previous analysis available."}
                    \`\`\`
                    ## 2. Full Raw Dataset
                    This is the complete, raw data from the inspection table.
                    Use this dataset if the user's question is a new query asking for specific details, counts, or trends that were not in the previous analysis.
                    \`\`\`json
                    ${JSON.stringify(simplifiedRecords, null, 2)}
                    \`\`\`
                    # User's New Question
                    \`\`\`
                    ${question}
                    \`\`\`
                    # Your Task
                    1.  **Analyze the User's New Question** to understand its intent.
                    2.  **Decide which source of information is more relevant** to answer the question.
                    3.  **Formulate your answer** based *primarily* on the more relevant source.
                    4.  Provide a clear and concise response in Markdown format.
                    `;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMessage = errorData?.error?.message || response.statusText || 'Chat API request failed';
                        throw new Error(errorMessage);
                    }
                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    $(`#${thinkingHtmlId}`).html(`<p class="font-semibold text-purple-600">AI:</p><div>${marked.parse(text)}</div>`);
                } catch (error) {
                    $(`#${thinkingHtmlId}`).html(`<p class="text-red-500">Error: ${error.message}</p>`);
                } finally {
                    chatBtn.prop('disabled', false).html('Send');
                    copilotContent.scrollTop(copilotContent[0].scrollHeight);
                }
            });
            // ===== START: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ =====
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Chart Slicer
            const handleChartFilterChange = () => {
                const startDate = chartStartDateInput.value;
                const endDate = chartEndDateInput.value;

                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                if (!startDate && !endDate) {
                    updateDashboards(allRecords);
                    return;
                }

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 'allRecords' ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const filteredChartData = allRecords.filter(record => {
                    if (!record.inspectionDate) return false;
                    const recordDate = new Date(record.inspectionDate);
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
                    const start = startDate ? new Date(startDate).setHours(0, 0, 0, 0) : -Infinity;
                    const end = endDate ? new Date(endDate).setHours(23, 59, 59, 999) : Infinity;
                    return recordDate.getTime() >= start && recordDate.getTime() <= end;
                });

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                updateDashboards(filteredChartData);
            };

            // ‡∏ú‡∏π‡∏Å Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Slicer
            $(chartStartDateInput).on('change', handleChartFilterChange);
            $(chartEndDateInput).on('change', handleChartFilterChange);
            $(chartFilterResetBtn).on('click', () => {
                chartStartDateInput.value = '';
                chartEndDateInput.value = '';
                handleChartFilterChange(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            });
            // ===== END: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ =====
            // --- DATA FETCHING & TABLE RENDERING ---
            const fetchAndRenderData = async () => {
                loadingIndicator.show();
                tableContainer.hide();
                try {
                    const snapshot = await db.collection("bale_checking_records").get();
                    let records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // ‚ú® REFACTORED: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô allRecords
                    allRecords = await Promise.all(records.map(async (record) => {
                        if (record.photoFileName) {
                            try {
                                const photoRef = storage.ref(`bale_images/${record.photoFileName}`);
                                record.photoURL = await photoRef.getDownloadURL();
                            } catch (error) { record.photoURL = null; }
                        }
                        return record;
                    }));

                    updateDashboards(allRecords); // Dashboard ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    initializeDataTable();
                    applyFiltersAndRender(); // ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å

                } catch (error) {
                    console.error("Error fetching records:", error);
                    loadingIndicator.text('Error loading data.').addClass('text-red-500');
                } finally {
                    loadingIndicator.hide();
                    tableContainer.show();
                }
            };

            // --- ‚ú® NEW FUNCTION: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
                            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° DataTable Column Filters
            const applyFiltersAndRender = () => {
                const startDate = exportStartDateInput.value;
                const endDate = exportEndDateInput.value;
                let filteredData = [...allRecords];

                // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Date Range (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                if (startDate || endDate) {
                    filteredData = filteredData.filter(record => {
                        if (!record.inspectionDate) return false;
                        const recordDate = new Date(record.inspectionDate);
                        const start = startDate ? new Date(startDate).setHours(0, 0, 0, 0) : -Infinity;
                        const end = endDate ? new Date(endDate).setHours(23, 59, 59, 999) : Infinity;
                        return recordDate.getTime() >= start && recordDate.getTime() <= end;
                    });
                }

                // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡∏≠‡∏á Column Filters (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö multi-select)
                if (recordsTable) {
                    recordsTable.columns([1, 3, 5, 6]).every(function() {
                        const column = this;
                        const dataProperty = column.dataSrc();
                        const selectedValues = $(column.header()).closest('thead').find('.filter-row th').eq(column.index()).find('select').val();

                        if (selectedValues && selectedValues.length > 0) {
                            filteredData = filteredData.filter(record => {
                                const cellData = record[dataProperty];
                                return selectedValues.includes(cellData);
                            });
                        }
                    });
                }

                // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Search Box ‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                if (recordsTable) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö recordsTable ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                    const globalSearchValue = recordsTable.search();
                    if (globalSearchValue) {
                        const regex = new RegExp($.fn.dataTable.util.escapeRegex(globalSearchValue), 'i');
                        filteredData = filteredData.filter(record => {
                            return Object.values(record).some(value => {
                                return String(value).match(regex);
                            });
                        });
                    }
                }

                // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                currentFilteredRecords = filteredData;
                if (recordsTable) {
                    recordsTable.clear().rows.add(currentFilteredRecords).draw();
                }
            };

            const initializeDataTable = () => {
                const filterRow = $('<tr class="filter-row"></tr>').appendTo('#recordsTable thead');
                $('#recordsTable thead tr:first-child th').each(() => filterRow.append('<th></th>'));

                recordsTable = $('#recordsTable').DataTable({
                    // ‚ú® REFACTORED: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà data ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    pageLength: 15,
                    order: [[0, 'desc']],
                    columns: [
                        { data: 'inspectionDate', render: (d) => formatDate(d) },
                        { data: 'department' },
                        { data: 'photoURL', orderable: false, searchable: false, render: (url) => url ?
                            `<a href="${url}" target="_blank"><img src="${url}" class="thumbnail" alt="Bale Image"></a>` : 'No Photo' },
                        { data: 'customerName' },
                        { data: 'baleNumber' },
                        { data: 'checkedBy' },
                        { data: 'issueProblem' },
                        { data: 'notes', render: (d) => d || '', className: 'notes-column' },
                        { data: null, orderable: false, searchable: false, render: (data, type, row) => `<div class="flex justify-center items-center gap-2"><button onclick="editRecord('${row.id}')" class="action-btn" title="Edit Record"><i class="fas fa-edit text-blue-500 hover:text-blue-700 fa-lg"></i></button><button onclick="deleteRecord('${row.id}', '${row.photoFileName || ''}')" class="action-btn" title="Delete Record"><i class="fas fa-trash-alt text-red-500 hover:text-red-700 fa-lg"></i></button></div>` }
                    ],
                    columnDefs: [{ targets: 8, visible: false, width: "80px" }],
                    initComplete: function () {
                        this.api().columns([1, 3, 5, 6]).every(function () {
                            const column = this;
                            const filterCell = $(filterRow.find('th').eq(column.index()));
                            filterCell.on('click', (e) => e.stopPropagation());
                            // ‚ú® 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô <select> ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö multiple ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° class 'select2'
                            const select = $('<select class="select2 form-input text-xs p-1" multiple="multiple" style="width: 100%;"></select>')
                                .appendTo(filterCell)
                                // .on('change') ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                                ;

                            const dataProperty = column.dataSrc();

                            if (typeof dataProperty === 'string') {
                                const uniqueData = [...new Set(allRecords
                                    .map(item => item[dataProperty])
                                    .filter(value => value) 
                                )];
                                uniqueData.sort().forEach((d) => {
                                    select.append($('<option></option>').attr('value', d).text(d));
                                });
                            }
                        });

                        // ‚ú® 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô initComplete
                        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏£‡πà‡∏≤‡∏á select ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Select2 ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡∏Å event ‡πÉ‡∏´‡∏°‡πà
                        $('.select2').select2({
                            placeholder: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                            allowClear: true
                        }).on('change', function() {
                            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å
                            applyFiltersAndRender();
                        });
                    }
                });

                // ‚ú® REFACTORED: ‡∏ú‡∏π‡∏Å event ‡∏Ç‡∏≠‡∏á search box ‡∏´‡∏•‡∏±‡∏Å
                $('.dataTables_filter input').unbind().bind('keyup', function() {
                    recordsTable.search(this.value); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ search value ‡∏Ç‡∏≠‡∏á datatable
                    applyFiltersAndRender(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
                });

                const isAdmin = currentUser && adminEmails.includes(currentUser.email?.toLowerCase());
                recordsTable.column(8).visible(isAdmin);
            };


            window.editRecord = (recordId) => { window.location.href = `Bale_Checking.html?id=${recordId}`; };
            window.deleteRecord = (recordId, photoFileName) => {
                if (!confirm(`Are you sure you want to delete this record?\nID: ${recordId}`)) return;
                const deleteFirestoreRecord = () => db.collection("bale_checking_records").doc(recordId).delete();
                if (photoFileName) {
                    const photoRef = storage.ref(`bale_images/${photoFileName}`);
                    photoRef.delete().then(() => deleteFirestoreRecord()).then(() => {
                        alert("Record and photo deleted successfully!");
                        fetchAndRenderData();
                    }).catch(error => {
                        if (error.code === 'storage/object-not-found') {
                            deleteFirestoreRecord().then(() => {
                                alert("Record deleted (photo not found in storage).");
                                fetchAndRenderData();
                            }).catch(dbError => alert("Error: " + dbError.message));
                        } else { alert("Error: " + error.message); }
                    });
                } else {
                    deleteFirestoreRecord().then(() => {
                        alert("Record deleted successfully!");
                        fetchAndRenderData();
                    }).catch(error => alert("Error: " + error.message));
                }
            };

            // === START: DASHBOARD CHART LOGIC (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ===
            let chartInstances = {};
            const getCount = (records, field) => {
                return records.reduce((acc, record) => {
                    const key = record[field];
                    if (key) acc[key] = (acc[key] || 0) + 1;
                    return acc;
                }, {});
            };
            const getTopEntry = (counts) => {
                return Object.entries(counts).sort(([,a],[,b]) => b-a)[0] || ['-', 0];
            };
            const updateKpiCards = (records) => {
                if (!records || records.length === 0) {
                    $('#kpi-total-issues, #kpi-top-issue').text('0');
                    return;
                }
                const issueCounts = getCount(records, 'issueProblem');
                const [topIssue] = getTopEntry(issueCounts);
                $('#kpi-total-issues').text(records.length);
                $('#kpi-top-issue').text(topIssue);
            };
            const createTopIssuesChart = (records, totalRecordsCount) => {
                const issueCounts = getCount(records, 'issueProblem');
                const sortedIssues = Object.entries(issueCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10);
                const labels = sortedIssues.map(item => item[0]);
                const data = sortedIssues.map(item => item[1]);
                const ctx = document.getElementById('topIssuesChart').getContext('2d');
                if (chartInstances.topIssues) chartInstances.topIssues.destroy();
                chartInstances.topIssues = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Issue Count',
                            data: data,
                            backgroundColor: '#3b82f6',
                            borderColor: '#1d4ed8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const count = context.raw;
                                        const percentage = totalRecordsCount > 0 ? (count / totalRecordsCount * 100).toFixed(1) : 0;
                                        return `Count: ${count} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            };
            const createDepartmentComparisonChart = (records) => {
                const issuesByDept = records.reduce((acc, { department, issueProblem }) => {
                    if (department && issueProblem) {
                        if (!acc[issueProblem]) {
                            acc[issueProblem] = { 'Spinning': 0, 'Warehouse': 0 };
                        }
                        if (acc[issueProblem][department] !== undefined) {
                            acc[issueProblem][department]++;
                        }
                    }
                    return acc;
                }, {});
                const labels = Object.keys(issuesByDept);
                const spinningData = labels.map(issue => issuesByDept[issue]['Spinning']);
                const warehouseData = labels.map(issue => issuesByDept[issue]['Warehouse']);
                const ctx = document.getElementById('departmentComparisonChart').getContext('2d');
                if (chartInstances.deptCompare) chartInstances.deptCompare.destroy();
                chartInstances.deptCompare = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Spinning',
                                data: spinningData,
                                backgroundColor: '#f97316',
                            },
                            {
                                label: 'Warehouse',
                                data: warehouseData,
                                backgroundColor: '#8b5cf6',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: false },
                            y: { stacked: false, beginAtZero: true }
                        }
                    }
                });
            };
            const createIssueTrendChart = (records) => {
                if (!records || records.length === 0) return;

                // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                const monthlyCounts = records.reduce((acc, record) => {
                    if (!record.inspectionDate || !record.issueProblem) return acc;
                    const monthYear = new Date(record.inspectionDate).toISOString().slice(0, 7);
                    if (!acc[monthYear]) acc[monthYear] = {};
                    if (!acc[monthYear][record.issueProblem]) acc[monthYear][record.issueProblem] = 0;
                    acc[monthYear][record.issueProblem]++;
                    return acc;
                }, {});

                const sortedMonths = Object.keys(monthlyCounts).sort().reverse();
                const lastThreeMonths = sortedMonths.slice(0, 3).reverse();
                if (lastThreeMonths.length === 0) return;

                // ===== START: ‡∏™‡πà‡∏ß‡∏ô Logic ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà =====

                // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤ Top 7 ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                const totalCountsInPeriod = {};
                lastThreeMonths.forEach(month => {
                    for (const issue in monthlyCounts[month]) {
                        totalCountsInPeriod[issue] = (totalCountsInPeriod[issue] || 0) + monthlyCounts[month][issue];
                    }
                });

                const topIssues = Object.entries(totalCountsInPeriod)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 7) // <--- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏≠‡∏≤ Top 7
                    .map(entry => entry[0]);

                // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (Point Styles) ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏á‡πà‡∏≤‡∏¢
                const DISTINCT_COLORS = ['#E6194B', '#3CB44B', '#4363D8', '#F58231', '#911EB4', '#46F0F0', '#FABEBE', '#008080', '#E6BEFF', '#9A6324'];
                const POINT_STYLES = ['circle', 'rect', 'triangle', 'rectRot', 'star', 'cross', 'rectRounded'];

                // 4. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Top Issues
                let datasets = topIssues.map((issue, index) => {
                    const data = lastThreeMonths.map(month => monthlyCounts[month][issue] || 0);
                    return {
                        label: issue,
                        data: data,
                        borderColor: DISTINCT_COLORS[index % DISTINCT_COLORS.length],
                        backgroundColor: DISTINCT_COLORS[index % DISTINCT_COLORS.length] + '33',
                        pointStyle: POINT_STYLES[index % POINT_STYLES.length], // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå
                        pointRadius: 6, // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                        tension: 0.1,
                        fill: false
                    };
                });

                // 5. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "Other Issues" (‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î Top 7)
                const otherIssuesData = lastThreeMonths.map(month => {
                    let otherCount = 0;
                    for (const issue in monthlyCounts[month]) {
                        if (!topIssues.includes(issue)) {
                            otherCount += monthlyCounts[month][issue];
                        }
                    }
                    return otherCount;
                });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° "Other Issues" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (otherIssuesData.some(count => count > 0)) {
                    datasets.push({
                        label: 'Other Issues',
                        data: otherIssuesData,
                        borderColor: '#808080', // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
                        backgroundColor: '#80808033',
                        borderDash: [5, 5], // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
                        pointStyle: 'line',
                        pointRadius: 5,
                        tension: 0.1,
                        fill: false
                    });
                }

                // ===== END: ‡∏™‡πà‡∏ß‡∏ô Logic ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà =====

                // 6. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á options ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
                const ctx = document.getElementById('issueTrendChart').getContext('2d');
                if (chartInstances.issueTrend) chartInstances.issueTrend.destroy();
                chartInstances.issueTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: lastThreeMonths.map(m => new Date(m + '-02').toLocaleString('default', { month: 'short', year: '2-digit' })),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true, // <--- ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Label ‡πÉ‡∏ô Legend ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Number of Issues' }
                            }
                        }
                    }
                });
            };
            const updateDashboards = (records) => {
                updateKpiCards(records);
                createTopIssuesChart(records, records.length);
                createDepartmentComparisonChart(records);
                createIssueTrendChart(records); // <-- ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
            };
            // === END: DASHBOARD LOGIC ===

            // --- EXPORT & FILTER FUNCTIONS ---
            clearFiltersBtn.on('click', function() {
                exportStartDateInput.value = '';
                exportEndDateInput.value = '';
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï dropdowns ‡πÉ‡∏ô filter-row
                $('#recordsTable .filter-row select').val('');
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï search box ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á datatable
                recordsTable.search('').draw(false); // draw(false) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ re-render ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å
                applyFiltersAndRender();
            });

            // ‚ú® REFACTORED: ‡∏ú‡∏π‡∏Å event ‡∏Å‡∏±‡∏ö date inputs
            $('#exportStartDate, #exportEndDate').on('change', applyFiltersAndRender);

            $('#exportExcel').on('click', () => {
                // ‚ú® REFACTORED: ‡πÉ‡∏ä‡πâ currentFilteredRecords ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export
                if (currentFilteredRecords.length === 0) return alert("No data to export for the selected filters.");
                const formattedData = currentFilteredRecords.map(record => ({ "Date": formatDate(record.inspectionDate), "Department": record.department, "Customer": record.customerName, "Bale No.": record.baleNumber, "Checked By": record.checkedBy, "Issue": record.issueProblem, "Notes": record.notes || '', "Photo Link": record.photoURL ? { t: 's', v: 'View Image', l: { Target: record.photoURL, Tooltip : "Click to view image" }} : '' }));
                const worksheet = XLSX.utils.json_to_sheet(formattedData);
                worksheet['!cols'] = [{wch:22},{wch:15},{wch:20},{wch:15},{wch:15},{wch:25},{wch:30},{wch:15}];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, worksheet, "Bale Records");
                XLSX.writeFile(wb, "Bale_Checking_Report_Filtered.xlsx");
            });

            fetchAndRenderData();
        });
        </script>
</body>
</html>
