<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Sample Report - Lab Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* 2. CSS Styles (From NCF & New) */
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .btn { font-weight: 600; border-radius: 0.5rem; padding: 0.6rem 1.2rem; transition: background-color 0.3s ease; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:disabled { cursor: not-allowed; background-color: #94a3b8; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #475569; }
        .form-input { width: 100%; background-color: #f9fafb; border: 1px solid #d1d5db; color: #111827; border-radius: 0.5rem; padding: 0.75rem; }
        .form-select { width: 100%; border-gray-300 rounded-md shadow-sm; } /* (‡πÄ‡∏û‡∏¥‡πà‡∏°) */

        /* Sidebar Styles (From NCF) */
        #detailsSidebar { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        #detailsSidebar.open { transform: translateX(0); }
        #copilot-sidebar { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        #copilot-sidebar.open { transform: translateX(0); }
        #close-copilot-btn { font-size: 2rem; line-height: 1; }

        /* Prose Styles (From NCF) */
        .prose h3 { font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose p { margin: 0.5em 0; }

        /* (‡πÉ‡∏´‡∏°‡πà) Status Badge (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å NCF) */
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-submitted { background-color: #eff6ff; color: #1d4ed8; } /* Issued -> Submitted */
        .status-inprogress { background-color: #fefce8; color: #a16207; } /* Responded -> In Progress */
        .status-completed { background-color: #f0fdf4; color: #15803d; }

        /* Sidebar Section Styles (From NCF) */
        .sidebar-section { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .sidebar-label { font-weight: 600; color: #4b5563; margin-bottom: 0.25rem; display: block; }
        .sidebar-value { color: #111827; }
        .sidebar-input { width: 100%; border-gray-300 rounded-md shadow-sm; }

        /* (‡πÉ‡∏´‡∏°‡πà) Landing Page Styles */
        #landingView {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            /* (‡πÉ‡∏´‡∏°‡πà) Background ‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ */
            background-color: #0c1427;
            background-image: 
                radial-gradient(at 27% 37%, hsla(215, 98%, 61%, 0.1) 0px, transparent 50%),
                radial-gradient(at 97% 21%, hsla(125, 98%, 72%, 0.1) 0px, transparent 50%),
                radial-gradient(at 52% 99%, hsla(355, 98%, 71%, 0.1) 0px, transparent 50%),
                radial-gradient(at 10% 29%, hsla(256, 96%, 68%, 0.1) 0px, transparent 50%),
                radial-gradient(at 97% 96%, hsla(38, 60%, 74%, 0.1) 0px, transparent 50%),
                radial-gradient(at 44% 53%, hsla(340, 98%, 76%, 0.1) 0px, transparent 50%),
                radial-gradient(at 10% 10%, hsla(215, 98%, 61%, 0.1) 0px, transparent 50%);
        }
        .selection-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2.5rem;
            text-align: center;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 350px;
        }
        .selection-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .selection-card i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            display: block;
        }
        .selection-card h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .selection-card p {
            font-size: 1rem;
            color: #cbd5e1;
        }
    </style>
</head>
<body class="antialiased">

    <div id="landingView">
        <div class="max-w-4xl mx-auto p-8">
            <div class="text-center mb-12">
                <h1 class="text-5xl font-bold text-white mb-4">Special Sample Report</h1>
                <p class="text-xl text-slate-300">Please select your role to continue</p>
            </div>
            <div class="flex flex-col md:flex-row gap-8">
                <div id="userSearchBtn" class="selection-card">
                    <i class="fas fa-user-check text-blue-400"></i>
                    <h2>For Requester</h2>
                    <p>Track your sample status using a Request ID</p>
                </div>
                <div id="staffLoginBtn" class="selection-card">
                    <i class="fas fa-flask-vial text-green-400"></i>
                    <h2>For Lab Staff</h2>
                    <p>Access the dashboard to manage and update results</p>
                </div>
            </div>
        </div>
    </div>

    <div id="userResultView" class="hidden min-h-screen bg-gray-100 p-8">
        <div class="max-w-3xl mx-auto">
            <button id="backToLandingBtn" class="btn btn-secondary mb-6">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <div class="bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Sample Status: <span id="userResult_requestId" class="text-blue-700"></span></h2>
                <div id="userResultContent" class="space-y-4">
                    </div>
            </div>
        </div>
    </div>

    <div id="dashboardView" class="hidden flex h-screen bg-gray-100">
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-8">
                <div class="container mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4">
                            <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-vial-circle-check text-blue-700"></i> Special Sample Dashboard</h1>
                            <button id="analyze-btn" class="btn btn-primary">
                                <i class="fas fa-sparkles"></i> Analyze with AI
                            </button>
                        </div>
                        <div id="auth-container">
                            <div id="user-info" class="hidden items-center gap-4">
                                <span id="user-email" class="text-gray-600 text-sm"></span>
                                <button id="logout-btn" class="btn btn-secondary text-sm">Logout</button>
                            </div>
                            <button id="login-prompt-btn" class="btn btn-primary">Admin Login</button>
                        </div>
                        <a href="index.html" class="bg-white text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition">
                            &#8592; Back to Dashboard
                        </a>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-bold text-lg text-gray-700 mb-4">Monthly Sample Requests Trend</h3>
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-bold text-lg text-gray-700 mb-4">Requests by Status</h3>
                            <canvas id="statusOverviewChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                      <h3 class="font-bold text-lg text-gray-700 mb-4">Monthly Sample Trend by Department (Requests)</h3>
                      <canvas id="departmentTrendChart" style="max-height: 350px;"></canvas>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                      <h3 class="font-bold text-lg text-gray-700 mb-4">Actual Workload (Total Tests Performed)</h3>
                      <p class="text-sm text-gray-500 mb-4">* This chart counts every single test parameter (e.g., 1 Request with 7 days monitoring = 7+ items)</p>
                      <canvas id="workloadTrendChart" style="max-height: 350px;"></canvas>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-700">Department Status Overview</h3>

                            <div class="flex gap-4 text-sm text-gray-600">
                                <span class="flex items-center">
                                    <span class="w-3 h-3 rounded-full mr-2" style="background-color: rgba(59, 130, 246, 0.7);"></span> Submitted
                                </span>
                                <span class="flex items-center">
                                    <span class="w-3 h-3 rounded-full mr-2" style="background-color: rgba(34, 197, 94, 0.7);"></span> Completed
                                </span>
                            </div>
                        </div>

                        <div id="departmentStatusContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-center">
                            </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                        <div>
                            <label for="searchInput" class="text-sm font-medium text-gray-700">Search Request ID:</label>
                            <input type="text" id="searchInput" placeholder="e.g., LAB-SP-0001" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="filterDepartment" class="text-sm font-medium text-gray-700">Filter by Department:</label>
                            <select id="filterDepartment" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Departments</option>
                                <option value="Viscose">Viscose</option>
                                <option value="Spinning">Spinning</option>
                                <option value="Auxiliary">Auxiliary</option>
                                <option value="ETP&WTP">ETP&WTP</option>
                                <option value="ABEC">ABEC</option>
                                <option value="Warehouse">Warehouse</option>
                                <option value="Quality Control">Quality Control</option>
                                <option value="Technical Cell">Technical Cell</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Other Unit">Other Unit</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterStatus" class="text-sm font-medium text-gray-700">Filter by Status:</label>
                            <select id="filterStatus" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="open">All Open</option>
                                <option value="Submitted">Submitted</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="all">All Statuses</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterPriority" class="text-sm font-medium text-gray-700">Filter by Priority:</label>
                            <select id="filterPriority" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Priorities</option>
                                <option value="Urgent">Urgent</option>
                                <option value="High">High</option>
                                <option value="Normal">Normal</option>
                            </select>
                        </div>
                        <div class="col-span-1 md:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="exportStartDate" class="text-sm font-medium text-gray-700">Start Date:</label>
                                <input type="date" id="exportStartDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="exportEndDate" class="text-sm font-medium text-gray-700">End Date:</label>
                                <input type="date" id="exportEndDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button id="clearFiltersBtn" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                                <button id="exportExcelBtn" class="btn btn-primary">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Request ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Sample Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Request Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Priority</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
                                    <th class="admin-actions-header px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider" style="display: none;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ncfTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="text-center p-8 text-gray-500">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="pagination-controls" class="flex justify-between items-center mt-4 px-4 py-2 bg-white rounded-lg shadow-md">
                        <button id="prevPageBtn" class="btn btn-secondary" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span id="pageInfo" class="text-sm font-semibold text-gray-700">Page 1 of 1</span>
                        <button id="nextPageBtn" class="btn btn-secondary" disabled>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="detailsSidebar" class="fixed top-0 right-0 w-full md:w-2/5 h-full bg-white shadow-2xl z-50 overflow-y-auto">
        <div class="p-8">
            <button id="closeSidebarBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <div id="sidebarContent">
                </div>
        </div>
    </div>

    <button id="copilot-btn" class="fixed bottom-8 right-8 bg-purple-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl z-40 hover:bg-purple-700 transition-transform transform hover:scale-110">
        <i class="fa-solid fa-wand-magic-sparkles"></i>
    </button>
    <div id="copilot-sidebar" class="fixed top-0 right-0 h-full w-full md:w-[450px] bg-white shadow-2xl z-[60] transform transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <header class="p-4 border-b flex justify-between items-center bg-slate-50 flex-shrink-0">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-wand-magic-sparkles text-purple-500 mr-2"></i> AI Analysis</h2>
                <button id="close-copilot-btn" class="text-slate-500 hover:text-slate-800">&times;</button>
            </header>
            <div id="copilot-content" class="flex-grow p-4 overflow-y-auto prose prose-sm max-w-none">
                <div class="text-center text-slate-500">
                    <p>Click "Analyze with AI" on the main page to get insights, or ask me a question below.</p>
                </div>
            </div>
            <footer class="p-4 border-t bg-slate-50 flex-shrink-0">
                <div class="flex gap-2">
                    <input type="text" id="copilot-chat-input" placeholder="Ask a follow-up question..." class="form-input flex-grow">
                    <button id="copilot-chat-submit-btn" class="btn btn-secondary">Send</button>
                </div>
            </footer>
        </div>
    </div>

    <div id="staffPasswordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-[100]" style="display: none;">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Lab Staff Access</h3>
                <div class="mt-2 px-7 py-3">
                    <label for="staffPasswordInput" class="sr-only">Password</label> 
                    <input type="password" id="staffPasswordInput" class="form-input w-full text-center" placeholder="Enter Password">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="staffPasswordOkBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-700">
                        Login
                    </button>
                    <button id="staffPasswordCancelBtn" class="ml-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="userSearchModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-[100]" style="display: none;">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Track Your Sample</h3>
                <div class="mt-2 px-7 py-3">
                    <label for="userSearchInput_number" class="sr-only">Request ID Number</label> 
                    <div class="flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                            LAB-SP-
                        </span>
                        <input type="text" id="userSearchInput_number" class="form-input flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md text-center" placeholder="0001">
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="userSearchOkBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-700">
                        Search
                    </button>
                    <button id="userSearchCancelBtn" class="ml-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-[100]" style="display: none;">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Enter Password</h3>
                <div class="mt-2 px-7 py-3">
                    <label for="passwordInput" class="sr-only">Password</label> <input type="password" id="passwordInput" class="form-input w-full text-center" placeholder="Password">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modalOkBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-700">OK</button>
                    <button id="modalCancelBtn" class="ml-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        Chart.register(ChartDataLabels);
        // --- 1. Firebase Config (From NCF/Sample Requesting) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w", // [cite: 192, 1337]
            authDomain: "lab-trc-management-system.firebaseapp.com", // [cite: 193, 1338]
            projectId: "lab-trc-management-system", // [cite: 194, 1339]
            storageBucket: "lab-trc-management-system.appspot.com", // [cite: 195]
            messagingSenderId: "43919979160", // [cite: 196, 1341]
            appId: "1:43919979160:web:779cb9de75cd4b9fce56ed" // [cite: 197, 1342]
        };
        firebase.initializeApp(firebaseConfig); // [cite: 200, 1345]

        const db = firebase.firestore();
        db.settings({ experimentalForceLongPolling: true }); // [cite: 202, 1350]
        const auth = firebase.auth(); // [cite: 204, 1348]
        const functions = firebase.functions(); // [cite: 206]

        // (‡πÉ‡∏´‡∏°‡πà) AI Function Names (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å NCF)
        const getSampleAiAnalysis = functions.httpsCallable('getSampleAiAnalysis');
        const askSampleChat = functions.httpsCallable('askSampleChat');

        // Admin Config (From NCF)
        const adminEmails = ["sittidate.p@adityabirla.com", "trc-qcl.laboratory@adityabirla.com", "laboratory.trc@adityabirla.com", "waraporn.jindanath@adityabirla.com"]; // [cite: 210]
        let currentUser = null; // [cite: 211]

        // --- 2. DOM Elements ---

        // (‡πÉ‡∏´‡∏°‡πà) View Containers
        const landingView = $('#landingView');
        const dashboardView = $('#dashboardView');
        const userResultView = $('#userResultView');

        // (‡πÉ‡∏´‡∏°‡πà) Landing Buttons
        const userSearchBtn = $('#userSearchBtn');
        const staffLoginBtn = $('#staffLoginBtn');
        const backToLandingBtn = $('#backToLandingBtn');

        // (‡πÉ‡∏´‡∏°‡πà) Staff Password Modal
        const staffPasswordModal = $('#staffPasswordModal');
        const staffPasswordInput = $('#staffPasswordInput');
        const staffPasswordOkBtn = $('#staffPasswordOkBtn');
        const staffPasswordCancelBtn = $('#staffPasswordCancelBtn');

        // (‡πÉ‡∏´‡∏°‡πà) User Search Modal
        const userSearchModal = $('#userSearchModal');
        const userSearchInput_number = $('#userSearchInput_number'); // <--- 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
        const userSearchOkBtn = $('#userSearchOkBtn');
        const userSearchCancelBtn = $('#userSearchCancelBtn');

        // (‡πÉ‡∏´‡∏°‡πà) User Result View Content
        const userResultContent = $('#userResultContent');
        const userResultRequestId = $('#userResult_requestId');

        // Admin Auth (From NCF [cite: 213-216])
        const loginPromptBtn = $('#login-prompt-btn');
        const logoutBtn = $('#logout-btn');
        const userInfoDiv = $('#user-info');
        const userEmailSpan = $('#user-email');
        const passwordModal = $('#passwordModal');
        const passwordInput = $('#passwordInput');
        const modalOkBtn = $('#modalOkBtn');
        const modalCancelBtn = $('#modalCancelBtn');

        // Dashboard Elements (From NCF [cite: 275-288])
        const tableBody = document.getElementById('ncfTableBody');
        const searchInput = document.getElementById('searchInput');
        const filterDepartment = document.getElementById('filterDepartment');
        const filterStatus = document.getElementById('filterStatus');
        const filterPriority = document.getElementById('filterPriority'); // (‡πÉ‡∏´‡∏°‡πà)
        const detailsSidebar = document.getElementById('detailsSidebar');
        const sidebarContent = document.getElementById('sidebarContent');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const exportStartDate = document.getElementById('exportStartDate');
        const exportEndDate = document.getElementById('exportEndDate');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');

        // (‡πÉ‡∏´‡∏°‡πà) Graph Elements
        const monthlyTrendCtx = document.getElementById('monthlyTrendChart')?.getContext('2d');
        const statusOverviewCtx = document.getElementById('statusOverviewChart')?.getContext('2d');
        // (‡πÉ‡∏´‡∏°‡πà) ‡∏Å‡∏£‡∏≤‡∏ü Trend ‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà departmentChart)
        const departmentTrendCtx = document.getElementById('departmentTrendChart')?.getContext('2d');
        // (‡πÉ‡∏´‡∏°‡πà) Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å
        const deptStatusContainer = document.getElementById('departmentStatusContainer');

        // AI Copilot Elements (From NCF [cite: 289-295])
        const copilotBtn = $('#copilot-btn');
        const copilotSidebar = $('#copilot-sidebar');
        const closeCopilotBtn = $('#close-copilot-btn');
        const copilotContent = $('#copilot-content');
        const copilotChatInput = $('#copilot-chat-input');
        const copilotChatSubmitBtn = $('#copilot-chat-submit-btn');
        const analyzeBtn = $('#analyze-btn');

        // Pagination Elements (From NCF [cite: 369-371])
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');

        // --- 3. State Variables ---

        // (‡πÉ‡∏´‡∏°‡πà) Graph States
        let monthlyTrendChart, statusOverviewChart, departmentTrendChart;
        let deptStatusCharts = []; // (‡πÉ‡∏´‡∏°‡πà) Array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡πà‡∏≠‡∏¢‡πÜ

        // State (From NCF [cite: 299-305])
        let currentFilteredRecords = [];
        let currentRecord = null;
        let currentUserRecord = null;
        let isInitialLoad = true;
        let currentPage = 1;
        const rowsPerPage = 15; // ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠
        let lastVisibleDoc = null;
        let pageDocHistory = [null];
        let loginEmailAttempt = null; // (From NCF)

        // --- 4. (‡πÉ‡∏´‡∏°‡πà) View Switching & Initial Load Logic ---

        // Show Landing Page by default
        landingView.show();
        dashboardView.hide();
        userResultView.hide();

        // Landing -> Staff Password Modal
        staffLoginBtn.on('click', () => {
            staffPasswordInput.val('');
            staffPasswordModal.show();
            staffPasswordInput.focus();
        });
        staffPasswordCancelBtn.on('click', () => staffPasswordModal.hide());
        

        // Staff Password Logic
        staffPasswordOkBtn.on('click', () => {
            if (staffPasswordInput.val() === "123456789") { // Password ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á
                staffPasswordModal.hide();
                landingView.fadeOut(() => {
                    dashboardView.fadeIn();
                    // (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) Initial Load Dashboard Data *NOW*
                    initializeDashboard();
                });
            } else {
                alert("Incorrect Password!");
                staffPasswordInput.val('');
            }
        });

        // Landing -> User Search Modal
        userSearchBtn.on('click', () => {
            userSearchInput_number.val(''); // <--- 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
            userSearchModal.show();
            userSearchInput_number.focus(); // <--- 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
        });
        userSearchCancelBtn.on('click', () => userSearchModal.hide());
        

        // User Search Logic
            userSearchOkBtn.on('click', async () => {
            // (‡πÉ‡∏´‡∏°‡πà) ‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á prefix ‡πÅ‡∏•‡∏∞ number ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å
            const requestNumber = userSearchInput_number.val().trim(); // <--- 4. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic
            if (!requestNumber) return;
            const requestId = "LAB-SP-" + requestNumber;

            userSearchOkBtn.prop('disabled', true).text('Searching...');
            try {
                const snapshot = await db.collection("sample_requests")
                                         .where("requestId", "==", requestId)
                                         .limit(1)
                                         .get();

                if (snapshot.empty) {
                    alert("Request ID not found. Please check the ID and try again.");
                } else {
                    const record = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    displayUserResult(record); // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
                    userSearchModal.hide();
                    landingView.fadeOut(() => {
                        userResultView.fadeIn();
                    });
                }
            } catch (error) {
                console.error("Error searching for Request ID: ", error);
                alert("An error occurred while searching.");
            } finally {
                userSearchOkBtn.prop('disabled', false).text('Search');
            }
        });

        // Back to Landing
        backToLandingBtn.on('click', () => {
            userResultView.fadeOut(() => {
                landingView.fadeIn();
                userResultContent.html(''); // Clear content
            });
        });

        // (‡πÉ‡∏´‡∏°‡πà) Function to display user result
        // (‡πÉ‡∏´‡∏°‡πà) Function to display user result (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Bug)
        const displayUserResult = (record) => {
            currentUserRecord = record;
        userResultRequestId.text(record.requestId);

        // (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % progress (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° 'result' ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 'status')
                    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Test ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏´‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
        const relevantTests = record.testsRequired.filter(t => t.testName && t.testName.trim() !== '');
        const totalTests = relevantTests.length;
                    // "Completed" ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á ‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (result)
        const completedTests = relevantTests.filter(t => t.result && t.result.trim() !== '').length;
        const progressPercent = totalTests > 0 ? (completedTests / totalTests) * 100 : 0;

        let html = `
        <div class="flex justify-end gap-3 mb-6 pb-4 border-b border-gray-200">
             <button onclick="printUserReport()" class="btn btn-secondary text-sm">
                <i class="fas fa-print"></i> Print Report
             </button>
             <button onclick="exportUserExcel()" class="btn btn-primary bg-green-600 hover:bg-green-700 text-white text-sm">
                <i class="fas fa-file-excel"></i> Download Excel
             </button>
        </div>
        <div class="mb-6">
        <span class="sidebar-label">Sample Name</span>
        <span class="sidebar-value text-lg">${record.sampleName}</span>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
<div><span class="sidebar-label">Request Date</span><span class="sidebar-value">${new Date(record.requestDate).toLocaleString('th-TH')}</span></div>
<div><span class="sidebar-label">Requester</span><span class="sidebar-value">${record.requesterName} (${record.requesterDepartment})</span></div>
<div><span class="sidebar-label">Priority</span><span class="sidebar-value">${record.priority}</span></div>
<div><span class="sidebar-label">Overall Status</span><span class="sidebar-value font-bold">${record.status}</span></div>
    
</div>

        <div class="mb-6">
        <span class="sidebar-label">Test Progress (${completedTests} of ${totalTests} completed)</span>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progressPercent}%"></div>
        </div>
        </div>

        <div class="sidebar-section">
        <h3 class="font-bold text-lg mb-4 text-gray-700">Test Results</h3>
        <ul class="space-y-3">
        `;

        // (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) 2. Loop for tests (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° 'result' ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 'status')
            const groupedData = {};
            relevantTests.forEach((test) => {
                const sLabel = test.sampleLabel || 'Sample #1'; 
                const tLabel = test.timePoint || 'Result';
                if (!groupedData[sLabel]) groupedData[sLabel] = {};
                if (!groupedData[sLabel][tLabel]) groupedData[sLabel][tLabel] = [];
                groupedData[sLabel][tLabel].push(test);
            });

            // Render Groups
            for (const [sampleLabel, timePoints] of Object.entries(groupedData)) {
                html += `<div class="mb-4 border border-gray-200 rounded-lg overflow-hidden">`;
                html += `<div class="bg-blue-50 px-4 py-2 font-bold text-blue-800 border-b border-blue-100">
                            <i class="fas fa-vial mr-2"></i>${sampleLabel}
                         </div>`;
                html += `<div class="p-4 bg-white space-y-4">`;

                for (const [timeLabel, tests] of Object.entries(timePoints)) {
                     // ‡πÅ‡∏™‡∏î‡∏á Time Header
                     html += `<h5 class="text-sm font-semibold text-slate-500 border-b pb-1 mt-1">
                                <i class="far fa-clock mr-1"></i>${timeLabel}
                              </h5>`;

                     html += `<ul class="space-y-2 mt-2">`;
                     tests.forEach(test => {
                        let statusIcon;
                        let resultText;

                        if (test.result && test.result.trim() !== '') {
                            statusIcon = '<i class="fas fa-check-circle text-green-500"></i>';
                            resultText = `<span class="font-bold text-blue-900">${test.result}</span>`;
                        } else {
                            statusIcon = '<i class="fas fa-hourglass-half text-yellow-500"></i>';
                            resultText = '<span class="text-gray-400 italic">(Pending)</span>';
                        }

                        html += `
                        <li class="flex justify-between items-center p-2 bg-gray-50 rounded text-sm">
                            <span class="font-medium text-gray-700 flex items-center gap-2">
                                ${statusIcon} ${test.testName}
                            </span>
                            <span>${resultText}</span>
                        </li>`;
                     });
                     html += `</ul>`;
                }
                html += `</div></div>`;
            }
                   html += `
            <div class="grid grid-cols-2 gap-4 mt-6 pt-4 border-t border-gray-200">
                <div>
                    <span class="sidebar-label">Lab Tester</span>
                    <span class="sidebar-value">${record.labTesterName || '-'}</span> 
                </div>
                <div>
                    <span class="sidebar-label">Lab Remarks</span>
                    <span class="sidebar-value">${record.labRemark || '-'}</span>
                </div>
            </div>
            `;
        userResultContent.html(html);
        };

        // --- 5. (‡πÉ‡∏´‡∏°‡πà) Dashboard Initialization Function ---
        const initializeDashboard = () => {
            // (From NCF) Setup Admin Auth
            setupAdminAuth();

            // (From NCF) Setup AI Copilot
            setupAICopilot();

            // (From NCF) Setup General Listeners
            setupDashboardListeners();

            // (From NCF) Load data
            // (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchDashboardData ‡πÅ‡∏•‡∏∞ resetAndRender ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
            exportExcelBtn.disabled = true;
            exportExcelBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading Data...`;

            fetchDashboardData();
            resetAndRender();
        };

        // --- 6. Admin Auth (Copied from NCF [cite: 218-272]) ---
        const setupAdminAuth = () => {
            loginPromptBtn.on('click', () => {
                const email = prompt("Please enter your admin email:");
                if (email) {
                    loginEmailAttempt = email;
                    passwordInput.val('');
                    passwordModal.show();
                    passwordInput.focus();
                }
            });
            modalOkBtn.on('click', () => {
                const password = passwordInput.val();
                if (password && loginEmailAttempt) {
                    auth.signInWithEmailAndPassword(loginEmailAttempt, password)
                        .catch(err => alert("Login Failed: " + err.message));
                }
                passwordModal.hide();
                loginEmailAttempt = null;
            });
            modalCancelBtn.on('click', () => {
                passwordModal.hide();
                loginEmailAttempt = null;
            });
            
            logoutBtn.on('click', () => auth.signOut());

            auth.onAuthStateChanged(user => {
                currentUser = user;
                const isAdmin = user && adminEmails.includes(user.email.toLowerCase());
                if (user) {
                    loginPromptBtn.hide();
                    userInfoDiv.show().css('display', 'flex');
                    userEmailSpan.text(user.email);
                } else {
                    loginPromptBtn.show();
                    userInfoDiv.hide();
                }

                // Show/Hide Admin Columns
                const headers = document.querySelectorAll('.admin-actions-header');
                const cells = document.querySelectorAll('.admin-actions-cell');
                const displayStyle = isAdmin ? '' : 'none';
                headers.forEach(el => el.style.display = displayStyle);
                cells.forEach(el => el.style.display = displayStyle);
            });
        };

        // --- 7. AI Copilot Logic (Adapted from NCF [cite: 309-367]) ---
        const setupAICopilot = () => {
            copilotBtn.on('click', () => copilotSidebar.addClass('open'));
            closeCopilotBtn.on('click', () => copilotSidebar.removeClass('open'));

            analyzeBtn.on('click', async function() {
                copilotSidebar.addClass('open');
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Analyzing...');

                copilotContent.html('<p class="text-center">‚ú® Analyzing data from server... Please wait a moment.</p>');
                try {
                    // (‡πÉ‡∏´‡∏°‡πà) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI ‡πÉ‡∏´‡∏°‡πà
                    const result = await getSampleAiAnalysis(); 
                    const text = result.data.text;
                    copilotContent.html(marked.parse(text));
                } catch (error) {
                    console.error("Error calling AI Analysis Function:", error);
                    copilotContent.html(`<p class="text-red-500">Sorry, the AI analysis failed. Error: ${error.message}</p>`);
                } finally {
                    $(this).prop('disabled', false).html('<i class="fas fa-sparkles"></i> Analyze with AI');
                }
            });

            copilotChatSubmitBtn.on('click', async function() {
                const question = copilotChatInput.val().trim();
                if (!question) return;

                const chatBtn = $(this);
                chatBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                const userQuestionHtml = `<div class="user-question mb-2 border-t pt-4 mt-4"><p class="font-semibold text-slate-800">You:</p><p>${question}</p></div>`;
                copilotContent.append(userQuestionHtml);
                const thinkingHtmlId = `thinking-${Date.now()}`;
                const thinkingHtml = `<div id="${thinkingHtmlId}" class="ai-answer"><p class="font-semibold text-purple-600">AI:</p><p>ü§î Thinking...</p></div>`;
                copilotContent.append(thinkingHtml);
                copilotContent.scrollTop(copilotContent[0].scrollHeight);
                copilotChatInput.val('');

                try {
                    // (‡πÉ‡∏´‡∏°‡πà) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Chat ‡πÉ‡∏´‡∏°‡πà
                    const result = await askSampleChat({ question: question }); 
                    const text = result.data.text;
                    $(`#${thinkingHtmlId}`).html(`<p class="font-semibold text-purple-600">AI:</p><div>${marked.parse(text)}</div>`);
                } catch (error) {
                    console.error("Error calling AI Chat Function:", error);
                    $(`#${thinkingHtmlId}`).html(`<p class="text-red-500">Error: ${error.message}</p>`);
                } finally {
                    chatBtn.prop('disabled', false).html('Send');
                    copilotContent.scrollTop(copilotContent[0].scrollHeight);
                }
            });
        };

        // --- 8. Dashboard Data Logic ---

        // (‡πÉ‡∏´‡∏°‡πà) ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard (‡πÄ‡∏ô‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î Read)
        const fetchDashboardData = () => {
            // (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!) ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö NCF 
            // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ Listen ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ (Summary Document)
            // ‡∏Ñ‡∏∏‡∏ì *‡∏ï‡πâ‡∏≠‡∏á* ‡∏™‡∏£‡πâ‡∏≤‡∏á Cloud Function ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
            const summaryRef = db.collection("metadata").doc("sample_dashboard_summary");

            summaryRef.onSnapshot(doc => {
                if (doc.exists) {
                    const summaryData = doc.data();
                    updateDashboard(summaryData); // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
                } else {
                    console.warn("Sample Summary document (sample_dashboard_summary) does not exist.");
                    updateDashboard({}); // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
                }
            }, error => {
                console.error("Error fetching sample dashboard data: ", error);
            });
        };

        // (‡πÉ‡∏´‡∏°‡πà) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á NCF [cite: 551-681])
        const updateDashboard = (summaryData) => {

            // (‡πÉ‡∏´‡∏°‡πà) ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å NCF)
            const deptColorMap = {
                'Viscose': '#3b82f6', // blue
                'Spinning': '#f59e0b', // amber
                'Auxiliary': '#10b981', // green
                'ETP&WTP': '#a855f7', // purple
                'ABEC': '#ec4899', // pink
                'Warehouse': '#84cc16', // lime
                'Quality Control': '#ef4444', // red
                'Technical Cell': '#14b8a6', // teal
                'Maintenance': '#6b7280', // gray
                'Other Unit': '#d946ef'  // fuchsia
            };
            const defaultColor = '#94a3b8'; // slate

            // --- 1. ‡πÅ‡∏õ‡∏•‡∏á Flat Data (Firestore) ‡πÄ‡∏õ‡πá‡∏ô Nested (Charts) ---
            const monthlyTrendData = {};
            const statusData = {};
            const monthlyTrendByDept = {}; // (‡πÉ‡∏´‡∏°‡πà) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏≤‡∏ü Trend ‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å
            const deptStatusData = {};     // (‡πÉ‡∏´‡∏°‡πà) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å

            for (const key in summaryData) {
                const value = summaryData[key];
                const parts = key.split('.');

                if (parts[0] === 'monthlyTrend' && parts.length === 2) {
                    monthlyTrendData[parts[1]] = value;
                } else if (parts[0] === 'status' && parts.length === 2) {
                    statusData[parts[1]] = value;
                } else if (parts[0] === 'monthlyTrendByDept' && parts.length === 3) {
                    // e.g., monthlyTrendByDept.VIS.2025-11
                    const [_, dept, month] = parts;
                    if (!monthlyTrendByDept[dept]) monthlyTrendByDept[dept] = {};
                    monthlyTrendByDept[dept][month] = value;
                } else if (parts[0] === 'deptStatus' && parts.length === 3) {
                    // e.g., deptStatus.AUX.Submitted
                    const [_, dept, status] = parts;
                    if (!deptStatusData[dept]) deptStatusData[dept] = {};
                    deptStatusData[dept][status] = value;
                }
            }

            // --- 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏Å‡∏ô X (6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á) ---
            const monthLabels = [];
            const monthIds = [];
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
            sixMonthsAgo.setDate(1);
            for (let i = 0; i < 6; i++) {
                const date = new Date(sixMonthsAgo.getFullYear(), sixMonthsAgo.getMonth() + i, 1);
                monthLabels.push(date.toLocaleString('en-US', { month: 'short', year: '2-digit' }));
                monthIds.push(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
            }

            // --- ‡∏Å‡∏£‡∏≤‡∏ü 1: Monthly Sample Requests Trend (Submitted ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ---
            const trendDataset = {
                label: 'Samples Submitted',
                data: monthIds.map(monthId => monthlyTrendData[monthId] || 0),
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3
            };

            if (monthlyTrendChart) monthlyTrendChart.destroy();
            if (monthlyTrendCtx) {
                monthlyTrendChart = new Chart(monthlyTrendCtx, {
                    type: 'line',
                    data: { labels: monthLabels, datasets: [trendDataset] }, // (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡πÄ‡∏≠‡∏≤ Completed ‡∏≠‡∏≠‡∏Å
                    plugins: [ChartDataLabels],
                    options: {
                        plugins: {
                            legend: { display: false }, // (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏õ‡∏¥‡∏î Legend
                            datalabels: {
                            display: false // (‡πÉ‡∏´‡∏°‡πà) ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡∏µ‡πâ
                            }
                        },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            // --- ‡∏Å‡∏£‡∏≤‡∏ü 2: Requests by Status (Submitted & Completed ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ---
            const statusLabels = ['Submitted', 'Completed'];
            const statusColors = ['rgba(59, 130, 246, 0.7)', 'rgba(34, 197, 94, 0.7)']; // (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
            const statusCounts = [
                statusData['Submitted'] || 0,
                statusData['Completed'] || 0 // (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
            ];
            const totalStatus = statusCounts.reduce((a, b) => a + b, 0);

            if (statusOverviewChart) statusOverviewChart.destroy();
            if (statusOverviewCtx) {
                statusOverviewChart = new Chart(statusOverviewCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [{ data: statusCounts, backgroundColor: statusColors }]
                    },
                    plugins: [ChartDataLabels],
                    options: {
                        plugins: {
                            legend: { position: 'right' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    if (totalStatus === 0) return '0%';
                                    const percentage = (value / totalStatus * 100).toFixed(0);
                                    return percentage + '%';
                                },
                                color: '#ffffff',
                                font: { weight: 'bold', size: 14 }
                            }
                        }
                    }
                });
            }

            // --- ‡∏Å‡∏£‡∏≤‡∏ü 3: Monthly Sample Trend by Department (‡πÉ‡∏´‡∏°‡πà) ---
            if (departmentTrendChart) departmentTrendChart.destroy();
            if (departmentTrendCtx) {
                const deptTrendDatasets = [];
                const depts = Object.keys(monthlyTrendByDept).sort();

                depts.forEach(dept => {
                    const color = deptColorMap[dept] || defaultColor;
                    deptTrendDatasets.push({
                        label: dept,
                        data: monthIds.map(monthId => monthlyTrendByDept[dept][monthId] || 0),
                        borderColor: color,
                        backgroundColor: `${color}33`, // ‡πÄ‡∏û‡∏¥‡πà‡∏° Alpha 0.2
                        fill: true,
                        tension: 0.4
                    });
                });

                departmentTrendChart = new Chart(departmentTrendCtx, {
                    type: 'line',
                    data: { labels: monthLabels, datasets: deptTrendDatasets },
                    options: {
                        plugins: {
                            legend: { position: 'top', labels: { usePointStyle: true } }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }

            // --- [NEW] ‡∏Å‡∏£‡∏≤‡∏ü 3.5: Workload Trend by Department ---
            const workloadTrendCtx = document.getElementById('workloadTrendChart')?.getContext('2d');
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Workload
            const workloadByDept = {}; 

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å summaryData (‡∏ï‡πâ‡∏≠‡∏á Loop ‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ó‡∏£‡∏Å‡πÉ‡∏ô Loop ‡πÅ‡∏£‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ)
            for (const key in summaryData) {
                const parts = key.split('.');
                if (parts[0] === 'workloadByDept' && parts.length === 3) {
                    const [_, dept, month] = parts;
                    if (!workloadByDept[dept]) workloadByDept[dept] = {};
                    workloadByDept[dept][month] = summaryData[key];
                }
            }

            if (workloadTrendCtx) {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ workloadChartGlobal ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ window.workloadChart ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏£‡∏µ‡∏ö)
                if (window.workloadChart) window.workloadChart.destroy();

                const workloadDatasets = [];
                const depts = Object.keys(workloadByDept).sort(); // ‡πÉ‡∏ä‡πâ Key ‡∏à‡∏≤‡∏Å Workload ‡πÅ‡∏ó‡∏ô

                depts.forEach(dept => {
                    const color = deptColorMap[dept] || defaultColor;
                    workloadDatasets.push({
                        label: dept,
                        data: monthIds.map(monthId => workloadByDept[dept][monthId] || 0),
                        backgroundColor: color, // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ó‡∏∂‡∏ö‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô Bar Chart ‡∏à‡∏∞‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤
                        borderColor: color,
                        borderWidth: 1
                    });
                });

                window.workloadChart = new Chart(workloadTrendCtx, {
                    type: 'bar', // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡πá‡∏ô Bar Chart ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô Volume ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                    data: { labels: monthLabels, datasets: workloadDatasets },
                    options: {
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        responsive: true,
                        scales: {
                            x: { stacked: true }, // ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô (Stacked) ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° Workload ‡∏î‡∏µ‡∏°‡∏≤‡∏Å
                            y: { stacked: true, beginAtZero: true }
                        }
                    }
                });
            }

            // --- ‡∏Å‡∏£‡∏≤‡∏ü 4: Department Status Overview (‡πÉ‡∏´‡∏°‡πà) ---
            if (deptStatusContainer) {
                // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏¢‡πà‡∏≠‡∏¢‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
                deptStatusCharts.forEach(chart => chart.destroy());
                deptStatusCharts = [];
                deptStatusContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á Container

                const depts = Object.keys(deptStatusData).sort();

                depts.forEach(dept => {
                    const submitted = deptStatusData[dept].Submitted || 0;
                    const completed = deptStatusData[dept].Completed || 0;
                    const total = submitted + completed;

                    if (total === 0) return; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

                    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML Structure
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex flex-col items-center';
                    const canvasId = `dept-status-${dept.replace(/[^a-zA-Z0-9]/g, '')}`; // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                    wrapper.innerHTML = `
                        <div class="w-24 h-24 relative">
                            <canvas id="${canvasId}"></canvas>
                        </div>
                        <h4 class="font-semibold text-gray-700 mt-2 text-sm">${dept}</h4>
                        <p class="text-xs text-gray-500">Total: ${total}</p>
                    `;
                    deptStatusContainer.appendChild(wrapper);

                    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    const miniChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Submitted', 'Completed'],
                            datasets: [{
                                data: [submitted, completed],
                                backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(34, 197, 94, 0.7)'],
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        },
                        plugins: [ChartDataLabels],
                        options: {
                            responsive: true,
                            cutout: '60%',
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: true },
                                datalabels: {
                                    formatter: (value, ctx) => {
                                        const percentage = (value / total * 100).toFixed(0);
                                        return percentage > 0 ? percentage + '%' : '';
                                    },
                                    color: '#ffffff',
                                    font: { weight: 'bold', size: 10 }
                                }
                            }
                        }
                    });
                    deptStatusCharts.push(miniChart); // ‡πÄ‡∏Å‡πá‡∏ö reference ‡πÑ‡∏ß‡πâ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢
                });
            }
        };

        // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å NCF) Render Table
        const renderTable = (records) => {
            const isAdmin = currentUser && adminEmails.includes(currentUser.email?.toLowerCase()); // [cite: 414]
            tableBody.innerHTML = '';
            if (records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">No records found.</td></tr>`; // [cite: 417]
                return;
            }

            records.forEach(record => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 cursor-pointer';
                tr.setAttribute('data-id', record.id);

                const status = record.status || 'Submitted';
                let statusBadge = '';
                if (status === 'Submitted') statusBadge = `<span class="status-badge status-submitted">Submitted</span>`;
                else if (status === 'In Progress') statusBadge = `<span class="status-badge status-inprogress">In Progress</span>`;
                else if (status === 'Completed') statusBadge = `<span class="status-badge status-completed">Completed</span>`;

                let priorityClass = '';
                if (record.priority === 'Urgent') priorityClass = 'font-bold text-red-600';
                else if (record.priority === 'High') priorityClass = 'font-semibold text-yellow-700';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-indigo-600">${record.requestId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${record.sampleName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.requesterDepartment}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(record.requestDate).toLocaleString('th-TH')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${priorityClass}">${record.priority}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                    <td class="admin-actions-cell px-6 py-4 whitespace-nowrap text-center" style="display: ${isAdmin ? '' : 'none'};">
                        <div class="flex justify-center items-center gap-4">
                            <button onclick="editRecord(event, '${record.id}')" class="text-blue-500 hover:text-blue-700" title="Edit Record">
                                <i class="fas fa-edit fa-lg"></i>
                            </button>
                            <button onclick="deleteRecord(event, '${record.id}')" class="text-red-500 hover:text-red-700" title="Delete Record">
                                <i class="fas fa-trash-alt fa-lg"></i>
                            </button>
                        </div>
                    </td>
                `; // [cite: 436-445]
                tableBody.appendChild(tr);

            tr.addEventListener('click', () => {
                // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Record ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
                const originalRecord = currentFilteredRecords.find(r => r.id === record.id);

                // 2. (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!) Clone ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Record ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô State Pollution
                // ‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢ spread property ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                // ‡πÅ‡∏•‡∏∞ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏™‡∏£‡πâ‡∏≤‡∏á Array ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö testsRequired (‡πÅ‡∏•‡∏∞ object ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô)
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£ "Add Parameter" ‡πÉ‡∏ô Sidebar ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
                currentRecord = {
                    ...originalRecord,
                    testsRequired: originalRecord.testsRequired.map(test => ({...test}))
                };

                // 3. ‡πÅ‡∏™‡∏î‡∏á Sidebar ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á" (Clone)
                populateAndShowSidebar(currentRecord, 'progress');
            });
            }); // (‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ }); ‡∏à‡∏≤‡∏Å [cite: 829])
        };

        // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å NCF [cite: 457]) Main Query Function
        const applyFiltersAndRender = async (pageDirection = 'first') => {
            const searchValue = searchInput.value.toLowerCase();
            const deptValue = filterDepartment.value;
            const statusValue = filterStatus.value;
            const priorityValue = filterPriority.value; // (‡πÉ‡∏´‡∏°‡πà)
            const startDateValue = exportStartDate.value;
            const endDateValue = exportEndDate.value;

            let query = db.collection("sample_requests"); // (‡πÉ‡∏´‡∏°‡πà) Collection

            // --- ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö Query (Filters) ---
            if (deptValue !== 'all') {
                query = query.where("requesterDepartment", "==", deptValue);
            }
            if (priorityValue !== 'all') {
                query = query.where("priority", "==", priorityValue);
            }

            // (‡πÉ‡∏´‡∏°‡πà) Logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á Status (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠)
            if (statusValue === 'open') {
                query = query.where("status", "in", ["Submitted", "In Progress"]);
            } else if (statusValue !== 'all') {
                query = query.where("status", "==", statusValue);
            }

            if (startDateValue) {
                query = query.where("createdAt", ">=", new Date(startDateValue + "T00:00:00"));
            }
            if (endDateValue) {
                query = query.where("createdAt", "<=", new Date(endDateValue + "T23:59:59"));
            }

            // Search & Order (‡∏à‡∏≤‡∏Å NCF [cite: 495-503])
            if (searchValue) {
                query = query.orderBy("requestId") // (‡πÉ‡∏´‡∏°‡πà) ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ requestId
                           .startAt(searchValue.toUpperCase())
                           .endAt(searchValue.toUpperCase() + '\uf8ff');
            } else {
                query = query.orderBy("createdAt", "desc");
            }

            // --- Pagination Logic (From NCF [cite: 504-548]) ---
            try {
                if (pageDirection === 'prev') {
                    lastVisibleDoc = pageDocHistory[currentPage - 1];
                    pageDocHistory.pop();
                }

                let pageQuery = query;
                if (lastVisibleDoc && (pageDirection === 'next' || pageDirection === 'prev')) {
                    pageQuery = pageQuery.startAfter(lastVisibleDoc);
                }
                pageQuery = pageQuery.limit(rowsPerPage);

                const snapshot = await pageQuery.get();
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (!snapshot.empty) {
                    lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                    if (pageDirection === 'next') {
                        pageDocHistory.push(lastVisibleDoc);
                    }
                }

                currentFilteredRecords = records;
                renderTable(records);
                updatePaginationUI(records.length);

            } catch (error) {
                console.error("Error fetching paginated records: ", error);
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-red-500">Failed to load data. Error: ${error.message}</td></tr>`;
            } finally {
                if (isInitialLoad) {
                    exportExcelBtn.disabled = false;
                    exportExcelBtn.innerHTML = `<i class="fas fa-file-excel"></i> Export Excel`;
                    isInitialLoad = false;
                }
            }
        };

        // (From NCF [cite: 373-380])
        const updatePaginationUI = (recordsFetchedCount) => {
            pageInfo.textContent = `Page ${currentPage}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = recordsFetchedCount < rowsPerPage;
        };

        // --- 9. Sidebar Logic (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏≤‡∏Å NCF) ---

        // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å NCF [cite: 683])
        const populateAndShowSidebar = (record, mode = 'progress') => {
            const isEditMode = (mode === 'edit');
            let contentHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-1">Sample ID: ${record.requestId}</h2>`;

            if (isEditMode) {
                contentHTML += `<p class="text-sm text-blue-600 font-semibold mb-6">Mode: Editing Record Data</p>`;
            } else {
                const requestedAt = (record.createdAt && record.createdAt.toDate) ? record.createdAt.toDate().toLocaleString('th-TH') : 'N/A';
                contentHTML += `<p class="text-sm text-gray-500 mb-6">Requested on: ${requestedAt}</p>`;
            }

            // --- Section 1: Requester & Sample Info ---
            contentHTML += `<div class="sidebar-section"><h3 class="font-bold text-lg mb-4 text-gray-700">Sample Info</h3>`;

            if (isEditMode) {
                // --- (‡πÉ‡∏´‡∏°‡πà) ‡πÇ‡∏´‡∏°‡∏î Admin Edit (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ 4) ---
                contentHTML += `<form id="editForm" class="space-y-4">
            <div><label class="sidebar-label">Sample Name</label><input type="text" id="edit_sampleName" class="sidebar-input border p-2" value="${record.sampleName || ''}"></div>
            <div><label class="sidebar-label">Requester Name</label><input type="text" id="edit_requesterName" class="sidebar-input border p-2" value="${record.requesterName || ''}"></div>
            <div><label class="sidebar-label">Department</label><input type="text" id="edit_requesterDepartment" class="sidebar-input border p-2" value="${record.requesterDepartment || ''}"></div>
            <div><label class="sidebar-label">Priority</label>
                <select id="edit_priority" class="form-select border p-2">
                    <option value="Normal" ${record.priority === 'Normal' ? 'selected' : ''}>Normal</option>
                    <option value="High" ${record.priority === 'High' ? 'selected' : ''}>High</option>
                    <option value="Urgent" ${record.priority === 'Urgent' ? 'selected' : ''}>Urgent</option>
                </select>
            </div>
            <div><label class="sidebar-label">Batch/Lot No.</label><input type="text" id="edit_batchLotNumber" class="sidebar-input border p-2" value="${record.batchLotNumber || ''}"></div>
            <div><label class="sidebar-label">Sample Source</label><input type="text" id="edit_sampleSource" class="sidebar-input border p-2" value="${record.sampleSource || ''}"></div>
            <div><label class="sidebar-label">Reason for Test</label><textarea id="edit_reasonForTest" rows="2" class="sidebar-input border p-2">${record.reasonForTest || ''}</textarea></div>
            <div><label class="sidebar-label">Test Purpose</label><textarea id="edit_testJustification" rows="2" class="sidebar-input border p-2">${record.testJustification || ''}</textarea></div>
            `;
                // (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <form> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î)
            } else {
                // --- ‡πÇ‡∏´‡∏°‡∏î Staff Progress (Read-Only) ---
                contentHTML += `<div class="grid grid-cols-2 gap-4">
            <div><span class="sidebar-label">Sample Name</span><span class="sidebar-value">${record.sampleName}</span></div>
            <div><span class="sidebar-label">Priority</span><span class="sidebar-value">${record.priority}</span></div>
            <div><span class="sidebar-label">Requester</span><span class="sidebar-value">${record.requesterName}</span></div>
            <div><span class="sidebar-label">Department</span><span class="sidebar-value">${record.requesterDepartment}</span></div>
            <div><span class="sidebar-label">Batch/Lot No.</span><span class="sidebar-value">${record.batchLotNumber}</span></div>
            <div><span class="sidebar-label">Sample Source</span><span class="sidebar-value">${record.sampleSource}</span></div>
            <div class="col-span-2"><span class="sidebar-label">Reason for Test</span><p class="sidebar-value">${record.reasonForTest}</p></div>
            <div class="col-span-2"><span class="sidebar-label">Test Purpose</span><p class="sidebar-value">${record.testJustification}</p></div>
            ${record.photoURL ? `<div class="col-span-2"><span class="sidebar-label">Reference Photo</span><a href="${record.photoURL}" target="_blank" class="text-blue-600 hover:underline">View Image</a></div>` : ''}
            </div>`;
            }
            contentHTML += `</div>`; // ‡∏õ‡∏¥‡∏î Section 1

            // --- Section 2: Lab Results Entry ---
            if (isEditMode) {
                // --- (‡πÉ‡∏´‡∏°‡πà) Admin Edit Mode (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ 4) ---
                contentHTML += `<div class="sidebar-section"><h3 class="font-bold text-lg mb-4 text-gray-700">Lab Results (Admin Edit)</h3>`;
                if (record.testsRequired && record.testsRequired.length > 0) {
                    record.testsRequired.forEach((test, index) => {
                        contentHTML += `
                <div class="p-3 bg-gray-50 rounded-lg border mb-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div>
                            <label for="admin_edit_name_${index}" class="text-sm font-medium">Parameter:</label>
                            <input type="text" id="admin_edit_name_${index}" class="sidebar-input border p-2" value="${test.testName || ''}">
                        </div>
                        <div>
                            <label for="admin_edit_result_${index}" class="text-sm font-medium">Result:</label>
                            <input type="text" id="admin_edit_result_${index}" class="sidebar-input border p-2" value="${test.result || ''}">
                        </div>
                    </div>
                </div>
                `;
                    });
                } else {
                    contentHTML += `<p class="text-gray-500">No specific tests listed.</p>`;
                }
                // (‡πÉ‡∏´‡∏°‡πà) ‡πÄ‡∏û‡∏¥‡πà‡∏° Lab Remarks (‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ 4)
                contentHTML += `
            <div class="mt-4">
                <label for="edit_labRemark" class="sidebar-label">Lab Remarks (Optional):</label>
                <textarea id="edit_labRemark" rows="3" class="sidebar-input border p-2">${record.labRemark || ''}</textarea>
            </div>
            `;
                contentHTML += `</div>`; // ‡∏õ‡∏¥‡∏î Section 2 (Admin)
                contentHTML += `</form>`; // (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏õ‡∏¥‡∏î <form id="editForm"> ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
            } else {
      // --- (Staff Progress Mode: UPDATED FOR GROUPING) ---
      contentHTML += `<div class="sidebar-section"><h3 class="font-bold text-lg mb-4 text-gray-700">Lab Results Entry</h3>`;
      contentHTML += `<form id="resultsForm" class="space-y-4">`;
      
      contentHTML += `<div><label class="sidebar-label">Tester Name:</label><input type="text" id="labTesterName" class="sidebar-input border p-2" value="${record.labTesterName || ''}"></div>`;

      if (record.testsRequired && record.testsRequired.length > 0) {
          // 1. Grouping Data
          const groupedData = {};
          record.testsRequired.forEach((test, index) => {
              const sLabel = test.sampleLabel || 'Sample #1'; 
              const tLabel = test.timePoint || 'Result';
              if (!groupedData[sLabel]) groupedData[sLabel] = {};
              if (!groupedData[sLabel][tLabel]) groupedData[sLabel][tLabel] = [];
              groupedData[sLabel][tLabel].push({ ...test, originalIndex: index });
          });

          // 2. Rendering Groups
          let groupIndex = 0; // ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å
          for (const [sampleLabel, timePoints] of Object.entries(groupedData)) {
              const sampleHeaderId = `sample_header_${groupIndex}`; // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡πâ Header
              
              contentHTML += `<div class="mb-4 border border-blue-200 rounded-lg overflow-hidden">`;
              // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Text ‡πÄ‡∏õ‡πá‡∏ô Input
              contentHTML += `<div class="bg-blue-100 px-4 py-2 font-bold text-blue-800 flex items-center gap-2">
                                <i class="fas fa-vial"></i>
                                <input type="text" id="${sampleHeaderId}" class="bg-transparent border-b border-blue-300 focus:outline-none focus:border-blue-600 w-full font-bold text-blue-900" value="${sampleLabel}">
                              </div>`;
              contentHTML += `<div class="p-4 bg-white space-y-4">`;
              
              let timeIndex = 0; // ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢
              for (const [timeLabel, tests] of Object.entries(timePoints)) {
                  const timeHeaderId = `time_header_${groupIndex}_${timeIndex}`; // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡πâ Time Header
                  
                  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô H5 ‡πÄ‡∏õ‡πá‡∏ô Input (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢)
                  contentHTML += `<div class="flex items-center gap-2 mt-2 border-b pb-1">
                                    <i class="far fa-clock text-slate-400 text-xs"></i>
                                    <input type="text" id="${timeHeaderId}" class="text-sm font-semibold text-slate-600 bg-transparent focus:outline-none w-full" value="${timeLabel}">
                                  </div>`;

                  tests.forEach(item => {
                      const idx = item.originalIndex;
                      // ‡πÄ‡∏û‡∏¥‡πà‡∏° data-sample-header-id ‡πÅ‡∏•‡∏∞ data-time-header-id ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô Save
                      contentHTML += `
                      <div class="grid grid-cols-12 gap-2 items-center mb-2">
                          <div class="col-span-5">
                              <label class="text-xs text-gray-500 block">Parameter</label>
                              <input type="text" id="test_name_${idx}" class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="${item.testName}" placeholder="Parameter Name">
                          </div>
                          <div class="col-span-7">
                              <label class="text-xs text-gray-500 block">Result</label>
                              <input type="text" id="test_result_${idx}" 
                                     data-sample-header-id="${sampleHeaderId}" 
                                     data-time-header-id="${timeHeaderId}"
                                     class="w-full border border-blue-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500" 
                                     placeholder="Enter result..." value="${item.result || ''}">
                          </div>
                      </div>`;
                  });
                  timeIndex++;
              }
              contentHTML += `
                    <div class="mt-3 pt-3 border-t border-dashed border-blue-100 text-right">
                        <button type="button" class="add-param-btn text-sm text-blue-600 hover:text-blue-800 font-semibold" data-target-sample="${sampleLabel}">
                            <i class="fas fa-plus-circle"></i> Add to ${sampleLabel}
                        </button>
                    </div>
                `;
              contentHTML += `</div></div>`; 
              groupIndex++;
          }
      } else {
           contentHTML += `<p>No tests required.</p>`;
      }

      contentHTML += `
        <div>
          <label for="labRemark" class="sidebar-label">Lab Remarks (Optional):</label>
                <textarea id="labRemark" rows="3" class="sidebar-input border p-2" placeholder="e.g., Sample was wet upon arrival...">${record.labRemark || ''}</textarea>
            </div>
            `;
                contentHTML += `</form></div>`; // ‡∏õ‡∏¥‡∏î Section 2 (Staff)
            }

            // --- Action Buttons ---
            contentHTML += `<div id="sidebarActions" class="mt-8 flex items-center gap-2 flex-wrap">`;
            if (isEditMode) {
                contentHTML += `<button id="saveChangesBtn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Save Changes</button>`;
            } else {
                contentHTML += `<button id="saveResultsBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Save Results</button>`;
                if (record.status === 'Completed') {
                    contentHTML += `<span class="text-green-700 font-bold ml-4">(Status: Completed)</span>`;
                }
            }
            contentHTML += `</div>`;

            sidebarContent.innerHTML = contentHTML;
            detailsSidebar.classList.add('open');
        };

        // --- 10. Event Listeners (Dashboard) ---

        // (‡πÉ‡∏´‡∏°‡πà) Sidebar Save Logic (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å NCF [cite: 843-974])
        detailsSidebar.addEventListener('click', async (e) => {
            // (‡πÉ‡∏´‡∏°‡πà) Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "Add New Parameter" (‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å Sample)
            const addBtn = e.target.closest('.add-param-btn'); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡πÇ‡∏î‡∏ô‡∏õ‡∏∏‡πà‡∏° class ‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°

            if (addBtn) {
                e.preventDefault();

                // 1. Save State ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                currentRecord.labTesterName = document.getElementById('labTesterName')?.value || '';
                currentRecord.labRemark = document.getElementById('labRemark')?.value || '';

                // (Logic Save Header ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
                currentRecord.testsRequired.forEach((test, index) => {
                    const resultInput = document.getElementById(`test_result_${index}`);
                    const nameInput = document.getElementById(`test_name_${index}`);
                    if (resultInput && nameInput) {
                         const sampleHeaderId = resultInput.getAttribute('data-sample-header-id');
                         const timeHeaderId = resultInput.getAttribute('data-time-header-id');

                         test.testName = nameInput.value;
                         test.result = resultInput.value;
                         test.sampleLabel = document.getElementById(sampleHeaderId)?.value || test.sampleLabel;
                         test.timePoint = document.getElementById(timeHeaderId)?.value || test.timePoint;
                    }
                });

                // 2. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ß‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Sample ‡πÑ‡∏´‡∏ô
                const targetSampleLabel = addBtn.getAttribute('data-target-sample');

                // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏ Sample Label ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏î
                currentRecord.testsRequired.push({
                    testName: "",
                    result: "",
                    sampleLabel: targetSampleLabel, // <--- ‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô: ‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏•‡∏∏‡πà‡∏°
                    timePoint: "One-time" // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (User ‡πÑ‡∏õ‡πÅ‡∏Å‡πâ Header ‡πÄ‡∏≠‡∏≤‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Day 2)
                });

                // 4. Render ‡πÉ‡∏´‡∏°‡πà
                populateAndShowSidebar(currentRecord, 'progress');
                return;
            }

            // (‡πÉ‡∏´‡∏°‡πà) Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Save Results (‡πÇ‡∏´‡∏°‡∏î Progress/Staff)
            if (e.target.id === 'saveResultsBtn') {
                const btn = e.target;
                btn.disabled = true;
                btn.textContent = 'Saving...';
                try {
                    // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á Parameter Name ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
                    const newTestsArray = currentRecord.testsRequired.map((test, index) => {
                        const resultInput = document.getElementById(`test_result_${index}`);
                        const nameInput = document.getElementById(`test_name_${index}`);

                        // ‡∏î‡∏∂‡∏á ID ‡∏Ç‡∏≠‡∏á Header ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô data-attribute
                        const sampleHeaderId = resultInput.getAttribute('data-sample-header-id');
                        const timeHeaderId = resultInput.getAttribute('data-time-header-id');

                        // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Header Input
                        const newSampleLabel = document.getElementById(sampleHeaderId)?.value || test.sampleLabel || 'Sample #1';
                        const newTimePoint = document.getElementById(timeHeaderId)?.value || test.timePoint || 'Result';

                        return {
                            // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢ spread operator
                            ...test, 
                            testName: nameInput.value,
                            result: resultInput.value,
                            sampleLabel: newSampleLabel, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠ Sample ‡πÉ‡∏´‡∏°‡πà
                            timePoint: newTimePoint      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
                        };
                    });

                    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏à‡πÄ‡∏ú‡∏•‡∏≠‡∏Å‡∏î Add ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å
                    const filledTestsArray = newTestsArray.filter(test =>
                        test.testName.trim() !== '' || test.result.trim() !== ''
                    );

                    // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
                    const relevantTests = filledTestsArray.filter(t => t.testName.trim() !== '');
                    const allTestsDone = relevantTests.length > 0 && relevantTests.every(t => t.result.trim() !== '');
                    let newOverallStatus;
                    if (allTestsDone) {
                        newOverallStatus = 'Completed';
                    } else if (relevantTests.some(t => t.result.trim() !== '')) {
                        newOverallStatus = 'In Progress';
                    } else {
                        newOverallStatus = 'Submitted';
                    }

                    // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firestore
                    await db.collection("sample_requests").doc(currentRecord.id).update({
                        testsRequired: filledTestsArray,
                        status: newOverallStatus,
                        labTesterName: document.getElementById('labTesterName').value,
                        labRemark: document.getElementById('labRemark').value
                    });

                    detailsSidebar.classList.remove('open');
                    resetAndRender(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                } catch (error) {
                    console.error("Error saving results: ", error);
                    alert("Failed to save results.");
                    btn.disabled = false;
                    btn.textContent = 'Save Results';
                }
            }

            // (‡πÉ‡∏´‡∏°‡πà) Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Save Changes (‡πÇ‡∏´‡∏°‡∏î Edit/Admin) (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠ 4)
            if (e.target.id === 'saveChangesBtn') {
                const btn = e.target;
                btn.disabled = true;
                btn.textContent = 'Saving...';
                try {
                    // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
                    const updateData = {
                        sampleName: document.getElementById('edit_sampleName').value,
                        requesterName: document.getElementById('edit_requesterName').value,
                        requesterDepartment: document.getElementById('edit_requesterDepartment').value,
                        priority: document.getElementById('edit_priority').value,
                        batchLotNumber: document.getElementById('edit_batchLotNumber').value,
                        sampleSource: document.getElementById('edit_sampleSource').value,
                        reasonForTest: document.getElementById('edit_reasonForTest').value,
                        testJustification: document.getElementById('edit_testJustification').value,
                        labRemark: document.getElementById('edit_labRemark').value // (‡πÉ‡∏´‡∏°‡πà)
                    };

                    // 2. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á (‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Parameter Name ‡πÅ‡∏•‡∏∞ Result)
                    const newTestsArray = currentRecord.testsRequired.map((test, index) => {
                        return {
                            testName: document.getElementById(`admin_edit_name_${index}`).value,
                            result: document.getElementById(`admin_edit_result_${index}`).value
                        };
                    });
                    // ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Admin ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Parameter ‡πÄ‡∏≠‡∏á)
                    updateData.testsRequired = newTestsArray.filter(test =>
                        test.testName.trim() !== '' || test.result.trim() !== ''
                    );


                    // 3. (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÇ‡∏´‡∏°‡∏î Staff)
                    const relevantTests = updateData.testsRequired.filter(t => t.testName.trim() !== '');
                    const allTestsDone = relevantTests.length > 0 && relevantTests.every(t => t.result.trim() !== '');

                    if (allTestsDone) {
                        updateData.status = 'Completed';
                    } else if (relevantTests.some(t => t.result.trim() !== '')) {
                        updateData.status = 'In Progress';
                    } else {
                        updateData.status = 'Submitted';
                    }

                    // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firestore
                    await db.collection("sample_requests").doc(currentRecord.id).update(updateData);

                    detailsSidebar.classList.remove('open');
                    resetAndRender();
                } catch (error) {
                    console.error("Error saving changes: ", error);
                    alert("Failed to save changes.");
                    btn.disabled = false;
                    btn.textContent = 'Save Changes';
                }
            }
        });

        // (‡πÉ‡∏´‡∏°‡πà) Admin Actions (Edit/Delete) (From NCF [cite: 976-1006])
        window.editRecord = (event, recordId) => {
        event.stopPropagation();
                    // (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
        const originalRecord = currentFilteredRecords.find(r => r.id === recordId); 
        if (originalRecord) {
                        // (‡πÉ‡∏´‡∏°‡πà) ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Clone ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡πÉ‡∏ô renderTable
                        currentRecord = {
                            ...originalRecord,
                            testsRequired: originalRecord.testsRequired.map(test => ({...test}))
                        };
        populateAndShowSidebar(currentRecord, 'edit'); // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î Edit ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Clone
        }
        };

        window.deleteRecord = (event, recordId) => {
            event.stopPropagation();
            if (!confirm(`Are you sure you want to delete this Sample Request?\nID: ${recordId}\nThis action cannot be undone.`)) {
                return;
            }
            db.collection("sample_requests").doc(recordId).delete()
                .then(() => {
                    alert("Record deleted successfully!");
                    resetAndRender();
                })
                .catch(error => {
                    console.error("Error deleting record: ", error);
                    alert("Failed to delete record: " + error.message);
                });
        };

        // (From NCF [cite: 1007-1012])
        const resetAndRender = () => {
            currentPage = 1;
            lastVisibleDoc = null;
            pageDocHistory = [null];
            applyFiltersAndRender('first');
        };

        // (From NCF [cite: 381-391])
        const setupDashboardListeners = () => {
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    applyFiltersAndRender('prev');
                }
            });
            nextPageBtn.addEventListener('click', () => {
                currentPage++;
                applyFiltersAndRender('next');
            });

            // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å NCF [cite: 1016-1029])
            searchInput.addEventListener('input', resetAndRender);
            filterDepartment.addEventListener('change', resetAndRender);
            filterStatus.addEventListener('change', resetAndRender);
            filterPriority.addEventListener('change', resetAndRender); // (‡πÉ‡∏´‡∏°‡πà)
            exportStartDate.addEventListener('change', resetAndRender);
            exportEndDate.addEventListener('change', resetAndRender);
            closeSidebarBtn.addEventListener('click', () => detailsSidebar.classList.remove('open'));

            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                filterDepartment.value = 'all';
                filterStatus.value = 'open'; // (‡πÉ‡∏´‡∏°‡πà) ‡∏Ñ‡πà‡∏≤ Default ‡∏Ñ‡∏∑‡∏≠ "open"
                filterPriority.value = 'all'; // (‡πÉ‡∏´‡∏°‡πà)
                exportStartDate.value = '';
                exportEndDate.value = '';
                resetAndRender();
            });

            // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å NCF [cite: 1040-1133]) Excel Export
            exportExcelBtn.addEventListener('click', async () => {
                exportExcelBtn.disabled = true;
                exportExcelBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Preparing...`;

                try {
                    const recordsToExport = await fetchAllFilteredRecordsForExport(); // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
                    if (recordsToExport.length === 0) {
                        alert("No data to export based on the current filters.");
                        return;
                    }

                    // (‡πÉ‡∏´‡∏°‡πà) ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export
                    const formattedData = recordsToExport.map(record => ({
                        "Request ID": record.requestId,
                        "Request Date": new Date(record.requestDate).toLocaleString('th-TH'),
                        "Priority": record.priority,
                        "Status": record.status,
                        "Sample Name": record.sampleName,
                        "Sample Source": record.sampleSource,
                        "Batch/Lot No.": record.batchLotNumber,
                        "Sample Count": record.sampleCount,
                        "Requester Name": record.requesterName,
                        "Requester Dept": record.requesterDepartment,
                        "Reason for Test": record.reasonForTest,
                        "Test Purpose": record.testJustification,
                        // 1. ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á "Tests Required" ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏∑‡πà‡∏≠ Test ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (Unique) ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î
                        "Tests Required": [...new Set(record.testsRequired.map(t => t.testName))].join(', '),

                        // 2. ‡πÅ‡∏Å‡πâ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏ Sample ‡πÅ‡∏•‡∏∞ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        ...Object.fromEntries(
                            record.testsRequired.map(t => {
                                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sample/Time ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÄ‡∏ä‡πà‡∏ô "Sample #1 (Day 1): Splinter"
                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡πÑ‡∏°‡πà‡∏°‡∏µ Label) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "Result" ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                                const colPrefix = t.sampleLabel ? `${t.sampleLabel} (${t.timePoint || '-'})` : "Result";
                                return [`${colPrefix}: ${t.testName}`, t.result];
                            })
                        )
                    }));

                    const worksheet = XLSX.utils.json_to_sheet(formattedData);
                    // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                    worksheet['!cols'] = [
                        { wch: 18 }, { wch: 20 }, { wch: 10 }, { wch: 12 }, { wch: 30 }, 
                        { wch: 25 }, { wch: 20 }, { wch: 10 }, { wch: 20 }, { wch: 20 },
                        { wch: 30 }, { wch: 40 }, { wch: 40 }
                    ]; 
                    // (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á default)

                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Sample Records");
                    XLSX.writeFile(workbook, "Special_Sample_Report_Detailed.xlsx");

                } catch (error) {
                    console.error("Error exporting Excel: ", error);
                    alert("An error occurred while preparing the export file.");
                } finally {
                    exportExcelBtn.disabled = false;
                    exportExcelBtn.innerHTML = `<i class="fas fa-file-excel"></i> Export Excel`;
                }
            });

            // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å NCF )
            const fetchAllFilteredRecordsForExport = async () => {
            const searchValue = searchInput.value.toLowerCase();
            const deptValue = filterDepartment.value;
            const statusValue = filterStatus.value;
            const priorityValue = filterPriority.value;
            const startDateValue = exportStartDate.value;
            const endDateValue = exportEndDate.value;

            // (‡πÉ‡∏´‡∏°‡πà) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Filter ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const isDefaultState = (
            deptValue === 'all' &&
            statusValue === 'open' && // <--- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            priorityValue === 'all' &&
            startDateValue === '' &&
            endDateValue === '' &&
            searchValue === ''
            );

            let query = db.collection("sample_requests");

            if (deptValue !== 'all') query = query.where("requesterDepartment", "==", deptValue);
            if (priorityValue !== 'all') query = query.where("priority", "==", priorityValue);

            // (‡πÉ‡∏´‡∏°‡πà) Logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á Status ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export
            if (!isDefaultState) {
            // ‡∏ñ‡πâ‡∏≤ *‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ* ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Filter ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (statusValue === 'open') query = query.where("status", "in", ["Submitted", "In Progress"]);
            else if (statusValue !== 'all') query = query.where("status", "==", statusValue);
            }
            // (‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (isDefaultState = true) ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏á Status ‡πÄ‡∏•‡∏¢ = ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)

            if (startDateValue) query = query.where("createdAt", ">=", new Date(startDateValue + "T00:00:00"));
            if (endDateValue) query = query.where("createdAt", "<=", new Date(endDateValue + "T23:59:59"));

            if (searchValue) {
            query = query.orderBy("requestId")
            .startAt(searchValue.toUpperCase())
            .endAt(searchValue.toUpperCase() + '\uf8ff');
            } else {
            query = query.orderBy("createdAt", "desc");
            }

            // (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏) Firestore ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å .get()
            // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1000 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Cloud Function ‡∏ä‡πà‡∏ß‡∏¢
            const snapshot = await query.limit(1000).get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            };
        };
        // --- [NEW] User Actions: Print & Export ---

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Print Report (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏ß‡∏¢‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå)
        window.printUserReport = () => {
            if (!currentUserRecord) return;

            const record = currentUserRecord;
            const printDate = new Date().toLocaleString('th-TH');

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏î‡∏∂‡∏á HTML ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ Clean)
            const printContent = `
                <html>
                <head>
                    <title>Test Report - ${record.requestId}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Sarabun', sans-serif; padding: 40px; color: #333; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 24px; }
                        .header p { margin: 5px 0; color: #666; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
                        .label { font-weight: bold; color: #555; }
                        .result-box { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
                        .result-header { background: #f3f4f6; padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #ddd; }
                        .result-item { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #eee; }
                        .result-item:last-child { border-bottom: none; }
                        .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #999; border-top: 1px solid #eee; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Laboratory Test Report</h1>
                        <p>Request ID: <strong>${record.requestId}</strong></p>
                        <p>Status: ${record.status}</p>
                    </div>

                    <div class="info-grid">
                        <div><span class="label">Sample Name:</span> ${record.sampleName}</div>
                        <div><span class="label">Requester:</span> ${record.requesterName}</div>
                        <div><span class="label">Department:</span> ${record.requesterDepartment}</div>
                        <div><span class="label">Request Date:</span> ${new Date(record.requestDate).toLocaleString('th-TH')}</div>
                        <div><span class="label">Batch/Lot:</span> ${record.batchLotNumber}</div>
                        <div><span class="label">Source:</span> ${record.sampleSource}</div>
                    </div>

                    <h3>Test Results</h3>
                    ${document.getElementById('userResultContent').querySelector('.sidebar-section ul')?.parentElement.innerHTML || '<p>No results to display.</p>'}

                    <div class="info-grid" style="margin-top: 30px;">
                        <div><span class="label">Tester:</span> ${record.labTesterName || '-'}</div>
                        <div><span class="label">Remarks:</span> ${record.labRemark || '-'}</div>
                    </div>

                    <div class="footer">
                        Report Generated on: ${printDate}<br>
                        Lab Management System
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '', 'width=900,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        };

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export Excel (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ)
        window.exportUserExcel = () => {
            if (!currentUserRecord) return;

            const record = currentUserRecord;

            // ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Admin Export ‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡πÅ‡∏Ñ‡πà record ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            const formattedData = [{
                "Request ID": record.requestId,
                "Request Date": new Date(record.requestDate).toLocaleString('th-TH'),
                "Priority": record.priority,
                "Status": record.status,
                "Sample Name": record.sampleName,
                "Sample Source": record.sampleSource,
                "Batch/Lot No.": record.batchLotNumber,
                "Sample Count": record.sampleCount,
                "Requester Name": record.requesterName,
                "Requester Dept": record.requesterDepartment,
                "Reason for Test": record.reasonForTest,
                "Test Purpose": record.testJustification,
                "Tests Required": [...new Set(record.testsRequired.map(t => t.testName))].join(', '),

                // ‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÉ‡∏ä‡πâ Logic ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)
                ...Object.fromEntries(
                    record.testsRequired.map(t => {
                        const colPrefix = t.sampleLabel ? `${t.sampleLabel} (${t.timePoint || '-'})` : "Result";
                        return [`${colPrefix}: ${t.testName}`, t.result];
                    })
                )
            }];

            const worksheet = XLSX.utils.json_to_sheet(formattedData);
            // ‡∏à‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
            worksheet['!cols'] = [{ wch: 18 }, { wch: 20 }, { wch: 10 }, { wch: 12 }, { wch: 25 }]; 

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Test Report");
            XLSX.writeFile(workbook, `${record.requestId}_Report.xlsx`);
        };
    }); // <-- End of DOMContentLoaded
    </script>
</body>
</html>