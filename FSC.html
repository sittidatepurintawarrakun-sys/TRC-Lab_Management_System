<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRC Department Portal (Smart Store & Production)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
        getFirestore, doc, setDoc, getDoc, addDoc, deleteDoc, updateDoc,
        arrayUnion, collection, Timestamp, runTransaction, query, orderBy, limit, onSnapshot, where, getDocs // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° getDocs ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import {
getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

import {
getFunctions, httpsCallable
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js";

// --- 1. CONFIGURATION ---
const firebaseConfig = {
apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
authDomain: "lab-trc-management-system.firebaseapp.com",
projectId: "lab-trc-management-system",
storageBucket: "lab-trc-management-system.appspot.com",
messagingSenderId: "43919979160",
appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const functions = getFunctions(app, "asia-southeast1");

// --- HELPER: Create Icons ---
const safeCreateIcons = () => {
if (typeof lucide !== 'undefined' && lucide.createIcons) {
lucide.createIcons();
}
};

// --- LOGIC: ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (07:00 ‡∏ô. - 07:00 ‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ß‡∏±‡∏ô) ---
// ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 07:00 ‡∏ô. ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Production Date ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
window.getShiftProductionDate = () => {
    const now = new Date();
    if (now.getHours() < 7) {
        now.setDate(now.getDate() - 1);
    }
    // ‡∏õ‡∏£‡∏±‡∏ö Timezone ‡πÄ‡∏õ‡πá‡∏ô Local (‡πÑ‡∏ó‡∏¢) ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏∂‡∏á YYYY-MM-DD
    const offset = now.getTimezoneOffset() * 60000;
    const localISOTime = (new Date(now.getTime() - offset)).toISOString().split('T')[0];
    return localISOTime;
};

// --- 2. CONSTANTS ---
const PULP_OPTIONS_STORE = `
<option value="ARAUCO FSC Mix Credit">ARAUCO FSC Mix Credit</option>
<option value="ARAUCO FSC Control Wood">ARAUCO FSC Control Wood</option>
<option value="ARAUCO PEFC">ARAUCO PEFC</option>
<option value="AVN FSC Mix Credit">AVN FSC Mix Credit</option>
<option value="AVN FSC Control Wood">AVN FSC Control Wood</option>
<option value="AVN PEFC">AVN PEFC</option>
<option value="AVC FSC Mix Credit">AVC FSC Mix Credit</option>
<option value="AVC FSC Control Wood">AVC FSC Control Wood</option>
<option value="AVC PEFC">AVC PEFC</option>
<option value="PHOENIX Mix Credit">PHOENIX Mix Credit</option>
<option value="PHOENIX Control Wood">PHOENIX Control Wood</option>
<option value="PHOENIX PEFC">PHOENIX PEFC</option>
<option value="SAICCOR FSC Mix Credit 70%">SAICCOR FSC Mix Credit 70%</option>
<option value="TEL Pellita FSC Mix Credit">TEL Pellita FSC Mix Credit</option>
<option value="TEL Pellita FSC Control Wood">TEL Pellita FSC Control Wood</option>
<option value="TEL Pellita PEFC">TEL Pellita PEFC</option>
`;
const VISCOSE_LINE_OPTIONS = `
<option value="Line Modal">Line Modal</option>
<option value="Line Grey">Line Grey</option>
<option value="Line NonWoven">Line NonWoven</option>
`;
const SPINNING_LINE_OPTIONS = `
<option value="Line MC2">Line MC2 (Modal)</option>
<option value="Line MC3">Line MC3 (Grey/NW)</option>
<option value="Line MC5">Line MC5 (Grey/NW)</option>
<option value="Line MC6">Line MC6 (Grey/NW)</option>
`;

// --- 3. AUTHENTICATION LOGIC ---
let currentUser = null;
let historyUnsubscribe = null;
let viscoseUnsubscribe = null;
let spinningUnsubscribe = null;
let dashboardListening = false;

window.handleLogin = async () => {
const email = document.getElementById('loginEmail').value;
const password = document.getElementById('loginPassword').value;
const errorMsg = document.getElementById('loginError');
const btn = document.getElementById('btnLoginAction');
errorMsg.classList.add('hidden');
if (!email || !password) {
errorMsg.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡πÅ‡∏•‡∏∞ Password";
errorMsg.classList.remove('hidden');
return;
}
try {
btn.disabled = true;
btn.innerHTML = `<span class="animate-spin">  ‚åõ  </span> Processing...`;
await signInWithEmailAndPassword(auth, email, password);
} catch (error) {
errorMsg.textContent = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (" + error.code + ")";
errorMsg.classList.remove('hidden');
btn.disabled = false;
btn.innerHTML = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)`;
}
};

window.handleLogout = async () => {
try { await signOut(auth); window.location.reload(); } catch (error) {}
};

onAuthStateChanged(auth, (user) => {
currentUser = user;
const loginContainer = document.getElementById('loginContainer');
const userProfile = document.getElementById('userProfileSection');
document.body.classList.toggle('is-logged-in', !!user);

if (user) {
loginContainer.classList.add('hidden');
userProfile.classList.remove('hidden');
document.getElementById('userNameDisplay').innerText = user.email.split('@')[0];
document.getElementById('userEmailDisplay').innerText = user.email;
if(user.photoURL) document.getElementById('userAvatar').src = user.photoURL;

window.initStoreListeners();
window.initViscoseListeners();
window.initSpinningListeners();
} else {
loginContainer.classList.remove('hidden');
userProfile.classList.add('hidden');
const btn = document.getElementById('btnLoginAction');
if(btn) { btn.disabled = false; btn.innerHTML = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)`; }
}
});

// ==========================================
// MODULE 1: STORE (Pulp Inventory)
// ==========================================
window.initStoreListeners = (searchDate = null) => {
if(!dashboardListening) {
const balanceRef = collection(db, "store_inventory_balance");
onSnapshot(balanceRef, (snapshot) => {
const container = document.getElementById('inventoryDashboard');
if(!container) return;
let cardsHTML = '';
if(snapshot.empty) { container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>'; return; }
snapshot.forEach(doc => {
const data = doc.data();
const [brand, grade] = doc.id.split('__');
const balance = data.balance || 0;
const isLow = balance < 50;
const bgClass = isLow ? 'bg-red-50 border-red-200' : 'bg-white border-slate-200';
const textClass = isLow ? 'text-red-700' : 'text-slate-700';
cardsHTML += `
<div class="p-3 rounded-lg border shadow-sm flex flex-col justify-between ${bgClass}">
<div><div class="text-[10px] uppercase text-slate-500 font-bold">${grade}</div><div class="text-xs font-semibold text-slate-800 truncate" title="${brand}">${brand}</div></div>
<div class="text-right mt-2"><span class="text-xl font-bold ${textClass}">${balance.toLocaleString(undefined, {minimumFractionDigits:3, maximumFractionDigits:3})}</span><span class="text-[10px] text-slate-400">Tons</span></div>
</div>`;
});
container.innerHTML = cardsHTML;
});
dashboardListening = true;
}
if (historyUnsubscribe) historyUnsubscribe();
const tbody = document.getElementById('storeHistoryTable');
let q = searchDate ? query(collection(db, "store_transaction_logs"), where("date", "==", searchDate), orderBy("recordedAt", "desc")) : query(collection(db, "store_transaction_logs"), orderBy("recordedAt", "desc"), limit(20));

historyUnsubscribe = onSnapshot(q, (snapshot) => {
tbody.innerHTML = '';
if(snapshot.empty) return tbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
snapshot.forEach(docSnap => {
const data = docSnap.data();
const isIN = data.type === 'IN';
const typeBadge = isIN ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700"> üì•  Buy</span>` : `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700"> üì§  Issue</span>`;
const row = document.createElement('tr');
row.className = "border-b hover:bg-gray-50 transition";
row.innerHTML = `
<td class="p-2 text-gray-500">${data.date}</td>
<td class="p-2">${typeBadge}</td>
<td class="p-2 font-medium">${data.brand}</td>
<td class="p-2 text-xs">${data.grade}</td>
<td class="p-2 text-xs text-gray-500">${data.docRef || '-'}</td>
<td class="p-2 text-right font-mono font-bold ${isIN ? 'text-green-600' : 'text-red-600'}">${isIN ? '+' : '-'}${data.weight.toFixed(3)}</td>
<td class="p-2 text-right">
<div class="auth-only hidden flex justify-end">
<button onclick="deleteTransaction('${docSnap.id}')" class="px-3 py-1 bg-red-50 hover:bg-red-100 text-red-600 rounded border border-red-200 text-xs font-bold flex items-center gap-1 transition shadow-sm">
<i data-lucide="trash-2" class="w-3 h-3"></i> <span>‡∏•‡∏ö</span>
</button>
</div>
</td>`;
tbody.appendChild(row);
});
safeCreateIcons();
});
};

window.addStoreRow = () => {
const tbody = document.getElementById('storeEntryTable');
const row = document.createElement('tr');
row.className = "border-b bg-green-50/50";
row.innerHTML = `
<td class="p-2"><input type="date" name="s_date" value="${window.getShiftProductionDate()}" class="w-full text-xs border border-gray-300 rounded p-2 font-bold outline-none"></td>
<td class="p-2"><select name="s_type" onchange="changeRowColor(this)" class="w-full text-xs border border-gray-300 rounded p-2 font-bold outline-none"><option value="IN" class="text-green-700"> üì•  ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option><option value="OUT" class="text-red-700"> üì§  ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</option></select></td>
<td class="p-2"><select name="s_brand" class="w-full text-xs border border-gray-300 rounded p-2 outline-none">${PULP_OPTIONS_STORE}</select></td>
<td class="p-2"><select name="s_grade" class="w-full text-xs border border-gray-300 rounded p-2 outline-none"><option value="NORMAL"> ‚úÖ  Normal</option><option value="OFF"> ‚ùå  Off Grade</option></select></td>
<td class="p-2"><input type="text" name="s_doc" placeholder="Lot No." class="w-full text-xs border border-gray-300 rounded p-2 outline-none"></td>
<td class="p-2"><input type="number" name="s_weight" step="0.001" placeholder="0.000" class="w-full text-sm font-mono text-right font-bold border border-gray-300 rounded p-2 outline-none"></td>
<td class="p-2 text-center"><button onclick="removeRow(this)" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
`;
tbody.appendChild(row);
safeCreateIcons();
};

window.removeRow = (btn) => { btn.closest('tr').remove(); };

window.changeRowColor = (selectEl) => {
const row = selectEl.closest('tr');
row.className = selectEl.value === 'IN' ? "border-b bg-green-50/50" : "border-b bg-red-50/50";
};

    window.saveStoreBatch = async () => {
        const rows = document.querySelectorAll('#storeEntryTable tr');
        if(rows.length === 0) return alert(" ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
        const btn = document.getElementById('btnSaveBatch');
        const originalBtnText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = ` ‚è≥ Processing...`;

        try {
            let successCount = 0;
            for (const row of rows) {
                const date = row.querySelector('[name="s_date"]').value;
                const type = row.querySelector('[name="s_type"]').value;
                const brand = row.querySelector('[name="s_brand"]').value;
                const grade = row.querySelector('[name="s_grade"]').value;
                const docVal = row.querySelector('[name="s_doc"]').value;
                const weight = parseFloat(row.querySelector('[name="s_weight"]').value);
                if(!date || !weight || weight <= 0) continue;

                // üü¢ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥ Dashboard
                const dateObj = new Date(date);
                const year = dateObj.getFullYear().toString();
                const month = date.substring(0, 7);
                const quarter = `Q${Math.floor(dateObj.getMonth() / 3) + 1}`;

                let standard = 'None';
                if (brand.includes("PEFC")) standard = 'PEFC';
                else if (brand.includes("Mix Credit") || brand.includes("FSC Mix")) standard = 'FSC';
                else if (brand.includes("Control Wood") || brand.includes("CW")) standard = 'FSC_CW';

                await runTransaction(db, async (transaction) => {
                    const logRef = doc(collection(db, "store_transaction_logs"));
                    const invRef = doc(db, "store_inventory_balance", `${brand}__${grade}`);
                    const invDoc = await transaction.get(invRef);
                    const currentBal = invDoc.exists() ? (invDoc.data().balance || 0) : 0;
                    const newBal = type === 'IN' ? currentBal + weight : currentBal - weight;

                    // üü¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Year, Quarter, Standard ‡∏•‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                    transaction.set(logRef, { 
                        type, brand, grade, weight, docRef: docVal, date, 
                        year, month, quarter, standard, // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                        recordedBy: currentUser ? currentUser.email : 'Guest', 
                        recordedAt: Timestamp.now() 
                    });
                    transaction.set(invRef, { balance: newBal, lastUpdated: Timestamp.now() }, { merge: true });
                });
                successCount++; row.remove();
            }
            if(successCount > 0 && document.querySelectorAll('#storeEntryTable tr').length === 0) window.addStoreRow();
        } catch (err) { alert(" ‚ùå Error: " + err.message); }
        finally { btn.disabled = false; btn.innerHTML = originalBtnText; safeCreateIcons(); }
    };

window.deleteTransaction = async (logId) => {
if(!currentUser) return;
if(!confirm(" ‚ö†Ô∏è  ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö? \n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")) return;
try {
await runTransaction(db, async (transaction) => {
const logRef = doc(db, "store_transaction_logs", logId);
const logDoc = await transaction.get(logRef);
if(!logDoc.exists()) throw "Document does not exist!";
const data = logDoc.data();
const invRef = doc(db, "store_inventory_balance", `${data.brand}__${data.grade}`);
const invDoc = await transaction.get(invRef);
const currentBal = invDoc.exists() ? (invDoc.data().balance || 0) : 0;
const reverseBal = data.type === 'IN' ? currentBal - data.weight : currentBal + data.weight;
transaction.delete(logRef);
transaction.set(invRef, { balance: reverseBal }, { merge: true });
});
} catch (e) { alert("Error deleting: " + e.message); }
};

// ==========================================
// MODULE 2: VISCOSE (Consumption & Ledger Generation)
// ==========================================
    window.addViscoseRow = () => {
        const tbody = document.getElementById('tableViscose');
        const row = document.createElement('tr');
        row.className = "border-b hover:bg-gray-50 transition";

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á Grade ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ onchange ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á Brand ‡πÅ‡∏•‡∏∞ Grade ‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadLotsForViscose
        row.innerHTML = `
            <td class="p-2"><input type="date" name="v_date" value="${window.getShiftProductionDate()}" class="w-full text-xs border border-gray-300 rounded p-2 outline-none"></td>
            <td class="p-2"><select name="v_line" class="w-full text-xs border border-gray-300 rounded p-2 outline-none">${VISCOSE_LINE_OPTIONS}</select></td>
            <td class="p-2"><select name="v_brand" onchange="loadLotsForViscose(this)" class="w-full text-xs border border-gray-300 rounded p-2 outline-none">${PULP_OPTIONS_STORE}</select></td>
            <td class="p-2">
                <select name="v_grade" onchange="loadLotsForViscose(this)" class="w-full text-xs border border-gray-300 rounded p-2 outline-none">
                    <option value="NORMAL">‚úÖ Normal</option>
                    <option value="OFF">‚ùå Off Grade</option>
                </select>
            </td>
            <td class="p-2"><select name="v_doc" class="w-full text-xs border border-gray-300 rounded p-2 outline-none bg-slate-50 focus:bg-white"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Lot No. --</option></select></td>
            <td class="p-2"><input type="number" name="v_weight" step="0.001" class="w-full text-sm font-mono text-right font-bold border border-gray-300 rounded p-2 text-orange-600 outline-none"></td>
            <td class="p-2 text-center"><button onclick="removeRow(this)" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
        `;
        tbody.appendChild(row);

        // ‡πÇ‡∏´‡∏•‡∏î Lot ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const newBrandSelect = row.querySelector('[name="v_brand"]');
        loadLotsForViscose(newBrandSelect);

        safeCreateIcons();
    };
    // --- NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á Lot No. ‡∏ó‡∏µ‡πà Store ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (OUT) ‡∏Ç‡∏≠‡∏á Brand ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏°‡∏≤‡∏ó‡∏≥ Dropdown ---
    window.loadLotsForViscose = async (el) => {
        const row = el.closest('tr');
        const brand = row.querySelector('[name="v_brand"]').value;
        const grade = row.querySelector('[name="v_grade"]').value; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Grade ‡∏î‡πâ‡∏ß‡∏¢
        const lotSelect = row.querySelector('[name="v_doc"]');

        lotSelect.innerHTML = '<option value="">‚è≥ ‡πÇ‡∏´‡∏•‡∏î...</option>';
        lotSelect.disabled = true;

        try {
            // Query ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏±‡πâ‡∏á Brand ‡πÅ‡∏•‡∏∞ Grade ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞
            const q = query(collection(db, "store_transaction_logs"),
                where("type", "==", "OUT"),
                where("brand", "==", brand),
                where("grade", "==", grade), // ‡∏Å‡∏£‡∏≠‡∏á Grade ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                orderBy("recordedAt", "desc"),
                limit(20)
            );
            const snapshot = await getDocs(q);
            const lots = new Set();

            snapshot.forEach(doc => {
                const data = doc.data();
                if(data.docRef && data.docRef.trim() !== '') lots.add(data.docRef);
            });

            lotSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Lot No. --</option>';
            if(lots.size === 0) {
                lotSelect.innerHTML += '<option value="NO_DATA">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏¥‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</option>';
            } else {
                Array.from(lots).sort().forEach(lot => {
                    lotSelect.innerHTML += `<option value="${lot}">${lot}</option>`;
                });
            }
        } catch (error) {
            console.error("Error loading lots:", error);
            lotSelect.innerHTML = '<option value="">‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</option>';
        } finally {
            lotSelect.disabled = false;
        }
    };
    window.saveViscoseData = async () => {
        const rows = document.querySelectorAll('#tableViscose tr');
        const btn = document.getElementById('btnSaveViscose');
        const payloadByDate = {};
        let count = 0;

        rows.forEach(row => {
            const date = row.querySelector('[name="v_date"]').value;
            if (!date) return;
            const weight = parseFloat(row.querySelector('[name="v_weight"]').value) || 0;

            if (weight > 0) {
                if (!payloadByDate[date]) payloadByDate[date] = [];

                const brandVal = row.querySelector('[name="v_brand"]').value;
                const gradeVal = row.querySelector('[name="v_grade"]').value;

                // Logic ‡∏™‡∏Å‡∏±‡∏î Standard ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ Dashboard ‡πÅ‡∏¢‡∏Å‡∏™‡∏µ/‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÜ)
                let standard = 'None';
                if (brandVal.includes("PEFC")) standard = 'PEFC';
                else if (brandVal.includes("Mix Credit") || brandVal.includes("FSC Mix")) standard = 'FSC';
                else if (brandVal.includes("Control Wood") || brandVal.includes("CW")) standard = 'FSC_CW';

                payloadByDate[date].push({
                    recordedAt: Timestamp.now(),
                    recordedBy: currentUser ? currentUser.email : 'Guest',
                    line: row.querySelector('[name="v_line"]').value,
                    brand: brandVal,
                    grade: gradeVal, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Grade
                    standard: standard, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Standard (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard)
                    docRef: row.querySelector('[name="v_doc"]').value,
                    weight: weight
                });
                count++;
            }
        });

        if (count === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
        btn.innerHTML = "Saving..."; btn.disabled = true;

        try {
            const promises = Object.entries(payloadByDate).map(([dateKey, transactions]) => {
                const dateObj = new Date(dateKey);
                const year = dateObj.getFullYear().toString();
                const month = dateKey.substring(0, 7); // YYYY-MM
                const quarter = `Q${Math.floor(dateObj.getMonth() / 3) + 1}`; // ‡∏´‡∏≤‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™

                // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏≤‡∏ü/Dashboard ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö 100%
                return setDoc(doc(db, "FSC_PEFC_RAW_LOGS", `Viscose_${dateKey}`), { 
                    department: 'Viscose', 
                    date: dateKey, 
                    month: month,
                    year: year,
                    quarter: quarter,
                    lastUpdated: Timestamp.now(), 
                    transactions: arrayUnion(...transactions) 
                }, { merge: true });
            });

            await Promise.all(promises);

            // ... ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend calculateDailyCredits ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ...
            const calculateCreditsFunc = httpsCallable(functions, 'calculateDailyCredits');
            const calcRes = await calculateCreditsFunc({ targetDate: Object.keys(payloadByDate)[0] });

            if(calcRes.data.suspensionActive) {
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà PEFC ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏¥‡∏î Suspension (16-Hour Rule)`);
            } else {
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Credit Ledger ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
            }

            document.getElementById('tableViscose').innerHTML = "";
            window.addViscoseRow();
            window.refreshViscoseBalance();
        } catch (err) { alert("Error: " + err.message); }
        finally { btn.innerHTML = `<i data-lucide="save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Viscose`; btn.disabled = false; safeCreateIcons(); }
    };

window.initViscoseListeners = (searchDate = null) => {
const tbody = document.getElementById('viscoseHistoryTable');
if (!tbody) return;
if (viscoseUnsubscribe) viscoseUnsubscribe();

let q = searchDate ? doc(db, "FSC_PEFC_RAW_LOGS", `Viscose_${searchDate}`) : query(collection(db, "FSC_PEFC_RAW_LOGS"), where("department", "==", "Viscose"), orderBy("date", "desc"), limit(5));

viscoseUnsubscribe = onSnapshot(q, (snapshot) => {
const docs = searchDate ? [snapshot] : snapshot.docs;
renderUnifiedTable(docs, tbody, !!searchDate, 'Viscose');
});
};

window.refreshViscoseBalance = async () => {
const btn = document.getElementById('btnRefreshViscoseBal');
const container = document.getElementById('viscoseDashboardCards');
if(!btn || !container) return;
const originalText = btn.innerHTML;
btn.innerHTML = `<span class="animate-spin inline-block"> ‚åõ </span> Updating...`;
btn.disabled = true;
try {
const getBal = httpsCallable(functions, 'getViscoseBalance');
const result = await getBal();
if (result.data.success) {
const balances = result.data.balances;
container.innerHTML = '';
let cardsHTML = '';
const keys = Object.keys(balances);
if(keys.length === 0) {
container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å/‡πÉ‡∏ä‡πâ Pulp</div>';
} else {
keys.forEach(key => {
const [brand, grade] = key.split('__');
const bal = balances[key];
const isLow = bal < 10;
const bgClass = isLow ? 'bg-red-50 border-red-200' : 'bg-orange-50 border-orange-200';
const textClass = isLow ? 'text-red-700' : 'text-slate-800';
cardsHTML += `
<div class="p-3 rounded-lg border shadow-sm flex flex-col justify-between ${bgClass}">
<div>
<div class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">${grade}</div>
<div class="text-xs font-semibold text-slate-800 truncate" title="${brand}">${brand}</div>
</div>
<div class="text-right mt-2">
<span class="text-xl font-bold ${textClass}">${bal.toLocaleString(undefined, {minimumFractionDigits:3, maximumFractionDigits:3})}</span>
<span class="text-[10px] text-slate-400">Tons</span>
</div>
</div>
`;
});
container.innerHTML = cardsHTML;
}
}
} catch (error) {
console.error(error);
container.innerHTML = `<div class="col-span-full text-center text-red-500 py-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
} finally {
btn.innerHTML = originalText;
btn.disabled = false;
safeCreateIcons();
}
};

window.reportHighRiskMaterial = async () => {
if(!confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ High Risk Material? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á PEFC ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 16 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ")) return;
try {
    const reportBtn = document.getElementById('btnReportHighRisk');
    reportBtn.disabled = true;
    reportBtn.innerHTML = "Processing...";
    const reportFunc = httpsCallable(functions, 'reportHighRiskMaterial');
    await reportFunc({});
    alert("‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏á‡∏±‡∏ö PEFC 16-Hour Rule ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    if(document.getElementById('Marketing').classList.contains('hidden') === false) {
        window.refreshCreditBalance();
    }
} catch (e) {
    alert("Error: " + e.message);
} finally {
    const reportBtn = document.getElementById('btnReportHighRisk');
    reportBtn.disabled = false;
    reportBtn.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (High Risk)`;
    safeCreateIcons();
}
};

// ==========================================
// MODULE 3: SPINNING (Production Output)
// ==========================================
    window.loadSpinningMassBalance = async (searchDate = null) => {
        const container = document.getElementById('spinningSummaryCards');
        if (!container) return;

        const targetDate = searchDate || window.getShiftProductionDate();
        const dateInput = document.getElementById('spinningSummaryDate');
        if(dateInput && !dateInput.value) dateInput.value = targetDate;

        container.innerHTML = `<div class="col-span-full text-center text-slate-500 py-2"><span class="animate-spin inline-block">‚åõ</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</div>`;

        try {
            // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Viscose (Input Pulp)
            const viscoseDocRef = doc(db, "FSC_PEFC_RAW_LOGS", `Viscose_${targetDate}`);
            const viscoseSnap = await getDoc(viscoseDocRef);

            // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Mix ‡∏Å‡∏±‡∏ö CW ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô
            let fscMixPulp = 0, fscCwPulp = 0, totalPefcPulp = 0;

            if (viscoseSnap.exists()) {
                const vData = viscoseSnap.data().transactions || [];
                vData.forEach(tx => {
                    if(tx.standard === 'FSC') fscMixPulp += Number(tx.weight);
                    if(tx.standard === 'FSC_CW') fscCwPulp += Number(tx.weight);
                    if(tx.standard === 'PEFC') totalPefcPulp += Number(tx.weight);
                });
            }

            const totalFscInput = fscMixPulp + fscCwPulp;

            // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Spinning (Actual Fibre Output)
            const spinDocRef = doc(db, "FSC_PEFC_RAW_LOGS", `Spinning_${targetDate}`);
            const spinSnap = await getDoc(spinDocRef);
            let actualFscFibre = 0, actualPefcFibre = 0;

            if (spinSnap.exists()) {
                const sData = spinSnap.data().transactions || [];
                sData.forEach(tx => {
                    if(tx.claimType === 'FSC') actualFscFibre += Number(tx.weight);
                    if(tx.claimType === 'PEFC') actualPefcFibre += Number(tx.weight);
                });
            }

            // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Theoretical & Credit (‡πÅ‡∏¢‡∏Å‡∏Å‡πâ‡∏≠‡∏ô)
            const fscFactor = 0.99;
            const pefcFactor = 0.93;

            const fscMixCredit = fscMixPulp * fscFactor;
            const fscCwCredit = fscCwPulp * fscFactor;
            const pefcTheoretical = totalPefcPulp * pefcFactor;

            // 4. Render UI
            container.innerHTML = `
                <div class="p-3 rounded-xl border border-amber-200 bg-amber-50/50 shadow-sm flex flex-col">
                    <div class="text-xs font-bold text-amber-800 mb-3 border-b border-amber-200 pb-2 flex items-center gap-1">üå≤ FSC Mass Balance (Mix & CW)</div>
                    <div class="grid grid-cols-3 gap-3 text-center flex-1 items-center">

                        <div class="flex flex-col gap-1 text-left bg-white/50 p-2 rounded">
                            <div class="text-[10px] text-slate-500 uppercase font-bold border-b border-amber-200/50 pb-1 mb-1 text-center">Pulp Input</div>
                            <div class="text-xs font-bold text-amber-700 flex justify-between"><span>Mix:</span> <span>${fscMixPulp.toFixed(3)} T</span></div>
                            <div class="text-xs font-bold text-slate-600 flex justify-between"><span>CW:</span> <span>${fscCwPulp.toFixed(3)} T</span></div>
                            <div class="text-sm font-black text-slate-800 border-t border-amber-200/50 pt-1 mt-1 flex justify-between"><span>Total:</span> <span>${totalFscInput.toFixed(3)} T</span></div>
                        </div>

                        <div>
                            <div class="text-[10px] text-slate-500 uppercase font-bold">Actual Fibre (‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô)</div>
                            <div class="text-sm font-bold text-amber-600 mt-2">${actualFscFibre.toFixed(3)} <span class="text-[10px] font-normal">T</span></div>
                        </div>

                        <div class="bg-white rounded-lg shadow-sm border border-amber-100 p-2 flex flex-col gap-1 text-left">
                            <div class="text-[10px] text-amber-600 font-bold uppercase border-b border-amber-100 pb-1 mb-1 text-center">Credit Claimed (99%)</div>
                            <div class="text-xs font-bold text-amber-700 flex justify-between"><span>Mix:</span> <span>${fscMixCredit.toFixed(3)}</span></div>
                            <div class="text-xs font-bold text-slate-600 flex justify-between"><span>CW:</span> <span>${fscCwCredit.toFixed(3)}</span></div>
                        </div>

                    </div>
                </div>

                <div class="p-3 rounded-xl border border-green-200 bg-green-50/50 shadow-sm flex flex-col">
                    <div class="text-xs font-bold text-green-800 mb-3 border-b border-green-200 pb-2 flex items-center gap-1">üõ°Ô∏è PEFC Mass Balance</div>
                    <div class="grid grid-cols-3 gap-3 text-center flex-1 items-center">
                        <div>
                            <div class="text-[10px] text-slate-500 uppercase font-bold">Pulp Input (Viscose)</div>
                            <div class="text-sm font-bold text-slate-700 mt-1">${totalPefcPulp.toFixed(3)} <span class="text-[10px] font-normal">T</span></div>
                        </div>
                        <div>
                            <div class="text-[10px] text-slate-500 uppercase font-bold">Actual Fibre (‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô)</div>
                            <div class="text-sm font-bold text-green-600 mt-1">${actualPefcFibre.toFixed(3)} <span class="text-[10px] font-normal">T</span></div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-green-100 p-2">
                            <div class="text-[10px] text-green-600 font-bold uppercase">Credit Claimed (93%)</div>
                            <div class="text-lg font-black text-green-700 mt-1">${pefcTheoretical.toFixed(3)}</div>
                        </div>
                    </div>
                </div>
            `;
            safeCreateIcons();
        } catch (error) {
            console.error("Error loading mass balance:", error);
            container.innerHTML = `<div class="col-span-full text-center text-red-500 py-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        }
    };
window.addSpinningRow = () => {
const tbody = document.getElementById('spinningEntryTable');
const row = document.createElement('tr');
row.className = "border-b hover:bg-gray-50 transition";
row.innerHTML = `
<td class="p-2"><input type="date" name="sp_date" value="${window.getShiftProductionDate()}" class="w-full text-xs border border-gray-300 rounded p-2 outline-none"></td>
<td class="p-2"><select name="sp_line" class="w-full text-xs border border-gray-300 rounded p-2 outline-none">${SPINNING_LINE_OPTIONS}</select></td>
<td class="p-2">
    <select name="sp_claim" class="w-full text-xs border border-gray-300 rounded p-2 outline-none font-bold">
        <option value="NORMAL" class="text-slate-600">‚ö™ Normal (Non-Certified)</option>
        <option value="FSC" class="text-amber-700">üå≤ FSC Certified</option>
        <option value="PEFC" class="text-green-700">üõ°Ô∏è PEFC Certified</option>
    </select>
</td>
<td class="p-2"><input type="number" name="sp_weight" step="0.001" placeholder="Fibre (Ton)" class="w-full text-sm font-mono text-right font-bold border border-gray-300 rounded p-2 text-teal-600 outline-none"></td>
<td class="p-2 text-center"><button onclick="removeRow(this)" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
`;
tbody.appendChild(row);
safeCreateIcons();
};

    window.saveSpinningData = async () => {
        const rows = document.querySelectorAll('#spinningEntryTable tr');
        const btn = document.getElementById('btnSaveSpinning');
        const payloadByDate = {};
        let count = 0;

        rows.forEach(row => {
            const date = row.querySelector('[name="sp_date"]').value;
            if (!date) return;
            const weight = parseFloat(row.querySelector('[name="sp_weight"]').value) || 0;
            if (weight > 0) {
                if (!payloadByDate[date]) payloadByDate[date] = [];
                payloadByDate[date].push({
                    recordedAt: Timestamp.now(),
                    recordedBy: currentUser ? currentUser.email : 'Guest',
                    line: row.querySelector('[name="sp_line"]').value,
                    claimType: row.querySelector('[name="sp_claim"]').value, 
                    weight
                });
                count++;
            }
        });
        if (count === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å Fibre ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
        btn.innerHTML = "Saving..."; btn.disabled = true;

        try {
            const promises = Object.entries(payloadByDate).map(([dateKey, transactions]) => {
                // üü¢ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard
                const dateObj = new Date(dateKey);
                const year = dateObj.getFullYear().toString();
                const quarter = `Q${Math.floor(dateObj.getMonth() / 3) + 1}`;

                return setDoc(doc(db, "FSC_PEFC_RAW_LOGS", `Spinning_${dateKey}`), { 
                    department: 'Spinning', 
                    date: dateKey, 
                    month: dateKey.substring(0, 7),
                    year: year,       // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    quarter: quarter, // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ 
                    lastUpdated: Timestamp.now(), 
                    transactions: arrayUnion(...transactions) 
                }, { merge: true });
            });
            await Promise.all(promises);
            alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
            document.getElementById('spinningEntryTable').innerHTML = "";
            window.addSpinningRow();
        } catch (err) { alert("Error: " + err.message); }
        finally { btn.innerHTML = `<i data-lucide="save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Spinning`; btn.disabled = false; safeCreateIcons(); }
    };

    window.initSpinningListeners = (searchDate = null) => {
        const tbody = document.getElementById('spinningHistoryTable');
        if (!tbody) return;

        // NEW: ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î Mass Balance
        window.loadSpinningMassBalance(searchDate);

        if (spinningUnsubscribe) spinningUnsubscribe();
        let q = searchDate ? doc(db, "FSC_PEFC_RAW_LOGS", `Spinning_${searchDate}`) : query(collection(db, "FSC_PEFC_RAW_LOGS"), where("department", "==", "Spinning"), orderBy("date", "desc"), limit(5));
        spinningUnsubscribe = onSnapshot(q, (snapshot) => {
            const docs = searchDate ? [snapshot] : snapshot.docs;
            renderSpinningHistoryTable(docs, tbody, !!searchDate);
        });
    };

const renderSpinningHistoryTable = (docs, tbody, isSingleDateMode) => {
let allTransactions = [];
docs.forEach(docSnap => {
if (docSnap.exists()) {
const data = docSnap.data();
(data.transactions || []).forEach((tx, idx) => {
allTransactions.push({ ...tx, _realDate: data.date, _realIndex: idx, _docId: docSnap.id });
});
}
});
if (allTransactions.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }

allTransactions.sort((a, b) => {
const timeA = a.recordedAt ? a.recordedAt.seconds : 0;
const timeB = b.recordedAt ? b.recordedAt.seconds : 0;
return timeA !== timeB ? timeB - timeA : b._realIndex - a._realIndex;
});
if (!isSingleDateMode) allTransactions = allTransactions.slice(0, 20);
tbody.innerHTML = '';

allTransactions.forEach((tx) => {
// ‡∏™‡∏£‡πâ‡∏≤‡∏á Badge ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Claim
let claimBadge = `<span class="text-xs text-slate-400">Normal</span>`;
if (tx.claimType === 'PEFC') claimBadge = `<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded">PEFC</span>`;
if (tx.claimType === 'FSC') claimBadge = `<span class="text-xs font-bold text-amber-700 bg-amber-100 px-2 py-0.5 rounded">FSC</span>`;

const row = document.createElement('tr');
row.className = "border-b hover:bg-gray-50 transition";
row.innerHTML = `
<td class="p-2 text-gray-500">${tx._realDate}</td>
<td class="p-2 font-bold text-slate-700">${tx.line}</td>
<td class="p-2">${claimBadge}</td>
<td class="p-2 text-right font-mono font-bold text-teal-600 border-l border-r bg-teal-50/30">${parseFloat(tx.weight).toFixed(3)}</td>
<td class="p-2 text-right">
<div class="auth-only hidden flex justify-end">
<button onclick="deleteEntry('${tx._docId}', ${tx._realIndex})" class="px-3 py-1 bg-red-50 hover:bg-red-100 text-red-600 rounded border border-red-200 text-xs font-bold transition shadow-sm flex items-center gap-1">
<i data-lucide="trash-2" class="w-3 h-3"></i> <span>‡∏•‡∏ö</span>
</button>
</div>
</td>
`;
tbody.appendChild(row);
});
safeCreateIcons();
};

/// ==========================================
    // MODULE 4: MARKETING (Bulk Import & Sales)
    // ==========================================
        let currentCreditBalance = { FSC: 0, FSC_CW: 0, PEFC: 0 };

        window.refreshCreditBalance = async () => {
            const btn = document.getElementById('btnRefreshBal');
            if(!btn) return;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin inline-block"> ‚åõ </span> Updating...`;
            btn.disabled = true;

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ alertBar ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà Error ‡πÅ‡∏î‡∏á‡πÉ‡∏ô Console
            const alertBar = document.getElementById('pefcSuspensionAlert');
            if(alertBar) alertBar.classList.add('hidden');

            try {
                const getBalance = httpsCallable(functions, 'getCreditBalance');
                const result = await getBalance();

                if (result.data.success) {
                    const bal = result.data.balance || { FSC: 0, FSC_CW: 0, PEFC: 0 };
                    const expiring = result.data.expiring || { FSC: 0, FSC_CW: 0, PEFC: 0 };
                    currentCreditBalance = bal;

                    // 1. Update FSC Mix Credit
                    const domFscBal = document.getElementById('bal_fsc');
                    const domFscExp = document.getElementById('bal_fsc_expiring');
                    if(domFscBal) domFscBal.innerText = (bal.FSC || 0).toLocaleString(undefined, {minimumFractionDigits:3});
                    if(domFscExp) domFscExp.innerText = (expiring.FSC || 0).toLocaleString(undefined, {minimumFractionDigits:3}) + " T";

                    // 2. Update FSC Control Wood
                    const domCwBal = document.getElementById('bal_fsc_cw');
                    const domCwExp = document.getElementById('bal_fsc_cw_expiring');
                    if(domCwBal) domCwBal.innerText = (bal.FSC_CW || 0).toLocaleString(undefined, {minimumFractionDigits:3});
                    if(domCwExp) domCwExp.innerText = (expiring.FSC_CW || 0).toLocaleString(undefined, {minimumFractionDigits:3}) + " T";

                    // 3. Update PEFC 
                    const domPefcBal = document.getElementById('bal_pefc');
                    const domPefcExp = document.getElementById('bal_pefc_expiring');
                    if(domPefcBal) domPefcBal.innerText = (bal.PEFC || 0).toLocaleString(undefined, {minimumFractionDigits:3});
                    if(domPefcExp) domPefcExp.innerText = (expiring.PEFC || 0).toLocaleString(undefined, {minimumFractionDigits:3}) + " T";

                    // Handle PEFC 16-Hour Rule Suspension UI
                    const btnUpload = document.getElementById('btnUploadMarketing');
                    if(result.data.pefcSuspended && alertBar && btnUpload) {
                        alertBar.classList.remove('hidden');
                        document.getElementById('suspensionTimeStr').innerText = result.data.pefcResumeTime;
                        btnUpload.disabled = true; 
                        btnUpload.classList.add('opacity-50', 'cursor-not-allowed');
                    } else if(btnUpload) {
                        btnUpload.disabled = false;
                        btnUpload.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            } catch (error) {
                console.error("Error refreshing balance:", error);
            } finally {
                btn.innerHTML = originalContent; 
                btn.disabled = false;
                safeCreateIcons();
            }
        };

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡πÅ‡∏ñ‡∏ß (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
function detectDateFormat(dataRows, dateColIndex, targetMonthIndex) {
let scoreDMY = 0;
let scoreMDY = 0;
for (let i = 0; i < Math.min(dataRows.length, 10); i++) {
const row = dataRows[i];
if (!row[dateColIndex]) continue;
const datePart = row[dateColIndex].trim().split(/\s+/)[0];
let separator = datePart.includes('/') ? '/' : '-';
const parts = datePart.split(separator);
if (parts.length >= 2) {
const val1 = parseInt(parts[0], 10);
const val2 = parseInt(parts[1], 10);
if (val2 === targetMonthIndex + 1) scoreDMY++;
if (val1 === targetMonthIndex + 1) scoreMDY++;
}
}
return scoreMDY > scoreDMY ? 'MDY' : 'DMY';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel ‡∏Ç‡∏∂‡πâ‡∏ô Firebase
window.uploadMarketingData = async () => {
const rawText = document.getElementById('excelPasteArea').value;
const targetMonthStr = document.getElementById('marketingDataMonth').value;
const statusArea = document.getElementById('marketingStatusArea');
const statusMsg = document.getElementById('marketingStatusMsg');
const btn = document.getElementById('btnUploadMarketing');

if (!targetMonthStr) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
if (!rawText.trim()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏ö FIFO ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ")) return;

statusArea.classList.remove('hidden');
statusMsg.className = 'bg-blue-50 text-blue-800 border border-blue-200 p-3 rounded-lg flex items-center shadow-sm';
statusMsg.innerHTML = '<span class="animate-spin inline-block mr-2">  ‚è≥  </span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏Å‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÉ‡∏ô Ledger (FIFO)...';
btn.disabled = true;

try {
const rows = rawText.trim().split('\n').map(r => r.split('\t'));
const headers = rows[0].map(h => h.trim());
const dataRows = rows.slice(1);
if (dataRows.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏û‡∏ö‡πÅ‡∏ï‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)");

// ‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
let dateIdx = headers.findIndex(h => h.toLowerCase().includes('date') || h.toLowerCase() === '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
if (dateIdx === -1) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'Date' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á Excel ‡∏ó‡∏µ‡πà‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏°‡∏≤");

const targetDateObj = new Date(targetMonthStr);
const targetMonthIndex = targetDateObj.getMonth();
const detectedFormat = detectDateFormat(dataRows, dateIdx, targetMonthIndex);

// ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Payload ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Backend ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
const payload = {
headers: headers,
dataRows: dataRows,
detectedFormat: detectedFormat,
targetMonthStr: targetMonthStr,
dateColIndex: dateIdx
};

const processMarketingFunc = httpsCallable(functions, 'processMarketingBulkData');
const result = await processMarketingFunc(payload);

if (result.data.success) {
statusMsg.className = 'bg-green-50 text-green-800 border border-green-200 p-3 rounded-lg shadow-sm';
statusMsg.innerHTML = `  ‚úÖ   <b>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</b> ‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡∏Å Batch (Traceability) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${result.data.processedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
document.getElementById('excelPasteArea').value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏≤‡∏á
window.refreshCreditBalance(); // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
} else {
throw new Error(result.data.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏");
}

} catch (error) {
console.error(error);
statusMsg.className = 'bg-red-50 text-red-800 border border-red-200 p-3 rounded-lg shadow-sm';
statusMsg.innerHTML = `  ‚ùå   <b>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</b> ${error.message}`;
} finally {
btn.disabled = false;
safeCreateIcons();
}
};
    window.uploadWarehouseData = async () => {
        const rawText = document.getElementById('warehousePasteArea').value;
        const statusArea = document.getElementById('warehouseStatusArea');
        const statusMsg = document.getElementById('warehouseStatusMsg');
        const btn = document.getElementById('btnUploadWarehouse');

        if (!rawText.trim()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Warehouse?")) return;

        statusArea.classList.remove('hidden');
        statusMsg.className = 'bg-blue-50 text-blue-800 border border-blue-200 p-3 rounded-lg flex items-center shadow-sm';
        statusMsg.innerHTML = '<span class="animate-spin inline-block mr-2"> ‚è≥ </span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
        btn.disabled = true;

        try {
            const rows = rawText.trim().split('\n').map(r => r.split('\t'));
            const headers = rows[0].map(h => h.trim());
            const dataRows = rows.slice(1);

            if (dataRows.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏û‡∏ö‡πÅ‡∏ï‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)");

            const processFunc = httpsCallable(functions, 'processWarehouseBulkData');
            const result = await processFunc({ headers, dataRows });

            if (result.data.success) {
                statusMsg.className = 'bg-green-50 text-green-800 border border-green-200 p-3 rounded-lg shadow-sm';
                statusMsg.innerHTML = ` ‚úÖ <b>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</b> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Warehouse ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Delivery: ${result.data.deliveryCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
                document.getElementById('warehousePasteArea').value = ''; 
            } else {
                throw new Error(result.data.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            }
        } catch (error) {
            statusMsg.className = 'bg-red-50 text-red-800 border border-red-200 p-3 rounded-lg shadow-sm';
            statusMsg.innerHTML = ` ‚ùå <b>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</b> ${error.message}`;
        } finally {
            btn.disabled = false;
            safeCreateIcons();
        }
    };

// --- SHARED UI LOGIC ---
const renderUnifiedTable = (docs, tbody, isSingleDateMode, dept) => {
let allTransactions = [];
docs.forEach(docSnap => {
if (docSnap.exists()) {
const data = docSnap.data();
(data.transactions || []).forEach((tx, idx) => {
allTransactions.push({ ...tx, _realDate: data.date, _realIndex: idx, _docId: docSnap.id });
});
}
});
if (allTransactions.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }

allTransactions.sort((a, b) => {
const timeA = a.recordedAt ? a.recordedAt.seconds : 0;
const timeB = b.recordedAt ? b.recordedAt.seconds : 0;
return timeA !== timeB ? timeB - timeA : b._realIndex - a._realIndex;
});
if (!isSingleDateMode) allTransactions = allTransactions.slice(0, 20);
tbody.innerHTML = '';

allTransactions.forEach((tx) => {
const row = document.createElement('tr');
row.className = "border-b hover:bg-gray-50 transition";
row.innerHTML = `
<td class="p-2 text-gray-500">${tx._realDate}</td>
<td class="p-2 font-bold">${tx.line}</td>
<td class="p-2">${tx.brand}</td>
<td class="p-2 text-xs text-gray-500">${tx.docRef || '-'}</td>
<td class="p-2 text-right font-mono font-bold text-orange-600">${parseFloat(tx.weight).toFixed(3)}</td>
<td class="p-2 text-right">
<div class="auth-only hidden flex justify-end">
<button onclick="deleteEntry('${tx._docId}', ${tx._realIndex})" class="px-3 py-1 bg-red-50 hover:bg-red-100 text-red-600 rounded border border-red-200 text-xs font-bold transition shadow-sm flex items-center gap-1">
<i data-lucide="trash-2" class="w-3 h-3"></i> <span>‡∏•‡∏ö</span>
</button>
</div>
</td>`;
tbody.appendChild(row);
});
safeCreateIcons();
};

    window.deleteEntry = async (docId, index) => {
        if(!currentUser) return;
        if(!confirm(`  ‚ö†Ô∏è   ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)`)) return;
        try {
            const docRef = doc(db, "FSC_PEFC_RAW_LOGS", docId);
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(docRef);
                if (!docSnap.exists()) throw "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£";
                const newTransactions = [...docSnap.data().transactions];
                if (index > -1 && index < newTransactions.length) newTransactions.splice(index, 1);
                transaction.update(docRef, { transactions: newTransactions, lastUpdated: Timestamp.now() });
            });

            // üü¢ ‡∏™‡∏±‡πà‡∏á Backend ‡πÉ‡∏´‡πâ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏´‡∏±‡∏Å Ledger ‡∏Ñ‡∏∑‡∏ô (‡∏ó‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Viscose)
            if (docId.startsWith("Viscose_")) {
                const targetDate = docId.split('_')[1];
                const calculateCreditsFunc = httpsCallable(functions, 'calculateDailyCredits');
                await calculateCreditsFunc({ targetDate: targetDate });

                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                if (typeof window.refreshViscoseBalance === 'function') window.refreshViscoseBalance();
                if (typeof window.refreshCreditBalance === 'function') window.refreshCreditBalance();
                if (typeof window.loadSpinningMassBalance === 'function') window.loadSpinningMassBalance(targetDate);
            }

            // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            if (docId.startsWith("Viscose_")) window.initViscoseListeners();
            if (docId.startsWith("Spinning_")) window.initSpinningListeners();

        } catch (e) { alert("Error: " + e.message); }
    };

// Tab Navigation Override to trigger Balance check
window.openTab = (tabName) => {
document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
document.getElementById(tabName).classList.remove('hidden');
document.querySelectorAll('.tab-btn').forEach(el => {
el.classList.remove('bg-slate-700', 'text-white', 'shadow-inner');
el.classList.add('text-slate-300', 'hover:bg-slate-700/50');
});
const activeBtn = document.getElementById(`btn${tabName}`);
activeBtn.classList.remove('text-slate-300', 'hover:bg-slate-700/50');
activeBtn.classList.add('bg-slate-700', 'text-white', 'shadow-inner');
if(tabName === 'Marketing') window.refreshCreditBalance();
if(tabName === 'Viscose') window.refreshViscoseBalance();
}

document.addEventListener('DOMContentLoaded', () => {
window.addStoreRow();
window.addViscoseRow();
window.addSpinningRow();
window.initStoreListeners();

const pwField = document.getElementById('loginPassword');
if(pwField) pwField.addEventListener('keypress', (e) => { if (e.key === 'Enter') window.handleLogin(); });
});
</script>
<style>
body:not(.is-logged-in) .auth-only { display: none !important; }
body.is-logged-in .auth-only { display: flex !important; }
</style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
<div id="loginContainer" class="fixed inset-0 z-50 flex items-center justify-center transition-all duration-300 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?auto=format&fit=crop&q=80');">
<div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
<div class="bg-white/95 backdrop-blur-md p-8 rounded-2xl shadow-2xl w-full max-w-md border border-white/20 relative z-10 m-4">
<div class="text-center mb-8">
<div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-100 mb-4 border-4 border-green-50 shadow-inner">
<i data-lucide="tree-pine" class="w-10 h-10 text-green-700"></i>
</div>
<h1 class="text-2xl font-bold text-slate-800">TRC Portal</h1>
<p class="text-green-700 font-semibold text-sm mt-1">FSC & PEFC Smart System</p>
</div>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
<input type="email" id="loginEmail" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="user@adityabirla.com">
</div>
<div>
<label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
<input type="password" id="loginPassword" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<button id="btnLoginAction" onclick="handleLogin()" class="w-full py-3 bg-green-700 hover:bg-green-800 text-white rounded-lg font-bold shadow-lg transition-all duration-200">
‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)
</button>
</div>
<p id="loginError" class="mt-4 text-center text-red-500 text-sm hidden bg-red-50 p-2 rounded border border-red-100"></p>
</div>
</div>

<div class="flex h-screen overflow-hidden">
<aside class="w-64 bg-slate-800 text-white flex flex-col shadow-xl z-20">
<div class="p-6 border-b border-slate-700">
<h1 class="text-xl font-bold flex items-center gap-2 text-green-400">
<i data-lucide="trees"></i> TRC Portal
</h1>
<p class="text-xs text-slate-400 mt-1 ml-7">FSC/PEFC Control System</p>
</div>
<nav class="flex-1 p-4 space-y-2">
<button id="btnStore" onclick="openTab('Store')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 bg-slate-700 text-white shadow-inner transition">
<i data-lucide="package"></i> Store (Pulp)
</button>
<button id="btnViscose" onclick="openTab('Viscose')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
<i data-lucide="flask-conical"></i> Viscose
</button>
<button id="btnSpinning" onclick="openTab('Spinning')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
<i data-lucide="activity"></i> Spinning
</button>
<button id="btnMarketing" onclick="openTab('Marketing')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
<i data-lucide="coins"></i> Marketing
</button>
    <button id="btnWarehouse" onclick="openTab('Warehouse')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
      <i data-lucide="package-check"></i> Warehouse (Dispatch)
    </button>
</nav>
<div class="p-4 border-t border-slate-700 bg-slate-900/50">
<div id="userProfileSection" class="hidden">
<div class="flex items-center gap-3 mb-3">
<img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=random" class="w-8 h-8 rounded-full border border-slate-500">
<div class="overflow-hidden">
<div id="userNameDisplay" class="text-sm font-bold truncate">User</div>
<div id="userEmailDisplay" class="text-[10px] text-slate-400 truncate">user@email.com</div>
</div>
</div>
<button onclick="handleLogout()" class="w-full py-1.5 px-3 bg-slate-700 hover:bg-red-600/80 rounded text-xs text-slate-300 hover:text-white flex items-center justify-center gap-2 transition">
<i data-lucide="log-out" class="w-3 h-3"></i> Logout
</button>
</div>
</div>
</aside>

<main class="flex-1 overflow-y-auto bg-slate-50 p-6">
<div id="Store" class="tab-content h-full flex flex-col gap-4">
<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
<h3 class="text-sm font-bold text-slate-500 uppercase mb-3 flex items-center gap-2"><i data-lucide="box" class="w-4 h-4 text-blue-500"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
<div id="inventoryDashboard" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
</div>
<div class="flex flex-col bg-white rounded-xl shadow border border-slate-200 overflow-hidden flex-shrink-0">
<div class="p-4 border-b bg-white flex justify-between items-center sticky top-0 z-20 shadow-sm">
<h2 class="text-lg font-bold text-slate-700 flex items-center gap-2"><i data-lucide="clipboard-list" class="text-blue-600"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Store</h2>
<div class="flex gap-2">
<button onclick="addStoreRow()" class="flex items-center gap-1 px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 font-bold text-sm border border-blue-200"><i data-lucide="plus-circle" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
<button id="btnSaveBatch" onclick="saveStoreBatch()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow flex items-center gap-2"><i data-lucide="save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>
</div>
<div class="overflow-y-auto max-h-[300px]" id="storeEntryContainer">
<table class="w-full text-left border-collapse">
<thead class="sticky top-0 bg-slate-100 text-slate-600 text-xs uppercase font-bold shadow-sm z-10 border-b">
<tr><th class="p-3 w-32">Production Date</th><th class="p-3 w-32">Type</th><th class="p-3">Brand</th><th class="p-3 w-28">Grade</th><th class="p-3 w-32">Lot No.</th><th class="p-3 w-28 text-right">Weight (T)</th><th class="p-3 w-10"></th></tr>
</thead>
<tbody id="storeEntryTable" class="text-sm"></tbody>
</table>
</div>
</div>
<div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex-1 overflow-hidden flex flex-col">
<div class="flex justify-between items-center mb-3">
<h3 class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2"><i data-lucide="history" class="w-4 h-4 text-orange-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Store</h3>
<div class="flex items-center gap-2">
<input type="date" id="historySearchDate" onchange="window.initStoreListeners(this.value)" class="text-xs border border-slate-300 rounded px-2 py-1 shadow-sm">
<button onclick="document.getElementById('historySearchDate').value=''; window.initStoreListeners();" class="p-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-500"><i data-lucide="rotate-ccw" class="w-3 h-3"></i></button>
</div>
</div>
<div class="overflow-y-auto flex-1 border rounded">
<table class="w-full text-left text-sm">
<thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0">
<tr><th class="p-2 w-24">Date</th><th class="p-2 w-24">Type</th><th class="p-2">Brand</th><th class="p-2 w-20">Grade</th><th class="p-2 w-32">Lot No.</th><th class="p-2 w-24 text-right">Weight</th><th class="p-2 w-20 text-right">Action</th></tr>
</thead>
<tbody id="storeHistoryTable"></tbody>
</table>
</div>
</div>
</div>

<div id="Viscose" class="tab-content hidden h-full flex flex-col gap-4">
<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
<div class="flex justify-between items-center mb-4">
<h3 class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2"><i data-lucide="boxes" class="w-4 h-4 text-orange-500"></i> ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ Pulp ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô Viscose (‡πÄ‡∏ö‡∏¥‡∏Å‡∏°‡∏≤ - ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ)</h3>
<button onclick="refreshViscoseBalance()" id="btnRefreshViscoseBal" class="px-3 py-1 bg-orange-50 text-orange-600 rounded-full text-xs font-bold hover:bg-orange-100 transition flex items-center gap-1 border border-orange-200"><i data-lucide="refresh-cw" class="w-3 h-3"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î</button>
</div>
<div id="viscoseDashboardCards" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3"><div class="col-span-full text-center text-gray-400 text-sm py-2">Loading balance...</div></div>
</div>
<div class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden flex-shrink-0">
<div class="p-4 border-b bg-white flex justify-between items-center sticky top-0 z-20 shadow-sm">
<h2 class="text-lg font-bold text-orange-800 flex items-center gap-2"><i data-lucide="flask-conical"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Viscose Consumption (Pulp Feed)</h2>
<div class="flex gap-2">
<button id="btnReportHighRisk" onclick="reportHighRiskMaterial()" class="flex items-center gap-1 px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 font-bold text-sm border border-red-300 transition shadow-sm mr-4"><i data-lucide="alert-triangle" class="w-4 h-4"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (High Risk)</button>
<button onclick="addViscoseRow()" class="flex items-center gap-1 px-4 py-2 bg-orange-50 text-orange-600 rounded hover:bg-orange-100 font-bold text-sm border border-orange-200"><i data-lucide="plus-circle" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
<button id="btnSaveViscose" onclick="saveViscoseData()" class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded font-bold shadow flex items-center gap-2"><i data-lucide="save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Viscose</button>
</div>
</div>
<div class="overflow-y-auto max-h-[300px]">
<table class="w-full text-left border-collapse">
    <thead class="sticky top-0 bg-slate-100 text-slate-600 text-xs uppercase font-bold shadow-sm z-10 border-b">
        <tr>
            <th class="p-3 w-32">Production Date</th>
            <th class="p-3 w-32">Line</th>
            <th class="p-3">Brand (Pulp)</th>
            <th class="p-3 w-28">Grade</th>
            <th class="p-3 w-32">Lot No.</th>
            <th class="p-3 w-28 text-right">Used (T)</th>
            <th class="p-3 w-10"></th>
        </tr>
    </thead>
<tbody id="tableViscose" class="text-sm"></tbody>
</table>
</div>
</div>
<div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex-1 overflow-hidden flex flex-col">
<div class="flex justify-between items-center mb-3">
<h3 class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2"><i data-lucide="history" class="w-4 h-4 text-orange-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ Viscose</h3>
<div class="flex items-center gap-2"><input type="date" id="viscoseHistorySearchDate" onchange="window.initViscoseListeners(this.value)" class="text-xs border border-slate-300 rounded px-2 py-1 shadow-sm"><button onclick="document.getElementById('viscoseHistorySearchDate').value=''; window.initViscoseListeners();" class="p-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-500"><i data-lucide="rotate-ccw" class="w-3 h-3"></i></button></div>
</div>
<div class="overflow-y-auto flex-1 border rounded">
<table class="w-full text-left text-sm">
<thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0"><tr><th class="p-2 w-24">Date</th><th class="p-2">Line</th><th class="p-2">Brand</th><th class="p-2 w-32">Lot No.</th><th class="p-2 w-24 text-right">Used</th><th class="p-2 w-20 text-right">Action</th></tr></thead>
<tbody id="viscoseHistoryTable"></tbody>
</table>
</div>
</div>
</div>

<div id="Spinning" class="tab-content hidden h-full flex flex-col gap-4">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2">
                <i data-lucide="scale" class="w-4 h-4 text-teal-500"></i> ‡∏™‡∏£‡∏∏‡∏õ Mass Balance & Credit ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            </h3>
            <div class="flex items-center gap-2">
                <input type="date" id="spinningSummaryDate" onchange="window.loadSpinningMassBalance(this.value)" class="text-xs border border-slate-300 rounded px-2 py-1 shadow-sm">
                <button onclick="document.getElementById('spinningSummaryDate').value=''; window.loadSpinningMassBalance();" class="p-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-500"><i data-lucide="rotate-ccw" class="w-3 h-3"></i></button>
            </div>
        </div>
        <div id="spinningSummaryCards" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="col-span-full text-center text-gray-400 text-sm py-2">Loading balance...</div>
        </div>
    </div>
<div class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden flex-shrink-0">
<div class="p-4 border-b bg-white flex justify-between items-center sticky top-0 z-20 shadow-sm">
<h2 class="text-lg font-bold text-teal-800 flex items-center gap-2"><i data-lucide="activity"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Spinning Output (Fibre Yield)</h2>
<div class="flex gap-2">
<button onclick="addSpinningRow()" class="flex items-center gap-1 px-4 py-2 bg-teal-50 text-teal-600 rounded hover:bg-teal-100 font-bold text-sm border border-teal-200"><i data-lucide="plus-circle" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
<button id="btnSaveSpinning" onclick="saveSpinningData()" class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded font-bold shadow flex items-center gap-2"><i data-lucide="save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Spinning</button>
</div>
</div>
<div class="overflow-y-auto max-h-[300px]">
<table class="w-full text-left border-collapse">
<thead class="sticky top-0 bg-slate-100 text-slate-600 text-xs uppercase font-bold shadow-sm z-10 border-b">
<tr><th class="p-3 w-32">Production Date</th><th class="p-3 w-32">Machine Line</th><th class="p-3 w-40">Claim Tag (Traceability)</th><th class="p-3 text-right">Fibre Output (Ton)</th><th class="p-3 w-10"></th></tr>
</thead>
<tbody id="spinningEntryTable" class="text-sm"></tbody>
</table>
</div>
</div>
<div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex-1 overflow-hidden flex flex-col">
<div class="flex justify-between items-center mb-3">
<h3 class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2"><i data-lucide="history" class="w-4 h-4 text-teal-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï Spinning Output</h3>
<div class="flex items-center gap-2"><input type="date" id="spinningHistorySearchDate" onchange="window.initSpinningListeners(this.value)" class="text-xs border border-slate-300 rounded px-2 py-1 shadow-sm"><button onclick="document.getElementById('spinningHistorySearchDate').value=''; window.initSpinningListeners();" class="p-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-500"><i data-lucide="rotate-ccw" class="w-3 h-3"></i></button></div>
</div>
<div class="overflow-y-auto flex-1 border rounded">
<table class="w-full text-left text-sm">
<thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0"><tr><th class="p-2 w-24">Date</th><th class="p-2 w-24">Line</th><th class="p-2 w-24">Claim</th><th class="p-2 w-24 text-right bg-teal-50 text-teal-800 font-bold border-l border-r">Fibre (T)</th><th class="p-2 w-16 text-right">Action</th></tr></thead>
<tbody id="spinningHistoryTable"></tbody>
</table>
</div>
</div>
</div>

    <div id="Marketing" class="tab-content hidden h-full flex flex-col gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="wallet"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Dual-Standard Ledger)
                </h2>
                <button onclick="refreshCreditBalance()" id="btnRefreshBal" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-700 transition flex items-center gap-2 shadow-sm">
                    ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å Ledger
                </button>
            </div>

            <div id="pefcSuspensionAlert" class="hidden bg-red-600 text-white px-4 py-3 rounded-xl shadow-lg flex items-center justify-between border-2 border-red-800 animate-pulse mb-6">
                <div class="flex items-center gap-3">
                    <i data-lucide="alert-octagon" class="w-6 h-6 text-white"></i>
                    <div>
                        <h4 class="font-bold text-lg">‚ö†Ô∏è PEFC Claim Suspended (16-Hour Rule)</h4>
                        <p class="text-sm opacity-90">‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢ PEFC ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤: <strong id="suspensionTimeStr" class="text-yellow-300">--:--</strong></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="border-2 border-amber-200 rounded-xl overflow-hidden flex flex-col bg-amber-50/30">
                    <div class="bg-amber-700 p-4 flex justify-between items-center">
                        <h3 class="font-black text-white text-lg">FSC Mix<br>Credit</h3>
                        <div class="bg-amber-900/50 px-2 py-1 rounded text-xs text-amber-100">Conv:<br>99.00%</div>
                    </div>
                    <div class="p-6 flex-1 flex flex-col items-center justify-center text-center">
                        <span class="text-sm font-bold text-amber-800 mb-2">AVAILABLE (FIFO)</span>
                        <span id="bal_fsc" class="text-4xl font-black text-slate-800">---</span>
                        <span class="text-xs text-amber-600/70 mt-2">(Expire in 24 Months)</span>
                    </div>
                    <div class="bg-white border-t border-amber-100 p-3 mx-4 mb-4 rounded text-sm flex justify-between text-red-600 font-bold shadow-sm">
                        <span>‚ö†Ô∏è < 30 days</span>
                        <span id="bal_fsc_expiring">0.000 T</span>
                    </div>
                </div>

                <div class="border-2 border-slate-200 rounded-xl overflow-hidden flex flex-col bg-slate-50/50">
                    <div class="bg-slate-700 p-4 flex justify-between items-center">
                        <h3 class="font-black text-white text-lg">FSC Control<br>Wood</h3>
                        <div class="bg-slate-900/50 px-2 py-1 rounded text-xs text-slate-100">Conv:<br>99.00%</div>
                    </div>
                    <div class="p-6 flex-1 flex flex-col items-center justify-center text-center">
                        <span class="text-sm font-bold text-slate-600 mb-2">AVAILABLE (FIFO)</span>
                        <span id="bal_fsc_cw" class="text-4xl font-black text-slate-800">---</span>
                        <span class="text-xs text-slate-400 mt-2">(Expire in 24 Months)</span>
                    </div>
                    <div class="bg-white border-t border-slate-200 p-3 mx-4 mb-4 rounded text-sm flex justify-between text-red-600 font-bold shadow-sm">
                        <span>‚ö†Ô∏è < 30 days</span>
                        <span id="bal_fsc_cw_expiring">0.000 T</span>
                    </div>
                </div>

                <div class="border-2 border-green-200 rounded-xl overflow-hidden flex flex-col bg-green-50/30">
                    <div class="bg-green-600 p-4 flex justify-between items-center">
                        <h3 class="font-black text-white text-lg">PEFC<br>Certified</h3>
                        <div class="bg-green-800/50 px-2 py-1 rounded text-xs text-green-100">Conv:<br>93.00%</div>
                    </div>
                    <div class="p-6 flex-1 flex flex-col items-center justify-center text-center">
                        <span class="text-sm font-bold text-green-700 mb-2">AVAILABLE (FIFO)</span>
                        <span id="bal_pefc" class="text-4xl font-black text-slate-800">---</span>
                        <span class="text-xs text-green-600/70 mt-2">(Expire in 12 Months)</span>
                    </div>
                    <div class="bg-white border-t border-green-100 p-3 mx-4 mb-4 rounded text-sm flex justify-between text-red-600 font-bold shadow-sm">
                        <span>‚ö†Ô∏è < 30 days</span>
                        <span id="bal_pefc_expiring">0.000 T</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex-1 flex flex-col mt-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2"><i data-lucide="file-spreadsheet" class="text-blue-600"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î Ledger (Sales Deduction)</h3>
                <div class="flex items-center gap-2"><label class="text-xs font-bold text-slate-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢:</label><input type="month" id="marketingDataMonth" class="text-sm border border-slate-300 rounded px-3 py-1.5 shadow-sm outline-none focus:ring-2 focus:ring-blue-500"></div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4"><p class="text-xs text-blue-800 leading-relaxed"><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong> Copy ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel <strong>(‡∏Ñ‡∏•‡∏∏‡∏°‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢)</strong> ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á<br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏ô‡∏¥‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "Claim" ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏ö‡∏ö <strong>FIFO</strong> ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)</p></div>
            <textarea id="excelPasteArea" rows="10" class="w-full flex-1 text-xs font-mono p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none mb-4" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ... (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á Date, Invoice, Claim, Weight ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢)"></textarea>
            <div class="flex gap-3">
                <button id="btnUploadMarketing" onclick="uploadMarketingData()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transition flex items-center justify-center gap-2"><i data-lucide="upload-cloud" class="w-5 h-5"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ & ‡∏´‡∏±‡∏Å‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</button>
                <button onclick="document.getElementById('excelPasteArea').value=''" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-lg transition">Clear ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            <div id="marketingStatusArea" class="mt-4 hidden"><div id="marketingStatusMsg" class="p-3 rounded-lg text-sm mb-2 font-bold"></div></div>
        </div>
    </div>
    <div id="Warehouse" class="tab-content hidden h-full flex flex-col gap-4">
        <div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex-1 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                    <i data-lucide="scan-line" class="text-indigo-600"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Warehouse (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Delivery & Production Date)
                </h3>
            </div>
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 mb-4">
                <p class="text-xs text-indigo-800 leading-relaxed">
                    <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong> Copy ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel <strong>(‡∏Ñ‡∏•‡∏∏‡∏°‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á Delivery No., Prod_Date ‡∏Ø‡∏•‡∏Ø)</strong> ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á<br>
                    ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Delivery No. ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Marketing ‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                </p>
            </div>
            <textarea id="warehousePasteArea" rows="10" class="w-full flex-1 text-xs font-mono p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none mb-4" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ..."></textarea>
            <div class="flex gap-3">
                <button id="btnUploadWarehouse" onclick="uploadWarehouseData()" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-md transition flex items-center justify-center gap-2">
                    <i data-lucide="upload-cloud" class="w-5 h-5"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Warehouse
                </button>
                <button onclick="document.getElementById('warehousePasteArea').value=''" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-lg transition">Clear ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            <div id="warehouseStatusArea" class="mt-4 hidden"><div id="warehouseStatusMsg" class="p-3 rounded-lg text-sm mb-2 font-bold"></div></div>
        </div>
    </div>

</main>
</div>
</body>
</html>