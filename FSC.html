<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC Department Portal (Smart Store)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            initializeFirestore, doc, setDoc, getDoc, addDoc, deleteDoc, updateDoc, 
            arrayUnion, collection, Timestamp, runTransaction, query, orderBy, limit, onSnapshot, where 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { 
            getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
            authDomain: "lab-trc-management-system.firebaseapp.com",
            projectId: "lab-trc-management-system",
            storageBucket: "lab-trc-management-system.appspot.com",
            messagingSenderId: "43919979160",
            appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
        };

        const app = initializeApp(firebaseConfig);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- 2. CONSTANTS ---
        // (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        const PULP_OPTIONS = `
            <option value="ARAUCO FSC Mix Credit">1. ARAUCO FSC Mix Credit</option>
            <option value="ARAUCO FSC Control Wood">2. ARAUCO FSC Control Wood</option>
            <option value="ARAUCO PEFC">3. ARAUCO PEFC</option>
            <option value="AVN FSC Mix Credit">4. AVN FSC Mix Credit</option>
            <option value="AVN FSC Control Wood">5. AVN FSC Control Wood</option>
            <option value="AVN PEFC">6. AVN PEFC</option>
            <option value="AVC FSC Mix Credit">7. AVC FSC Mix Credit</option>
            <option value="AVC FSC Control Wood">8. AVC FSC Control Wood</option>
            <option value="AVC PEFC">9. AVC PEFC</option>
            <option value="PHOENIX Mix Credit">10. PHOENIX Mix Credit</option>
            <option value="PHOENIX Control Wood">11. PHOENIX Control Wood</option>
            <option value="PHOENIX PEFC">12. PHOENIX PEFC</option>
            <option value="SAICCOR FSC Mix Credit 70%">13. SAICCOR FSC Mix Credit 70%</option>
        `;
        const LINE_OPTIONS = `
            <option value="MC2">Line MC2</option>
            <option value="MC3">Line MC3</option>
            <option value="MC5">Line MC5</option>
            <option value="MC6">Line MC6</option>
        `;
        const PULP_OPTIONS_STORE = `
            <option value="ARAUCO FSC Mix Credit">ARAUCO FSC Mix Credit</option>
            <option value="ARAUCO FSC Control Wood">ARAUCO FSC Control Wood</option>
            <option value="ARAUCO PEFC">ARAUCO PEFC</option>
            <option value="AVN FSC Mix Credit">AVN FSC Mix Credit</option>
            <option value="AVN FSC Control Wood">AVN FSC Control Wood</option>
            <option value="AVN PEFC">AVN PEFC</option>
            <option value="AVC FSC Mix Credit">AVC FSC Mix Credit</option>
            <option value="AVC FSC Control Wood">AVC FSC Control Wood</option>
            <option value="AVC PEFC">AVC PEFC</option>
            <option value="PHOENIX Mix Credit">PHOENIX Mix Credit</option>
            <option value="PHOENIX Control Wood">PHOENIX Control Wood</option>
            <option value="PHOENIX PEFC">PHOENIX PEFC</option>
            <option value="SAICCOR FSC Mix Credit 70%">SAICCOR FSC Mix Credit 70%</option>
        `;

        // --- 3. AUTHENTICATION LOGIC ---
        let currentUser = null;

        window.handleLogin = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                alert("Login Error: " + error.message);
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed", error);
            }
        };

        // Listen for auth state changes
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const loginBtn = document.getElementById('loginSection');
            const userProfile = document.getElementById('userProfileSection');
            const userName = document.getElementById('userNameDisplay');
            const userEmail = document.getElementById('userEmailDisplay');
            const userAvatar = document.getElementById('userAvatar');

            // Toggle Edit/Delete buttons visibility class
            document.body.classList.toggle('is-logged-in', !!user);

            if (user) {
                loginBtn.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userName.innerText = user.displayName || 'User';
                userEmail.innerText = user.email;
                if(user.photoURL) userAvatar.src = user.photoURL;
                console.log("User Logged In:", user.email);
            } else {
                loginBtn.classList.remove('hidden');
                userProfile.classList.add('hidden');
                console.log("User Logged Out");
            }
        });

        // --- 4. STORE LOGIC (REAL-TIME & CRUD) ---

        // 4.1 Real-time Listeners (Dashboard & History)
        window.initStoreListeners = () => {
            // A. Inventory Balance Listener (Dashboard)
            const balanceRef = collection(db, "store_inventory_balance");
            onSnapshot(balanceRef, (snapshot) => {
                const container = document.getElementById('inventoryDashboard');
                container.innerHTML = ''; // Clear old

                // Group by Brand to make it look nice
                let cardsHTML = '';
                if(snapshot.empty) {
                    container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const [brand, grade] = doc.id.split('__');
                    const balance = data.balance || 0;
                    
                    // Style condition
                    const isLow = balance < 50; 
                    const bgClass = isLow ? 'bg-red-50 border-red-200' : 'bg-white border-slate-200';
                    const textClass = isLow ? 'text-red-700' : 'text-slate-700';

                    cardsHTML += `
                        <div class="p-3 rounded-lg border shadow-sm flex flex-col justify-between ${bgClass}">
                            <div>
                                <div class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">${grade}</div>
                                <div class="text-xs font-semibold text-slate-800 truncate" title="${brand}">${brand}</div>
                            </div>
                            <div class="text-right mt-2">
                                <span class="text-xl font-bold ${textClass}">${balance.toLocaleString(undefined, {minimumFractionDigits:3, maximumFractionDigits:3})}</span>
                                <span class="text-[10px] text-slate-400">Tons</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = cardsHTML;
            });

            // B. Transaction History Listener (Recent Logs)
            const logsQuery = query(collection(db, "store_transaction_logs"), orderBy("recordedAt", "desc"), limit(20));
            onSnapshot(logsQuery, (snapshot) => {
                const tbody = document.getElementById('storeHistoryTable');
                tbody.innerHTML = '';
                
                if(snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const isIN = data.type === 'IN';
                    const typeBadge = isIN 
                        ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700">üì• Buy</span>`
                        : `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700">üì§ Issue</span>`;
                    
                    const row = document.createElement('tr');
                    row.className = "border-b hover:bg-gray-50 transition";
                    row.innerHTML = `
                        <td class="p-2 text-gray-500">${data.date}</td>
                        <td class="p-2">${typeBadge}</td>
                        <td class="p-2 font-medium text-slate-700">${data.brand}</td>
                        <td class="p-2 text-xs">${data.grade}</td>
                        <td class="p-2 text-xs text-gray-500">${data.docRef || '-'}</td>
                        <td class="p-2 text-right font-mono font-bold ${isIN ? 'text-green-600' : 'text-red-600'}">
                            ${isIN ? '+' : '-'}${data.weight.toFixed(3)}
                        </td>
                        <td class="p-2 text-right">
                            <div class="auth-only hidden flex justify-end gap-1">
                                <button onclick="editTransaction('${docSnap.id}')" class="p-1 hover:bg-blue-100 text-blue-600 rounded transition" title="Edit (Re-load)">
                                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                                </button>
                                <button onclick="deleteTransaction('${docSnap.id}')" class="p-1 hover:bg-red-100 text-red-600 rounded transition" title="Delete (Reverse Stock)">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                lucide.createIcons();
                
                // Manually re-check auth visibility after render
                if(currentUser) {
                    document.body.classList.add('is-logged-in');
                }
            });
        };

        // 4.2 Entry Logic (New Rows) - Keep similar to original
        window.addStoreRow = () => {
            const tbody = document.getElementById('storeEntryTable');
            const row = document.createElement('tr');
            const today = new Date().toISOString().split('T')[0];
            row.className = "border-b transition-colors bg-green-50/50";
            row.innerHTML = `
                <td class="p-2">
                    <input type="date" name="s_date" value="${today}" class="w-full text-xs border border-gray-300 rounded p-2 font-bold text-gray-600 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </td>
                <td class="p-2">
                    <select name="s_type" onchange="changeRowColor(this)" class="w-full text-xs border border-gray-300 rounded p-2 font-bold shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                        <option value="IN" class="text-green-700"> üì•  ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (Buy)</option>
                        <option value="OUT" class="text-red-700"> üì§  ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (Issue)</option>
                    </select>
                </td>
                <td class="p-2">
                    <select name="s_brand" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                        ${PULP_OPTIONS_STORE}
                    </select>
                </td>
                <td class="p-2">
                    <select name="s_grade" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                        <option value="NORMAL"> ‚úÖ  Normal</option>
                        <option value="OFF"> ‚ùå  Off Grade</option>
                    </select>
                </td>
                <td class="p-2">
                    <input type="text" name="s_doc" placeholder="PO / Line / Ref..." class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </td>
                <td class="p-2">
                    <input type="number" name="s_weight" step="0.001" placeholder="0.000" class="w-full text-sm font-mono text-right font-bold border border-gray-300 rounded p-2 bg-white text-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </td>
                <td class="p-2 text-center">
                    <button onclick="this.closest('tr').remove()" class="text-gray-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            lucide.createIcons();
            const container = document.getElementById('storeEntryContainer');
            container.scrollTop = container.scrollHeight;
        };

        window.changeRowColor = (selectEl) => {
            const row = selectEl.closest('tr');
            if(selectEl.value === 'IN') {
                row.classList.remove('bg-red-50/50');
                row.classList.add('bg-green-50/50');
            } else {
                row.classList.remove('bg-green-50/50');
                row.classList.add('bg-red-50/50');
            }
        };

        // 4.3 Save Batch (Create)
        window.saveStoreBatch = async () => {
            const rows = document.querySelectorAll('#storeEntryTable tr');
            if(rows.length === 0) return alert(" ‚ö†Ô∏è  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");

            const btn = document.getElementById('btnSaveBatch');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = ` ‚è≥  Saving...`;

            let successCount = 0;
            let errorCount = 0;

            try {
                for (const row of rows) {
                    const date = row.querySelector('[name="s_date"]').value;
                    const type = row.querySelector('[name="s_type"]').value;
                    const brand = row.querySelector('[name="s_brand"]').value;
                    const grade = row.querySelector('[name="s_grade"]').value;
                    const docVal = row.querySelector('[name="s_doc"]').value;
                    const weight = parseFloat(row.querySelector('[name="s_weight"]').value);

                    if(!date || !weight || weight <= 0) {
                        row.classList.add('border-l-4', 'border-red-500');
                        errorCount++;
                        continue;
                    }

                    await runTransaction(db, async (transaction) => {
                        const logRef = doc(collection(db, "store_transaction_logs"));
                        const invKey = `${brand}__${grade}`;
                        const invRef = doc(db, "store_inventory_balance", invKey);

                        const invDoc = await transaction.get(invRef);
                        let currentBal = 0;
                        if(invDoc.exists()) currentBal = invDoc.data().balance || 0;

                        const newBal = type === 'IN' ? currentBal + weight : currentBal - weight;

                        transaction.set(logRef, {
                            type, brand, grade, weight,
                            docRef: docVal, date,
                            recordedBy: currentUser ? currentUser.email : 'Guest',
                            recordedAt: Timestamp.now()
                        });

                        transaction.set(invRef, { balance: newBal, lastUpdated: Timestamp.now() }, { merge: true });
                    });

                    successCount++;
                    row.remove();
                }

                if(errorCount > 0) {
                    alert(` ‚ö†Ô∏è  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ \n ‚ùå  ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                } else {
                    // Success! No alert needed if dashboard updates, but a small toast or simple alert is fine.
                    // alert(` ‚úÖ  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`); 
                }

            } catch (err) {
                console.error(err);
                alert(" ‚ùå  System Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
                if(document.querySelectorAll('#storeEntryTable tr').length === 0) {
                    try { window.addStoreRow(); } catch(e) {}
                }
            }
        };

        // 4.4 Delete Transaction (Reverse Stock)
        window.deleteTransaction = async (logId) => {
            if(!currentUser) return alert("Access Denied");
            if(!confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö? \n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å (Reverse Stock) ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const logRef = doc(db, "store_transaction_logs", logId);
                    const logDoc = await transaction.get(logRef);
                    if(!logDoc.exists()) throw "Document does not exist!";

                    const data = logDoc.data();
                    const invKey = `${data.brand}__${data.grade}`;
                    const invRef = doc(db, "store_inventory_balance", invKey);
                    const invDoc = await transaction.get(invRef);

                    let currentBal = 0;
                    if(invDoc.exists()) currentBal = invDoc.data().balance || 0;

                    // Reverse Logic: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô IN ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡∏≠‡∏≠‡∏Å, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô OUT ‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∑‡∏ô
                    const reverseBal = data.type === 'IN' ? currentBal - data.weight : currentBal + data.weight;

                    transaction.delete(logRef);
                    transaction.set(invRef, { balance: reverseBal }, { merge: true });
                });
                // No alert needed, realtime listener updates UI
            } catch (e) {
                console.error(e);
                alert("Error deleting: " + e.message);
            }
        };

        // 4.5 Edit Transaction (Load & Delete)
        window.editTransaction = async (logId) => {
            if(!currentUser) return alert("Access Denied");
            const confirmMsg = "‚úèÔ∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? \n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:\n1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°\n2. ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å)\n3. ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà";
            if(!confirm(confirmMsg)) return;

            try {
                // 1. Get Data
                const logRef = doc(db, "store_transaction_logs", logId);
                const logDoc = await getDoc(logRef);
                if(!logDoc.exists()) return;
                const data = logDoc.data();

                // 2. Add Row to Table with Data
                const tbody = document.getElementById('storeEntryTable');
                // Clear empty default row if it exists and is pristine
                // (Simplified: just add new row)
                
                const row = document.createElement('tr');
                row.className = data.type === 'IN' ? "border-b bg-green-50/50" : "border-b bg-red-50/50";
                
                // Select Option Helper
                const pulpOpts = PULP_OPTIONS_STORE.replace(`value="${data.brand}"`, `value="${data.brand}" selected`);
                
                row.innerHTML = `
                    <td class="p-2"><input type="date" name="s_date" value="${data.date}" class="w-full text-xs border border-gray-300 rounded p-2 font-bold text-gray-600 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"></td>
                    <td class="p-2">
                        <select name="s_type" onchange="changeRowColor(this)" class="w-full text-xs border border-gray-300 rounded p-2 font-bold shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                            <option value="IN" class="${data.type==='IN'?'':'hidden'} text-green-700" ${data.type==='IN'?'selected':''}> üì•  ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (Buy)</option>
                            <option value="OUT" class="${data.type==='OUT'?'':'hidden'} text-red-700" ${data.type==='OUT'?'selected':''}> üì§  ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (Issue)</option>
                            <option value="IN" class="text-green-700"> üì•  ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (Buy)</option>
                            <option value="OUT" class="text-red-700"> üì§  ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (Issue)</option>
                        </select>
                    </td>
                    <td class="p-2"><select name="s_brand" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">${pulpOpts}</select></td>
                    <td class="p-2">
                        <select name="s_grade" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                            <option value="NORMAL" ${data.grade==='NORMAL'?'selected':''}> ‚úÖ  Normal</option>
                            <option value="OFF" ${data.grade==='OFF'?'selected':''}> ‚ùå  Off Grade</option>
                        </select>
                    </td>
                    <td class="p-2"><input type="text" name="s_doc" value="${data.docRef||''}" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"></td>
                    <td class="p-2"><input type="number" name="s_weight" value="${data.weight}" step="0.001" class="w-full text-sm font-mono text-right font-bold border border-gray-300 rounded p-2 bg-white text-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"></td>
                    <td class="p-2 text-center"><button onclick="this.closest('tr').remove()" class="text-gray-400 hover:text-red-500 p-1.5 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                `;
                
                // Prepend to top so user sees it
                tbody.insertBefore(row, tbody.firstChild);
                lucide.createIcons();

                // 3. Delete Original (Reverse Stock)
                await window.deleteTransaction(logId);

                // 4. Scroll to Input
                document.getElementById('Store').scrollTop = 0;

            } catch (e) {
                console.error(e);
                alert("Error preparing edit: " + e.message);
            }
        };

        // --- 5. LEGACY LOGIC (Viscose, Spinning, Marketing) ---
        // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ï‡πâ‡∏≠‡∏á)
        window.addRow = (dept) => {
            if(dept === 'Store') return;
            const tableId = `table${dept}`;
            const table = document.getElementById(tableId);
            if (!table) return;
            const row = document.createElement('tr');
            row.className = "border-b hover:bg-gray-50 transition";
            const today = new Date().toISOString().split('T')[0];
            let innerHTML = `<td class="p-2"><input type="date" name="date" value="${today}" class="w-full border rounded p-1 text-sm bg-gray-50"></td>`;

            if (dept === 'Viscose') {
                innerHTML += `
                    <td class="p-2"><select name="line" class="w-full border rounded p-1 text-sm">${LINE_OPTIONS}</select></td>
                    <td class="p-2"><select name="brand" class="w-full border rounded p-1 text-sm">${PULP_OPTIONS}</select></td>
                    <td class="p-2"><input type="number" name="weight" step="0.001" class="w-full border rounded p-1 text-sm text-right font-bold text-orange-600"></td>
                `;
            } else if (dept === 'Spinning') {
                innerHTML += `
                    <td class="p-2"><select name="line" class="w-full border rounded p-1 text-sm">${LINE_OPTIONS}</select></td>
                    <td class="p-2"><input type="number" name="weight" step="0.001" class="w-full border rounded p-1 text-sm text-right font-bold text-teal-600"></td>
                    <td class="p-2"><input type="text" name="lot" placeholder="Lot/Batch" class="w-full border rounded p-1 text-sm"></td>
                `;
            } else if (dept === 'Marketing') {
                innerHTML += `
                    <td class="p-2"><input type="text" name="invoice" placeholder="INV-XXXX" class="w-full border rounded p-1 text-sm font-bold"></td>
                    <td class="p-2">
                        <select name="claim" class="w-full border rounded p-1 text-sm">
                            <option value="FSC Mix">FSC Mix Credit</option>
                            <option value="PEFC 100%">PEFC 100%</option>
                            <option value="None">None (General)</option>
                        </select>
                    </td>
                    <td class="p-2"><input type="number" name="weight" step="0.001" class="w-full border rounded p-1 text-sm text-right font-bold text-purple-600"></td>
                `;
            }
            innerHTML += `
                <td class="p-2 text-center">
                    <button onclick="this.closest('tr').remove()" class="text-gray-400 hover:text-red-500 rounded-full p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            `;
            row.innerHTML = innerHTML;
            table.appendChild(row);
            lucide.createIcons();
        };

        window.saveData = async (dept) => {
            const rows = document.querySelectorAll(`#table${dept} tr`);
            const btn = document.getElementById(`btnSave${dept}`);
            const originalText = btn.innerHTML;
            const payloadByDate = {};
            let count = 0;
            rows.forEach(row => {
                const date = row.querySelector('[name="date"]').value;
                if(!date) return;
                const baseData = { recordedAt: Timestamp.now() };

                if (dept === 'Viscose') {
                    const line = row.querySelector('[name="line"]').value;
                    const brand = row.querySelector('[name="brand"]').value;
                    const weight = parseFloat(row.querySelector('[name="weight"]').value) || 0;
                    if (weight > 0) {
                        if (!payloadByDate[date]) payloadByDate[date] = [];
                        payloadByDate[date].push({ ...baseData, line, brand, weight });
                        count++;
                    }
                } else if (dept === 'Spinning') {
                    const line = row.querySelector('[name="line"]').value;
                    const weight = parseFloat(row.querySelector('[name="weight"]').value) || 0;
                    const lot = row.querySelector('[name="lot"]').value;
                    if (weight > 0) {
                        if (!payloadByDate[date]) payloadByDate[date] = [];
                        payloadByDate[date].push({ ...baseData, line, weight, lot });
                        count++;
                    }
                } else if (dept === 'Marketing') {
                    const invoice = row.querySelector('[name="invoice"]').value;
                    const claim = row.querySelector('[name="claim"]').value;
                    const weight = parseFloat(row.querySelector('[name="weight"]').value) || 0;
                    if (weight > 0) {
                        if (!payloadByDate[date]) payloadByDate[date] = [];
                        payloadByDate[date].push({ ...baseData, invoice, claim, weight });
                        count++;
                    }
                }
            });
            if (count === 0) return alert(" ‚ö†Ô∏è  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            btn.innerHTML = " ‚è≥  Saving...";
            btn.disabled = true;
            try {
                const promises = [];
                for (const [dateKey, transactions] of Object.entries(payloadByDate)) {
                    const docId = `${dept}_${dateKey}`;
                    const docRef = doc(db, "FSC_PEFC_RAW_LOGS", docId);
                    promises.push(setDoc(docRef, {
                        department: dept, date: dateKey, month: dateKey.substring(0, 7),
                        lastUpdated: Timestamp.now(), transactions: arrayUnion(...transactions)
                    }, { merge: true }));
                }
                await Promise.all(promises);
                alert(` ‚úÖ  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${dept} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                document.getElementById(`table${dept}`).innerHTML = "";
                window.addRow(dept);
            } catch (err) {
                console.error(err);
                alert(" ‚ùå  Error: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.openTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-slate-700', 'text-white', 'shadow-inner');
                el.classList.add('text-slate-300', 'hover:bg-slate-700/50');
            });
            const activeBtn = document.getElementById(`btn${tabName}`);
            activeBtn.classList.remove('text-slate-300', 'hover:bg-slate-700/50');
            activeBtn.classList.add('bg-slate-700', 'text-white', 'shadow-inner');
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.addStoreRow();
            ['Viscose', 'Spinning', 'Marketing'].forEach(d => window.addRow(d));
            // Initialize Realtime Listeners for Store
            window.initStoreListeners();
        });
    </script>
    <style>
        /* CSS to toggle visibility based on Auth state */
        body:not(.is-logged-in) .auth-only {
            display: none !important;
        }
        body.is-logged-in .auth-only {
            display: flex !important;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
    <div class="flex h-screen overflow-hidden">

        <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold flex items-center gap-2 text-blue-400">
                    <i data-lucide="layers"></i> TRC Portal
                </h1>
                <p class="text-xs text-slate-400 mt-1 ml-7">Production Control</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <button id="btnStore" onclick="openTab('Store')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 bg-slate-700 text-white shadow-inner transition">
                    <i data-lucide="package"></i> Store (Pulp)
                </button>
                <button id="btnViscose" onclick="openTab('Viscose')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
                    <i data-lucide="flask-conical"></i> Viscose
                </button>
                <button id="btnSpinning" onclick="openTab('Spinning')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
                    <i data-lucide="activity"></i> Spinning
                </button>
                <button id="btnMarketing" onclick="openTab('Marketing')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
                    <i data-lucide="coins"></i> Marketing
                </button>
            </nav>

            <div class="p-4 border-t border-slate-700 bg-slate-900/50">
                <div id="loginSection">
                    <button onclick="handleLogin()" class="w-full py-2 px-3 bg-blue-600 hover:bg-blue-500 rounded text-sm font-bold flex items-center justify-center gap-2 transition">
                        <i data-lucide="log-in" class="w-4 h-4"></i> Login with Google
                    </button>
                </div>
                <div id="userProfileSection" class="hidden">
                    <div class="flex items-center gap-3 mb-3">
                        <img id="userAvatar" src="https://via.placeholder.com/40" class="w-8 h-8 rounded-full border border-slate-500">
                        <div class="overflow-hidden">
                            <div id="userNameDisplay" class="text-sm font-bold truncate">User</div>
                            <div id="userEmailDisplay" class="text-[10px] text-slate-400 truncate">user@email.com</div>
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="w-full py-1.5 px-3 bg-slate-700 hover:bg-red-600/80 rounded text-xs text-slate-300 hover:text-white flex items-center justify-center gap-2 transition">
                        <i data-lucide="log-out" class="w-3 h-3"></i> Logout
                    </button>
                </div>
            </div>

            <div class="p-2 bg-slate-950 text-[10px] text-center text-slate-600">
                FSC/PEFC System v2.2 (Smart Store)
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-slate-50 p-6">

            <div id="Store" class="tab-content h-full flex flex-col gap-4">
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                    <h3 class="text-sm font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                        <i data-lucide="box" class="w-4 h-4 text-blue-500"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current Inventory)
                    </h3>
                    <div id="inventoryDashboard" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <div class="col-span-full text-center text-gray-400 text-sm py-2">Loading stock data...</div>
                    </div>
                </div>

                <div class="flex flex-col bg-white rounded-xl shadow border border-slate-200 overflow-hidden flex-shrink-0">
                    <div class="p-4 border-b bg-white flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <div>
                            <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="clipboard-list" class="text-blue-600"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Transaction Entry)
                            </h2>
                            <p class="text-xs text-slate-400">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤/‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="addStoreRow()" class="flex items-center gap-1 px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 font-bold text-sm transition border border-blue-200">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß
                            </button>
                            <button id="btnSaveBatch" onclick="saveStoreBatch()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow flex items-center gap-2 transition">
                                <i data-lucide="save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-[300px]" id="storeEntryContainer">
                        <table class="w-full text-left border-collapse">
                            <thead class="sticky top-0 bg-slate-100 text-slate-600 text-xs uppercase font-bold shadow-sm z-10 border-b">
                                <tr>
                                    <th class="p-3 w-32">Date</th>
                                    <th class="p-3 w-32">Type</th>
                                    <th class="p-3">Brand</th>
                                    <th class="p-3 w-28">Grade</th>
                                    <th class="p-3 w-40">Ref / Document</th>
                                    <th class="p-3 w-28 text-right">Weight (T)</th>
                                    <th class="p-3 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="storeEntryTable" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex-1 overflow-hidden flex flex-col">
                    <h3 class="text-sm font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                        <i data-lucide="history" class="w-4 h-4 text-orange-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Recent Transactions)
                        <span class="text-[10px] normal-case font-normal text-slate-400 ml-auto">*Login ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö</span>
                    </h3>
                    <div class="overflow-y-auto flex-1 border rounded">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0">
                                <tr>
                                    <th class="p-2 w-24">Date</th>
                                    <th class="p-2 w-24">Type</th>
                                    <th class="p-2">Brand</th>
                                    <th class="p-2 w-20">Grade</th>
                                    <th class="p-2 w-32">Ref</th>
                                    <th class="p-2 w-24 text-right">Weight</th>
                                    <th class="p-2 w-20 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="storeHistoryTable">
                                <tr><td colspan="7" class="p-4 text-center text-gray-400">Loading history...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="Viscose" class="tab-content hidden h-full">
                <h2 class="text-lg font-bold text-orange-800 mb-2 flex items-center gap-2">
                    <i data-lucide="flask-conical"></i> Viscose Consumption
                </h2>
                <div class="bg-white p-4 rounded-xl shadow border border-slate-200">
                    <div class="overflow-x-auto border rounded mb-4">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="p-2 w-32">Date</th>
                                    <th class="p-2 w-32">Line</th>
                                    <th class="p-2">Brand</th>
                                    <th class="p-2 w-32 text-right">Used (Ton)</th>
                                    <th class="p-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="tableViscose"></tbody>
                        </table>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addRow('Viscose')" class="px-4 py-2 bg-gray-200 rounded font-bold hover:bg-gray-300 transition">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
                        <button id="btnSaveViscose" onclick="saveData('Viscose')" class="px-6 py-2 bg-orange-600 text-white rounded font-bold hover:bg-orange-700 shadow flex-1 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Viscose</button>
                    </div>
                </div>
            </div>

            <div id="Spinning" class="tab-content hidden h-full">
                <h2 class="text-lg font-bold text-teal-800 mb-2 flex items-center gap-2">
                    <i data-lucide="activity"></i> Spinning Output
                </h2>
                <div class="bg-white p-4 rounded-xl shadow border border-slate-200">
                    <div class="overflow-x-auto border rounded mb-4">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="p-2 w-32">Date</th>
                                    <th class="p-2 w-32">Line</th>
                                    <th class="p-2 w-48 text-right">Output (Ton)</th>
                                    <th class="p-2">Lot / Batch</th>
                                    <th class="p-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="tableSpinning"></tbody>
                        </table>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addRow('Spinning')" class="px-4 py-2 bg-gray-200 rounded font-bold hover:bg-gray-300 transition">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
                        <button id="btnSaveSpinning" onclick="saveData('Spinning')" class="px-6 py-2 bg-teal-600 text-white rounded font-bold hover:bg-teal-700 shadow flex-1 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Spinning</button>
                    </div>
                </div>
            </div>

            <div id="Marketing" class="tab-content hidden h-full">
                <h2 class="text-lg font-bold text-purple-800 mb-2 flex items-center gap-2">
                    <i data-lucide="coins"></i> Marketing Sales
                </h2>
                <div class="bg-white p-4 rounded-xl shadow border border-slate-200">
                    <div class="overflow-x-auto border rounded mb-4">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="p-2 w-32">Date</th>
                                    <th class="p-2 w-48">Invoice No.</th>
                                    <th class="p-2 w-48">Claim Type</th>
                                    <th class="p-2 w-48 text-right">Weight (Ton)</th>
                                    <th class="p-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="tableMarketing"></tbody>
                        </table>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addRow('Marketing')" class="px-4 py-2 bg-gray-200 rounded font-bold hover:bg-gray-300 transition">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
                        <button id="btnSaveMarketing" onclick="saveData('Marketing')" class="px-6 py-2 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 shadow flex-1 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Marketing</button>
                    </div>
                </div>
            </div>

        </main>
    </div>
    <script>lucide.createIcons();</script>
</body>
</html>‡πÅ