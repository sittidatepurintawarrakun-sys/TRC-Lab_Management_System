<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC Department Portal (Smart Store & Production)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getFirestore, doc, setDoc, getDoc, addDoc, deleteDoc, updateDoc, 
            arrayUnion, collection, Timestamp, runTransaction, query, orderBy, limit, onSnapshot, where 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { 
            getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
            authDomain: "lab-trc-management-system.firebaseapp.com",
            projectId: "lab-trc-management-system",
            storageBucket: "lab-trc-management-system.appspot.com",
            messagingSenderId: "43919979160",
            appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- HELPER: Create Icons ---
        const safeCreateIcons = () => {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        };

        // --- 2. CONSTANTS ---
        const PULP_OPTIONS_STORE = `
            <option value="ARAUCO FSC Mix Credit">ARAUCO FSC Mix Credit</option>
            <option value="ARAUCO FSC Control Wood">ARAUCO FSC Control Wood</option>
            <option value="ARAUCO PEFC">ARAUCO PEFC</option>
            <option value="AVN FSC Mix Credit">AVN FSC Mix Credit</option>
            <option value="AVN FSC Control Wood">AVN FSC Control Wood</option>
            <option value="AVN PEFC">AVN PEFC</option>
            <option value="AVC FSC Mix Credit">AVC FSC Mix Credit</option>
            <option value="AVC FSC Control Wood">AVC FSC Control Wood</option>
            <option value="AVC PEFC">AVC PEFC</option>
            <option value="PHOENIX Mix Credit">PHOENIX Mix Credit</option>
            <option value="PHOENIX Control Wood">PHOENIX Control Wood</option>
            <option value="PHOENIX PEFC">PHOENIX PEFC</option>
            <option value="SAICCOR FSC Mix Credit 70%">SAICCOR FSC Mix Credit 70%</option>
        `;

        const VISCOSE_LINE_OPTIONS = `
            <option value="Line Modal">Line Modal</option>
            <option value="Line Grey">Line Grey</option>
            <option value="Line NonWoven">Line NonWoven</option>
        `;

        // Updated Line Options for Spinning (MC2, MC3, MC5, MC6)
        const SPINNING_LINE_OPTIONS = `
            <option value="Line MC2">Line MC2</option>
            <option value="Line MC3">Line MC3</option>
            <option value="Line MC5">Line MC5</option>
            <option value="Line MC6">Line MC6</option>
        `;

        // --- 3. AUTHENTICATION LOGIC ---
        let currentUser = null;
        let editingLogId = null; 
        
        // Listeners
        let historyUnsubscribe = null; // Store
        let viscoseUnsubscribe = null; // Viscose
        let spinningUnsubscribe = null; // Spinning
        
        let dashboardListening = false;

        window.handleLogin = async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorMsg = document.getElementById('loginError');
            const btn = document.getElementById('btnLoginAction');

            errorMsg.classList.add('hidden');
            errorMsg.textContent = "";

            if (!email || !password) {
                errorMsg.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡πÅ‡∏•‡∏∞ Password";
                errorMsg.classList.remove('hidden');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = `<span class="animate-spin"> ‚åõ </span> Processing...`;
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed", error);
                errorMsg.textContent = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (" + error.code + ")";
                errorMsg.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)`;
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                console.error("Logout failed", error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const loginContainer = document.getElementById('loginContainer');
            const userProfile = document.getElementById('userProfileSection');
            const userName = document.getElementById('userNameDisplay');
            const userEmail = document.getElementById('userEmailDisplay');
            const userAvatar = document.getElementById('userAvatar');

            document.body.classList.toggle('is-logged-in', !!user);

            if (user) {
                loginContainer.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userName.innerText = user.email.split('@')[0];
                userEmail.innerText = user.email;
                if(user.photoURL) userAvatar.src = user.photoURL;

                console.log("User Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> Loading Listeners...");
                window.initStoreListeners();   
                window.initViscoseListeners(); 
                window.initSpinningListeners(); // Load Spinning
                // Marketing uses manual load usually, but we ensure it's ready
            } else {
                loginContainer.classList.remove('hidden');
                userProfile.classList.add('hidden');
                const btn = document.getElementById('btnLoginAction');
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)`;
                }
            }
        });

        // ==========================================
        // MODULE 1: STORE (Pulp Inventory)
        // ==========================================
        window.initStoreListeners = (searchDate = null) => {
            // A. Inventory Dashboard
            if(!dashboardListening) {
                const balanceRef = collection(db, "store_inventory_balance");
                onSnapshot(balanceRef, (snapshot) => {
                    const container = document.getElementById('inventoryDashboard');
                    if(!container) return;
                    container.innerHTML = '';
                    let cardsHTML = '';
                    if(snapshot.empty) {
                        container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const [brand, grade] = doc.id.split('__');
                        const balance = data.balance || 0;
                        const isLow = balance < 50;
                        const bgClass = isLow ? 'bg-red-50 border-red-200' : 'bg-white border-slate-200';
                        const textClass = isLow ? 'text-red-700' : 'text-slate-700';
                        cardsHTML += `
                        <div class="p-3 rounded-lg border shadow-sm flex flex-col justify-between ${bgClass}">
                            <div>
                                <div class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">${grade}</div>
                                <div class="text-xs font-semibold text-slate-800 truncate" title="${brand}">${brand}</div>
                            </div>
                            <div class="text-right mt-2">
                                <span class="text-xl font-bold ${textClass}">${balance.toLocaleString(undefined, {minimumFractionDigits:3, maximumFractionDigits:3})}</span>
                                <span class="text-[10px] text-slate-400">Tons</span>
                            </div>
                        </div>`;
                    });
                    container.innerHTML = cardsHTML;
                });
                dashboardListening = true;
            }

            // B. History Table
            if (historyUnsubscribe) historyUnsubscribe();
            const tbody = document.getElementById('storeHistoryTable');
            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400"><span class="animate-spin inline-block mr-2"> ‚è≥ </span> Loading...</td></tr>';
            
            let q;
            const logsRef = collection(db, "store_transaction_logs");
            if (searchDate) {
                q = query(logsRef, where("date", "==", searchDate), orderBy("recordedAt", "desc"));
            } else {
                q = query(logsRef, orderBy("recordedAt", "desc"), limit(20));
            }

            historyUnsubscribe = onSnapshot(q, (snapshot) => {
                tbody.innerHTML = '';
                if(snapshot.empty) {
                    const msg = searchDate ? `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${searchDate}` : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-400">${msg}</td></tr>`;
                    return;
                }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const isIN = data.type === 'IN';
                    const typeBadge = isIN 
                        ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700"> üì•  Buy</span>` 
                        : `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700"> üì§  Issue</span>`;
                    
                    const isEditing = (editingLogId === docSnap.id);
                    const rowClass = isEditing ? "bg-blue-50 border-l-4 border-blue-500" : "border-b hover:bg-gray-50 transition";
                    
                    const row = document.createElement('tr');
                    row.className = rowClass;
                    row.innerHTML = `
                        <td class="p-2 text-gray-500">${data.date}</td>
                        <td class="p-2">${typeBadge}</td>
                        <td class="p-2 font-medium text-slate-700">${data.brand}</td>
                        <td class="p-2 text-xs">${data.grade}</td>
                        <td class="p-2 text-xs text-gray-500">${data.docRef || '-'}</td>
                        <td class="p-2 text-right font-mono font-bold ${isIN ? 'text-green-600' : 'text-red-600'}">
                            ${isIN ? '+' : '-'}${data.weight.toFixed(3)}
                        </td>
                        <td class="p-2 text-right">
                            <div class="auth-only hidden flex justify-end items-center gap-2">
                                <button onclick="deleteTransaction('${docSnap.id}')" class="px-2 py-1 bg-red-50 hover:bg-red-100 text-red-600 rounded border border-red-200 text-xs font-bold flex items-center gap-1 transition">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i> <span>‡∏•‡∏ö</span>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                safeCreateIcons();
                if(currentUser) document.body.classList.add('is-logged-in');
            });
        };

        window.addStoreRow = () => {
            const tbody = document.getElementById('storeEntryTable');
            const row = document.createElement('tr');
            const today = new Date().toISOString().split('T')[0];
            row.className = "border-b transition-colors bg-green-50/50";
            row.innerHTML = `
                <td class="p-2"><input type="date" name="s_date" value="${today}" class="w-full text-xs border border-gray-300 rounded p-2 font-bold text-gray-600 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"></td>
                <td class="p-2">
                    <select name="s_type" onchange="changeRowColor(this)" class="w-full text-xs border border-gray-300 rounded p-2 font-bold shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                        <option value="IN" class="text-green-700">  üì•   ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (Buy)</option>
                        <option value="OUT" class="text-red-700">  üì§   ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (Issue)</option>
                    </select>
                </td>
                <td class="p-2"><select name="s_brand" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">${PULP_OPTIONS_STORE}</select></td>
                <td class="p-2">
                    <select name="s_grade" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                        <option value="NORMAL">  ‚úÖ   Normal</option>
                        <option value="OFF">  ‚ùå   Off Grade</option>
                    </select>
                </td>
                <td class="p-2"><input type="text" name="s_doc" placeholder="Batch / Lot" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"></td>
                <td class="p-2"><input type="number" name="s_weight" step="0.001" placeholder="0.000" class="w-full text-sm font-mono text-right font-bold border border-gray-300 rounded p-2 bg-white text-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"></td>
                <td class="p-2 text-center">
                    <button onclick="removeRow(this)" class="text-gray-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            `;
            tbody.appendChild(row);
            safeCreateIcons();
            const container = document.getElementById('storeEntryContainer');
            container.scrollTop = container.scrollHeight;
        };

        window.removeRow = (btn) => { btn.closest('tr').remove(); };

        window.changeRowColor = (selectEl) => {
            const row = selectEl.closest('tr');
            if(selectEl.value === 'IN') {
                row.classList.remove('bg-red-50/50');
                row.classList.add('bg-green-50/50');
            } else {
                row.classList.remove('bg-green-50/50');
                row.classList.add('bg-red-50/50');
            }
        };

        window.saveStoreBatch = async () => {
            const rows = document.querySelectorAll('#storeEntryTable tr');
            if(rows.length === 0) return alert("  ‚ö†Ô∏è   ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            const btn = document.getElementById('btnSaveBatch');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `  ‚è≥   Processing...`;

            try {
                let successCount = 0;
                for (const row of rows) {
                    const date = row.querySelector('[name="s_date"]').value;
                    const type = row.querySelector('[name="s_type"]').value;
                    const brand = row.querySelector('[name="s_brand"]').value;
                    const grade = row.querySelector('[name="s_grade"]').value;
                    const docVal = row.querySelector('[name="s_doc"]').value;
                    const weight = parseFloat(row.querySelector('[name="s_weight"]').value);

                    if(!date || !weight || weight <= 0) continue;

                    await runTransaction(db, async (transaction) => {
                        const logRef = doc(collection(db, "store_transaction_logs"));
                        const invKey = `${brand}__${grade}`;
                        const invRef = doc(db, "store_inventory_balance", invKey);
                        const invDoc = await transaction.get(invRef);
                        let currentBal = 0;
                        if(invDoc.exists()) currentBal = invDoc.data().balance || 0;
                        const newBal = type === 'IN' ? currentBal + weight : currentBal - weight;

                        transaction.set(logRef, {
                            type, brand, grade, weight,
                            docRef: docVal, date,
                            recordedBy: currentUser ? currentUser.email : 'Guest',
                            recordedAt: Timestamp.now()
                        });
                        transaction.set(invRef, { balance: newBal, lastUpdated: Timestamp.now() }, { merge: true });
                    });
                    successCount++;
                    row.remove();
                }
                if(successCount > 0 && document.querySelectorAll('#storeEntryTable tr').length === 0) {
                    window.addStoreRow();
                }
            } catch (err) {
                console.error(err);
                alert("  ‚ùå   Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        };

        window.deleteTransaction = async (logId) => {
            if(!currentUser) return alert("Access Denied");
            if(!confirm(" ‚ö†Ô∏è  ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö? \n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å (Reverse Stock) ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")) return;
            try {
                await runTransaction(db, async (transaction) => {
                    const logRef = doc(db, "store_transaction_logs", logId);
                    const logDoc = await transaction.get(logRef);
                    if(!logDoc.exists()) throw "Document does not exist!";
                    const data = logDoc.data();
                    const invKey = `${data.brand}__${data.grade}`;
                    const invRef = doc(db, "store_inventory_balance", invKey);
                    const invDoc = await transaction.get(invRef);
                    let currentBal = 0;
                    if(invDoc.exists()) currentBal = invDoc.data().balance || 0;
                    const reverseBal = data.type === 'IN' ? currentBal - data.weight : currentBal + data.weight;
                    transaction.delete(logRef);
                    transaction.set(invRef, { balance: reverseBal }, { merge: true });
                });
            } catch (e) {
                console.error(e);
                alert("Error deleting: " + e.message);
            }
        };

        // ==========================================
        // MODULE 2: VISCOSE (Consumption)
        // ==========================================
        window.addViscoseRow = () => {
            const tbody = document.getElementById('tableViscose');
            const row = document.createElement('tr');
            const today = new Date().toISOString().split('T')[0];
            row.className = "border-b hover:bg-gray-50 transition";
            row.innerHTML = `
                <td class="p-2"><input type="date" name="v_date" value="${today}" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm outline-none"></td>
                <td class="p-2"><select name="v_line" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm outline-none cursor-pointer">${VISCOSE_LINE_OPTIONS}</select></td>
                <td class="p-2"><select name="v_brand" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm outline-none cursor-pointer">${PULP_OPTIONS_STORE}</select></td>
                <td class="p-2">
                    <select name="v_grade" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm outline-none cursor-pointer">
                        <option value="NORMAL">Normal</option>
                        <option value="OFF">Off Grade</option>
                    </select>
                </td>
                <td class="p-2"><input type="text" name="v_doc" placeholder="Batch / Ref" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm outline-none"></td>
                <td class="p-2"><input type="number" name="v_weight" step="0.001" class="w-full text-sm font-mono text-right font-bold border border-gray-300 rounded p-2 bg-white text-orange-600 shadow-sm outline-none"></td>
                <td class="p-2 text-center">
                    <button onclick="removeRow(this)" class="text-gray-400 hover:text-red-500 p-1.5 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            `;
            tbody.appendChild(row);
            safeCreateIcons();
        };

        window.saveViscoseData = async () => {
            const rows = document.querySelectorAll('#tableViscose tr');
            const btn = document.getElementById('btnSaveViscose');
            const originalText = btn.innerHTML;
            const payloadByDate = {};
            let count = 0;

            rows.forEach(row => {
                const date = row.querySelector('[name="v_date"]').value;
                if (!date) return;
                const line = row.querySelector('[name="v_line"]').value;
                const brand = row.querySelector('[name="v_brand"]').value;
                const grade = row.querySelector('[name="v_grade"]').value;
                const docRef = row.querySelector('[name="v_doc"]').value;
                const weight = parseFloat(row.querySelector('[name="v_weight"]').value) || 0;

                if (weight > 0) {
                    if (!payloadByDate[date]) payloadByDate[date] = [];
                    payloadByDate[date].push({ 
                        recordedAt: Timestamp.now(), 
                        line, brand, grade, docRef, weight 
                    });
                    count++;
                }
            });

            if (count === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            btn.innerHTML = "Saving...";
            btn.disabled = true;

            try {
                const promises = [];
                for (const [dateKey, transactions] of Object.entries(payloadByDate)) {
                    const docId = `Viscose_${dateKey}`;
                    const docRef = doc(db, "FSC_PEFC_RAW_LOGS", docId);
                    promises.push(setDoc(docRef, {
                        department: 'Viscose',
                        date: dateKey,
                        month: dateKey.substring(0, 7),
                        lastUpdated: Timestamp.now(),
                        transactions: arrayUnion(...transactions)
                    }, { merge: true }));
                }
                await Promise.all(promises);
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Viscose ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                document.getElementById('tableViscose').innerHTML = "";
                window.addViscoseRow();
            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.initViscoseListeners = (searchDate = null) => {
            const tbody = document.getElementById('viscoseHistoryTable');
            if (!tbody) return;
            const dateInput = document.getElementById('viscoseHistorySearchDate');
            if (dateInput) dateInput.value = searchDate || "";
            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">Loading...</td></tr>';
            
            if (viscoseUnsubscribe) viscoseUnsubscribe();

            let q;
            if (searchDate) {
                // Specific Date
                const docRef = doc(db, "FSC_PEFC_RAW_LOGS", `Viscose_${searchDate}`);
                viscoseUnsubscribe = onSnapshot(docRef, (docSnap) => renderUnifiedTable([docSnap], tbody, true, 'Viscose'));
            } else {
                // Recent
                q = query(
                    collection(db, "FSC_PEFC_RAW_LOGS"),
                    where("department", "==", "Viscose"),
                    orderBy("date", "desc"),
                    limit(5)
                );
                viscoseUnsubscribe = onSnapshot(q, (snapshot) => renderUnifiedTable(snapshot.docs, tbody, false, 'Viscose'));
            }
        };

        // ==========================================
        // MODULE 3: SPINNING (Production Output) - UPGRADED
        // ==========================================
        window.addSpinningRow = () => {
            const tbody = document.getElementById('spinningEntryTable');
            const row = document.createElement('tr');
            const today = new Date().toISOString().split('T')[0];
            row.className = "border-b hover:bg-gray-50 transition";
            row.innerHTML = `
                <td class="p-2"><input type="date" name="sp_date" value="${today}" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm outline-none"></td>
                <td class="p-2"><select name="sp_line" class="w-full text-xs border border-gray-300 rounded p-2 bg-white shadow-sm outline-none cursor-pointer">${SPINNING_LINE_OPTIONS}</select></td>
                <td class="p-2"><input type="number" name="sp_weight" step="0.001" placeholder="Fibre Output (Ton)" class="w-full text-sm font-mono text-right font-bold border border-gray-300 rounded p-2 bg-white text-teal-600 shadow-sm outline-none"></td>
                <td class="p-2 text-center">
                    <button onclick="removeRow(this)" class="text-gray-400 hover:text-red-500 p-1.5 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            `;
            tbody.appendChild(row);
            safeCreateIcons();
        };

        window.saveSpinningData = async () => {
            const rows = document.querySelectorAll('#spinningEntryTable tr');
            const btn = document.getElementById('btnSaveSpinning');
            const originalText = btn.innerHTML;
            const payloadByDate = {};
            let count = 0;

            rows.forEach(row => {
                const date = row.querySelector('[name="sp_date"]').value;
                if (!date) return;
                const line = row.querySelector('[name="sp_line"]').value;
                const weight = parseFloat(row.querySelector('[name="sp_weight"]').value) || 0;

                if (weight > 0) {
                    if (!payloadByDate[date]) payloadByDate[date] = [];
                    // Backend will calculate Credit/Pulp usage based on this Output
                    payloadByDate[date].push({ 
                        recordedAt: Timestamp.now(), 
                        line, weight 
                    });
                    count++;
                }
            });

            if (count === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å Fibre Output ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            btn.innerHTML = "Saving...";
            btn.disabled = true;

            try {
                const promises = [];
                for (const [dateKey, transactions] of Object.entries(payloadByDate)) {
                    const docId = `Spinning_${dateKey}`;
                    const docRef = doc(db, "FSC_PEFC_RAW_LOGS", docId);
                    promises.push(setDoc(docRef, {
                        department: 'Spinning',
                        date: dateKey,
                        month: dateKey.substring(0, 7),
                        lastUpdated: Timestamp.now(),
                        transactions: arrayUnion(...transactions)
                    }, { merge: true }));
                }
                await Promise.all(promises);
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Spinning ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                document.getElementById('spinningEntryTable').innerHTML = "";
                window.addSpinningRow();
            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.initSpinningListeners = (searchDate = null) => {
            const tbody = document.getElementById('spinningHistoryTable');
            if (!tbody) return;
            const dateInput = document.getElementById('spinningHistorySearchDate');
            if (dateInput) dateInput.value = searchDate || "";
            tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-400">Loading...</td></tr>';
            
            if (spinningUnsubscribe) spinningUnsubscribe();

            let q;
            if (searchDate) {
                const docRef = doc(db, "FSC_PEFC_RAW_LOGS", `Spinning_${searchDate}`);
                spinningUnsubscribe = onSnapshot(docRef, (docSnap) => renderSpinningHistoryTable([docSnap], tbody, true));
            } else {
                q = query(
                    collection(db, "FSC_PEFC_RAW_LOGS"),
                    where("department", "==", "Spinning"),
                    orderBy("date", "desc"),
                    limit(5)
                );
                spinningUnsubscribe = onSnapshot(q, (snapshot) => renderSpinningHistoryTable(snapshot.docs, tbody, false));
            }
        };

        // Specialized Render for Spinning History (Aggregated Data from Backend)
        const renderSpinningHistoryTable = (docs, tbody, isSingleDateMode) => {
            let allTransactions = [];
            docs.forEach(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const dayTrans = data.transactions || [];
                    dayTrans.forEach((tx, idx) => {
                        allTransactions.push({
                            ...tx,
                            _realDate: data.date,
                            _realIndex: idx,
                            _docId: docSnap.id
                        });
                    });
                }
            });

            if (allTransactions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
                return;
            }

            // Sort new to old
            allTransactions.sort((a, b) => {
                const timeA = a.recordedAt ? a.recordedAt.seconds : 0;
                const timeB = b.recordedAt ? b.recordedAt.seconds : 0;
                if (timeA !== timeB) return timeB - timeA;
                return b._realIndex - a._realIndex;
            });

            if (!isSingleDateMode) allTransactions = allTransactions.slice(0, 20);

            tbody.innerHTML = '';
            allTransactions.forEach((tx) => {
                // Prepare Backend Calculated Data (if available)
                const pulpInfo = tx.composition ? `${tx.composition.brand} (${tx.composition.grade})` : '<span class="text-gray-300">-</span>';
                const pulpRef = tx.composition ? tx.composition.docRef : '-';
                const pulpUsed = tx.pulp_used_weight ? parseFloat(tx.pulp_used_weight).toFixed(3) : '-';
                const fscCredit = tx.fsc_credit ? `<span class="text-green-600 font-bold">${parseFloat(tx.fsc_credit).toFixed(3)}</span>` : '-';
                const pefcCredit = tx.pefc_credit ? `<span class="text-blue-600 font-bold">${parseFloat(tx.pefc_credit).toFixed(3)}</span>` : '-';

                const row = document.createElement('tr');
                row.className = "border-b hover:bg-gray-50 transition";
                row.innerHTML = `
                    <td class="p-2 text-gray-500">${tx._realDate}</td>
                    <td class="p-2 font-bold text-slate-700">${tx.line}</td>
                    <td class="p-2 text-xs">${pulpInfo}</td>
                    <td class="p-2 text-xs text-gray-500">${pulpRef}</td>
                    <td class="p-2 text-right text-gray-400 text-xs">${pulpUsed}</td>
                    <td class="p-2 text-right font-mono font-bold text-teal-600 border-l border-r bg-teal-50/30">${parseFloat(tx.weight).toFixed(3)}</td>
                    <td class="p-2 text-right text-xs">${fscCredit}</td>
                    <td class="p-2 text-right text-xs">${pefcCredit}</td>
                    <td class="p-2 text-right">
                         <div class="auth-only hidden flex justify-end">
                            <button onclick="deleteEntry('${tx._docId}', ${tx._realIndex})" class="px-2 py-1 bg-red-50 text-red-600 rounded border border-red-200 text-xs font-bold hover:bg-red-100 transition">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> ‡∏•‡∏ö
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            safeCreateIcons();
            if(currentUser) document.body.classList.add('is-logged-in');
        };

        // ==========================================
        // MODULE 4: MARKETING (Legacy / Sales)
        // ==========================================
        window.addMarketingRow = () => {
            const tbody = document.getElementById('tableMarketing');
            const row = document.createElement('tr');
            const today = new Date().toISOString().split('T')[0];
            row.className = "border-b hover:bg-gray-50 transition";
            row.innerHTML = `
                <td class="p-2"><input type="date" name="m_date" value="${today}" class="w-full border rounded p-1 text-sm bg-gray-50"></td>
                <td class="p-2"><input type="text" name="m_invoice" placeholder="INV-XXXX" class="w-full border rounded p-1 text-sm font-bold"></td>
                <td class="p-2">
                    <select name="m_claim" class="w-full border rounded p-1 text-sm">
                        <option value="FSC Mix">FSC Mix Credit</option>
                        <option value="PEFC 100%">PEFC 100%</option>
                        <option value="None">None (General)</option>
                    </select>
                </td>
                <td class="p-2"><input type="number" name="m_weight" step="0.001" class="w-full border rounded p-1 text-sm text-right font-bold text-purple-600"></td>
                <td class="p-2 text-center">
                    <button onclick="removeRow(this)" class="text-gray-400 hover:text-red-500 rounded-full p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            `;
            tbody.appendChild(row);
            safeCreateIcons();
        };

        window.saveMarketingData = async () => {
            const rows = document.querySelectorAll('#tableMarketing tr');
            const btn = document.getElementById('btnSaveMarketing');
            const originalText = btn.innerHTML;
            const payloadByDate = {};
            let count = 0;

            rows.forEach(row => {
                const date = row.querySelector('[name="m_date"]').value;
                if (!date) return;
                const invoice = row.querySelector('[name="m_invoice"]').value;
                const claim = row.querySelector('[name="m_claim"]').value;
                const weight = parseFloat(row.querySelector('[name="m_weight"]').value) || 0;

                if (weight > 0) {
                    if (!payloadByDate[date]) payloadByDate[date] = [];
                    payloadByDate[date].push({ recordedAt: Timestamp.now(), invoice, claim, weight });
                    count++;
                }
            });

            if (count === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            btn.innerHTML = "Saving...";
            btn.disabled = true;

            try {
                const promises = [];
                for (const [dateKey, transactions] of Object.entries(payloadByDate)) {
                    const docId = `Marketing_${dateKey}`;
                    const docRef = doc(db, "FSC_PEFC_RAW_LOGS", docId);
                    promises.push(setDoc(docRef, {
                        department: 'Marketing',
                        date: dateKey,
                        month: dateKey.substring(0, 7),
                        lastUpdated: Timestamp.now(),
                        transactions: arrayUnion(...transactions)
                    }, { merge: true }));
                }
                await Promise.all(promises);
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Marketing ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                document.getElementById('tableMarketing').innerHTML = "";
                window.addMarketingRow();
            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // ==========================================
        // SHARED HELPERS (Viscose & General)
        // ==========================================
        const renderUnifiedTable = (docs, tbody, isSingleDateMode, dept) => {
            let allTransactions = [];
            docs.forEach(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const dayTrans = data.transactions || [];
                    dayTrans.forEach((tx, idx) => {
                        allTransactions.push({
                            ...tx,
                            _realDate: data.date,
                            _realIndex: idx,
                            _docId: docSnap.id
                        });
                    });
                }
            });

            if (allTransactions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
                return;
            }

            allTransactions.sort((a, b) => {
                const timeA = a.recordedAt ? a.recordedAt.seconds : 0;
                const timeB = b.recordedAt ? b.recordedAt.seconds : 0;
                if (timeA !== timeB) return timeB - timeA;
                return b._realIndex - a._realIndex;
            });

            if (!isSingleDateMode) allTransactions = allTransactions.slice(0, 20);

            tbody.innerHTML = '';
            allTransactions.forEach((tx) => {
                const row = document.createElement('tr');
                row.className = "border-b hover:bg-gray-50 transition";
                
                // Viscose Table
                row.innerHTML = `
                    <td class="p-2 text-gray-500">${tx._realDate}</td>
                    <td class="p-2 font-bold text-slate-700">${tx.line}</td>
                    <td class="p-2">${tx.brand}</td>
                    <td class="p-2 text-xs">${tx.grade}</td>
                    <td class="p-2 text-xs text-gray-500">${tx.docRef || '-'}</td>
                    <td class="p-2 text-right font-mono font-bold text-orange-600">${parseFloat(tx.weight).toFixed(3)}</td>
                    <td class="p-2 text-right">
                        <div class="auth-only hidden flex justify-end">
                            <button onclick="deleteEntry('${tx._docId}', ${tx._realIndex})" class="px-2 py-1 bg-red-50 text-red-600 rounded border border-red-200 text-xs font-bold hover:bg-red-100 transition flex items-center gap-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> ‡∏•‡∏ö
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            safeCreateIcons();
            if(currentUser) document.body.classList.add('is-logged-in');
        };

        window.deleteEntry = async (docId, index) => {
            if(!currentUser) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            if(!confirm(` ‚ö†Ô∏è  ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?`)) return;
            try {
                const docRef = doc(db, "FSC_PEFC_RAW_LOGS", docId);
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists()) throw "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£";
                    const data = docSnap.data();
                    const newTransactions = [...data.transactions];
                    if (index > -1 && index < newTransactions.length) {
                        newTransactions.splice(index, 1);
                    }
                    transaction.update(docRef, {
                        transactions: newTransactions,
                        lastUpdated: Timestamp.now()
                    });
                });
                // Alert removed, onSnapshot will update UI
            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
            }
        };

        window.openTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-slate-700', 'text-white', 'shadow-inner');
                el.classList.add('text-slate-300', 'hover:bg-slate-700/50');
            });
            const activeBtn = document.getElementById(`btn${tabName}`);
            activeBtn.classList.remove('text-slate-300', 'hover:bg-slate-700/50');
            activeBtn.classList.add('bg-slate-700', 'text-white', 'shadow-inner');
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.addStoreRow();
            window.addViscoseRow();
            window.addSpinningRow();
            window.addMarketingRow();
            window.initStoreListeners();
            // Auth trigger will init others
            
            const pwField = document.getElementById('loginPassword');
            if(pwField) {
                pwField.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') window.handleLogin();
                });
            }
        });
    </script>
    <style>
        body:not(.is-logged-in) .auth-only { display: none !important; }
        body.is-logged-in .auth-only { display: flex !important; }
        body:not(.is-logged-in) .non-auth-only { display: flex !important; }
        body.is-logged-in .non-auth-only { display: none !important; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
    <div id="loginContainer" class="fixed inset-0 z-50 flex items-center justify-center transition-all duration-300 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?auto=format&fit=crop&q=80');">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="bg-white/95 backdrop-blur-md p-8 rounded-2xl shadow-2xl w-full max-w-md border border-white/20 relative z-10 m-4">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-100 mb-4 border-4 border-green-50 shadow-inner">
                    <i data-lucide="tree-pine" class="w-10 h-10 text-green-700"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">TRC Portal</h1>
                <p class="text-green-700 font-semibold text-sm mt-1">FSC & PEFC Smart System</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="user@adityabirla.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button id="btnLoginAction" onclick="handleLogin()" class="w-full py-3 bg-green-700 hover:bg-green-800 text-white rounded-lg font-bold shadow-lg transition-all duration-200 flex items-center justify-center gap-2">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)
                </button>
            </div>
            <p id="loginError" class="mt-4 text-center text-red-500 text-sm hidden bg-red-50 p-2 rounded border border-red-100"></p>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-xl font-bold flex items-center gap-2 text-green-400">
                    <i data-lucide="trees"></i> TRC Portal
                </h1>
                <p class="text-xs text-slate-400 mt-1 ml-7">FSC/PEFC Control System</p>
            </div>

            <nav class="flex-1 p-4 space-y-2">
                <button id="btnStore" onclick="openTab('Store')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 bg-slate-700 text-white shadow-inner transition">
                    <i data-lucide="package"></i> Store (Pulp)
                </button>
                <button id="btnViscose" onclick="openTab('Viscose')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
                    <i data-lucide="flask-conical"></i> Viscose
                </button>
                <button id="btnSpinning" onclick="openTab('Spinning')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
                    <i data-lucide="activity"></i> Spinning
                </button>
                <button id="btnMarketing" onclick="openTab('Marketing')" class="tab-btn w-full text-left p-3 rounded flex items-center gap-3 text-slate-300 hover:bg-slate-700/50 transition">
                    <i data-lucide="coins"></i> Marketing
                </button>
            </nav>

            <div class="p-4 border-t border-slate-700 bg-slate-900/50">
                <div id="userProfileSection" class="hidden">
                    <div class="flex items-center gap-3 mb-3">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=random" class="w-8 h-8 rounded-full border border-slate-500">
                        <div class="overflow-hidden">
                            <div id="userNameDisplay" class="text-sm font-bold truncate">User</div>
                            <div id="userEmailDisplay" class="text-[10px] text-slate-400 truncate">user@email.com</div>
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="w-full py-1.5 px-3 bg-slate-700 hover:bg-red-600/80 rounded text-xs text-slate-300 hover:text-white flex items-center justify-center gap-2 transition">
                        <i data-lucide="log-out" class="w-3 h-3"></i> Logout
                    </button>
                </div>
            </div>
            <div class="p-2 bg-slate-950 text-[10px] text-center text-slate-600">
                FSC/PEFC System v3.0 (Full Suite)
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-slate-50 p-6">
            
            <div id="Store" class="tab-content h-full flex flex-col gap-4">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                    <h3 class="text-sm font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                        <i data-lucide="box" class="w-4 h-4 text-blue-500"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current Inventory)
                    </h3>
                    <div id="inventoryDashboard" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <div class="col-span-full text-center text-gray-400 text-sm py-2">Loading stock data...</div>
                    </div>
                </div>

                <div class="flex flex-col bg-white rounded-xl shadow border border-slate-200 overflow-hidden flex-shrink-0">
                    <div class="p-4 border-b bg-white flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <div>
                            <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="clipboard-list" class="text-blue-600"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Store
                            </h2>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="addStoreRow()" class="flex items-center gap-1 px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 font-bold text-sm border border-blue-200">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß
                            </button>
                            <button id="btnSaveBatch" onclick="saveStoreBatch()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow flex items-center gap-2">
                                <i data-lucide="save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-[300px]" id="storeEntryContainer">
                        <table class="w-full text-left border-collapse">
                            <thead class="sticky top-0 bg-slate-100 text-slate-600 text-xs uppercase font-bold shadow-sm z-10 border-b">
                                <tr>
                                    <th class="p-3 w-32">Date</th>
                                    <th class="p-3 w-32">Type</th>
                                    <th class="p-3">Brand</th>
                                    <th class="p-3 w-28">Grade</th>
                                    <th class="p-3 w-40">Ref / Doc</th>
                                    <th class="p-3 w-28 text-right">Weight (T)</th>
                                    <th class="p-3 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="storeEntryTable" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex-1 overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2">
                            <i data-lucide="history" class="w-4 h-4 text-orange-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Store
                        </h3>
                        <div class="flex items-center gap-2">
                            <input type="date" id="historySearchDate" onchange="window.initStoreListeners(this.value)" class="text-xs border border-slate-300 rounded px-2 py-1 shadow-sm">
                            <button onclick="document.getElementById('historySearchDate').value=''; window.initStoreListeners();" class="p-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-500"><i data-lucide="rotate-ccw" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <div class="overflow-y-auto flex-1 border rounded">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0">
                                <tr>
                                    <th class="p-2 w-24">Date</th>
                                    <th class="p-2 w-24">Type</th>
                                    <th class="p-2">Brand</th>
                                    <th class="p-2 w-20">Grade</th>
                                    <th class="p-2 w-32">Ref</th>
                                    <th class="p-2 w-24 text-right">Weight</th>
                                    <th class="p-2 w-20 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="storeHistoryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="Viscose" class="tab-content hidden h-full flex flex-col gap-4">
                <div class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden flex-shrink-0">
                    <div class="p-4 border-b bg-white flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <h2 class="text-lg font-bold text-orange-800 flex items-center gap-2">
                            <i data-lucide="flask-conical"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Viscose Consumption
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="addViscoseRow()" class="flex items-center gap-1 px-4 py-2 bg-orange-50 text-orange-600 rounded hover:bg-orange-100 font-bold text-sm border border-orange-200">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß
                            </button>
                            <button id="btnSaveViscose" onclick="saveViscoseData()" class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded font-bold shadow flex items-center gap-2">
                                <i data-lucide="save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Viscose
                            </button>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-[300px]">
                        <table class="w-full text-left border-collapse">
                            <thead class="sticky top-0 bg-slate-100 text-slate-600 text-xs uppercase font-bold shadow-sm z-10 border-b">
                                <tr>
                                    <th class="p-3 w-32">Date</th>
                                    <th class="p-3 w-32">Line</th>
                                    <th class="p-3">Brand</th>
                                    <th class="p-3 w-28">Grade</th>
                                    <th class="p-3 w-40">Ref / Doc</th>
                                    <th class="p-3 w-28 text-right">Used (T)</th>
                                    <th class="p-3 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="tableViscose" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex-1 overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2">
                            <i data-lucide="history" class="w-4 h-4 text-orange-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Viscose
                        </h3>
                        <div class="flex items-center gap-2">
                            <input type="date" id="viscoseHistorySearchDate" onchange="window.initViscoseListeners(this.value)" class="text-xs border border-slate-300 rounded px-2 py-1 shadow-sm">
                            <button onclick="document.getElementById('viscoseHistorySearchDate').value=''; window.initViscoseListeners();" class="p-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-500"><i data-lucide="rotate-ccw" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <div class="overflow-y-auto flex-1 border rounded">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0">
                                <tr>
                                    <th class="p-2 w-24">Date</th>
                                    <th class="p-2">Line</th>
                                    <th class="p-2">Brand</th>
                                    <th class="p-2 w-20">Grade</th>
                                    <th class="p-2 w-32">Ref</th>
                                    <th class="p-2 w-24 text-right">Used</th>
                                    <th class="p-2 w-20 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="viscoseHistoryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="Spinning" class="tab-content hidden h-full flex flex-col gap-4">
                <div class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden flex-shrink-0">
                    <div class="p-4 border-b bg-white flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <h2 class="text-lg font-bold text-teal-800 flex items-center gap-2">
                            <i data-lucide="activity"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Spinning Output
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="addSpinningRow()" class="flex items-center gap-1 px-4 py-2 bg-teal-50 text-teal-600 rounded hover:bg-teal-100 font-bold text-sm border border-teal-200">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß
                            </button>
                            <button id="btnSaveSpinning" onclick="saveSpinningData()" class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded font-bold shadow flex items-center gap-2">
                                <i data-lucide="save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Spinning
                            </button>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-[300px]">
                        <table class="w-full text-left border-collapse">
                            <thead class="sticky top-0 bg-slate-100 text-slate-600 text-xs uppercase font-bold shadow-sm z-10 border-b">
                                <tr>
                                    <th class="p-3 w-32">Date</th>
                                    <th class="p-3 w-32">Line</th>
                                    <th class="p-3 text-right">Fibre Output (Ton)</th>
                                    <th class="p-3 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="spinningEntryTable" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow border border-slate-200 p-4 flex-1 overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2">
                            <i data-lucide="history" class="w-4 h-4 text-teal-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï Spinning & Credit Calculation
                        </h3>
                        <div class="flex items-center gap-2">
                            <input type="date" id="spinningHistorySearchDate" onchange="window.initSpinningListeners(this.value)" class="text-xs border border-slate-300 rounded px-2 py-1 shadow-sm">
                            <button onclick="document.getElementById('spinningHistorySearchDate').value=''; window.initSpinningListeners();" class="p-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-500"><i data-lucide="rotate-ccw" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <div class="overflow-y-auto flex-1 border rounded">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0">
                                <tr>
                                    <th class="p-2 w-24">Date</th>
                                    <th class="p-2 w-24">Line</th>
                                    <th class="p-2">Brand/Grade (Pulp)</th>
                                    <th class="p-2 w-24">Ref</th>
                                    <th class="p-2 w-20 text-right text-gray-500">Used (T)</th>
                                    <th class="p-2 w-24 text-right bg-teal-50 text-teal-800 font-bold border-l border-r">Fibre (T)</th>
                                    <th class="p-2 w-20 text-right text-green-700">FSC Cr.</th>
                                    <th class="p-2 w-20 text-right text-blue-700">PEFC Cr.</th>
                                    <th class="p-2 w-16 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="spinningHistoryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="Marketing" class="tab-content hidden h-full">
                <h2 class="text-lg font-bold text-purple-800 mb-2 flex items-center gap-2">
                    <i data-lucide="coins"></i> Marketing Sales
                </h2>
                <div class="bg-white p-4 rounded-xl shadow border border-slate-200">
                    <div class="overflow-x-auto border rounded mb-4">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="p-2 w-32">Date</th>
                                    <th class="p-2 w-48">Invoice No.</th>
                                    <th class="p-2 w-48">Claim Type</th>
                                    <th class="p-2 w-48 text-right">Weight (Ton)</th>
                                    <th class="p-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="tableMarketing"></tbody>
                        </table>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addMarketingRow()" class="px-4 py-2 bg-gray-200 rounded font-bold hover:bg-gray-300 transition">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
                        <button id="btnSaveMarketing" onclick="saveMarketingData()" class="px-6 py-2 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 shadow flex-1 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Marketing</button>
                    </div>
                </div>
            </div>

        </main>
    </div>
</body>
</html>