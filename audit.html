<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Audit Assistant (Secured)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ---
        // TODO: ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const firebaseConfig = {
            apiKey: "AIzaSyCYalG5sMWG9jy4Lg-475TH_xuIRwA146w",
            authDomain: "lab-trc-management-system.firebaseapp.com",
            projectId: "lab-trc-management-system",
            storageBucket: "lab-trc-management-system.appspot.com",
            messagingSenderId: "43919979160",
            appId: "1:43919979160:web:779cb9de75cd4b9fce56ed"
        };

        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Admin ‡∏ï‡∏≤‡∏° Rules ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
        const ADMIN_EMAILS = [
            'sittidate.p@adityabirla.com',
            'trc-qcl.laboratory@adityabirla.com',
            'laboratory.trc@adityabirla.com',
            'waraporn.jindanath@adityabirla.com',
            'datejub@hotmail.com' 
        ];

        let db, auth;
        let currentUser = null;
        let isAdmin = false;

        // Initialize Firebase
        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listener ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    isAdmin = ADMIN_EMAILS.includes(user.email);
                    window.updateUIForUser(user, isAdmin);
                } else {
                    currentUser = null;
                    isAdmin = false;
                    window.showLoginScreen();
                }
            });
        } else {
            console.log("Offline Mode: Firebase Config missing");
        }

        // Expose Functions to Window
        window.handleLogin = async (email, password) => {
            if (!auth) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Firebase Config ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏á
            } catch (error) {
                console.error(error);
                alert("Login Failed: " + error.message);
            }
        };

        window.handleLogout = async () => {
            if (auth) await signOut(auth);
            window.location.reload();
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏≤‡∏Å Rules ‡πÉ‡∏ô Backend ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
        window.saveFindingToFirebase = async (data) => {
            if (db && currentUser) {
                try {
                    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á non_conformance_records ‡∏´‡∏£‡∏∑‡∏≠ audit_findings
                    await addDoc(collection(db, 'non_conformance_records'), {
                        ...data,
                        recordedBy: currentUser.email,
                        recordedUid: currentUser.uid,
                        timestamp: serverTimestamp()
                    });
                    console.log("Saved to Firestore successfully");
                    return true;
                } catch (e) {
                    console.error("Error saving:", e);
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Permission Denied)");
                    return false;
                }
            }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Glass Effect for Login */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <!-- App Container -->
    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6 pb-24 relative">

        <!-- User Profile Badge (Top Right) -->
        <div id="user-badge" class="hidden absolute top-4 right-4 z-50 flex items-center gap-3 bg-white px-4 py-2 rounded-full shadow-md border border-slate-200">
            <div class="flex flex-col text-right leading-tight">
                <span id="user-email" class="text-xs font-bold text-slate-700">user@example.com</span>
                <span id="user-role" class="text-[10px] text-slate-500">Auditor</span>
            </div>
            <button onclick="handleLogout()" class="text-slate-400 hover:text-red-500 transition">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>

        <!-- STEP 1: Login Screen -->
        <div id="login-screen" class="flex flex-col items-center justify-center min-h-[90vh] fade-in">
            <div class="glass-panel p-8 rounded-2xl shadow-xl max-w-sm w-full border border-white/50 relative overflow-hidden">
                <!-- Decoration -->
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>

                <div class="text-center mb-8">
                    <div class="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white shadow-sm">
                        <i class="fas fa-fingerprint text-3xl text-blue-600"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800">Smart Audit</h1>
                    <p class="text-slate-500 text-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>
                </div>

                <form onsubmit="event.preventDefault(); submitLogin();" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1 ml-1">EMAIL</label>
                        <div class="relative">
                            <i class="fas fa-envelope absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                            <input type="email" id="email-input" required 
                                class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition focus:bg-white"
                                placeholder="name@adityabirla.com">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1 ml-1">PASSWORD</label>
                        <div class="relative">
                            <i class="fas fa-lock absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                            <input type="password" id="password-input" required 
                                class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition focus:bg-white"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>

                    <button type="submit" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-500/30 transition transform hover:-translate-y-0.5 flex items-center justify-center gap-2 mt-4">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö <i class="fas fa-arrow-right"></i>
                    </button>
                </form>

                <div class="mt-6 pt-4 border-t border-slate-100 text-center">
                    <p class="text-xs text-slate-400">
                        *‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                    </p>
                </div>
            </div>
        </div>

        <!-- STEP 2: Department Selection (Hidden) -->
        <div id="select-screen" class="hidden fade-in pt-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2 text-slate-800">
                <i class="fas fa-layer-group text-blue-600"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à (Scope)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="dept-grid">
                <!-- Cards will be injected by JS -->
            </div>
        </div>

        <!-- STEP 3: Loading (Hidden) -->
        <div id="loading-screen" class="hidden flex-col items-center justify-center min-h-[60vh] fade-in">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-600 mb-6"></div>
            <h3 class="text-xl font-semibold text-slate-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h3>
            <p class="text-slate-500 mt-2 text-sm">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Checklist</p>
        </div>

        <!-- STEP 4: Audit Interface (Hidden) -->
        <div id="audit-screen" class="hidden fade-in pt-6">
            <!-- Header -->
            <div class="bg-white p-6 rounded-2xl mb-8 shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center text-2xl" id="dept-icon">üè≠</div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800" id="audit-title">Audit Room</h2>
                        <p class="text-slate-500 text-sm">Checklist generated from Risk Assessment</p>
                    </div>
                </div>
                <button onclick="resetApp()" class="px-4 py-2 text-slate-500 hover:text-slate-800 text-sm font-medium bg-slate-50 rounded-lg hover:bg-slate-100 transition">
                    <i class="fas fa-arrow-left mr-1"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Checklist Column -->
                <div class="lg:col-span-2 space-y-6" id="checklist-container">
                    <!-- Questions will be injected here -->
                </div>

                <!-- Copilot Column -->
                <div class="lg:col-span-1">
                    <div class="sticky top-6 bg-white rounded-xl shadow-lg border border-slate-200 p-4 h-[calc(100vh-100px)] flex flex-col">
                        <div class="flex items-center gap-2 mb-4 pb-4 border-b border-slate-100">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <h3 class="font-bold text-slate-800">AI Assistant (Backend)</h3>
                        </div>

                        <!-- Chat History -->
                        <div id="chat-history" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2 custom-scrollbar p-2 bg-slate-50 rounded">
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-sm text-blue-800 shadow-sm">
                                <i class="fas fa-robot mr-1"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Backend ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö <br>
                                ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div class="relative">
                            <input type="text" id="chat-input"
                                placeholder="‡∏ñ‡∏≤‡∏° AI... (‡πÄ‡∏ä‡πà‡∏ô '‡πÄ‡∏à‡∏≠‡∏ñ‡∏±‡∏á‡∏™‡∏µ‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏ú‡∏¥‡∏î‡πÑ‡∏´‡∏°?')"
                                class="w-full border border-slate-300 rounded-full py-2 px-4 pr-10 text-sm focus:outline-none focus:border-blue-500 shadow-sm"
                                onkeypress="handleChatEnter(event)">
                            <button onclick="sendMessage()" class="absolute right-2 top-2 text-blue-600 hover:text-blue-800 p-1">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        // --- MOCK DATA (‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô AI ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß) ---
        let CURRENT_DEPT = "";

        const DEPARTMENT_CONTEXT = {
            "Maintenance": {
                icon: "üîß",
                riskLevel: "High",
                color: "orange",
                lastIssues: ["PM Record ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô", "‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•"],
                kpiStatus: "Downtime ‡πÄ‡∏û‡∏¥‡πà‡∏° 5%",
                standards: ["ISO 45001", "ISO 14001", "ISO 9001"],
                // Mock Checklist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Demo
                mockChecklist: [
                    { id: 1, question: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (PM) ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Mixer #3 ‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", requirement: "ISO 9001 Cl. 7.1.3", risk: "High", guidance: "‡∏Ç‡∏≠‡∏î‡∏π‡πÉ‡∏ö Job Order ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Master Plan" },
                    { id: 2, question: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏•‡πà‡∏≠‡∏•‡∏∑‡πà‡∏ô ‡∏°‡∏µ‡∏ñ‡∏≤‡∏î‡∏£‡∏≠‡∏á (Secondary Containment) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", requirement: "ISO 14001 Cl. 8.1", risk: "High", guidance: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏ñ‡∏≤‡∏î‡∏£‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÅ‡∏ï‡∏Å ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏Ç‡∏±‡∏á" },
                    { id: 3, question: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå PPE ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏ì‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", requirement: "ISO 45001 Cl. 8.1.2", risk: "Medium", guidance: "‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô" }
                ]
            },
            "Production-Food": {
                icon: "üè≠",
                riskLevel: "Critical",
                color: "red",
                lastIssues: ["‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏Å‡∏Ñ‡∏•‡∏∏‡∏°‡∏ú‡∏°", "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ CCP ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á"],
                kpiStatus: "Customer Complaint 2 ‡πÄ‡∏Ñ‡∏™",
                standards: ["GMP", "HACCP", "Halal", "ISO 22000"],
                mockChecklist: [
                    { id: 1, question: "‡∏à‡∏∏‡∏î CCP Metal Detector ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Test Piece ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", requirement: "HACCP / ISO 22000", risk: "Critical", guidance: "‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 24 ‡∏ä‡∏°. ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á" },
                    { id: 2, question: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏Å‡∏Ñ‡∏•‡∏∏‡∏°‡∏ú‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", requirement: "GMP / Hygiene", risk: "High", guidance: "‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏à‡∏∏‡∏î‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå" }
                ]
            },
            "Warehouse": {
                icon: "üì¶",
                riskLevel: "Medium",
                color: "green",
                lastIssues: ["‡πÑ‡∏°‡πâ‡∏û‡∏≤‡πÄ‡∏•‡∏ó‡∏õ‡∏ô‡∏Å‡∏±‡∏ô (FSC/Non-FSC)"],
                kpiStatus: "Stock Accuracy 98%",
                standards: ["FSC", "PEFC", "ISO 9001"],
                mockChecklist: [
                    { id: 1, question: "‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏µ‡πâ‡∏ö‡πà‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πâ FSC ‡πÅ‡∏•‡∏∞ Non-FSC ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", requirement: "FSC-STD-40-004", risk: "Medium", guidance: "‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏°‡πâ‡∏û‡∏≤‡πÄ‡∏•‡∏ó" },
                    { id: 2, question: "‡∏™‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö SAP ‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", requirement: "ISO 9001 Cl. 8.5.1", risk: "Medium", guidance: "‡∏™‡∏∏‡πà‡∏° 3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" }
                ]
            }
        };

        // --- AUTH & NAVIGATION ---

        function submitLogin() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            window.handleLogin(email, password);
        }

        // Called by Firebase Listener
        window.showLoginScreen = () => {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('select-screen').classList.add('hidden');
            document.getElementById('user-badge').classList.add('hidden');
            document.getElementById('audit-screen').classList.add('hidden');
        };

        window.updateUIForUser = (user, isAdmin) => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('select-screen').classList.remove('hidden');

            // Show User Badge
            const userBadge = document.getElementById('user-badge');
            userBadge.classList.remove('hidden');
            document.getElementById('user-email').innerText = user.email;
            document.getElementById('user-role').innerText = isAdmin ? "Lead Auditor (Admin)" : "Internal Auditor";
            document.getElementById('user-role').className = isAdmin ? "text-[10px] text-blue-600 font-bold" : "text-[10px] text-slate-500";

            renderDeptSelection();
        };

        function resetApp() {
            document.getElementById('audit-screen').classList.add('hidden');
            document.getElementById('select-screen').classList.remove('hidden');
            document.getElementById('checklist-container').innerHTML = '';
        }

        // --- APP LOGIC ---

        function renderDeptSelection() {
            const container = document.getElementById('dept-grid');
            container.innerHTML = '';

            for (const [name, info] of Object.entries(DEPARTMENT_CONTEXT)) {
                const riskColorClass = info.riskLevel === 'Critical' ? 'bg-red-50 text-red-700 border-red-200' : 
                                     info.riskLevel === 'High' ? 'bg-orange-50 text-orange-700 border-orange-200' : 'bg-green-50 text-green-700 border-green-200';

                const card = `
                    <div onclick="selectDept('${name}')" class="bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-lg transition cursor-pointer overflow-hidden group relative">
                        <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                            <span class="text-6xl">${info.icon}</span>
                        </div>
                        <div class="p-6 relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold text-slate-800">${name}</h3>
                            </div>
                             <span class="text-xs px-2 py-1 rounded-full border ${riskColorClass} font-semibold mb-4 inline-block">${info.riskLevel} Risk</span>

                            <div class="text-sm text-slate-600 mb-4 space-y-2">
                                <p class="flex items-center gap-2"><i class="fas fa-exclamation-circle text-slate-400"></i> ${info.lastIssues[0]}</p>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-4">
                                ${info.standards.slice(0,3).map(s => `<span class="text-[10px] uppercase bg-slate-100 px-2 py-1 rounded text-slate-500 font-medium">${s}</span>`).join('')}
                            </div>
                            <div class="mt-6 pt-4 border-t border-slate-100 text-right">
                                <span class="text-blue-600 font-medium text-sm group-hover:underline flex items-center justify-end gap-1">Start Audit <i class="fas fa-chevron-right text-xs"></i></span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            }
        }

        async function selectDept(deptName) {
            CURRENT_DEPT = deptName;
            document.getElementById('select-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('loading-screen').style.display = 'flex';

            // Simulate AI Delay
            await new Promise(r => setTimeout(r, 1500));

            const checklistData = DEPARTMENT_CONTEXT[deptName].mockChecklist;
            renderChecklist(checklistData);

            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('loading-screen').style.display = '';
            document.getElementById('audit-screen').classList.remove('hidden');
            document.getElementById('audit-title').innerText = `${deptName} Audit`;
            document.getElementById('dept-icon').innerText = DEPARTMENT_CONTEXT[deptName].icon;
        }

        function renderChecklist(data) {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';

            data.forEach((item, index) => {
                const html = `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in" style="animation-delay: ${index * 0.1}s">
                        <div class="bg-slate-50 p-4 border-b border-slate-200 flex gap-3 items-start">
                            <span class="bg-slate-800 text-white font-bold rounded-lg w-8 h-8 flex items-center justify-center shrink-0 text-sm">${index + 1}</span>
                            <div class="flex-1">
                                <h3 class="font-semibold text-slate-800 text-lg leading-snug">${item.question}</h3>
                                <div class="flex flex-wrap items-center gap-2 mt-2">
                                    <span class="text-xs font-mono bg-blue-50 text-blue-700 px-2 py-0.5 rounded border border-blue-100"><i class="fas fa-book mr-1"></i>${item.requirement}</span>
                                    <span class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded border border-slate-200">${item.risk} Risk</span>
                                </div>
                            </div>
                        </div>

                        <!-- AI Guidance Block -->
                        <div class="p-3 bg-amber-50/50 border-b border-amber-100 text-sm text-slate-700 flex gap-3">
                            <i class="fas fa-lightbulb text-amber-500 mt-0.5"></i> 
                            <div><strong class="text-amber-700">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ${item.guidance}</div>
                        </div>

                        <div class="p-4 space-y-3">
                            <textarea id="finding-${item.id}" class="w-full border border-slate-200 bg-slate-50 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö... (‡πÄ‡∏ä‡πà‡∏ô '‡∏õ‡∏Å‡∏ï‡∏¥‡∏î‡∏µ' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏û‡∏ö‡∏£‡∏≠‡∏¢‡∏£‡∏±‡πà‡∏ß')"></textarea>

                            <div class="flex justify-between items-center pt-2">
                                <button class="text-slate-400 hover:text-slate-600 text-sm flex items-center gap-1 transition">
                                    <i class="fas fa-camera"></i> <span class="hidden sm:inline">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢</span>
                                </button>
                                <button onclick="analyzeFinding(${item.id})" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 text-sm px-4 py-2 rounded-lg transition flex items-center gap-2 shadow-sm font-medium">
                                    <i class="fas fa-gavel text-slate-400"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•
                                </button>
                            </div>
                            <div id="result-${item.id}" class="hidden mt-3 bg-slate-50 p-3 rounded-lg border border-slate-200 text-sm animate-pulse"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        async function analyzeFinding(id) {
            const findingText = document.getElementById(`finding-${id}`).value;
            if (!findingText) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }

            const resultDiv = document.getElementById(`result-${id}`);
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="flex items-center gap-2 text-slate-500"><i class="fas fa-circle-notch fa-spin"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend...</span>';

            // Simulate Backend Processing
            await new Promise(r => setTimeout(r, 1000));
            resultDiv.classList.remove('animate-pulse');

            // Mock Logic
            let mockAnalysis = "";
            let statusColor = "";
            if (findingText.includes("‡∏õ‡∏Å‡∏ï‡∏¥") || findingText.includes("‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") || findingText.includes("‡∏Ñ‡∏£‡∏ö")) {
                mockAnalysis = "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: <strong>Conform (‡∏ú‡πà‡∏≤‡∏ô)</strong><br>‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á";
                statusColor = "border-green-200 bg-green-50 text-green-800";
            } else {
                mockAnalysis = "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: <strong>Potential NC (‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á)</strong><br>‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö CAR";
                statusColor = "border-red-200 bg-red-50 text-red-800";
            }

            resultDiv.className = `mt-3 p-3 rounded-lg border text-sm ${statusColor}`;
            resultDiv.innerHTML = `<div class="flex gap-2"><i class="fas fa-robot mt-1"></i> <div>${mockAnalysis}</div></div>`;

            // Try saving to Firestore
            if (window.saveFindingToFirebase) {
                window.saveFindingToFirebase({
                    dept: CURRENT_DEPT,
                    questionId: id,
                    finding: findingText,
                    analysis: mockAnalysis
                });
            }
        }

        // --- MOCK CHAT ---

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            addChatMessage('user', text);
            input.value = '';

            setTimeout(() => {
                const reply = "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Audit ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Demo Response)";
                addChatMessage('ai', reply);
            }, 800);
        }

        function addChatMessage(role, text) {
            const history = document.getElementById('chat-history');
            const isUser = role === 'user';
            const html = `
                <div class="flex ${isUser ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2">
                    <div class="${isUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'} p-3 rounded-lg text-sm max-w-[85%] shadow-sm">
                        ${text}
                    </div>
                </div>
            `;
            history.innerHTML += html;
            history.scrollTop = history.scrollHeight;
        }

        function handleChatEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

    </script>
</body>
</html>